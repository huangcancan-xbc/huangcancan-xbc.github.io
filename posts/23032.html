<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>052 传输层 —— TCP（下） | 小米里的大麦</title><meta name="keywords" content="Linux,网络"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="052 传输层 —— TCP（下）"><meta name="application-name" content="052 传输层 —— TCP（下）"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="052 传输层 —— TCP（下）"><meta property="og:url" content="https://www.minbit.top/posts/23032.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="传输层 —— TCP（下） 30 张图解： TCP 重传、滑动窗口、流量控制、拥塞控制 | 博客园  1. TCP 流量控制1. 什么是流量控制？先想一个比喻：你在和朋友聊天，对方打字太快，你还没看完一句他又发十条，你就“被淹没”了。TCP 里也一样，发送方（Sender）发数据太快，而接收方（Re"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=f3a39255-670f-3481-069b-60d99044a24e"><meta property="article:author" content="小米里的大麦"><meta property="article:tag" content="技术博客,Linux,C++,后端开发,编程学习,个人博客,技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=f3a39255-670f-3481-069b-60d99044a24e"><meta name="description" content="传输层 —— TCP（下） 30 张图解： TCP 重传、滑动窗口、流量控制、拥塞控制 | 博客园  1. TCP 流量控制1. 什么是流量控制？先想一个比喻：你在和朋友聊天，对方打字太快，你还没看完一句他又发十条，你就“被淹没”了。TCP 里也一样，发送方（Sender）发数据太快，而接收方（Re"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "052 传输层 —— TCP（下）",
  "description": "传输层 —— TCP（下） 30 张图解： TCP 重传、滑动窗口、流量控制、拥塞控制 | 博客园  1. TCP 流量控制1. 什么是流量控制？先想一个比喻：你在和朋友聊天，对方打字太快，你还没看完一句他又发十条，你就“被淹没”了。TCP 里也一样，发送方（Sender）发数据太快，而接收方（Re",
  "image": "https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=f3a39255-670f-3481-069b-60d99044a24e",
  "datePublished": "2025-10-05T04:00:00.000Z",
  "dateModified": "2025-11-15T04:00:00.000Z",
  "author": {
    "@type": "Person",
    "name": "小米里的大麦",
    "url": "https://www.minbit.top"
  },
  "publisher": {
    "@type": "Organization",
    "name": "小米里的大麦",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.minbit.top/img/Profile%20picture.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.minbit.top/posts/23032.html"
  },
  "keywords": "Linux, 网络"
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "首页",
      "item": "https://www.minbit.top"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "052 传输层 —— TCP（下）",
      "item": "https://www.minbit.top/posts/23032.html"
    }
  ]
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "小米里的大麦",
  "url": "https://www.minbit.top",
  "image": "https://www.minbit.top/img/Profile%20picture.png",
  "description": "时间好像总会留下点什么，或许是一个人，或许是一个梦，或许……是一段有意义的经历~"
}</script><link rel="shortcut icon" href="/img/icons/funny.svg"><link rel="canonical" href="https://www.minbit.top/posts/23032.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//bsz.dusays.com:9001"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"友链 + 外链 + 无限进步！欢迎欣赏和贡献！",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"小米里的大麦",mode:"local",switchBtn:!1,btnLink:"https://afdian.net/item/886a79d4db6711eda42a52540025c377",randomNum:4,basicWordCount:1999,key:"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv",Referer:"https://www.minbit.top/"},diytitle:{enable:!0,leaveTitle:"w(ﾟДﾟ)w 不要走！再看看嘛！",backTitle:"♪(^∇^*)欢迎肥来！"},LA51:{enable:!0,ck:"Jp8wwGQpp21utaFQ",LingQueMonitorID:"Jp8ztDRrxmTf7LDj"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.minbit.top/",commentBarrageConfig:{enable:!0,maxBarrage:10,barrageTime:5e3,accessToken:"25c96851dd8a790c4819ad4bfbaf153c",mailMd5:"7b12ebc2be80f9159099f6ab0e16573c"},music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:void 0,navMusic:!0,mainTone:{mode:"both",api:"https://img2color-go.vercel.app/api?img=",cover_change:!0},authorStatus:{skills:["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"距上次更新已过去",messageNext:"天了，这篇文章的内容可能已经过时了。"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!0,limitCount:150,languages:{author:"作者: 小米里的大麦",link:"链接: ",source:"来源: 小米里的大麦",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"小米里的大麦",title:"052 传输层 —— TCP（下）",postAI:"这篇文章讲述了TCP协议中的流量控制、滑动窗口、拥塞控制等关键机制。流量控制通过接收窗口大小来限制发送速率，防止接收方被淹没，其核心是滑动窗口机制，接收方通过窗口字段通知发送方能接收的数据量，发送方据此动态调整发送速率。拥塞控制则是为了防止发送方过快导致网络过载，通过拥塞窗口和慢启动、拥塞避免等策略自适应调整发送速率，避免网络崩溃。文章还介绍了延迟应答和捎带应答优化ACK发送，以及TCP面向字节流的特性，即TCP不关心消息边界，只保证字节流的可靠传输，导致应用层可能面临粘包问题。",pageFillDescription:"传输层 —— TCP（下）, 1. TCP 流量控制, 1. 什么是流量控制？, 2. 实现方式：接收窗口, 2. 滑动窗口, 1. 什么是滑动窗口？, 2. 滑动窗口的组成（发送方视角）, 3. 确认序号（ACK）的含义是什么？, 4. 滑动窗口如何向右移动？移动时大小会变吗？, 1. 向右移动：, 2. 窗口大小会变化吗？, 5. 滑动窗口会越界发送缓冲区吗？, 6. 流量控制是通过滑动窗口实现的吗？, 7. 如果发生丢包滑动窗口怎么处理？, 3. 拥塞控制, 1. 什么是拥塞控制？, 2. 为什么要有拥塞控制？, 3. 如何判断网络是否拥塞？, 4. 拥塞控制的核心机制与关键概念, 1. 慢启动, 2. 拥塞避免, 3. 快重传, 4. 快恢复, 5. 如何解决网络拥塞问题？, 4. 流量控制 VS 拥塞窗口, 5. 延迟应答, 1. 类比场景, 2. 对应 TCP 含义, 3. 作用, 6. 捎带应答, 1. 类比场景, 2. 对应 TCP 含义, 3. 作用, 7. 延迟应答 VS 捎带应答, 8. 面向字节流, 1. 面向字节流的本质, 2. 从发送到接收的完整过程, 1. 应用层调用 write(), 2. TCP 自动分片与聚合, 3. 网络传输与确认, 4. 接收方重组数据流, 5. 应用层调用 read(), 6. 举个例子, 9. 粘包问题, 1. 什么是粘包问题？, 2. 为什么会发生粘包？, 3. UDP 会不会有粘包问题？, 4. 解决粘包的四种典型方案（应用层协议）, 5. 小结（可直接答面试）, 10. TCP 异常情况, 1. 进程终止（正常退出或被 kill）, 2. 机器重启（操作系统重启）, 3. 机器掉电 x2F 网线断开（非正常断连）, 4. 小结, 11. TCP 小结, 12. 基于 TCP 的应用层协议, 13. UDP 实现可靠传输的思路 —— 具体场景具体分析往 TCP 靠, 14. 补充：listen 第二个参数（backlog）的准确理解, 1. 函数原型, 2. 实际含义, 3. 关键要点（重要）, 1. 队列机制, 2. 实际队列长度, 3. 连接拒绝机制, 4. 历史演变, 5. 实际应用传输层下张图解重传滑动窗口流量控制拥塞控制博客园流量控制什么是流量控制先想一个比喻你在和朋友聊天对方打字太快你还没看完一句他又发十条你就被淹没了里也一样发送方发数据太快而接收方处理不过来就会导致接收缓冲区溢出数据丢失重传拥塞效率下降所以设计了流量控制机制让接收方告诉发送方我现在只能接收这么多数据请你慢一点它是一种防止发送方发送数据过快导致接收方来不及处理而造成数据丢失的机制其核心目标是匹配发送速率与接收能力实现方式接收窗口报文头部包含一个位的窗口字段表示接收方当前还能接收多少字节的数据即接收缓冲区剩余空间发送方根据这个窗口大小决定最多能发送多少未确认的数据如果接收方缓冲区快满了它会通告一个较小的窗口如果缓冲区空了就通告一个较大的窗口甚至为高性能扩展注意窗口大小字段最大为字节这对早期的低速网络还行但在高速宽带比如千兆环境下窗口太小会严重限制吞吐量于是引入了窗口缩放选项根据原始后来更新到在三次握手阶段双方可以协商一个窗口缩放因子范围是也就是说报文里的位窗口字段只是一个基值实际值还要乘上缩放因子实际窗口大小通告窗口大小最大窗口字节所以理论上最大窗口但这样一来就与内核文档说的不一样了这其实就是进入理论实际实现差异的问题不同操作系统内核或栈为了性能内存安全兼容性会人为限制最大窗口不会真的给我们用到比如系统实际可配置的最大窗口通常由限制一般上限在几文档中说最大是默认配置限制不是协议上限所以是协议标准定义了理论上能支持到系统实现比如出于稳定性或内存限制只允许配置到几查看窗口缩放功能是否启用输出表示启用窗口缩放定义的扩展允许接收窗口大小超过字节提升高带宽长距离网络的吞吐量查看系统所有接收缓冲区的最大大小全局上限单位字节所有的接收缓冲区配置不能超过此值当前值为字节查看系统所有发送缓冲区的最大大小全局上限单位字节所有的发送缓冲区配置不能超过此值当前值为字节查看协议接收缓冲区的配置三个值分别为最小默认最大单位字节接收缓冲区最小值即使内存紧张也不会小于此值接收缓冲区默认值新建连接时的初始大小接收缓冲区理论最大值实际受限制当前实际最大为接收缓冲区的实际最大值查看协议发送缓冲区的配置三个值分别为最小默认最大单位字节发送缓冲区最小值发送缓冲区默认值发送缓冲区理论最大值实际受限制当前实际最大为滑动窗口神奇的滑动窗口流量控制站什么是滑动窗口这里的滑动窗口和在算法中的滑动窗口算法可以认为是一致的如果滑动窗口算法你有所了解那么此处很容易理解因为原理一致滑动窗口流量控制的核心机制用于让发送方根据接收方的处理能力动态调整发送速率防止发太快收不动滑动窗口是实现流量控制高效传输的关键机制它允许发送方在未收到确认的情况下连续发送多个数据段而不是发送一个等待一个其本质是一个动态的发送许可本质就是为了提高传输效率设计的一种机制目的不用每发一个包就等确认而是允许一批包在途从而实现一次可以发送大量报文可以理解为发送方最多能发多少还没被确认的数据未的数据这个能发的范围由接收方决定接收方通过里的字段窗口大小通知发送方举个直观例子假设接收方当前窗口大小为每个数据包发送方就能连续发个包后必须停下来等等接收方确认了第个包它的窗口右移发送方又能继续发新的一个滑动窗口的组成发送方视角发送窗口通常分为四部分按序列号顺序区域说明是否占用缓冲区已发送且已确认收到可以丢弃窗口向前滑动不再占用可释放已发送但未确认未收到正在等待占用未发送但可发送在窗口内可立即发送占用待发未发送且不可发送存在感不高可忽略而且是窗口之外的空间严格来说不属于滑动窗口本身超出窗口需等待窗口滑动占用但被冻结发送方的发送窗口是一个区间主要分为三块已发送且已确认的数据窗口左边已经安全了已发送但未确认的数据窗口中间在途数据允许发送但还没发送的数据窗口右边可以继续发重点理论上的滑动窗口大小接收方通告窗口拥塞窗口发送方缓存大小这是操作系统实际可用的发送窗口上限包含内核资源限制而协议标准中通常只考虑发送方当前实际使用的滑动窗口大小实际窗口大小接收窗口大小拥塞窗口大小即确认序号的含义是什么的确认序号表示我期望收到的下一个字节的序号是也就是说之前的所有字节我都成功收到了例如表示序号的字节都收到了这是累计确认机制允许少量丢失吗是可靠传输协议丢了接收方下次再发累积确认依旧能覆盖所以只要不是连续大量丢失就不会有问题允许因为使用累计确认即使某个丢了只要后续的到达比如就说明都收到了所以前面的丢失不影响正确性但可能影响性能如触发重传普通数据丢失通常无害但携带窗口更新的丢失可能影响性能滑动窗口如何向右移动移动时大小会变吗向右移动当收到比如说明之前的数据都确认了窗口整体向右滑动发送窗口的左边界就移动到释放已确认的数据空间这意味着一些数据已经确认不用再管了如果接收方缓冲区有空闲还会在中携带新的接收窗口大小可能让右边界也右移窗口变大窗口大小会变化吗会而且经常变变大接收方处理了数据缓冲区空出接收窗口大小增大窗口右边界右移变小接收方缓冲区快满了接收窗口大小减小窗口右边界左移但左边界不能左移变为接收方缓冲区完全满接收窗口大小窗口大小为发送方暂停发送进入零窗口探测状态注意窗口左边界只能右移或不动不能左移因为已确认的数据不能反悔滑动窗口会越界发送缓冲区吗采用了类似环状算法始终保证滑动窗口不会越界不会滑动窗口的右边界即可发送的最大序号永远不会超过发送缓冲区的容量如果应用程序写入的数据太多而窗口太小比如接收窗口大小系统调用会阻塞或返回如果是非阻塞直到窗口有空间因此滑动窗口始终被限制在发送缓冲区内不会越界流量控制是通过滑动窗口实现的吗是的流量控制的核心就是滑动窗口流量控制的本质防止发送方发得太快把接收方撑爆实现方式接收方通过报文头中的字段即接收窗口大小告诉发送方自己还能收多少发送方据此动态调整滑动窗口的大小当接收窗口大小时发送方停止发送除零窗口探测包外滑动窗口是流量控制的执行机制接收窗口大小是流量控制的控制信号如果发生丢包滑动窗口怎么处理丢包主要影响拥塞控制但也会间接影响滑动窗口发送方发现丢包通过超时或重复会触发重传重发未确认的数据同时减小拥塞窗口比如减半导致滑动窗口变小滑动窗口本身不会回退已确认的部分不会撤销未确认的部分继续等待或重传窗口左边界不变右边界可能因拥塞窗口减小而左移窗口缩小接收方视角如果中间丢包接收方会重复发送最后一个正确比如一直发送方收到个重复后会快速重传序号开始的数据快速重传机制重点滑动窗口只向前滑左边界不回退丢包通过重传调整拥塞窗口大小来处理拥塞控制什么是拥塞控制拥塞控制是协议中的一种机制用于防止发送方因发送数据过快而导致网络过载网络中的路由器或链路被过多数据淹没拥塞从而避免大量丢包延迟剧增甚至网络崩溃它的目标是既要尽可能高效利用带宽又要避免让网络堵车关键点流量控制保护接收方别发太快我处理不过来防止发送方把接收方撑爆拥塞控制保护整个网络别发太多网络会堵防止所有发送方把网络堵死为什么要有拥塞控制如果所有主机都无脑狂发数据网络会出现路由器缓存溢出包被丢弃延迟飙升重传风暴越丢越发最终导致整个网络吞吐量下降也就是所谓的网络崩溃网络资源有限网络资源本质还是共享资源路由器缓存带宽都是有限的无控制的后果多个发送方同时高速发包路由器缓存溢出大量丢包丢包触发重传更多数据进入网络恶性循环拥塞崩溃因此必须感知网络状态并自适应调整发送速率如何判断网络是否拥塞无法直接看到网络状态只能通过间接信号推断拥塞拥塞信号说明超时数据包长时间未收到很可能已丢弃严重拥塞重复接收方收到乱序包反复确认最后一个正确序号如连续次中间包可能丢失轻度拥塞这两个事件是触发拥塞控制算法动作的关键警报拥塞控制的核心机制与关键概念在热恋中人总是小心试探一开始不敢太快靠近慢启动发现对方反应良好就逐步增加接触拥塞避免快增长如果对方突然冷淡丢包超时就立刻收敛变得保守快恢复慢启动重启也是这样它试探网络承受能力逐渐增加速度一旦发现不对劲丢包马上退回去避免网络受伤拥塞控制通过一个拥塞窗口来限制发送速率阶段策略触发条件增长方式说明慢启动初始阶段或严重拥塞每指数增长拥塞避免每线性增长快重传个重复立即重传丢失包不等超时快恢复轻微拥塞然后线性增长恢复阶段慢启动就像刚恋爱试探性地快快加深感情目的连接刚建立时不知道网络承载能力先试探性发送规则传统初始拥塞窗口大小通常字节注现代实现如的初始拥塞窗口更大通常是个在慢启动阶段每经过一个大致翻倍指数增长一直到达到慢启动阈值例子第轮发个包收个第轮发个包收个第轮发个包收个虽叫慢启动但增长其实很快指数级小故事一个农名欠地主粮食于是地主给出个选择一个是慢慢还一个是第一天还粒米第二天粒以此类推农民毫不犹豫的选择了第个选择让他没想到的是最开始的日子还能还的上后来指数级增长的粮食竟压得他叫苦不迭拥塞避免稳定关系后不再激进增加逐渐探索极限何时进入当拥塞窗口大小大于等于慢启动阈值时规则每收到一个每轮拥塞窗口只增加线性增长目的避免指数增长导致突然拥塞快重传触发条件收到个重复就认为某个包丢了动作立即重传丢失的包不等超时优点大幅减少重传延迟快恢复恋爱里遇到小矛盾退一步再慢慢靠近触发条件快重传之后当检测到轻微拥塞时不用回到最初的慢启动动作将慢启动阈值设为当前拥塞窗口大小的一半把降到然后线性增长目的避免因单个丢包就从头开始保持较高吞吐如何解决网络拥塞问题的解决思路就是自我降速逐步恢复动态调整拥塞窗口根据反馈推断网络状态丢包时快速响应防止恶化利用慢启动和线性增长实现自适应调节现代系统还在此基础上发展出了许多变种算法如经典改进快恢复默认基于带宽估计提出流量控制拥塞窗口对比维度流量控制拥塞控制控制目标防止接收方缓冲区溢出防止网络整体拥塞控制范围端到端发送方与接收方之间全局整个网络路径触发因素接收方缓冲区容量网络路由器队列溢出分组丢失关键参数接收窗口拥塞窗口阈值实现方式接收方反馈窗口大小发送方主动调整发送速率典型算法滑动窗口协议慢启动拥塞避免快重传快恢复窗口增长根据接收方反馈动态调整指数增长线性增长快速下降检测机制零窗口检测超时重传重复检测是全双工通信双方都能同时发数据和但发送确认号本身也要占用网络资源如果对方每发一个小包我就立刻回一个就会增加很多小包通信影响效率所以引入了延迟应答和捎带应答来优化延迟应答类比场景你吃饭了吗听到了但暂时没回他在想自己是不是也要说点别的几秒后吃了这句话既是回答也是我听到你说话了的信号如果想了半天没要说的就会单独说一句听到了对应含义收到数据后不急着立刻回而是稍微等一下看看自己是否要发送数据回去如果这段时间内有要发的数据就在数据包里顺便带上如果一直没有新数据到了延迟时间比如再单独发作用减少纯包数量降低网络负担提高吞吐率让数据传输更高效捎带应答类比场景吃饭了吗吃了这里没有说听到你说话了但实际上他回答了问题自然就说明他听到了这就是捎带在自己的内容里顺便带上确认对应含义当双方都在发数据时接收方就在自己的数据包中附上确认号告诉对方上一个包我收到了不需要单独发一个包作用减少包的数量因为数据和确认合并成一个包提高通信效率尤其在双向传输时延迟应答捎带应答延迟应答等一等再回看看能不能顺便带上捎带应答既然要说话那就顺便说我听到了项目延迟应答捎带应答类比等一等看要不要顺便回在自己的回答中顺便确认触发条件收到数据但无数据要发收到数据且有数据要发是否等会延迟一小段时间不延迟直接发是否双向通信不一定必须双向都有数据目的减少无意义的包合并数据和节省一次发包典型场景单向传输如文件下载双向交互如面向字节流面向字节流的本质是面向字节流的协议这句话的意思是只看连续的字节不关心消息边界也就是说眼中没有包或消息的概念它只负责把发送方写入的那一串字节完整有序地交给接收方确保不丢不乱不错所以无论写几次读几次对来说都没区别它只是管流动的字节从发送到接收的完整过程应用层调用用户态数据拷贝到内核态的发送缓冲区协议栈按当前网络状况和拥塞窗口决定什么时候按多大尺寸分段发送网络传输对端的收到后先把数据放入内核态的接收缓冲区对端应用层调用从内核缓冲区中按需读取任意长度的字节数据由应用层自己根据协议格式解析出完整消息边界这就是面向字节流的本质提供可靠有序的字节传输通道但把语义交给上层我们用一个简化图来还原整个流程现在来讲讲每一步背后的逻辑应用层调用应用层产生数据转成字节拷贝进内核的发送缓冲区这时就可以返回了并不意味着数据发出去了只是进入了内核队列自动分片与聚合发送缓冲区中的数据由协议控制发送如果太大会拆成多个段如果太小可能暂时不发比如启用了算法等待更多数据合并成一个包再发这一步是的面向字节流特性在发送端的体现它不管我们一次写多少字节只管按自己的节奏连续发字节网络传输与确认在传输过程中做三件事维护序号保证有序超时重传保证可靠滑动窗口控制流量丢了会重发乱序会重排接收方重组数据流数据到达接收方内核后会根据序号把乱序的包重新排序确认收到的字节把连续的字节流写入接收缓冲区应用层调用应用层从接收缓冲区中按自己想要的长度去读数据读多少读几次都行不关心我们每次的分界它只负责保证我们收到的字节顺序正确举个例子用写次每次字节和一次写字节这对来说完全一样它只看到个连续字节同样接收方可以一次读完或次逐字节读甚至一次把这字节和其他后续数据一起读进来不保证写多少次就读多少次也不保证每次写的边界每次读的边界像水管输水不管你倒一桶还是倒十桶水流不断过去水分段传输但水的总量是靠序号控制的不需要每次标记这一桶多大粘包问题什么是粘包问题这就好像小时候家里蒸包子出现从蒸笼里拿一个包子结果连带一个或者多个包子一并被拿起一样粘包是因为是面向字节流的协议不保留消息边界导致多个应用层消息被合并成一个段传输其根本就是是面向字节流的协议它只保证字节的顺序和可靠不丢不重传输不关心一条消息从哪里开始到哪里结束举个例子假设客户端连续发了两条消息底层实际发送过程可能是一起发出去收方一次得到拆成两次发收方第一次得到第二次得到无论哪种情况对来说都没错它完成了字节传输但对应用层来说就糊涂了到底哪个字节是哪个字节是呢这就是粘包拆包问题注意严格来说粘包是应用层术语本身没有包的概念它是字节流所以更准确的说法是消息边界丢失或应用层消息粘连为什么会发生粘包主要有两个原因是流式协议没有消息边界发送端的优化机制可能把多次的小数据包合并成一个更大的包再发送比如受算法影响比喻连发两封信相当于觉得信太小顺手把它们塞进一个信封寄了出去收信人收到一封信里两张纸就要自己判断哪一张属于哪一封会不会有粘包问题不会因为是面向报文的每次发出的数据就是一个独立的报文接收方一次只能收到一个完整的报文如果太大直接丢不会拆分合并所以可能会丢包但不会粘包解决粘包的四种典型方案应用层协议方案类型描述优点缺点常见场景定长报文每个消息的长度是固定的比如每条字节实现最简单无需解析浪费带宽不适合变长内容心跳包状态同步特殊字符分隔每条消息结尾加一个独特分隔符比如等简单直观易调试若数据本身可能包含该字符就要转义或转码文本协议定长报头描述字段自描述长度报头中包含消息体长度先读报头再按长度读消息体高通用性可支持任意变长数据需要两阶段解析读头再读体二进制协议通信游戏服务器自描述字段特殊字符报头带长度字段报尾再加结束符双重保险边界更安全健壮报文略复杂通信要求高可靠性时如金融系统举个例子第种最常用比如我们定义协议格式报头字节消息体长度报体消息数据假设发两条消息和接收方解析逻辑先读字节得知消息长度为再读字节重复上述步骤这样即使把两条粘一起了也能正确拆包小结可直接答面试粘包是因为是字节流没有边界概念所以我们要在用户层定义应用协议划分消息常见方案包括固定长度特殊分隔符定长报头长度字段最通用长度字段分隔符更健壮不会粘包因为它是面向报文的异常情况进程终止正常退出或被连接会正常断开四次挥手原理当进程调用或被终止时内核会自动关闭该进程打开的所有文件描述符包括关闭时内核协议栈会发送报文表示我不会再发数据了进入状态后续完成标准的四次挥手流程即使进程是被强制杀死内核仍会清理其资源并发送因为是内核对象进程只是持有对方表现对端收到后返回表示对方关闭连接应用可正常感知连接关闭做清理工作注意如果进程退出前有未发送完的数据内核会尝试发送取决于设置默认情况下内核会尽力完成挥手连接是优雅关闭的机器重启操作系统重启所有连接会被强制中断但过程分两步原理关机阶段系统时会向所有进程发送然后内核会尝试关闭所有理想情况下会发送但如果关机太快可能来不及发重启后所有旧连接的已被销毁本机状态机重置对端仍认为连接存在因为没收到或关键问题对端无法立即感知连接已断对端继续发数据本机收到后发现无对应连接回复位对端收到知道连接已失效会触发或返回保活机制详解知乎但如果对端不发数据它可能长时间不知道连接已断直到保活探测或应用超时解决方案建议应用层实现心跳机制定期启用长连接与短连接心跳机制长连接心跳机制的实现站机器掉电网线断开非正常断连连接静默失效双方都无法立即感知原理本机突然断电或网线拔掉无法发送任何报文包括对端仍认为连接正常若继续发数据数据包到达对方但对方已关机无返回经过多次重传超时后返回若一直不发数据永远不知道连接已断这就是所谓的半开连接一方已断另一方不知情默认超时时间有多长默认重传约次总超时可达分钟在此期间连接看似正常实则已失效查看重传次数和间隔单位秒通常为小结异常场景本机能否发对端能否立即感知是否会自动断开连接如何关闭建议应对措施进程终止能发能收到正常断开正常四次挥手无需特殊处理机器重启可能来不及发不能除非对端发数据不一定对端收到启用或心跳掉电断网完全不能不能静默失效不自动断开超时或探测失败必须用心跳或调短只有进程终止能保证优雅关闭系统级异常重启断电会导致连接假死本身无法快速检测物理层断连生产环境必须依赖应用层心跳推荐或调优记住可靠但不万能异常检测靠心跳保命小结协议这么复杂就是因为既要保证可靠性同时又尽可能的提高性能可靠性检验和检测数据传输中的错误序列号确保数据按序到达解决重复和乱序问题确认应答接收方确认收到数据形成闭环核心超时重传发送方未及时收到确认则重发数据连接管理三次握手建立连接四次挥手释放连接流量控制通过滑动窗口机制控制发送速率避免接收方过载也属于提高性能拥塞控制检测网络拥塞并调整发送速率也属于提高性能提高性能滑动窗口允许发送方连续发送多个数据包快速重传基于重复确认快速检测丢包并重传延迟应答合并多个确认减少网络开销捎带应答在数据报文段中携带确认信息其他定时器重传定时器为了控制丢失的报文段或丢弃的报文段也就是对报文段确认的等待时间坚持定时器专门为对方零窗口通知而设立的也就是向对方发送窗口探测的时间间隔保活定时器为了检查空闲连接的存在状态也就是向对方发送探查报文的时间间隔定时器双方在四次挥手后主动断开连接的一方需要等待的时长基于的应用层协议常见的基于的应用层协议如下超文本传输协议安全数据传输协议安全外壳协议远程终端协议文件传输协议电子邮件传输协议当然也包括自己写程序时自定义的应用层协议实现可靠传输的思路具体场景具体分析往靠虽然本身是不可靠的但可以在应用层实现类似的可靠性机制引入序列号为每个数据包分配唯一序号确保数据有序确认应答机制接收方收到数据后发送确认信息超时重传设置合理的超时时间未收到确认则重传滑动窗口控制发送窗口大小实现流量控制拥塞控制根据网络状况动态调整发送速率补充第二个参数的准确理解函数原型官方定义参数指定了内核为该套接字维护的等待接受的连接队列的最大长度实际含义在现代系统中这个参数控制的是全连接队列的大小即已经完成三次握手的连接等待应用层调用函数取走的连接关键要点重要队列机制连接建立过程中涉及两个队列半连接队列处理三次握手过程中的连接状态全连接队列已完成握手等待应用处理的连接状态参数主要影响的是全连接队列的大小实际队列长度在内核中实际的全连接队列长度通常是这是因为队列维护时会包含当前正在被处理的连接所以设置时实际可容纳个等待连接连接拒绝机制当全连接队列满时新的连接请求会被内核拒绝客户端可能会收到错误或者内核会静默丢弃连接请求取决于具体配置历史演变早期实现表示半连接队列和全连接队列的总和现代实现主要控制全连接队列半连接队列由其他内核参数控制实际应用服务器通常设置为或高并发服务可以适当增大如或更高考虑系统限制受内核参数限制监控队列状态通过等命令查看队列使用情况简单来说参数决定了服务器能够同时挂起多少个已经建立但尚未被应用程序处理的连接",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-11-15 12:00:00",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach(e=>{c.setAttribute(e,t[e])}),document.head.appendChild(c)}),e.getCSS=(e,t=!1)=>new Promise((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=10||e>=20?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())})}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/custom/css/font.css"><link rel="stylesheet" href="/custom/css/bilibili.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="小米里的大麦" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/Profile%20picture.png"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">算法</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://ac.nowcoder.com/acm/contest/profile/517073385" title="牛客"><img class="back-menu-item-icon" src="/img/icons/think.svg" alt="牛客"><span class="back-menu-item-text">牛客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/1367427" title="洛谷"><img class="back-menu-item-icon" src="/img/icons/funny.svg" alt="洛谷"><span class="back-menu-item-text">洛谷</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" alt="微信" src="/img/wechat.webp"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="/img/alipay.webp"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:1.05rem">AI<sup>2</sup></a><a href="/tags/C/" style="font-size:1.05rem">C++<sup>11</sup></a><a href="/tags/Git/" style="font-size:1.05rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:1.05rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:1.05rem">Linux<sup>59</sup></a><a href="/tags/MySQL/" style="font-size:1.05rem">MySQL<sup>9</sup></a><a href="/tags/Redis/" style="font-size:1.05rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:1.05rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:1.05rem">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:1.05rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:1.05rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:1.05rem">历程<sup>2</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:1.05rem">地址空间<sup>6</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size:1.05rem">工具<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:1.05rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:1.05rem">模板<sup>1</sup></a><a href="/tags/%E7%81%B5%E5%85%89%E8%8D%9F%E8%90%83/" style="font-size:1.05rem">灵光荟萃<sup>3</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:1.05rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:1.05rem">线程<sup>5</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:1.05rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:1.05rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:1.05rem">进程<sup>15</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">一月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a><a class="article-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>网络</span></a></span></div></div><h1 class="post-title" itemprop="name headline">052 传输层 —— TCP（下）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-10-05T04:00:00.000Z" title="发表于 2025-10-05 12:00:00">2025-10-05</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-11-15T04:00:00.000Z" title="更新于 2025-11-15 12:00:00">2025-11-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="052 传输层 —— TCP（下）"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=f3a39255-670f-3481-069b-60d99044a24e"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/23032.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><a href="/tags/%E7%BD%91%E7%BB%9C/" tabindex="-1" itemprop="url">网络</a><h1 id="CrawlerTitle" itemprop="name headline">052 传输层 —— TCP（下）</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-10-05T04:00:00.000Z" title="发表于 2025-10-05 12:00:00">2025-10-05</time><time itemprop="dateCreated datePublished" datetime="2025-11-15T04:00:00.000Z" title="更新于 2025-11-15 12:00:00">2025-11-15</time></header><h1 id="传输层-——-TCP（下）"><a href="#传输层-——-TCP（下）" class="headerlink" title="传输层 —— TCP（下）"></a>传输层 —— TCP（下）</h1><blockquote><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaolincoding/p/12732052.html">30 张图解： TCP 重传、滑动窗口、流量控制、拥塞控制 | 博客园</a></p></blockquote><h2 id="1-TCP-流量控制"><a href="#1-TCP-流量控制" class="headerlink" title="1. TCP 流量控制"></a>1. TCP 流量控制</h2><h3 id="1-什么是流量控制？"><a href="#1-什么是流量控制？" class="headerlink" title="1. 什么是流量控制？"></a>1. 什么是流量控制？</h3><p>先想一个比喻：你在和朋友聊天，对方打字太快，你还没看完一句他又发十条，你就“被淹没”了。TCP 里也一样，发送方（Sender）发数据太快，而接收方（Receiver）处理不过来，就会导致：</p><ul><li>接收缓冲区溢出（数据丢失）</li><li>重传、拥塞、效率下降</li></ul><p>所以 TCP 设计了 <strong>流量控制机制（Flow Control）</strong>，让接收方告诉发送方：“我现在只能接收这么多数据，请你慢一点。”它是一种防止发送方发送数据过快，导致接收方来不及处理而造成数据丢失的机制，其核心目标是 <strong>匹配发送速率与接收能力</strong>。</p><h3 id="2-实现方式：接收窗口"><a href="#2-实现方式：接收窗口" class="headerlink" title="2. 实现方式：接收窗口"></a>2. 实现方式：接收窗口</h3><p>TCP 报文头部包含一个 <strong>16 位的窗口字段（Window Size）</strong>，表示接收方当前还能接收多少字节的数据（即接收缓冲区剩余空间）。发送方根据这个窗口大小决定最多能发送多少未确认的数据。如果接收方缓冲区快满了，它会通告一个较小的窗口；如果缓冲区空了，就通告一个较大的窗口（甚至为 0）。</p><blockquote><p><a target="_blank" rel="noopener" href="https://www.ietf.org/rfc/rfc1323.txt">高性能 TCP 扩展</a></p></blockquote><p>注意：窗口大小字段最大为 65535 字节（64 KB），这对早期的低速网络还行，但在高速宽带（比如千兆）环境下，<strong>64KB 窗口太小，会严重限制吞吐量</strong>。于是 RFC 1323 引入了“窗口缩放选项（Window Scale Option，<a target="_blank" rel="noopener" href="https://www.ibm.com/docs/zh/aix/7.3.0?topic=tuning-rfc1323-tunable">RFC 1323</a>）”，根据原始 RFC 1323（后来更新到 RFC 7323）在 <strong>三次握手阶段</strong>，双方可以协商一个窗口缩放因子 <code>S</code>，范围是：[0,14]，也就是说，<strong>报文里的 16 位窗口字段只是一个“基值”，实际值还要乘上缩放因子。</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">实际窗口大小 = 通告窗口大小 × (<span class="number">2</span>^S)</span><br><span class="line">最大窗口 = <span class="number">65535</span> × <span class="number">2</span>^<span class="number">14</span></span><br><span class="line">          = <span class="number">65535</span> × <span class="number">16384</span></span><br><span class="line">          = <span class="number">1</span>,<span class="number">073</span>,<span class="number">725</span>,<span class="number">440</span> 字节 ≈ <span class="number">1</span> GB</span><br></pre></td></tr></table></figure><p>所以 <strong>理论上最大窗口 ≈ 1GB</strong>，但这样一来，就与 IBM、Linux 内核文档说的不一样了，这其实就是进入“<strong>理论 vs 实际实现差异</strong>”的问题：不同操作系统、内核或 TCP 栈为了性能、内存安全、兼容性，会 <strong>人为限制最大窗口</strong>，不会真的给我们用到 1GB。比如：</p><table><thead><tr><th>系统</th><th>实际可配置的最大窗口</th></tr></thead><tbody><tr><td><strong>Linux (CentOS 7)</strong></td><td>通常 ≤ 16 MB（由 <code>/proc/sys/net/core/rmem_max</code> 限制）</td></tr><tr><td><strong>Windows</strong></td><td>一般上限在几 MB</td></tr><tr><td><strong>IBM AIX</strong></td><td>文档中说最大 1 MB（是默认配置限制，不是协议上限）</td></tr></tbody></table><p>所以：RFC 是协议标准，定义了“理论上能支持到 1GB”，系统实现（比如 AIX、Linux）出于稳定性或内存限制，只允许配置到几 MB。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看TCP窗口缩放功能是否启用，输出1表示启用TCP窗口缩放（RFC 1323定义的扩展）</span></span><br><span class="line"><span class="comment"># 允许TCP接收窗口大小超过65535字节，提升高带宽长距离网络的吞吐量</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/ipv4/tcp_window_scaling</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统所有socket接收缓冲区的最大大小（全局上限），单位：字节，所有socket的接收缓冲区配置不能超过此值</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/core/rmem_max</span><br><span class="line">212992		<span class="comment"># 当前值为212992字节（208KB）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统所有socket发送缓冲区的最大大小（全局上限），单位：字节，所有socket的发送缓冲区配置不能超过此值</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/core/wmem_max</span><br><span class="line">212992		<span class="comment"># 当前值为212992字节（208KB）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看TCP协议接收缓冲区的配置（三个值分别为最小/默认/最大），单位：字节</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/ipv4/tcp_rmem</span><br><span class="line">4096	87380	6291456</span><br><span class="line"><span class="comment"># 4096：接收缓冲区最小值（即使内存紧张也不会小于此值）</span></span><br><span class="line"><span class="comment"># 87380：接收缓冲区默认值（新建连接时的初始大小）</span></span><br><span class="line"><span class="comment"># 6291456：接收缓冲区理论最大值（实际受rmem_max限制，当前实际最大为212992）</span></span><br><span class="line"><span class="comment"># TCP 接收缓冲区的实际最大值 = min(tcp_rmem[2], rmem_max)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看TCP协议发送缓冲区的配置（三个值分别为最小/默认/最大），单位：字节</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/ipv4/tcp_wmem</span><br><span class="line">4096	16384	4194304</span><br><span class="line"><span class="comment"># 4096：发送缓冲区最小值</span></span><br><span class="line"><span class="comment"># 16384：发送缓冲区默认值</span></span><br><span class="line"><span class="comment"># 4194304：发送缓冲区理论最大值（实际受wmem_max限制，当前实际最大为212992）</span></span><br></pre></td></tr></table></figure><h2 id="2-滑动窗口"><a href="#2-滑动窗口" class="headerlink" title="2. 滑动窗口"></a>2. 滑动窗口</h2><blockquote><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sQXDYREwP/?share_source=copy_web&vd_source=872e5e3ccf44874c39edaf42e30ab0de">神奇的滑动窗口 | TCP 流量控制 | B 站</a></p></blockquote><h3 id="1-什么是滑动窗口？"><a href="#1-什么是滑动窗口？" class="headerlink" title="1. 什么是滑动窗口？"></a>1. 什么是滑动窗口？</h3><blockquote><p>这里的滑动窗口和在算法中的滑动窗口算法可以认为是一致的，如果滑动窗口算法你有所了解，那么此处很容易理解，因为原理一致！</p><p><strong>TCP 滑动窗口 &#x3D; 流量控制的核心机制，用于让发送方根据接收方的处理能力动态调整发送速率，防止“发太快、收不动”。</strong></p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251006153117547.png" alt="PixPin_2025-10-06_15-31-06"></p><p>滑动窗口是 TCP 实现 <strong>流量控制 + 高效传输</strong> 的关键机制。它允许发送方在 <strong>未收到确认的情况下</strong> 连续发送多个数据段，而不是“发送一个、等待一个”。其本质是一个“动态的发送许可”。</p><ul><li><strong>本质</strong>：就是 TCP 为了提高传输 <strong>效率</strong> 设计的一种机制。</li><li><strong>目的</strong>：不用每发一个包就等确认，而是允许「一批包」在途，从而实现一次可以发送大量 TCP 报文。</li></ul><p>可以理解为：“发送方最多能发多少还没被确认的数据（未 ACK 的数据）。”这个“能发的范围”由 <strong>接收方</strong> 决定， 接收方通过 <code>TCP Header</code> 里的 <strong>Window 字段（窗口大小）</strong> 通知发送方，举个直观例子（假设）：</p><ul><li>接收方当前窗口大小为 <code>4096 bytes</code>。</li><li>每个数据包 <code>1024 bytes</code>。</li></ul><p>发送方就能 <strong>连续发 4 个包</strong>（4096 bytes）后，必须停下来等 ACK。 等接收方确认了第 1 个包，它的窗口“右移”，发送方又能继续发新的一个。</p><h3 id="2-滑动窗口的组成（发送方视角）"><a href="#2-滑动窗口的组成（发送方视角）" class="headerlink" title="2. 滑动窗口的组成（发送方视角）"></a>2. 滑动窗口的组成（发送方视角）</h3><p>发送窗口通常分为四部分（按序列号顺序）：</p><table><thead><tr><th><strong>区域</strong></th><th><strong>说明</strong></th><th><strong>是否占用缓冲区</strong></th></tr></thead><tbody><tr><td><strong>已发送且已确认（收到 ACK）</strong></td><td><strong>可以丢弃，窗口向前滑动</strong></td><td><strong>不再占用（可释放）</strong></td></tr><tr><td><strong>已发送但未确认（未收到 ACK）</strong></td><td><strong>正在等待 ACK</strong></td><td><strong>占用</strong></td></tr><tr><td><strong>未发送但可发送</strong></td><td><strong>在窗口内，可立即发送</strong></td><td><strong>占用（待发）</strong></td></tr><tr><td>未发送且不可发送（存在感不高，可忽略，而且是窗口之外的空间，严格来说 <strong>不属于滑动窗口本身</strong>）</td><td>超出窗口，需等待窗口滑动</td><td>占用（但被“冻结”）</td></tr></tbody></table><p>发送方的 <strong>发送窗口</strong> 是一个区间，主要分为三块：</p><ol><li><strong>已发送且已确认的数据</strong>（窗口左边，已经安全了）</li><li><strong>已发送但未确认的数据</strong>（窗口中间，在途数据）</li><li><strong>允许发送但还没发送的数据</strong>（窗口右边，可以继续发）</li></ol><blockquote><p><strong>重点：<span style="color:red">理论上的滑动窗口大小 &#x3D; min(接收方通告窗口，拥塞窗口，发送方缓存大小)</span>，这是操作系统实际可用的发送窗口上限，包含内核资源限制；而协议标准中通常只考虑发送方当前实际使用的滑动窗口大小，<span style="color:red">实际窗口大小 &#x3D; min（接收窗口大小，拥塞窗口大小）即 min(cwnd, rwnd)</span>。</strong></p></blockquote><h3 id="3-确认序号（ACK）的含义是什么？"><a href="#3-确认序号（ACK）的含义是什么？" class="headerlink" title="3. 确认序号（ACK）的含义是什么？"></a>3. 确认序号（ACK）的含义是什么？</h3><p>TCP 的确认序号（Acknowledgment Number）表示：“<strong>我期望收到的下一个字节的序号是 x，也就是说，x 之前的所有字节我都成功收到了。</strong>” 例如：ACK &#x3D; 1001 → 表示序号 1~1000 的字节都收到了，这是 <strong>累计确认（Cumulative ACK）</strong> 机制。</p><p><strong>允许少量 ACK 丢失吗？</strong></p><blockquote><p><strong>TCP 是可靠传输协议，ACK 丢了，接收方下次再发 ACK（累积确认）依旧能覆盖。所以只要不是连续大量丢失，就不会有问题。</strong></p></blockquote><p><strong>允许！</strong> 因为 TCP 使用累计确认：</p><ul><li>即使某个 ACK 丢了，只要后续的 ACK 到达（比如 ACK &#x3D; 2001），就说明 1~2000 都收到了。</li><li>所以前面的 ACK 丢失不影响正确性（但可能影响性能，如触发重传）。</li><li><strong>普通数据 ACK 丢失通常无害，但携带窗口更新的 ACK 丢失可能影响性能。</strong></li></ul><h3 id="4-滑动窗口如何“向右移动”？移动时大小会变吗？"><a href="#4-滑动窗口如何“向右移动”？移动时大小会变吗？" class="headerlink" title="4. 滑动窗口如何“向右移动”？移动时大小会变吗？"></a>4. 滑动窗口如何“向右移动”？移动时大小会变吗？</h3><h4 id="1-向右移动："><a href="#1-向右移动：" class="headerlink" title="1. 向右移动："></a>1. 向右移动：</h4><ol><li>当收到 ACK（比如 ACK &#x3D; x），说明 x 之前的数据都确认了，窗口整体向右滑动。</li><li>发送窗口的 <strong>左边界</strong> 就移动到 x，释放已确认的数据空间，这意味着一些数据已经确认，不用再管了。</li><li>如果接收方缓冲区有空闲，还会在 ACK 中携带新的接收窗口大小，可能让 <strong>右边界也右移</strong>（窗口变大）。</li></ol><h4 id="2-窗口大小会变化吗？"><a href="#2-窗口大小会变化吗？" class="headerlink" title="2. 窗口大小会变化吗？"></a>2. 窗口大小会变化吗？</h4><p><strong>会！而且经常变！</strong></p><ul><li><strong>变大</strong>：接收方处理了数据，缓冲区空出 → 接收窗口大小增大 → 窗口右边界右移。</li><li><strong>变小</strong>：接收方缓冲区快满了 → 接收窗口大小减小 → 窗口右边界左移（但左边界不能左移！）。</li><li><strong>变为 0</strong>：接收方缓冲区完全满 → 接收窗口大小 &#x3D; 0 → 窗口大小为 0，发送方暂停发送（进入“零窗口探测”状态）。</li></ul><blockquote><p><strong>注意：窗口左边界只能右移或不动，不能左移（因为已确认的数据不能“反悔”）。</strong></p></blockquote><h3 id="5-滑动窗口会“越界”发送缓冲区吗？"><a href="#5-滑动窗口会“越界”发送缓冲区吗？" class="headerlink" title="5. 滑动窗口会“越界”发送缓冲区吗？"></a>5. 滑动窗口会“越界”发送缓冲区吗？</h3><blockquote><p><strong>TCP 采用了类似环状算法，始终保证滑动窗口不会越界！</strong></p></blockquote><p><strong>不会。</strong></p><ul><li>滑动窗口的右边界（即“可发送的最大序号”）<strong>永远不会超过发送缓冲区的容量</strong>。</li><li>如果应用程序写入的数据太多，而窗口太小（比如接收窗口大小 &#x3D; 0），<code>send()</code> 系统调用会 <strong>阻塞</strong>（或返回 EAGAIN，如果是非阻塞 socket），直到窗口有空间。</li><li>因此，<strong>滑动窗口始终被限制在发送缓冲区内</strong>，不会越界。</li></ul><h3 id="6-流量控制是通过滑动窗口实现的吗？"><a href="#6-流量控制是通过滑动窗口实现的吗？" class="headerlink" title="6. 流量控制是通过滑动窗口实现的吗？"></a>6. 流量控制是通过滑动窗口实现的吗？</h3><p><strong>是的！流量控制的核心就是滑动窗口！</strong></p><p><strong>流量控制的本质</strong>：防止发送方发得太快，把接收方“撑爆”。<strong>实现方式</strong>：接收方通过 TCP 报文头中的 <strong>Window 字段（即接收窗口大小）</strong> 告诉发送方自己还能收多少。发送方据此 <strong>动态调整滑动窗口的大小</strong>。当 接收窗口大小 &#x3D; 0 时，发送方停止发送（除零窗口探测包外）。</p><blockquote><p><strong>滑动窗口是流量控制的执行机制，接收窗口大小是流量控制的控制信号。</strong></p></blockquote><h3 id="7-如果发生丢包，滑动窗口怎么处理？"><a href="#7-如果发生丢包，滑动窗口怎么处理？" class="headerlink" title="7. 如果发生丢包，滑动窗口怎么处理？"></a>7. 如果发生丢包，滑动窗口怎么处理？</h3><p>丢包主要影响 <strong>拥塞控制</strong>，但也会间接影响滑动窗口：</p><ol><li><strong>发送方发现丢包</strong>（通过超时或重复 ACK）：<ul><li>会触发重传（重发未确认的数据）。</li><li>同时 <strong>减小拥塞窗口</strong>（比如减半）→ 导致滑动窗口变小。</li></ul></li><li><strong>滑动窗口本身不会“回退”</strong>：<ul><li>已确认的部分不会撤销。</li><li>未确认的部分继续等待 ACK 或重传。</li><li>窗口左边界不变，右边界可能因 <strong>拥塞窗口</strong> 减小而左移（窗口缩小）。</li></ul></li><li><strong>接收方视角</strong>：<ul><li>如果中间丢包，接收方会重复发送 <strong>最后一个正确 ACK</strong>（比如一直 ACK &#x3D; 1001）。</li><li>发送方收到 3 个重复 ACK 后，会快速重传序号 1001 开始的数据（快速重传机制）。</li></ul></li></ol><blockquote><p><strong>重点：滑动窗口只向前滑（左边界不回退），丢包通过重传 + 调整拥塞窗口大小来处理。</strong></p></blockquote><h2 id="3-拥塞控制"><a href="#3-拥塞控制" class="headerlink" title="3. 拥塞控制"></a>3. 拥塞控制</h2><h3 id="1-什么是拥塞控制？"><a href="#1-什么是拥塞控制？" class="headerlink" title="1. 什么是拥塞控制？"></a>1. 什么是拥塞控制？</h3><p><strong>拥塞控制</strong> 是 TCP 协议中的一种 <strong>机制</strong>，用于 <strong>防止发送方因发送数据过快而导致网络过载（网络中的路由器或链路被过多数据淹没&#x2F;拥塞）</strong>，从而避免大量丢包、延迟剧增甚至网络崩溃。它的目标是：既要尽可能高效利用带宽，又要避免让网络“堵车”。</p><blockquote><p>关键点：</p><ul><li>流量控制 → 保护 <strong>接收方</strong>（别发太快，我处理不过来），防止「<strong>发送方</strong>」把「<strong>接收方</strong>」撑爆。</li><li>拥塞控制 → 保护 <strong>整个网络</strong>（别发太多，网络会堵），防止「<strong>所有发送方</strong>」把「<strong>网络</strong>」堵死。</li></ul></blockquote><h3 id="2-为什么要有拥塞控制？"><a href="#2-为什么要有拥塞控制？" class="headerlink" title="2. 为什么要有拥塞控制？"></a>2. 为什么要有拥塞控制？</h3><blockquote><p><strong>如果所有主机都“无脑狂发数据”，网络会出现：路由器缓存溢出（包被丢弃）、延迟飙升、重传风暴（越丢越发），最终导致整个网络吞吐量下降，也就是所谓的“网络崩溃”。</strong></p></blockquote><ol><li><strong>网络资源有限</strong>：网络资源本质还是 <strong>共享资源</strong>，路由器缓存、带宽都是有限的。</li><li><strong>无控制的后果</strong>：<ul><li>多个发送方同时高速发包 → 路由器缓存溢出 → <strong>大量丢包</strong>。</li><li>丢包触发重传 → 更多数据进入网络 → <strong>恶性循环（拥塞崩溃）</strong>。</li></ul></li></ol><blockquote><p><strong>因此，TCP 必须“感知”网络状态，并 自适应调整发送速率。</strong></p></blockquote><h3 id="3-如何判断网络是否拥塞？"><a href="#3-如何判断网络是否拥塞？" class="headerlink" title="3. 如何判断网络是否拥塞？"></a>3. 如何判断网络是否拥塞？</h3><p>TCP <strong>无法直接看到网络状态</strong>，只能通过 <strong>间接信号</strong> 推断拥塞：</p><table><thead><tr><th>拥塞信号</th><th>说明</th></tr></thead><tbody><tr><td><strong>超时（Timeout）</strong></td><td>数据包长时间未收到 ACK → 很可能已丢弃（严重拥塞）</td></tr><tr><td><strong>重复 ACK</strong></td><td>接收方收到乱序包，反复确认最后一个正确序号（如连续 3 次 ACK &#x3D; 1001）→ 中间包可能丢失（轻度拥塞）</td></tr></tbody></table><blockquote><p>这两个事件是触发拥塞控制算法动作的关键“警报”。</p></blockquote><h3 id="4-拥塞控制的核心机制与关键概念"><a href="#4-拥塞控制的核心机制与关键概念" class="headerlink" title="4. 拥塞控制的核心机制与关键概念"></a>4. 拥塞控制的核心机制与关键概念</h3><blockquote><p>在热恋中，人总是“小心试探”——</p><ul><li>一开始不敢太快靠近（<strong>慢启动</strong>）。</li><li>发现对方反应良好，就逐步增加接触（<strong>拥塞避免&#x2F;快增长</strong>）。</li><li>如果对方突然冷淡（<strong>丢包&#x2F;超时</strong>），就立刻收敛，变得保守（<strong>快恢复&#x2F;慢启动重启</strong>）。</li></ul><p>TCP 也是这样：它“试探”网络承受能力，逐渐增加速度，一旦发现不对劲（丢包），马上退回去，避免网络“受伤”。</p></blockquote><p>TCP 拥塞控制通过一个 <strong>拥塞窗口</strong> 来限制发送速率。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251006170038145.png" alt="PixPin_2025-10-06_17-00-35"></p><table><thead><tr><th>阶段&#x2F;策略</th><th>触发条件</th><th>cwnd 增长方式</th><th>说明</th></tr></thead><tbody><tr><td>慢启动</td><td>初始阶段或严重拥塞</td><td>每 ACK cwnd × 2</td><td>指数增长</td></tr><tr><td>拥塞避免</td><td>cwnd ≥ ssthresh</td><td>每 RTT cwnd + 1 MSS</td><td>线性增长</td></tr><tr><td>快重传</td><td>3 个重复 ACK</td><td>立即重传丢失包</td><td>不等超时</td></tr><tr><td>快恢复</td><td>轻微拥塞</td><td>cwnd &#x3D; ssthresh，然后线性增长</td><td>恢复阶段</td></tr></tbody></table><h4 id="1-慢启动"><a href="#1-慢启动" class="headerlink" title="1. 慢启动"></a>1. 慢启动</h4><blockquote><p>就像“刚恋爱，试探性地快快加深感情”。</p></blockquote><ul><li><strong>目的</strong>：连接刚建立时，不知道网络承载能力，先“试探性”发送。</li><li><strong>规则</strong>：<ul><li>传统初始拥塞窗口大小 &#x3D; 1 MSS（Maximum Segment Size，通常 1460 字节）。注：现代 TCP 实现（如 RFC 6928）的初始拥塞窗口更大，通常是 10 个 MSS。</li><li>在慢启动阶段，每经过一个 RTT，cwnd 大致翻倍（<strong>指数增长</strong>）。</li><li>一直到达到慢启动阈值（ssthresh）。</li></ul></li><li><strong>例子</strong>：<ul><li>第 1 轮：发 1 个包 → 收 1 个 ACK → cwnd &#x3D; 2</li><li>第 2 轮：发 2 个包 → 收 2 个 ACK → cwnd &#x3D; 4</li><li>第 3 轮：发 4 个包 → 收 4 个 ACK → cwnd &#x3D; 8</li><li>……</li></ul></li></ul><blockquote><p><strong>虽叫“慢启动”，但增长其实很快（指数级）！</strong> 小故事：一个农名欠地主粮食，于是地主给出 2 个选择，一个是慢慢还，一个是第一天还 1 粒米，第二天 2 粒，以此类推……农民毫不犹豫的选择了第 2 个选择，让他没想到的是最开始的日子还能还的上，后来指数级增长的粮食竟压得他叫苦不迭……</p></blockquote><h4 id="2-拥塞避免"><a href="#2-拥塞避免" class="headerlink" title="2. 拥塞避免"></a>2. 拥塞避免</h4><blockquote><p>稳定关系后，不再激进增加，逐渐探索极限。</p></blockquote><ul><li><strong>何时进入</strong>：当拥塞窗口大小大于等于慢启动阈值时（cwnd ≥ ssthresh）。</li><li><strong>规则</strong>：<ul><li>每收到一个 ACK，cwnd +&#x3D; 1&#x2F;cwnd → <strong>每轮 RTT，拥塞窗口只增加 1 MSS（线性增长）</strong></li></ul></li><li><strong>目的</strong>：避免指数增长导致突然拥塞。</li></ul><h4 id="3-快重传"><a href="#3-快重传" class="headerlink" title="3. 快重传"></a>3. 快重传</h4><ul><li><strong>触发条件</strong>：收到 <strong>3 个重复 ACK</strong>，就认为某个包丢了。</li><li><strong>动作</strong>：立即重传丢失的包，<strong>不等超时</strong>。</li><li><strong>优点</strong>：大幅减少重传延迟。</li></ul><h4 id="4-快恢复"><a href="#4-快恢复" class="headerlink" title="4. 快恢复"></a>4. 快恢复</h4><blockquote><p>恋爱里遇到小矛盾，退一步，再慢慢靠近。</p></blockquote><ul><li><strong>触发条件</strong>：快重传之后，当检测到轻微拥塞时，不用回到最初的慢启动。</li><li><strong>动作</strong>：将慢启动阈值设为当前拥塞窗口大小的一半（把 ssthresh 降到 cwnd&#x2F;2，然后线性增长）。</li><li><strong>目的</strong>：避免因单个丢包就“从头开始”，保持较高吞吐。</li></ul><h3 id="5-如何解决网络拥塞问题？"><a href="#5-如何解决网络拥塞问题？" class="headerlink" title="5. 如何解决网络拥塞问题？"></a>5. 如何解决网络拥塞问题？</h3><p>TCP 的解决思路就是「<strong>自我降速 + 逐步恢复</strong>」：</p><ol><li><strong>动态调整 cwnd（拥塞窗口）。</strong></li><li><strong>根据 ACK 反馈推断网络状态。</strong></li><li><strong>丢包时快速响应，防止恶化。</strong></li><li><strong>利用慢启动和线性增长实现自适应调节。</strong></li></ol><p>现代系统还在此基础上发展出了许多变种算法，如：</p><ul><li>Reno（经典）</li><li>NewReno（改进快恢复）</li><li>CUBIC（Linux 默认）</li><li>BBR（基于带宽估计，Google 提出）</li></ul><h2 id="4-流量控制-VS-拥塞窗口"><a href="#4-流量控制-VS-拥塞窗口" class="headerlink" title="4. 流量控制 VS 拥塞窗口"></a>4. 流量控制 VS 拥塞窗口</h2><table><thead><tr><th align="left">对比维度</th><th align="left">流量控制</th><th align="left">拥塞控制</th></tr></thead><tbody><tr><td align="left">控制目标</td><td align="left">防止 <strong>接收方</strong> 缓冲区溢出</td><td align="left">防止 <strong>网络</strong> 整体拥塞</td></tr><tr><td align="left">控制范围</td><td align="left">端到端（发送方与接收方之间）</td><td align="left">全局（整个网络路径）</td></tr><tr><td align="left">触发因素</td><td align="left">接收方缓冲区容量</td><td align="left">网络路由器队列溢出、分组丢失</td></tr><tr><td align="left">关键参数</td><td align="left">接收窗口 (rwnd)</td><td align="left">拥塞窗口 (cwnd)、阈值 (ssthresh)</td></tr><tr><td align="left">实现方式</td><td align="left">接收方反馈窗口大小</td><td align="left">发送方主动调整发送速率</td></tr><tr><td align="left">典型算法</td><td align="left">滑动窗口协议</td><td align="left">慢启动、拥塞避免、快重传、快恢复</td></tr><tr><td align="left">窗口增长</td><td align="left">根据接收方反馈动态调整</td><td align="left">指数增长 → 线性增长 → 快速下降</td></tr><tr><td align="left">检测机制</td><td align="left">零窗口检测</td><td align="left">超时重传、重复 ACK 检测</td></tr></tbody></table><hr><blockquote><p><strong>TCP 是全双工通信（双方都能同时发数据和 ACK）。但发送 ACK（确认号）本身也要占用网络资源，如果对方每发一个小包，我就立刻回一个 ACK，就会增加很多小包通信 → 影响效率。所以：TCP 引入了 延迟应答（Delayed ACK）和 捎带应答（Piggyback ACK）来优化。</strong></p></blockquote><h2 id="5-延迟应答"><a href="#5-延迟应答" class="headerlink" title="5. 延迟应答"></a>5. 延迟应答</h2><h3 id="1-类比场景"><a href="#1-类比场景" class="headerlink" title="1. 类比场景"></a>1. 类比场景</h3><ol><li>A：你吃饭了吗？（B 听到了，但暂时没回——他在想自己是不是也要说点别的）。</li><li>几秒后：B：吃了（这句话既是回答，也是“我听到你说话了”的信号）。</li><li>如果 B 想了半天没要说的，就会单独说一句：B：听到了！</li></ol><h3 id="2-对应-TCP-含义"><a href="#2-对应-TCP-含义" class="headerlink" title="2. 对应 TCP 含义"></a>2. 对应 TCP 含义</h3><ol><li>TCP 收到数据后，不急着立刻回 ACK，而是 <strong>稍微等一下</strong>，看看自己是否要发送数据回去。</li><li>如果这段时间内有要发的数据 → 就在数据包里“顺便带上 ACK”。</li><li>如果一直没有新数据 → 到了延迟时间（比如 40ms）再单独发 ACK。</li></ol><h3 id="3-作用"><a href="#3-作用" class="headerlink" title="3. 作用"></a>3. 作用</h3><ul><li>减少纯 ACK 包数量，降低网络负担；</li><li>提高吞吐率，让数据传输更高效。</li></ul><h2 id="6-捎带应答"><a href="#6-捎带应答" class="headerlink" title="6. 捎带应答"></a>6. 捎带应答</h2><h3 id="1-类比场景-1"><a href="#1-类比场景-1" class="headerlink" title="1. 类比场景"></a>1. 类比场景</h3><ol><li>A：吃饭了吗？</li><li>B：吃了。</li></ol><p>这里 B 没有说「听到你说话了」，但实际上他回答了问题，<strong>自然就说明他听到了</strong>。这就是「捎带」：在自己的内容里顺便带上确认。</p><h3 id="2-对应-TCP-含义-1"><a href="#2-对应-TCP-含义-1" class="headerlink" title="2. 对应 TCP 含义"></a>2. 对应 TCP 含义</h3><p>当 TCP 双方都在发数据时，接收方就 <strong>在自己的数据包中附上 ACK 确认号</strong>，告诉对方“上一个包我收到了”，不需要单独发一个 ACK 包。</p><h3 id="3-作用-1"><a href="#3-作用-1" class="headerlink" title="3. 作用"></a>3. 作用</h3><ul><li>减少包的数量（因为数据和确认合并成一个包）。</li><li>提高通信效率，尤其在双向传输时。</li></ul><h2 id="7-延迟应答-VS-捎带应答"><a href="#7-延迟应答-VS-捎带应答" class="headerlink" title="7. 延迟应答 VS 捎带应答"></a>7. 延迟应答 VS 捎带应答</h2><blockquote><ul><li>延迟应答：<strong>等一等再回，看看能不能顺便带上 ACK。</strong></li><li>捎带应答：<strong>既然要说话，那就顺便说“我听到了”。</strong></li></ul></blockquote><table><thead><tr><th>项目</th><th>延迟应答</th><th>捎带应答</th></tr></thead><tbody><tr><td>类比</td><td>B 等一等，看要不要顺便回</td><td>B 在自己的回答中顺便确认</td></tr><tr><td>触发条件</td><td>收到数据，但无数据要发</td><td>收到数据且有数据要发</td></tr><tr><td>是否等</td><td>会延迟一小段时间</td><td>不延迟，直接发</td></tr><tr><td>是否双向通信</td><td>不一定</td><td>必须双向都有数据</td></tr><tr><td>目的</td><td>减少无意义的 ACK 包</td><td>合并数据和 ACK，节省一次发包</td></tr><tr><td>典型场景</td><td>单向传输（如文件下载）</td><td>双向交互（如 Telnet、HTTP）</td></tr></tbody></table><hr><h2 id="8-面向字节流"><a href="#8-面向字节流" class="headerlink" title="8. 面向字节流"></a>8. 面向字节流</h2><h3 id="1-面向字节流的本质"><a href="#1-面向字节流的本质" class="headerlink" title="1. 面向字节流的本质"></a>1. 面向字节流的本质</h3><p>TCP 是 <strong>「面向字节流」</strong> 的协议，这句话的意思是：<strong>TCP 只看连续的字节，不关心消息边界。</strong> 也就是说，TCP 眼中没有“包”或“消息”的概念，它只负责：把发送方写入的那一串字节完整、有序地交给接收方，确保不丢、不乱、不错。<strong>所以无论写几次、读几次，对 TCP 来说都没区别——它只是管「流动的字节」。</strong></p><h3 id="2-从发送到接收的完整过程"><a href="#2-从发送到接收的完整过程" class="headerlink" title="2. 从发送到接收的完整过程"></a>2. 从发送到接收的完整过程</h3><blockquote><p><strong>应用层调用 <code>write()</code> → 用户态数据拷贝到内核态的 TCP 发送缓冲区 → TCP 协议栈按当前网络状况和拥塞窗口决定什么时候、按多大尺寸分段发送 → 网络传输 → 对端的 TCP 收到后，先把数据放入内核态的 TCP 接收缓冲区 → 对端应用层调用 <code>read()</code> 从内核缓冲区中按需读取任意长度的字节数据 → 由应用层自己根据协议格式解析出完整消息边界。这就是 TCP 面向字节流的本质：提供可靠、有序的字节传输通道，但把“语义”交给上层。</strong></p></blockquote><p>我们用一个简化图来还原整个流程：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251006221632301.png" alt="PixPin_2025-10-06_22-16-21"></p><p>现在来讲讲每一步背后的逻辑：</p><h4 id="1-应用层调用-write"><a href="#1-应用层调用-write" class="headerlink" title="1. 应用层调用 write()"></a>1. 应用层调用 <code>write()</code></h4><p>应用层产生数据转成字节拷贝进 <strong>内核的发送缓冲区</strong>。这时 <code>write()</code> 就可以返回了，<strong>并不意味着数据发出去了</strong>，只是进入了内核队列。</p><h4 id="2-TCP-自动分片与聚合"><a href="#2-TCP-自动分片与聚合" class="headerlink" title="2. TCP 自动分片与聚合"></a>2. TCP 自动分片与聚合</h4><p>发送缓冲区中的数据由 TCP 协议控制发送：</p><ul><li>如果太大，会拆成多个 TCP 段；</li><li>如果太小，TCP 可能暂时不发（比如启用了 Nagle 算法），等待更多数据合并成一个包再发。</li></ul><p>这一步是 <strong>TCP 的“面向字节流”特性在发送端的体现</strong>：它不管我们一次 write 写多少字节，只管按自己的节奏连续发字节。</p><h4 id="3-网络传输与确认"><a href="#3-网络传输与确认" class="headerlink" title="3. 网络传输与确认"></a>3. 网络传输与确认</h4><p>TCP 在传输过程中做三件事：</p><ol><li>维护序号（保证有序）。</li><li>超时重传（保证可靠）。</li><li>滑动窗口（控制流量）。</li></ol><p>丢了会重发，乱序会重排。</p><h4 id="4-接收方重组数据流"><a href="#4-接收方重组数据流" class="headerlink" title="4. 接收方重组数据流"></a>4. 接收方重组数据流</h4><p>数据到达接收方内核后，TCP 会根据序号：把乱序的包重新排序，确认收到的字节，把连续的字节流写入 <strong>接收缓冲区</strong>。</p><h4 id="5-应用层调用-read"><a href="#5-应用层调用-read" class="headerlink" title="5. 应用层调用 read()"></a>5. 应用层调用 <code>read()</code></h4><p>应用层从接收缓冲区中 <strong>按自己想要的长度</strong> 去读数据。读多少、读几次都行。TCP 不关心我们每次 read 的“分界”，它只负责保证我们收到的字节顺序正确。</p><h4 id="6-举个例子"><a href="#6-举个例子" class="headerlink" title="6. 举个例子"></a>6. 举个例子</h4><p>用 <code>write(fd, &quot;Hello&quot;, 5)</code> 写 5 次，每次 1 字节：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write</span>(fd, <span class="string">&quot;H&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">write</span>(fd, <span class="string">&quot;e&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">write</span>(fd, <span class="string">&quot;l&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">write</span>(fd, <span class="string">&quot;l&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">write</span>(fd, <span class="string">&quot;o&quot;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>和一次写 5 字节：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write</span>(fd, <span class="string">&quot;Hello&quot;</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure><p><strong>这对 TCP 来说完全一样</strong>！它只看到 5 个连续字节：<code>H e l l o</code>。</p><p>同样，接收方可以：</p><ul><li>一次 <code>read(buf, 5)</code> 读完；</li><li>或 5 次 <code>read(buf, 1)</code> 逐字节读；</li><li>甚至一次 <code>read(buf, 100)</code> 把这 5 字节和其他后续数据一起读进来。</li></ul><blockquote><p><strong>TCP 不保证“写多少次，就读多少次”；也不保证“每次写的边界 &#x3D; 每次读的边界”。 像水管输水，不管你倒一桶还是倒十桶，水流不断过去。水分段传输，但水的“总量”是靠序号控制的，不需要每次标记“这一桶多大”。</strong></p></blockquote><h2 id="9-粘包问题"><a href="#9-粘包问题" class="headerlink" title="9. 粘包问题"></a>9. 粘包问题</h2><h3 id="1-什么是粘包问题？"><a href="#1-什么是粘包问题？" class="headerlink" title="1. 什么是粘包问题？"></a>1. 什么是粘包问题？</h3><blockquote><p>这就好像小时候家里蒸包子，出现从蒸笼里拿一个包子，结果连带一个或者多个包子一并被拿起一样。</p></blockquote><p>TCP 粘包是因为 TCP 是面向字节流的协议，不保留消息边界，导致多个应用层消息被合并成一个 TCP 段传输。其根本就是 <strong>TCP 是面向字节流的协议</strong>，它只保证字节的顺序和可靠（不丢不重）传输，不关心一条消息从哪里开始、到哪里结束。举个例子：假设客户端连续发了两条消息：”hello”、”world”，底层 TCP 实际发送过程可能是：</p><ol><li>一起发出去 → 收方一次 read() 得到 “helloworld”</li><li>拆成两次发 → 收方第一次 read() 得到 “hell”，第二次得到 “oworld”</li></ol><p>无论哪种情况，对 TCP 来说都没错，它完成了“字节传输”。但对应用层来说，就糊涂了：到底哪 5 个字节是 “hello”，哪 5 个字节是 “world” 呢？这就是 <strong>粘包&#x2F;拆包问题</strong>。</p><blockquote><p>注意：严格来说，“粘包”是 <strong>应用层术语</strong>，TCP 本身没有“包”的概念（它是字节流），所以更准确的说法是 <strong>“消息边界丢失”</strong> 或 <strong>“应用层消息粘连”</strong>。</p></blockquote><h3 id="2-为什么会发生粘包？"><a href="#2-为什么会发生粘包？" class="headerlink" title="2. 为什么会发生粘包？"></a>2. 为什么会发生粘包？</h3><p>主要有两个原因：</p><ol><li><strong>TCP 是流式协议</strong> —— 没有消息边界。</li><li><strong>发送端的优化机制</strong>：TCP 可能把多次 <code>write()</code> 的小数据包合并成一个更大的包再发送（比如受 <strong>Nagle 算法</strong> 影响）。</li></ol><blockquote><p>比喻：连发两封信，TCP 相当于觉得信太小，顺手把它们塞进一个信封寄了出去。收信人收到一封信里两张纸，就要自己判断哪一张属于哪一封。</p></blockquote><h3 id="3-UDP-会不会有粘包问题？"><a href="#3-UDP-会不会有粘包问题？" class="headerlink" title="3. UDP 会不会有粘包问题？"></a>3. UDP 会不会有粘包问题？</h3><p><strong>不会。</strong> 因为：UDP 是 <strong>面向报文</strong> 的，每次 <code>sendto()</code> 发出的数据就是一个独立的报文，接收方 <code>recvfrom()</code> 一次只能收到一个完整的报文，如果太大，UDP 直接丢（不会拆分合并）。所以 UDP 可能会 <strong>丢包</strong>，但 <strong>不会粘包</strong>。</p><h3 id="4-解决粘包的四种典型方案（应用层协议）"><a href="#4-解决粘包的四种典型方案（应用层协议）" class="headerlink" title="4. 解决粘包的四种典型方案（应用层协议）"></a>4. 解决粘包的四种典型方案（应用层协议）</h3><table><thead><tr><th>方案类型</th><th>描述</th><th>优点</th><th>缺点</th><th>常见场景</th></tr></thead><tbody><tr><td><strong>1. 定长报文</strong></td><td>每个消息的长度是固定的，比如每条 128 字节。</td><td>实现最简单，无需解析。</td><td>浪费带宽，不适合变长内容。</td><td>心跳包、状态同步。</td></tr><tr><td><strong>2. 特殊字符分隔</strong></td><td>每条消息结尾加一个独特分隔符，比如 <code>\n</code>、<code>\r\n</code>、<code>#</code> 等。</td><td>简单直观，易调试。</td><td>若数据本身可能包含该字符，就要转义或转码。</td><td>文本协议：HTTP（<code>\r\n\r\n</code>）、Redis（<code>\r\n</code>）、FTP。</td></tr><tr><td><strong>3. 定长报头 + 描述字段（自描述长度）</strong></td><td>报头中包含“消息体长度”，先读报头，再按长度读消息体。</td><td>高通用性，可支持任意变长数据。</td><td>需要两阶段解析（读头再读体）。</td><td>二进制协议、RPC 通信、游戏服务器。</td></tr><tr><td><strong>4. 自描述字段 + 特殊字符</strong></td><td>报头带长度字段，报尾再加结束符；双重保险。</td><td>边界更安全、健壮。</td><td>报文略复杂。</td><td>通信要求高可靠性时（如金融系统）。</td></tr></tbody></table><p>举个例子（第 3 种最常用），比如我们定义协议格式：<code>| 报头：4字节消息体长度 | 报体：消息数据 |</code>，假设发两条消息：”0005hello” 和 “0005world”，接收方解析逻辑：</p><ol><li>先读 4 字节（0005） → 得知消息长度为 5。</li><li>再读 5 字节 → “hello”。</li><li>重复上述步骤 → “world”。</li></ol><p>这样即使 TCP 把两条粘一起了，也能正确拆包。</p><h3 id="5-小结（可直接答面试）"><a href="#5-小结（可直接答面试）" class="headerlink" title="5. 小结（可直接答面试）"></a>5. 小结（可直接答面试）</h3><blockquote><p>粘包是因为 TCP 是字节流，没有边界概念，所以我们要在 <strong>用户层定义应用协议</strong> 划分消息。常见方案包括：</p><ol><li>固定长度；</li><li>特殊分隔符；</li><li>定长报头 + 长度字段（最通用）；</li><li>长度字段 + 分隔符（更健壮）。</li></ol><p>UDP 不会粘包，因为它是面向报文的。</p></blockquote><h2 id="10-TCP-异常情况"><a href="#10-TCP-异常情况" class="headerlink" title="10. TCP 异常情况"></a>10. TCP 异常情况</h2><h3 id="1-进程终止（正常退出或被-kill）"><a href="#1-进程终止（正常退出或被-kill）" class="headerlink" title="1. 进程终止（正常退出或被 kill）"></a>1. 进程终止（正常退出或被 kill）</h3><p><strong><span style="color:red">TCP 连接会正常断开（四次挥手）</span></strong>，原理：当进程调用 <code>exit()</code>、<code>_exit()</code> 或被 <code>kill -9</code> 终止时，<strong>内核会自动关闭该进程打开的所有文件描述符</strong>，包括 socket，关闭 socket 时，内核 TCP 协议栈会：</p><ol><li>发送 <strong>FIN</strong> 报文（表示“我不会再发数据了”）。</li><li>进入 <strong>FIN-WAIT-1</strong> 状态。</li><li>后续完成标准的 <strong>四次挥手</strong> 流程。</li></ol><blockquote><p>即使进程是被 <code>kill -9</code> 强制杀死，<strong>内核仍会清理其资源并发送 FIN</strong>（因为 socket 是内核对象，进程只是持有 fd）。</p></blockquote><p>对方表现：对端收到 FIN 后，<code>read()</code> 返回 0（表示对方关闭连接），应用可正常感知连接关闭，做清理工作。注意：</p><ul><li>如果进程退出前有未发送完的数据，内核会尝试发送（取决于 SO_LINGER 设置）。</li><li>默认情况下，内核会尽力完成挥手，<strong>连接是“优雅关闭”的</strong>。</li></ul><h3 id="2-机器重启（操作系统重启）"><a href="#2-机器重启（操作系统重启）" class="headerlink" title="2. 机器重启（操作系统重启）"></a>2. 机器重启（操作系统重启）</h3><p><strong><span style="color:red">所有 TCP 连接会被强制中断，但过程分两步</span></strong>，原理：</p><ol><li><p><strong>关机阶段</strong>：</p><ul><li>系统 shutdown 时，会向所有进程发送 SIGTERM，然后 SIGKILL。</li><li>内核会尝试关闭所有 socket，<strong>理想情况下会发送 FIN</strong>。</li><li>但如果关机太快，可能来不及发 FIN。</li></ul></li><li><p><strong>重启后</strong>：</p><ul><li>所有旧连接的 socket 已被销毁。</li><li>本机 TCP 状态机重置。</li><li><strong>对端仍认为连接存在</strong>（因为没收到 FIN 或 RST）。</li></ul></li></ol><p>关键问题：<strong>对端无法立即感知连接已断！</strong></p><ul><li>对端继续发数据 → 本机收到后，发现无对应连接 → 回 <strong>RST（复位）</strong>。</li><li>对端收到 RST → 知道连接已失效，<code>write()</code> 会触发 <strong>SIGPIPE</strong> 或返回 <strong>ECONNRESET</strong>。</li></ul><blockquote><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/670726420">TCP 保活机制详解（KeepAlive）| 知乎</a></p><p>但如果对端不发数据，它可能 <strong>长时间不知道连接已断</strong>（直到保活探测或应用超时）。</p></blockquote><p>解决方案建议：</p><ul><li>应用层实现 <strong>心跳机制</strong>（定期 ping&#x2F;pong）。</li><li>启用 <strong><a target="_blank" rel="noopener" href="https://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html">TCP Keep-Alive</a></strong>。</li></ul><blockquote><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pmt123456/article/details/58233999">TCP 长连接与短连接、心跳机制 | CSDN</a></p><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uF411V7WH/?share_source=copy_web&vd_source=872e5e3ccf44874c39edaf42e30ab0de">0407.TCP 长连接心跳机制的实现 | B 站</a></p></blockquote><h3 id="3-机器掉电-网线断开（非正常断连）"><a href="#3-机器掉电-网线断开（非正常断连）" class="headerlink" title="3. 机器掉电 &#x2F; 网线断开（非正常断连）"></a>3. 机器掉电 &#x2F; 网线断开（非正常断连）</h3><p><strong><span style="color:red">连接“静默失效”——双方都无法立即感知！</span></strong>，原理：本机突然断电或网线拔掉 → <strong>无法发送任何 TCP 报文（包括 FIN、RST）</strong>，对端：仍认为连接正常，若继续发数据 → 数据包到达对方（但对方已关机）→ <strong>无 ACK 返回</strong>，经过多次重传超时后 → <code>write()</code> 返回 <strong>ETIMEDOUT</strong>，若一直不发数据 → <strong>永远不知道连接已断！</strong></p><blockquote><p>这就是所谓的 <strong>“半开连接”</strong> —— 一方已断，另一方不知情。</p></blockquote><p><strong>默认超时时间有多长？</strong> Linux 默认 TCP 重传约 <strong>15 次</strong>，总超时可达 <strong>9~13 分钟</strong>！在此期间，连接“看似正常”，实则已失效。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看重传次数和间隔（单位：秒）</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/net/ipv4/tcp_retries2    <span class="comment"># 通常为 15</span></span><br></pre></td></tr></table></figure><h3 id="4-小结"><a href="#4-小结" class="headerlink" title="4. 小结"></a>4. 小结</h3><table><thead><tr><th>异常场景</th><th>本机能否发 FIN&#x2F;RST？</th><th>对端能否立即感知？</th><th>是否会自动断开</th><th>连接如何关闭</th><th>建议应对措施</th></tr></thead><tbody><tr><td><strong>进程终止</strong></td><td>✅ 能（发 FIN）</td><td>✅ 能（收到 FIN）</td><td>✅ 正常断开</td><td>正常四次挥手</td><td>无需特殊处理</td></tr><tr><td><strong>机器重启</strong></td><td>⚠️ 可能来不及发</td><td>❌ 不能（除非对端发数据）</td><td>❌ 不一定</td><td>对端收到 RST</td><td>启用 Keep-Alive 或心跳</td></tr><tr><td><strong>掉电&#x2F;断网</strong></td><td>❌ 完全不能</td><td>❌ 不能（静默失效）</td><td>❌ 不自动断开</td><td>超时或 Keep-Alive 探测失败</td><td><strong>必须用心跳或调短 Keep-Alive</strong></td></tr></tbody></table><blockquote><ol><li><strong>只有进程终止能保证优雅关闭；</strong></li><li><strong>系统级异常（重启、断电）会导致连接“假死”；</strong></li><li><strong>TCP 本身无法快速检测物理层断连；</strong></li><li><strong>生产环境必须依赖：</strong><ul><li><strong>应用层心跳（推荐）</strong></li><li><strong>或 调优 TCP Keep-Alive</strong></li></ul></li></ol><p><strong>记住：“TCP 可靠，但不万能；异常检测，靠心跳保命。”</strong></p></blockquote><h2 id="11-TCP-小结"><a href="#11-TCP-小结" class="headerlink" title="11. TCP 小结"></a>11. TCP 小结</h2><p>TCP 协议这么复杂就是因为 TCP 既要保证可靠性，同时又尽可能的提高性能。</p><p><strong>可靠性：</strong></p><ul><li><p><strong>检验和：</strong> 检测数据传输中的错误。</p></li><li><p><strong>序列号：</strong> 确保数据按序到达，解决重复和乱序问题。</p></li><li><p><strong>确认应答：</strong> 接收方确认收到数据，形成闭环（核心）。</p></li><li><p><strong>超时重传：</strong> 发送方未及时收到确认则重发数据。</p></li><li><p><strong>连接管理：</strong> 三次握手建立连接，四次挥手释放连接。</p></li><li><p><strong>流量控制：</strong> 通过滑动窗口机制控制发送速率，避免接收方过载（也属于提高性能）。</p></li><li><p><strong>拥塞控制：</strong> 检测网络拥塞并调整发送速率（也属于提高性能）。</p></li></ul><p><strong>提高性能：</strong></p><ul><li><p><strong>滑动窗口：</strong> 允许发送方连续发送多个数据包。</p></li><li><p><strong>快速重传：</strong> 基于重复确认快速检测丢包并重传。</p></li><li><p><strong>延迟应答：</strong> 合并多个确认，减少网络开销。</p></li><li><p><strong>捎带应答：</strong> 在数据报文段中携带确认信息。</p></li></ul><p>其他：TCP 定时器：</p><ul><li>重传定时器：为了控制丢失的报文段或丢弃的报文段，也就是对报文段确认的等待时间。</li><li>坚持定时器：专门为对方零窗口通知而设立的，也就是向对方发送窗口探测的时间间隔。</li><li>保活定时器：为了检查空闲连接的存在状态，也就是向对方发送探查报文的时间间隔。</li><li>TIME_WAIT 定时器：双方在四次挥手后，主动断开连接的一方需要等待的时长。</li></ul><h2 id="12-基于-TCP-的应用层协议"><a href="#12-基于-TCP-的应用层协议" class="headerlink" title="12. 基于 TCP 的应用层协议"></a>12. 基于 TCP 的应用层协议</h2><p>常见的基于 TCP 的应用层协议如下：</p><ul><li>HTTP（超文本传输协议）。</li><li>HTTPS（安全数据传输协议）。</li><li>SSH（安全外壳协议）。</li><li>Telnet（远程终端协议）。</li><li>FTP（文件传输协议）。</li><li>SMTP（电子邮件传输协议）。</li></ul><p>当然，也包括自己写 TCP 程序时自定义的应用层协议。</p><h2 id="13-UDP-实现可靠传输的思路-——-具体场景具体分析，往-TCP-靠"><a href="#13-UDP-实现可靠传输的思路-——-具体场景具体分析，往-TCP-靠" class="headerlink" title="13. UDP 实现可靠传输的思路 —— 具体场景具体分析，往 TCP 靠"></a>13. UDP 实现可靠传输的思路 —— 具体场景具体分析，往 TCP 靠</h2><p>虽然 UDP 本身是不可靠的，但可以在应用层实现类似 TCP 的可靠性机制：</p><ol><li><strong>引入序列号</strong>：为每个数据包分配唯一序号，确保数据有序。</li><li><strong>确认应答机制</strong>：接收方收到数据后发送确认信息。</li><li><strong>超时重传</strong>：设置合理的超时时间，未收到确认则重传。</li><li><strong>滑动窗口</strong>：控制发送窗口大小，实现流量控制。</li><li><strong>拥塞控制</strong>：根据网络状况动态调整发送速率。</li></ol><h2 id="14-补充：listen-第二个参数（backlog）的准确理解"><a href="#14-补充：listen-第二个参数（backlog）的准确理解" class="headerlink" title="14. 补充：listen 第二个参数（backlog）的准确理解"></a>14. 补充：<code>listen</code> 第二个参数（<code>backlog</code>）的准确理解</h2><h3 id="1-函数原型"><a href="#1-函数原型" class="headerlink" title="1. 函数原型"></a>1. 函数原型</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> backlog)</span>;</span><br></pre></td></tr></table></figure><p>官方定义：<code>backlog</code> 参数指定了 <strong>内核为该套接字维护的等待接受的连接队列的最大长度</strong>。</p><h3 id="2-实际含义"><a href="#2-实际含义" class="headerlink" title="2. 实际含义"></a>2. 实际含义</h3><p>在现代 Linux 系统中，这个参数控制的是 <strong>全连接队列（accept queue）</strong> 的大小，即：</p><ul><li>已经完成三次握手的连接。</li><li>等待应用层调用 <code>accept()</code> 函数取走的连接。</li></ul><h3 id="3-关键要点（重要）"><a href="#3-关键要点（重要）" class="headerlink" title="3. 关键要点（重要）"></a>3. 关键要点（重要）</h3><h4 id="1-队列机制"><a href="#1-队列机制" class="headerlink" title="1. 队列机制"></a>1. 队列机制</h4><p>TCP 连接建立过程中涉及两个队列：</p><ul><li><strong>半连接队列（SYN queue）</strong>：处理三次握手过程中的连接（SYN_RECV 状态）。</li><li><strong>全连接队列（accept queue）</strong>：已完成握手等待应用处理的连接（ESTABLISHED 状态）。</li></ul><p><code>backlog</code> 参数主要影响的是 <strong>全连接队列</strong> 的大小。</p><h4 id="2-实际队列长度"><a href="#2-实际队列长度" class="headerlink" title="2. 实际队列长度"></a>2. 实际队列长度</h4><p>在 Linux 内核中，实际的全连接队列长度通常是 <code>backlog + 1</code>。这是因为：队列维护时会包含当前正在被 <code>accept()</code> 处理的连接，所以设置 <code>backlog = 5</code> 时，实际可容纳 6 个等待连接。</p><h4 id="3-连接拒绝机制"><a href="#3-连接拒绝机制" class="headerlink" title="3. 连接拒绝机制"></a>3. 连接拒绝机制</h4><p>当全连接队列满时：新的连接请求会被内核拒绝，客户端可能会收到 <code>ECONNREFUSED</code> 错误，或者内核会静默丢弃连接请求（取决于具体配置）。</p><h3 id="4-历史演变"><a href="#4-历史演变" class="headerlink" title="4. 历史演变"></a>4. 历史演变</h3><ul><li><strong>早期实现</strong>：<code>backlog</code> 表示半连接队列和全连接队列的总和。</li><li><strong>现代实现</strong>：<code>backlog</code> 主要控制全连接队列，半连接队列由其他内核参数控制。</li></ul><h3 id="5-实际应用"><a href="#5-实际应用" class="headerlink" title="5. 实际应用"></a>5. 实际应用</h3><ul><li><strong>Web 服务器</strong>：通常设置为 128、256 或 512。</li><li><strong>高并发服务</strong>：可以适当增大，如 1024 或更高。</li><li><strong>考虑系统限制</strong>：受 <code>/proc/sys/net/core/somaxconn</code> 内核参数限制。</li><li><strong>监控队列状态</strong>：通过 <code>ss -tlnp</code> 等命令查看队列使用情况。</li></ul><p>简单来说，<code>backlog</code> 参数决定了服务器能够同时 “挂起” 多少个已经建立但尚未被应用程序处理的 TCP 连接。</p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/23032.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://www.minbit.top/posts/23032.html")'>052 传输层 —— TCP（下）</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/23032.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=052 传输层 —— TCP（下）&amp;url=https://www.minbit.top/posts/23032.html&amp;pic=https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=f3a39255-670f-3481-069b-60d99044a24e" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">59</span></a><a class="post-meta__box__tags" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>网络<span class="tagsPageCount">11</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=ebdc8f73-2df6-eb02-56e4-2e58830a0423" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/38169.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/12THR4h.png?_r_=87c807eb-3526-f15d-e7f4-ba755502a266" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">058 从 Centos 切换到 Ubuntu</div></div></a></div><div class="next-post pull-right"><a href="/posts/60727.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=06957f22-b4e7-a785-793e-fde854edfc9b" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">053 网络层 —— IP 协议</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/47537.html" title="045 网络基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/IAdmxAt.png?_r_=f8ae69f3-be23-058e-b3ed-f44bbc08347d" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-12</div><div class="title">045 网络基础</div></div></a></div><div><a href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=1f628b9b-ebc6-05dd-4e6f-f847d84f7767" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-22</div><div class="title">047 网络传输基础：TCP 连接建立与数据序列化</div></div></a></div><div><a href="/posts/34998.html" title="049 HTTPS 协议原理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=1f23abb0-1c76-3d16-4bbb-2d38417dcc91" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-28</div><div class="title">049 HTTPS 协议原理</div></div></a></div><div><a href="/posts/63840.html" title="048 HTTP 协议"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/12THR4h.png?_r_=c489c29a-d1cd-463d-c6a3-cfe289dbec3e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-25</div><div class="title">048 HTTP 协议</div></div></a></div><div><a href="/posts/40348.html" title="046 网络编程套接字"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=fe0b3dd7-ebf2-525d-1485-d1c8d5f2b78c" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-15</div><div class="title">046 网络编程套接字</div></div></a></div><div><a href="/posts/42057.html" title="051 传输层 —— TCP（上）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=0f19e815-8b67-c290-cc36-cf5e36871ff1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-20</div><div class="title">051 传输层 —— TCP（上）</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><span>👋🏻 Hi，我是 <a target="_blank" href="https://huangcancan-xbc.github.io" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">小米里的大麦</a>，欢迎来看我的博客鸭！</span><br><span>👉 建议优先查看置顶的 <a target="_blank" href="https://huangcancan-xbc.github.io/posts/17934.html" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">网站说明</a>，如有问题欢迎评论区交流！</span><br><span>😫 页面异常？尝试<kbd>Ctrl</kbd>+<kbd>F5</kbd></span><br><span>📩 联系我：<a href="mailto:hc1960074081@qq.com" rel="external nofollow noreferrer"><b>给我发送邮件🚀</b></a></span></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82-%E2%80%94%E2%80%94-TCP%EF%BC%88%E4%B8%8B%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">传输层 —— TCP（下）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-TCP-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.1.</span> <span class="toc-text">1. TCP 流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 什么是流量控制？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%EF%BC%9A%E6%8E%A5%E6%94%B6%E7%AA%97%E5%8F%A3"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. 实现方式：接收窗口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="toc-number">1.2.</span> <span class="toc-text">2. 滑动窗口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%EF%BC%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 什么是滑动窗口？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%9A%84%E7%BB%84%E6%88%90%EF%BC%88%E5%8F%91%E9%80%81%E6%96%B9%E8%A7%86%E8%A7%92%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 滑动窗口的组成（发送方视角）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%A1%AE%E8%AE%A4%E5%BA%8F%E5%8F%B7%EF%BC%88ACK%EF%BC%89%E7%9A%84%E5%90%AB%E4%B9%89%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 确认序号（ACK）的含义是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%A6%82%E4%BD%95%E2%80%9C%E5%90%91%E5%8F%B3%E7%A7%BB%E5%8A%A8%E2%80%9D%EF%BC%9F%E7%A7%BB%E5%8A%A8%E6%97%B6%E5%A4%A7%E5%B0%8F%E4%BC%9A%E5%8F%98%E5%90%97%EF%BC%9F"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 滑动窗口如何“向右移动”？移动时大小会变吗？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%90%91%E5%8F%B3%E7%A7%BB%E5%8A%A8%EF%BC%9A"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">1. 向右移动：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%AA%97%E5%8F%A3%E5%A4%A7%E5%B0%8F%E4%BC%9A%E5%8F%98%E5%8C%96%E5%90%97%EF%BC%9F"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">2. 窗口大小会变化吗？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E4%BC%9A%E2%80%9C%E8%B6%8A%E7%95%8C%E2%80%9D%E5%8F%91%E9%80%81%E7%BC%93%E5%86%B2%E5%8C%BA%E5%90%97%EF%BC%9F"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 滑动窗口会“越界”发送缓冲区吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%98%AF%E9%80%9A%E8%BF%87%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%90%97%EF%BC%9F"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 流量控制是通过滑动窗口实现的吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%A6%82%E6%9E%9C%E5%8F%91%E7%94%9F%E4%B8%A2%E5%8C%85%EF%BC%8C%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%EF%BC%9F"><span class="toc-number">1.2.7.</span> <span class="toc-text">7. 如果发生丢包，滑动窗口怎么处理？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">3. 拥塞控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%EF%BC%9F"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 什么是拥塞控制？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%EF%BC%9F"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 为什么要有拥塞控制？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E7%BD%91%E7%BB%9C%E6%98%AF%E5%90%A6%E6%8B%A5%E5%A1%9E%EF%BC%9F"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 如何判断网络是否拥塞？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 拥塞控制的核心机制与关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%85%A2%E5%90%AF%E5%8A%A8"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">1. 慢启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8B%A5%E5%A1%9E%E9%81%BF%E5%85%8D"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2. 拥塞避免</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BF%AB%E9%87%8D%E4%BC%A0"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">3. 快重传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%BF%AB%E6%81%A2%E5%A4%8D"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">4. 快恢复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%BD%91%E7%BB%9C%E6%8B%A5%E5%A1%9E%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. 如何解决网络拥塞问题？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-VS-%E6%8B%A5%E5%A1%9E%E7%AA%97%E5%8F%A3"><span class="toc-number">1.4.</span> <span class="toc-text">4. 流量控制 VS 拥塞窗口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%BB%B6%E8%BF%9F%E5%BA%94%E7%AD%94"><span class="toc-number">1.5.</span> <span class="toc-text">5. 延迟应答</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%B1%BB%E6%AF%94%E5%9C%BA%E6%99%AF"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 类比场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AF%B9%E5%BA%94-TCP-%E5%90%AB%E4%B9%89"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 对应 TCP 含义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%9C%E7%94%A8"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%8D%8E%E5%B8%A6%E5%BA%94%E7%AD%94"><span class="toc-number">1.6.</span> <span class="toc-text">6. 捎带应答</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%B1%BB%E6%AF%94%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. 类比场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AF%B9%E5%BA%94-TCP-%E5%90%AB%E4%B9%89-1"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 对应 TCP 含义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%9C%E7%94%A8-1"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%BB%B6%E8%BF%9F%E5%BA%94%E7%AD%94-VS-%E6%8D%8E%E5%B8%A6%E5%BA%94%E7%AD%94"><span class="toc-number">1.7.</span> <span class="toc-text">7. 延迟应答 VS 捎带应答</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%9D%A2%E5%90%91%E5%AD%97%E8%8A%82%E6%B5%81"><span class="toc-number">1.8.</span> <span class="toc-text">8. 面向字节流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9D%A2%E5%90%91%E5%AD%97%E8%8A%82%E6%B5%81%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.8.1.</span> <span class="toc-text">1. 面向字节流的本质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BB%8E%E5%8F%91%E9%80%81%E5%88%B0%E6%8E%A5%E6%94%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.2.</span> <span class="toc-text">2. 从发送到接收的完整过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BA%94%E7%94%A8%E5%B1%82%E8%B0%83%E7%94%A8-write"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">1. 应用层调用 write()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-TCP-%E8%87%AA%E5%8A%A8%E5%88%86%E7%89%87%E4%B8%8E%E8%81%9A%E5%90%88"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">2. TCP 自动分片与聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E4%B8%8E%E7%A1%AE%E8%AE%A4"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">3. 网络传输与确认</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%8E%A5%E6%94%B6%E6%96%B9%E9%87%8D%E7%BB%84%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="toc-number">1.8.2.4.</span> <span class="toc-text">4. 接收方重组数据流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%BA%94%E7%94%A8%E5%B1%82%E8%B0%83%E7%94%A8-read"><span class="toc-number">1.8.2.5.</span> <span class="toc-text">5. 应用层调用 read()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-number">1.8.2.6.</span> <span class="toc-text">6. 举个例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.</span> <span class="toc-text">9. 粘包问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.9.1.</span> <span class="toc-text">1. 什么是粘包问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%8F%91%E7%94%9F%E7%B2%98%E5%8C%85%EF%BC%9F"><span class="toc-number">1.9.2.</span> <span class="toc-text">2. 为什么会发生粘包？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-UDP-%E4%BC%9A%E4%B8%8D%E4%BC%9A%E6%9C%89%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.9.3.</span> <span class="toc-text">3. UDP 会不会有粘包问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%A7%A3%E5%86%B3%E7%B2%98%E5%8C%85%E7%9A%84%E5%9B%9B%E7%A7%8D%E5%85%B8%E5%9E%8B%E6%96%B9%E6%A1%88%EF%BC%88%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">1.9.4.</span> <span class="toc-text">4. 解决粘包的四种典型方案（应用层协议）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%B0%8F%E7%BB%93%EF%BC%88%E5%8F%AF%E7%9B%B4%E6%8E%A5%E7%AD%94%E9%9D%A2%E8%AF%95%EF%BC%89"><span class="toc-number">1.9.5.</span> <span class="toc-text">5. 小结（可直接答面试）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-TCP-%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5"><span class="toc-number">1.10.</span> <span class="toc-text">10. TCP 异常情况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%EF%BC%88%E6%AD%A3%E5%B8%B8%E9%80%80%E5%87%BA%E6%88%96%E8%A2%AB-kill%EF%BC%89"><span class="toc-number">1.10.1.</span> <span class="toc-text">1. 进程终止（正常退出或被 kill）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%BA%E5%99%A8%E9%87%8D%E5%90%AF%EF%BC%88%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%87%8D%E5%90%AF%EF%BC%89"><span class="toc-number">1.10.2.</span> <span class="toc-text">2. 机器重启（操作系统重启）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%BA%E5%99%A8%E6%8E%89%E7%94%B5-%E7%BD%91%E7%BA%BF%E6%96%AD%E5%BC%80%EF%BC%88%E9%9D%9E%E6%AD%A3%E5%B8%B8%E6%96%AD%E8%BF%9E%EF%BC%89"><span class="toc-number">1.10.3.</span> <span class="toc-text">3. 机器掉电 &#x2F; 网线断开（非正常断连）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B0%8F%E7%BB%93"><span class="toc-number">1.10.4.</span> <span class="toc-text">4. 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-TCP-%E5%B0%8F%E7%BB%93"><span class="toc-number">1.11.</span> <span class="toc-text">11. TCP 小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E5%9F%BA%E4%BA%8E-TCP-%E7%9A%84%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.12.</span> <span class="toc-text">12. 基于 TCP 的应用层协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-UDP-%E5%AE%9E%E7%8E%B0%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93%E7%9A%84%E6%80%9D%E8%B7%AF-%E2%80%94%E2%80%94-%E5%85%B7%E4%BD%93%E5%9C%BA%E6%99%AF%E5%85%B7%E4%BD%93%E5%88%86%E6%9E%90%EF%BC%8C%E5%BE%80-TCP-%E9%9D%A0"><span class="toc-number">1.13.</span> <span class="toc-text">13. UDP 实现可靠传输的思路 —— 具体场景具体分析，往 TCP 靠</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-%E8%A1%A5%E5%85%85%EF%BC%9Alisten-%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%88backlog%EF%BC%89%E7%9A%84%E5%87%86%E7%A1%AE%E7%90%86%E8%A7%A3"><span class="toc-number">1.14.</span> <span class="toc-text">14. 补充：listen 第二个参数（backlog）的准确理解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.14.1.</span> <span class="toc-text">1. 函数原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9E%E9%99%85%E5%90%AB%E4%B9%89"><span class="toc-number">1.14.2.</span> <span class="toc-text">2. 实际含义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%85%B3%E9%94%AE%E8%A6%81%E7%82%B9%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">1.14.3.</span> <span class="toc-text">3. 关键要点（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%98%9F%E5%88%97%E6%9C%BA%E5%88%B6"><span class="toc-number">1.14.3.1.</span> <span class="toc-text">1. 队列机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%9E%E9%99%85%E9%98%9F%E5%88%97%E9%95%BF%E5%BA%A6"><span class="toc-number">1.14.3.2.</span> <span class="toc-text">2. 实际队列长度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%BF%9E%E6%8E%A5%E6%8B%92%E7%BB%9D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.14.3.3.</span> <span class="toc-text">3. 连接拒绝机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8E%86%E5%8F%B2%E6%BC%94%E5%8F%98"><span class="toc-number">1.14.4.</span> <span class="toc-text">4. 历史演变</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8"><span class="toc-number">1.14.5.</span> <span class="toc-text">5. 实际应用</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/22243.html" title="2025 年度总结"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=ebdc8f73-2df6-eb02-56e4-2e58830a0423" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2025 年度总结"></a><div class="content"><a class="title" href="/posts/22243.html" title="2025 年度总结">2025 年度总结</a><time datetime="2025-12-31T16:00:00.000Z" title="发表于 2026-01-01 00:00:00">2026-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/39993.html" title="08 表的增删改查下"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=784b23fb-15a7-eb8f-33eb-0d96dfe181cb" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="08 表的增删改查下"></a><div class="content"><a class="title" href="/posts/39993.html" title="08 表的增删改查下">08 表的增删改查下</a><time datetime="2025-12-12T16:00:00.000Z" title="发表于 2025-12-13 00:00:00">2025-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38170.html" title="Ubuntu 22.04 中安装 thefuck 与 tldr 工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/IAdmxAt.png?_r_=2efc2a28-f1f4-769a-5e7b-21833cf2c899" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Ubuntu 22.04 中安装 thefuck 与 tldr 工具"></a><div class="content"><a class="title" href="/posts/38170.html" title="Ubuntu 22.04 中安装 thefuck 与 tldr 工具">Ubuntu 22.04 中安装 thefuck 与 tldr 工具</a><time datetime="2025-11-22T04:00:00.000Z" title="发表于 2025-11-22 12:00:00">2025-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/31539.html" title="CodeX CLI 的使用备忘"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=19ad5a3e-ac75-3d2f-1d77-6c1b4b007131" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="CodeX CLI 的使用备忘"></a><div class="content"><a class="title" href="/posts/31539.html" title="CodeX CLI 的使用备忘">CodeX CLI 的使用备忘</a><time datetime="2025-11-19T04:00:00.000Z" title="发表于 2025-11-19 12:00:00">2025-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=36336436-a4b8-d24d-99f7-94bfb59134b6" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="免费白嫖 ChatGPT Go 套餐"></a><div class="content"><a class="title" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐">免费白嫖 ChatGPT Go 套餐</a><time datetime="2025-11-04T16:00:00.000Z" title="发表于 2025-11-05 00:00:00">2025-11-05</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile picture.png" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 - 2026 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType(){fetch("https://v1.hitokoto.cn").then(t=>t.json()).then(t=>{{const e="出自 "+t.from,n=["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","《答案在风中飘扬》（Blowing in The Wind）","梦想是不会发光的，发光的是追梦的你！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。"];n.unshift(t.hitokoto,e),window.typed=new Typed("#footer-type-tips",{strings:n,startDelay:300,typeSpeed:150,loop:!0,backSpeed:50})}})}"function"==typeof Typed?subtitleType():getScript("https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js").then(subtitleType)</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">93</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">算法</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://ac.nowcoder.com/acm/contest/profile/517073385" title="牛客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/think.svg" alt="牛客"><span class="back-menu-item-text">牛客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/1367427" title="洛谷"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/funny.svg" alt="洛谷"><span class="back-menu-item-text">洛谷</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:.88rem">AI<sup>2</sup></a><a href="/tags/C/" style="font-size:.88rem">C++<sup>11</sup></a><a href="/tags/Git/" style="font-size:.88rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:.88rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:.88rem">Linux<sup>59</sup></a><a href="/tags/MySQL/" style="font-size:.88rem">MySQL<sup>9</sup></a><a href="/tags/Redis/" style="font-size:.88rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:.88rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:.88rem">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:.88rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:.88rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:.88rem">历程<sup>2</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:.88rem">地址空间<sup>6</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size:.88rem">工具<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:.88rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:.88rem">模板<sup>1</sup></a><a href="/tags/%E7%81%B5%E5%85%89%E8%8D%9F%E8%90%83/" style="font-size:.88rem">灵光荟萃<sup>3</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:.88rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:.88rem">线程<sup>5</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:.88rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:.88rem">进程<sup>15</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("01/01/2025 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["这里是 小米里的大麦","芝兰生于深谷，不以无人而不芳。","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2025 By 安知鱼 V1.7.1"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.minbit.top/",path:window.location.pathname,region:"ap-shanghai",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then(o=>{t.textContent=o[0].count}).catch(t=>{console.error(t)})})()};anzhiyu.loadComment(document.getElementById("twikoo-wrap"),t)})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",pageSize:6,includeReply:!0}).then((function(t){const n=t.map(e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t});saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)})</script><script async data-pjax src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="xiaomilidedamai@minbit.top"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="https://events.vercount.one/js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>window.addEventListener("load",()=>{const t=()=>{if(!window.location.pathname.startsWith("/comments/"))return;const t=async()=>{const t=new EasyDanmaku({page:"/comments/",el:"#danmu-wrap",line:5,speed:20,hover:!0,loop:!1,colourful:!0,coefficient:1.38,runtime:10});try{let a=saveToLocal.get("twikoo-danmu");if(a)t.batchSend(a,!0);else{const n={method:"POST",body:JSON.stringify({event:"GET_RECENT_COMMENTS",includeReply:!1,pageSize:100}),headers:{"Content-Type":"application/json"}};a=[];const o=await fetch("https://twikoo.minbit.top/",n);if(o.ok){const{data:n}=await o.json();n.forEach(t=>{null==t.avatar&&(t.avatar="https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp"),a.push({avatar:t.avatar,content:t.nick+"："+e(t.comment),url:t.url+"#"+t.id})}),t.batchSend(a,!0),saveToLocal.set("twikoo-danmu",a,.5)}function e(t){return t=(t=(t=(t=(t=t.replace(/<\/*br>|[\s\uFEFF\xA0]+/g,"")).replace(/<img.*?>/g,"[图片]")).replace(/<a.*?>.*?<\/a>/g,"[链接]")).replace(/<pre.*?>.*?<\/pre>/g,"[代码块]")).replace(/<.*?>/g,"")}}}catch(t){console.error("Error fetching data:",t)}document.getElementById("danmu-Btn")&&(document.getElementById("danmu-Btn").innerHTML="<button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.remove('hide-danmu')\">显示弹幕</button> <button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.add('hide-danmu')\">隐藏弹幕</button>")};(async()=>{if("function"==typeof EasyDanmaku)await t();else{await getScript("https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js");"function"==typeof EasyDanmaku?await t():console.error("EasyDanmaku function not found even after loading the script.")}})()};t(),document.addEventListener("pjax:complete",t)})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>