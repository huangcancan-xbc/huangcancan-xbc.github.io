<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>034 进程间通信 —— System V 共享内存 | 小米里的大麦</title><meta name="keywords" content="Linux,进程,地址空间"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="034 进程间通信 —— System V 共享内存"><meta name="application-name" content="034 进程间通信 —— System V 共享内存"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="034 进程间通信 —— System V 共享内存"><meta property="og:url" content="https://www.minbit.top/posts/9524.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="进程间通信 —— System V 共享内存 传统的 System V IPC 主要包括三种：共享内存、消息队列、信号量，我们后面主要涉及其 System v 共享内存，消息队列和信号量仅作为了解。 现代开发和教学中，共享内存 作为重点和常用技术，而 消息队列 和 信号量 相对被弱化，主要有以下原因"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=310655a6-6c39-cf83-30a5-291a83bcaa41"><meta property="article:author" content="小米里的大麦"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=310655a6-6c39-cf83-30a5-291a83bcaa41"><meta name="description" content="进程间通信 —— System V 共享内存 传统的 System V IPC 主要包括三种：共享内存、消息队列、信号量，我们后面主要涉及其 System v 共享内存，消息队列和信号量仅作为了解。 现代开发和教学中，共享内存 作为重点和常用技术，而 消息队列 和 信号量 相对被弱化，主要有以下原因"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://www.minbit.top/posts/9524.html"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Cd-RTVhRO2mndEhicN2cvLXbsNxPqFC6fSn6ql80eVg"/><meta name="baidu-site-verification" content="codeva-ZG3S9QTvGO"/><meta name="msvalidate.01" content="6DF744D82FE6D1FD11CE18658760B59D"/><meta name="baidu-site-verification" content="codeva-gIjOMzUuhV"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"/><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"友链 + 外链 + 无限进步！欢迎欣赏和贡献！","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"小米里的大麦","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":4,"basicWordCount":1999,"key":"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv","Referer":"https://www.minbit.top/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"Jp8wwGQpp21utaFQ","LingQueMonitorID":"Jp8ztDRrxmTf7LDj"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-olive-one.vercel.app/',
  commentBarrageConfig:{"enable":true,"maxBarrage":10,"barrageTime":5000,"accessToken":"25c96851dd8a790c4819ad4bfbaf153c","mailMd5":"7b12ebc2be80f9159099f6ab0e16573c"},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 小米里的大麦","link":"链接: ","source":"来源: 小米里的大麦","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '小米里的大麦',
  title: '034 进程间通信 —— System V 共享内存',
  postAI: '这篇文章讲述了System V共享内存作为一种高效的进程间通信方式，其核心原理和系统调用。System V共享内存通过`shmget`创建或获取共享内存段，使用`ftok`生成唯一标识的key值，`shmat`将共享内存段映射到进程的虚拟地址空间实现零拷贝通信，而`shmdt`用于脱挂释放虚拟空间的映射。`shmctl`则用于控制共享内存段，如获取状态信息、设置状态或删除共享内存段。共享内存的生命周期由引用计数和手动删除决定，只有当引用计数归零且使用`IPC_RMID`标记删除时，物理页才会被真正回收。文章还介绍了System V共享内存通信的完整步骤和服务端-客户端模型，强调了其在多进程协作中的高效性和灵活性。',
  pageFillDescription: '进程间通信 —— System V 共享内存, 1. System V 共享内存的直接原理, 深入理解 挂接, 2. 系统调用, 1. ftok —— 生成 IPC key（为后面的 shmget 铺垫）, 1. 作用, 2. ftok 函数原型, 3. 怎么生成？, 4. 返回值, 5. 示例, 2. shmget —— 创建x2F获取共享内存, 1. 作用, 2. shmget 函数原型, 3. 参数详解, 4. 常用的 shmflg, 5. 返回值, 6. 示例, 3. 二者关系总结, 4. shmctl —— 删除（控制x2F管理）共享内存, 1. shmctl 函数原型, 2. 参数详解, 3. 返回值, shmid_ds 结构体：, 1. 查看系统现有的共享内存, 2. 删除指定系统的共享内存, 5. shmat —— 挂接内存, 1. 函数原型, 2. 作用, 3. 参数详解, 4. 返回值, 6. shmdt —— 脱挂释放虚拟空间的映射, 1. 作用, 2. 函数原型, 3. 参数详解, 4. 返回值, 3. System V 共享内存的生命周期随内核, 4. 示例 Demo, 1. System V 共享内存通信完整步骤, 2. System V 共享内存的服务端-客户端模型 Demo, fgets 函数, 1. 作用 x2F 功能, 2. 函数原型, 3.参数详解, 4. 返回值, 5. 代码示例, 1. Log.hpp 文件（之前写的日志插件）, 2. comm.hpp 文件, 3. processA.cc 文件, 4. processB.cc 文件, 5. 运行示例进程间通信共享内存传统的主要包括三种共享内存消息队列信号量我们后面主要涉及其共享内存消息队列和信号量仅作为了解现代开发和教学中共享内存作为重点和常用技术而消息队列和信号量相对被弱化主要有以下原因了解信息来自网络共享内存的独特优势不可替代性极致性能说白了就是快它是所有方式中速度最快的一旦建立映射数据交换直接在内存中进行没有内核到用户空间的数据拷贝开销灵活性共享内存本身只是提供了一块共享区域进程可以在上面构建任何复杂的数据结构和通信协议消息队列则限制了消息的结构和大小消息队列的局限性逐渐被替代性能瓶颈每次发送和接收消息都涉及系统调用和数据在内核与用户空间之间的拷贝对于大量或高频小消息的开销非常明显灵活性限制消息有最大长度限制且通常是的虽然支持优先级但模型相对固定注老方案麻烦扩展性差写多进程服务时不如直接用大厂一般直接上用户态网络或者自己封装信号量的现状同步需求永存只要存在并发访问共享资源尤其是共享内存就需要同步机制信号量的核心功能互斥同步仍然是必需的注单独用很少一般是搭配共享内存或者消息队列用于加锁现代里更常用所以学信号量只需要理解一下需要同步但实战更偏向或用户态自旋锁共享内存的直接原理共享内存就是一块物理内存区域由内核在物理内存中分配多个进程通过等系统调用映射到各自的虚拟地址空间从而实现零拷贝的高效通信即共享内存一块物理内存多个进程虚拟映射自己实现同步控制本质是内核帮我们做了虚拟地址和物理页的映射表维护保证多进程读写指向同一物理地址共享区映射到同一物理内存的过程首先一个进程或内核初始化时通过系统调用创建或获取一个共享内存段这个段存在于物理内存中由一个唯一的标识符标识接下来任何想要使用这个共享内存段的进程包括创建者都需要在自己的地址空间中附加更多情况我们更喜欢称挂接它这是通过系统调用完成的在调用进程的虚拟地址空间中动态分配一块映射区通常位于动态映射区域常见于堆和栈之间并在页表中建立映射使这块虚拟地址指向共享内存段实际占用的物理页帧而不再指向进程私有页注意通常位置处于进程地址空间的共享区但并非强制多个进程执行后它们各自的虚拟地址空间中被返回的那个地址或指定的地址所对应的页表项都指向了同一块物理内存区域结果当一个进程通过它附加的虚拟地址写入数据时数据直接写入了这块共享物理内存另一个进程通过它自己附加的不同的虚拟地址读取时直接从这块共享物理内存读取数据不同的虚拟地址通过各自的页表映射到相同的物理地址这就是让不同进程看到同一份资源的本质下面找了几个较为形象的图注意上述的映射页表操作都是由操作系统内核来做而不是用户态进程做为什么用户态没权限直接操作页表这是和硬件特权模式约束只有内核有权限分配物理页修改页表维护引用计数如果用户态可以随意改那整个系统就失去内存隔离了安全性就没有了所以用户态只能发起系统调用具体找页改表挂映射由内核执行那么当系统中存在多个共享内存要不要进行管理呢回答要的这就又是我们老生常谈的先描述再组织内核结构体描述共享内存深入理解挂接挂接页表映射在自己的地址空间里开一扇门让我们能访问内核里那块共享仓库挂接是传统的说法和文件系统的挂载类似本质都是把已有的物理资源通过操作系统管理暴露给一个命名空间可访问空间文件系统挂载把设备分区挂到某个目录共享内存挂接把物理页挂到某个虚拟地址段比喻共享内存就是一块公共仓库物理页帧这块仓库在内核里用管理内核负责保管单纯就是创建了这块仓库但谁也没把仓库门对接到自己家里就像是在你的家进程的虚拟地址空间里开个门和这块仓库打通让你能直接看到和访问这块公共物理页所以挂接虚拟地址空间里挂一块区域指向同一块物理页帧进程间通信的前提是让不同的进程先看到同一份资源不挂能不能用不能共享内存只是一块物理页帧没挂接到进程页表前进程看不到只有挂接后访问你的虚拟地址才会翻译到这块物理内存挂接后要不要解绑要用完后要把这块映射从页表里去掉虚拟内存就能被释放但物理页帧还在因为其他进程可能还挂着当最后一个挂接者后如果之前用标记删除了就会真正释放物理页系统调用生成为后面的铺垫作用的作用是生成一个的键值本质是一个将路径作为的字符串和这个整数结合的一个算法和这个用来在共享内存参数里作为唯一标识它不是随机生成的而是用和生成的一个整数在前面的有名管道中我们使用路径作为唯一标识路径本身就具有唯一性这里使用一个值作为唯一性也是异曲同工之妙注只是为了生成和数据本身没关系函数原型有效路径和任意整数怎么生成内部算法大概是把的低字节设备号等信息混进去经过算法组合从而形成唯一的哈希值所以只要文件不变同一个得到的是一样的这样保证不同进程用相同文件和就能找到同一块资源返回值成功返回是个整数失败返回设置路径不可访问文件不存在路径中的目录不存在示例文件必须存在创建获取共享内存作用创建一个新的共享内存段或者获取已存在的共享内存段关键靠做唯一标识函数原型参数详解参数含义键值由生成用于唯一标识可以自定义但是不保证一定有效可能存在冲突共享内存段大小单位字节如果是获取已存在的则忽略注意页对齐行为通常分配的整数倍的整数倍权限标志控制标志典型注意共享内存段在物理页帧分配时总是按页对齐通常是但的是逻辑大小里显示也是逻辑大小实际物理内存占用是向上对齐的页大小倍数使用时应按逻辑大小访问超出即是越界访问可能存在未定义行为段错误例如表示我承诺只用前字节合法回应我实际给你字节但超出的部分你别碰非越界访问指有效值用户分配值的大小永远记住能做不代表应该做在系统编程中自律比能力更重要不立即爆炸但终将毁灭常用的权限位表示其他进程是否可读写和的权限一样如果不存在则创建存在就获取返回和一起用时要求仅当不存在时才创建否则出错不单独使用举例只想创建如果存在则失败想获取或必要时创建返回值成功返回共享内存标识符唯一失败返回设置示例生成唯一创建或获取共享内存二者关系总结函数作用关键点生成依赖文件和不保证全局唯一但同参数一致性好创建获取共享内存需要大小和标志内核内部管理分配和引用计数小坑提醒不是必须的我们完全可以自己写只要和另一端一致就行很多老项目直接用固定数值不同机器生成同一文件的可能不一样因为和设备号可能不同所以跨机集群时要注意只分配描述符不分配虚拟地址只有才会把它挂到进程地址空间是为了在多人协作或多程序协作时保证只要文件和一致生成的就一致从而多个进程可以用相同访问同一个对象删除控制管理共享内存函数原型控制共享内存参数详解共享内存段标识符由返回删除从系统中标记删除该段获取状态用于接收共享内存的状态信息输出设置状态用于向内核提交新状态输入锁定共享内存段防止换出到交换空间解除锁定如果是或就需要传状态结构体指针时可传返回值成功返回失败返回同时设置常见错误无效的没有权限段已被删除结构体这是操作的核心数据结构用来描述共享内存段的元数据具体含义权限信息段大小字节上次时间上次时间创建或上次修改时间创建该段的进程最后一次操作该段的进程当前的进程数量引用计数传递给的键值共享内存拥有者的有效用户共享内存拥有者的有效组创建该共享内存的进程的有效用户创建该共享内存的进程的有效组权限标志位包含和等标志序列号用于生成唯一标识如何查看哪个进程还挂着共享内存查看引用计数只要物理页就不释放场景示例查看大小创建者引用数标记删除标记删除立刻删除等引用数归后才真正释放查看系统现有的共享内存查看系统现有的共享内存删除指定系统的共享内存删除指定共享内存段挂接内存函数原型作用进程各自的虚拟地址空间是隔离的但把同一个物理内存页挂接到多个进程的页表里所以多个进程访问同一块物理页实现了多进程看到同一份资源到此多进程间才具备的通信的能力底层做的是页表映射和引用计数返回值是可直接访问的指针真正实现多进程间的零拷贝数据共享拷贝少速度快参数详解参数作用解释共享内存段标识符来自的返回值希望映射到进程虚拟空间的首选地址通常写让内核自己找个合适的可用地址标志位主要用于指定映射权限或对齐如果是表示由内核自动分配虚拟地址这是最常用也最安全的写法如果指定了具体地址必须是页对齐地址可以带表示按对齐的典型值最常用表示默认读写以只读方式挂接这个进程只能读别的进程可以写如果指定了且希望地址自动按页对齐就要加这个返回值成功返回共享内存段在当前进程虚拟地址空间中的起始地址失败返回并设置不存在或非法权限不足比如只读段却尝试写挂接找不到可用虚拟地址尤其是自己指定时更容易出现脱挂释放虚拟空间的映射作用从当前进程的页表中卸载共享内存段的映射区域并把内核引用计数不会释放物理页帧物理段释放要靠和引用计数归零一起决定负责关门走人负责拆掉仓库对比主要功能脱挂取消挂接控制管理共享内存段作用对象当前进程的虚拟地址空间内核中整个共享内存段是否影响物理内存不会直接删除物理页帧可以通过标记删除物理页帧引用计数影响调用后后等引用数归零才真正释放调用场景挂接用完后必须调用释放虚拟空间要永久回收内存段时必须调用是否必须一般必须防止虚拟内存泄漏必须否则段会一直挂在内核表错误示例不脱挂会浪费虚拟地址空间不标记删除会造成内核残留需手动函数原型参数详解由返回的指针表示要脱挂的共享内存区域的起始虚拟地址注意这个地址必须是之前成功挂接时返回的那个指针不允许随便传地址返回值成功返回失败返回常见错误找不到对应挂接非法有些实现里如果内部释放失败比较罕见共享内存的生命周期随内核结论共享内存段不手动删就不回收引用计数归零才是唯一的释放条件真正释放物理页如果没引用计数再归零也不删物理页照样挂着共享内存的生命周期和两个东西密切相关共享内存段本身描述的物理页挂接的引用计数他们俩共同决定什么时候物理页还存在什么时候物理页真正被回收注意共享内存不会自动回收必须手动使用内核会一直保留这块物理页帧只要系统重启前这段共享内存都在里挂着所以的最终清理手段重启是内核维护的全局资源而是一个远程终端工具本质就是个客户端它不会托管共享内存段只是帮助登录远程主机关掉只是断了跟远程机器上的进程内核资源没有必然关系所以关掉对共享内存没有任何直接影响示例共享内存通信完整步骤可选但推荐生成一个作为对象的唯一标识本质上就是用路径名生成一个整数内核分配一块物理内存页帧挂到内核的共享内存表得到一个共享内存段标识符挂接把这块共享内存段映射到调用进程的虚拟地址空间更新页表返回一个指针后续直接对这块物理页读写各个进程的读写操作省略用完后进程要执行脱挂把这块内存区域从自己的页表取消映射用命令显式标记这块共享内存段为待删除当挂接计数归零时内核真正回收物理页共享内存的服务端客户端模型函数作用功能标准库提供的一个输入函数用于从指定的文件流中读取一行字符串可安全限制最大读取长度避免缓冲区溢出常用于读取带空格的一整行输入包括换行符常用于从获取用户输入从文件中按行读取文本函数原型推荐使用或者在纯里用参数详解参数名类型说明输入输出参数指向用于存放读取字符串的缓冲区的指针读取到的字符串包括换行符会存到这里必须有足够空间输入参数要读取的最大字符数包含结尾的所以实际最多读取个字符输入参数文件流指针比如标准输入或用打开的文件指针返回值返回值类型成功时返回传入的缓冲区指针失败时如果发生错误或遇到文件结尾且未读取到任何字符则返回常用的判断写法成功读取失败或代码示例引入需要的头文件用于异常退出定义缓冲区大小创建缓冲区请输入一行文字最多个字符调用从读取您输入的是会保留换行符读取失败读取出错或文件之前写的日志插件管道错误码这是创建管道文件失败的错误码这是删除管道文件失败的错误码这是打开管道文件失败的错误码枚举会自动赋值为日志等级最严重级别严重错误警告调试信息普通信息是否启用日志是否分类日志存放路径是否输出到终端日志等级转换成字符串获取当前计算机的时间返回格式含微秒包含秒和微秒系统调用获取当前时间精确到微秒分解时间转格式年月日时分秒把秒转换成年月日时分秒本地时区定义字符数组作为格式化输出的缓冲区年从开始计数月从开始表示月日时分秒微秒部分取自转换成返回使用默认构造重载函数调用运算符日志未启用传入的分类参数错误分类未启用文件路径的后缀处理函数当按照日志等级分类存储并且文件路径是这种有文件扩展名时的处理方法如果是一个目录的路径比如则最终文件名为等级名如果是一个文件路径比如则最终文件名为等级名从后往前找到第一个的位置即最后一次出现的的位置去掉后缀即我所需要的有效的前部分路径保留后缀即有效的文件扩展名组合成新的文件名如果没有文件扩展名比如则直接在文件名后面加上等级名核心写文件函数按照日志等级分类存储不分类直接使用传入的追加写入文件不存在则创建权限文件获取共享内存的共享内存的创建失败创建共享内存共享内存创建失败只想创建共享内存如果存在则报错获取共享内存如果不存在则创建文件创建共享内存只创建挂接共享内存打开管道文件打开文件失败打开文件失败共享内存信息结构体读取字符读取管道文件客户说模拟业务处理时间延迟秒获取共享内存信息段大小附着进程数传递给进程的键值访问模式脱挂共享内存删除共享内存关闭文件描述符文件获取共享内存挂接共享内存打开文件打开文件失败打开文件失败请输入要发送的消息从标准输入读取消息发送消息脱挂共享内存关闭文件运行示例共享内存',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-08 12:10:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 10 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="哔哩哔哩"/><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="Gitee"/><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN"/><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="稀土掘金"/><span class="back-menu-item-text">稀土掘金</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>8</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size: 1.05rem;">IO<sup>3</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>50</sup></a><a href="/tags/Obsidian/" style="font-size: 1.05rem;">Obsidian<sup>1</sup></a><a href="/tags/STL/" style="font-size: 1.05rem;">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size: 1.05rem;">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size: 1.05rem;">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size: 1.05rem;">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size: 1.05rem;">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 1.05rem;">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 1.05rem;">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size: 1.05rem;">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size: 1.05rem;">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 1.05rem;">网站<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>6</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 1.05rem;">进程<sup>15</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">10</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div id="console-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a><a class="article-meta__tags" href="/tags/%E8%BF%9B%E7%A8%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>进程</span></a><a class="article-meta__tags" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>地址空间</span></a></span></div></div><h1 class="post-title" itemprop="name headline">034 进程间通信 —— System V 共享内存</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-07-08T04:10:00.000Z" title="发表于 2025-07-08 12:10:00">2025-07-08</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-07-08T04:10:00.000Z" title="更新于 2025-07-08 12:10:00">2025-07-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">7.1k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="034 进程间通信 —— System V 共享内存"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=310655a6-6c39-cf83-30a5-291a83bcaa41"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/9524.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><a href="/tags/%E8%BF%9B%E7%A8%8B/" tabindex="-1" itemprop="url">进程</a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" tabindex="-1" itemprop="url">地址空间</a><h1 id="CrawlerTitle" itemprop="name headline">034 进程间通信 —— System V 共享内存</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-07-08T04:10:00.000Z" title="发表于 2025-07-08 12:10:00">2025-07-08</time><time itemprop="dateCreated datePublished" datetime="2025-07-08T04:10:00.000Z" title="更新于 2025-07-08 12:10:00">2025-07-08</time></header><h1 id="进程间通信-——-System-V-共享内存"><a href="#进程间通信-——-System-V-共享内存" class="headerlink" title="进程间通信 —— System V 共享内存"></a>进程间通信 —— System V 共享内存</h1><blockquote>
<p><strong>传统的 System V IPC 主要包括三种：共享内存、消息队列、信号量，我们后面主要涉及其 System v 共享内存，消息队列和信号量仅作为了解。</strong> 现代开发和教学中，<strong>共享内存</strong> 作为重点和常用技术，而 <strong>消息队列</strong> 和 <strong>信号量</strong> 相对被弱化，主要有以下原因（<strong>了解，信息来自网络</strong>）：</p>
<ul>
<li><p><strong>共享内存的独特优势（不可替代性）：</strong></p>
</li>
<li><p><strong>极致性能（说白了就是快）：</strong> 它是所有 IPC 方式中 <strong>速度最快</strong> 的。一旦建立映射，数据交换直接在内存中进行，<strong>没有内核到用户空间的数据拷贝开销</strong>。</p>
</li>
<li><p><strong>灵活性：</strong> 共享内存本身只是提供了一块共享区域，进程可以在上面构建任何复杂的数据结构和通信协议。消息队列则限制了消息的结构和大小。</p>
</li>
<li><p><strong>消息队列的局限性（逐渐被替代）：</strong></p>
</li>
<li><p><strong>性能瓶颈：</strong> 每次发送和接收消息都涉及 <strong>系统调用</strong> 和 <strong>数据在内核与用户空间之间的拷贝</strong>。对于大量或高频小消息的开销非常明显。</p>
</li>
<li><p><strong>灵活性限制：</strong> 消息有最大长度限制，且通常是 FIFO 的，虽然支持优先级，但模型相对固定。</p>
</li>
<li><p><strong>注：</strong> 老方案，API 麻烦，扩展性差，写多进程服务时不如直接用 socket。大厂一般直接上 RabbitMQ、Kafka（用户态 + 网络），或者自己封装 Pipe&#x2F;Socket。</p>
</li>
<li><p><strong>信号量的现状：</strong></p>
</li>
<li><p><strong>同步需求永存：</strong> 只要存在并发访问共享资源（尤其是共享内存！），就需要同步机制。信号量的核心功能（互斥、同步）仍然是必需的。</p>
</li>
<li><p><strong>注：</strong> 单独用很少，一般是搭配共享内存或者消息队列，用于加锁。现代 C++ 里更常用 POSIX Mutex、pthread_mutex、futex。所以学信号量只需要理解一下“需要同步”，但实战更偏向 POSIX Mutex 或用户态自旋锁。</p>
</li>
</ul>
</blockquote>
<h2 id="1-System-V-共享内存的直接原理"><a href="#1-System-V-共享内存的直接原理" class="headerlink" title="1. System V 共享内存的直接原理"></a>1. System V 共享内存的直接原理</h2><p><strong>System V 共享内存</strong> 就是一块 <strong>物理内存区域</strong>，由内核在物理内存中分配，多个进程通过 <code>shmget</code> 等系统调用 <strong>映射到各自的虚拟地址空间</strong>，从而实现 <strong>零拷贝的高效通信</strong>。即：<strong>System V 共享内存 &#x3D; 一块物理内存 + 多个进程虚拟映射 + 自己实现同步控制</strong>。本质是 <strong>内核帮我们做了虚拟地址和物理页的映射表维护</strong>，保证多进程读写指向同一物理地址。</p>
<blockquote>
<p><strong>共享区映射到同一物理内存的过程：</strong></p>
<ol>
<li>首先，一个进程（或内核初始化时）通过系统调用 <code>shmget</code> <strong>创建</strong> 或 <strong>获取</strong> 一个共享内存段。这个段存在于物理内存中，由一个唯一的标识符 <code>shmid</code> 标识。</li>
<li>接下来，<strong>任何</strong> 想要使用这个共享内存段的进程（包括创建者），都需要在自己的地址空间中 <strong>附加(Attach，更多情况我们更喜欢称挂接)</strong> 它。这是通过系统调用 <code>shmat</code> 完成的。</li>
<li><code>shmat</code> 在调用进程的虚拟地址空间中动态分配一块映射区（通常位于 mmap 动态映射区域，常见于堆和栈之间），并在页表中建立映射，使这块虚拟地址指向共享内存段实际占用的物理页帧，而不再指向进程私有页（注意 <strong>通常位置处于进程地址空间的共享区，但并非强制！</strong>）。</li>
<li><strong>多个进程执行 <code>shmat</code> 后：</strong> 它们各自的虚拟地址空间中，被 <code>shmat</code> 返回的那个地址（或指定的地址）所对应的页表项，都指向了 <strong>同一块物理内存区域</strong>。</li>
<li><strong>结果：</strong> 当一个进程通过它附加的虚拟地址写入数据时，数据直接写入了这块共享物理内存。另一个进程通过它自己附加的（不同的）虚拟地址读取时，直接从这块共享物理内存读取数据。<strong>不同的虚拟地址，通过各自的页表，映射到相同的物理地址。</strong> 这就是“让不同进程看到同一份资源”的本质。</li>
</ol>
</blockquote>
<p>下面找了几个较为形象的图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250702193137385.png" alt="image-20250702193137249"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250702193250357.png" alt="image-20250702193250253"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250702193332596.png" alt="image-20250702193332460"></p>
<p>注意：<strong>上述的映射、页表操作，都是由操作系统（内核）来做，而不是用户态进程做！</strong></p>
<p>为什么？</p>
<ul>
<li>用户态没权限直接操作页表（这是 MMU 和硬件特权模式约束）。</li>
<li>只有内核有权限分配物理页、修改页表、维护引用计数。</li>
<li>如果用户态可以随意改，那整个系统就失去内存隔离了，安全性就没有了。</li>
</ul>
<p>所以，用户态只能发起系统调用（<code>shmget</code>、<code>shmat</code>），<strong>具体“找页、改表、挂映射”由内核执行</strong>。那么当系统中存在多个共享内存，OS 要不要进行管理呢？回答：要的！这就又是我们老生常谈的 <strong>“先描述，再组织”</strong>（内核结构体描述共享内存）。</p>
<blockquote>
<h3 id="深入理解-“挂接”"><a href="#深入理解-“挂接”" class="headerlink" title="深入理解 “挂接”"></a>深入理解 “挂接”</h3><p><strong>挂接 &#x3D; 页表映射 &#x3D; 在自己的地址空间里开一扇门，让我们能访问内核里那块共享仓库。</strong> 挂接是 Linux 传统的说法，和文件系统的“挂载”类似，本质都是：<strong>把已有的物理资源，通过操作系统管理，暴露给一个命名空间&#x2F;可访问空间</strong>。</p>
<ul>
<li>文件系统挂载：把设备&#x2F;分区挂到某个目录。</li>
<li>共享内存挂接：把物理页挂到某个虚拟地址段。</li>
</ul>
<p><strong>比喻：</strong> System V 共享内存就是一块 <strong>公共仓库</strong>（物理页帧），这块仓库在内核里用 <code>shmid_ds</code> 管理，内核负责“保管”。单纯 <code>shmget</code> 就是创建了这块仓库，但谁也没把仓库门对接到自己家里。<code>shmat</code>（<strong>attach</strong>）就像是在你的家（进程的虚拟地址空间）里开个门，和这块仓库打通，让你能直接看到和访问这块公共物理页。所以：<strong>挂接 &#x3D; 虚拟地址空间里挂一块区域指向同一块物理页帧，进程间通信的前提是让不同的进程先看到同一份资源！</strong></p>
<hr>
<p><strong>不挂能不能用？</strong><br>不能！</p>
<ul>
<li><p>共享内存只是一块物理页帧，没挂接到进程页表前，进程看不到。</p>
</li>
<li><p>只有挂接后，CPU 访问你的虚拟地址才会翻译到这块物理内存。</p>
</li>
</ul>
<hr>
<p><strong>挂接后要不要解绑？</strong><br>要！</p>
<ul>
<li>用完后要 <code>shmdt</code>（detach）把这块映射从页表里去掉，虚拟内存就能被释放。</li>
<li>但物理页帧还在（因为其他进程可能还挂着）。</li>
<li>当最后一个挂接者 <code>shmdt</code> 后，如果之前用 <code>IPC_RMID</code> 标记删除了，就会真正释放物理页。</li>
</ul>
</blockquote>
<hr>
<h2 id="2-系统调用"><a href="#2-系统调用" class="headerlink" title="2. 系统调用"></a>2. 系统调用</h2><h3 id="1-ftok-——-生成-IPC-key（为后面的-shmget-铺垫）"><a href="#1-ftok-——-生成-IPC-key（为后面的-shmget-铺垫）" class="headerlink" title="1. ftok —— 生成 IPC key（为后面的 shmget 铺垫）"></a>1. <code>ftok</code> —— 生成 IPC key（为后面的 <code>shmget</code> 铺垫）</h3><h4 id="1-作用"><a href="#1-作用" class="headerlink" title="1. 作用"></a>1. 作用</h4><p><code>ftok</code> 的作用是 <strong>生成一个 System V IPC 的 key（键值）</strong>，本质是一个将路径作为的字符串和 proj_id 这个整数结合的一个算法。和这个 key 用来在：<code>shmget</code>（共享内存）参数里作为唯一标识。它不是随机生成的！而是用 <code>pathname</code> 和 <code>proj_id</code> 生成的一个整数 <code>key_t</code>。在前面的有名管道中，我们使用路径作为唯一标识（路径本身就具有唯一性），这里使用一个 key 值作为唯一性也是异曲同工之妙。注：<code>ftok</code> 只是为了生成 key，和数据本身没关系！</p>
<h4 id="2-ftok-函数原型"><a href="#2-ftok-函数原型" class="headerlink" title="2. ftok 函数原型"></a>2. <code>ftok</code> 函数原型</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">key_t</span> <span class="title">ftok</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> proj_id)</span></span>;			<span class="comment">// 有效路径和任意整数</span></span><br></pre></td></tr></table></figure>

<h4 id="3-怎么生成？"><a href="#3-怎么生成？" class="headerlink" title="3. 怎么生成？"></a>3. 怎么生成？</h4><p>内部算法 <strong>大概</strong> 是：把 inode 的低字节、设备号等信息混进去，经过算法组合，从而形成唯一的哈希值 key。所以：</p>
<ul>
<li><strong>只要文件不变，同一个 proj_id 得到的 key 是一样的。</strong></li>
<li>这样保证不同进程用相同文件和 proj_id，就能找到同一块 IPC 资源。</li>
</ul>
<h4 id="4-返回值"><a href="#4-返回值" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li>成功：返回 key (<code>key_t</code>)，是个整数。</li>
<li>失败：返回 <code>-1</code>，设置 <code>errno</code>。<ul>
<li><code>EACCES</code>：路径不可访问。</li>
<li><code>ENOENT</code>：文件不存在。</li>
<li><code>ENOTDIR</code>：路径中的目录不存在。</li>
</ul>
</li>
</ul>
<h4 id="5-示例"><a href="#5-示例" class="headerlink" title="5. 示例"></a>5. 示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">ftok</span>(<span class="string">&quot;./tmp.txt&quot;</span>, <span class="number">65</span>);  <span class="comment">// 文件必须存在</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ftok&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;IPC Key: &quot;</span> &lt;&lt; key &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250702210024190.png" alt="image-20250702210024126"></p>
<hr>
<h3 id="2-shmget-——-创建-获取共享内存"><a href="#2-shmget-——-创建-获取共享内存" class="headerlink" title="2. shmget —— 创建&#x2F;获取共享内存"></a>2. <code>shmget</code> —— 创建&#x2F;获取共享内存</h3><h4 id="1-作用-1"><a href="#1-作用-1" class="headerlink" title="1. 作用"></a>1. 作用</h4><ul>
<li><strong>创建一个新的共享内存段。</strong></li>
<li>或者 <strong>获取已存在的共享内存段。</strong></li>
</ul>
<p>关键靠 <code>key</code> 做唯一标识。</p>
<h4 id="2-shmget-函数原型"><a href="#2-shmget-函数原型" class="headerlink" title="2. shmget 函数原型"></a>2. <code>shmget</code> 函数原型</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shmget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">size_t</span> size, <span class="type">int</span> shmflg)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-参数详解"><a href="#3-参数详解" class="headerlink" title="3. 参数详解"></a>3. 参数详解</h4><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>key</code></td>
<td><strong>IPC 键值</strong>（由 <code>ftok</code> 生成），用于唯一标识，可以自定义，但是不保证一定有效，可能存在冲突！</td>
</tr>
<tr>
<td><code>size</code></td>
<td><strong>共享内存段大小</strong>（单位字节），如果是获取已存在的，则忽略，<strong>注意 页对齐 行为！通常分配 4KB 的整数倍（4096 的整数倍）</strong></td>
</tr>
<tr>
<td><code>shmflg</code></td>
<td><strong>权限标志 + 控制标志</strong>，典型：<code>IPC_CREAT</code>，<code>IPC_EXCL</code>，<code>0666</code></td>
</tr>
</tbody></table>
<p><strong>注意：</strong> System V 共享内存段在物理页帧分配时总是 <strong>按页对齐（通常是 4KB）</strong>，但 <code>shmget</code> 的 <code>size</code> 是逻辑大小，<code>ipcs -m</code> 里显示也是逻辑大小，实际物理内存占用是向上对齐的页大小倍数，使用时应按逻辑大小访问，超出即是“越界访问”，可能存在 <strong>未定义行为&#x2F;段错误</strong>。</p>
<p>例如：<code>shmget(4100)</code> 表示：”我承诺只用前 4100 字节（0~4099 合法）”，OS 回应：” 我实际给你 8192 字节（4KB * 2），但超出的部分你别碰 “（非越界访问指 0 ≦ 有效值 &lt; 用户分配值的大小）。<strong>永远记住：”能” 做不代表 “应该” 做。在系统编程中，自律比能力更重要。不立即爆炸，但终将毁灭！</strong></p>
<h4 id="4-常用的-shmflg"><a href="#4-常用的-shmflg" class="headerlink" title="4. 常用的 shmflg"></a>4. 常用的 <code>shmflg</code></h4><ul>
<li><code>0666</code>：权限位，表示其他进程是否可读&#x2F;写（和 <code>open</code> 的权限一样）。</li>
<li><code>IPC_CREAT</code>：如果不存在则创建，存在就获取返回。</li>
<li><code>IPC_EXCL</code>：和 <code>IPC_CREAT</code> 一起用时，要求“仅当不存在时才创建”，否则出错。</li>
<li><code>IPC_EXCL</code>：不单独使用！</li>
</ul>
<p>举例：</p>
<ul>
<li>只想创建（如果存在则失败）：<code>IPC_CREAT | IPC_EXCL | 0666</code>。</li>
<li>想获取（或必要时创建）：<code>IPC_CREAT | 0666</code>。</li>
</ul>
<h4 id="5-返回值"><a href="#5-返回值" class="headerlink" title="5. 返回值"></a>5. 返回值</h4><ul>
<li>成功：返回共享内存标识符（<code>shmid</code>），唯一 int ID。</li>
<li>失败：返回 -1，设置 <code>errno</code>。</li>
</ul>
<h4 id="6-示例"><a href="#6-示例" class="headerlink" title="6. 示例"></a>6. 示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">ftok</span>(<span class="string">&quot;/tmp.txt&quot;</span>, <span class="number">65</span>);                       <span class="comment">// 生成唯一 key</span></span><br><span class="line">    <span class="type">int</span> shmid = <span class="built_in">shmget</span>(key, <span class="number">4096</span>, <span class="number">0666</span> | IPC_CREAT);        <span class="comment">// 创建或获取 4KB 共享内存</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shmid == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;shmid: &quot;</span> &lt;&lt; shmid &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-二者关系总结"><a href="#3-二者关系总结" class="headerlink" title="3. 二者关系总结"></a>3. 二者关系总结</h3><table>
<thead>
<tr>
<th>函数</th>
<th>作用</th>
<th>关键点</th>
</tr>
</thead>
<tbody><tr>
<td><code>ftok</code></td>
<td>生成 key</td>
<td>依赖文件 inode 和 proj_id，不保证全局唯一，但同参数一致性好</td>
</tr>
<tr>
<td><code>shmget</code></td>
<td>创建&#x2F;获取共享内存</td>
<td>需要 key、大小和标志，内核内部管理分配和引用计数</td>
</tr>
</tbody></table>
<p><strong>小坑提醒：</strong></p>
<ul>
<li><code>ftok</code> 不是必须的！我们完全可以自己写 <code>key_t</code>，只要和另一端一致就行（很多老项目直接用固定数值）。</li>
<li>不同机器，<code>ftok</code> 生成同一文件的 key 可能不一样（因为 inode 和设备号可能不同），所以跨机集群时要注意！</li>
<li><code>shmget</code> 只分配描述符，不分配虚拟地址；只有 <code>shmat</code> 才会把它挂到进程地址空间。</li>
</ul>
<blockquote>
<p>  <code>ftok</code> 是为了在多人协作或多程序协作时，保证只要文件和 proj_id 一致，生成的 key 就一致，从而多个进程可以用相同 key 访问同一个 IPC 对象。</p>
</blockquote>
<hr>
<h3 id="4-shmctl-——-删除（控制-管理）共享内存"><a href="#4-shmctl-——-删除（控制-管理）共享内存" class="headerlink" title="4. shmctl —— 删除（控制&#x2F;管理）共享内存"></a>4. <code>shmctl</code> —— 删除（控制&#x2F;管理）共享内存</h3><h4 id="1-shmctl-函数原型"><a href="#1-shmctl-函数原型" class="headerlink" title="1. shmctl 函数原型"></a>1. <code>shmctl</code> 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shmctl</span><span class="params">(<span class="type">int</span> shmid, <span class="type">int</span> cmd, <span class="keyword">struct</span> shmid_ds *buf)</span></span>;		 <span class="comment">// 控制共享内存</span></span><br></pre></td></tr></table></figure>

<h4 id="2-参数详解"><a href="#2-参数详解" class="headerlink" title="2. 参数详解"></a>2. 参数详解</h4><ol>
<li><code>shmid</code>：共享内存段标识符（由 <code>shmget</code> 返回）。</li>
<li><code>cmd</code>：<ul>
<li><strong><code>IPC_RMID</code>：删除，从系统中标记删除该段。</strong></li>
<li><strong><code>IPC_STAT</code>：获取状态，用于接收共享内存的状态信息（输出）。</strong></li>
<li><strong><code>IPC_SET</code>：设置状态，用于向内核提交新状态（输入）。</strong></li>
<li><code>SHM_LOCK</code>：锁定共享内存段（防止换出到交换空间）。</li>
<li><code>SHM_UNLOCK</code>：解除锁定。</li>
</ul>
</li>
<li><code>buf</code>：如果是 <code>IPC_STAT</code> 或 <code>IPC_SET</code>，就需要传状态结构体指针；<code>IPC_RMID</code> 时可传 <code>NULL</code>（<code>nullptr</code>）。</li>
</ol>
<h4 id="3-返回值"><a href="#3-返回值" class="headerlink" title="3. 返回值"></a>3. 返回值</h4><ul>
<li><strong>成功</strong>：返回 0。</li>
<li><strong>失败</strong>：返回 -1，同时设置 <code>errno</code>。常见错误：<ul>
<li><code>EINVAL</code>：无效的 <code>shmid</code>。</li>
<li><code>EACCES</code>：没有权限。</li>
<li><code>EIDRM</code>：段已被删除。</li>
</ul>
</li>
</ul>
<blockquote>
<h4 id="shmid-ds-结构体："><a href="#shmid-ds-结构体：" class="headerlink" title="shmid_ds 结构体："></a><code>shmid_ds</code> 结构体：</h4><p>这是 <code>shmctl</code> 操作的核心数据结构，用来描述共享内存段的元数据。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250703094226258.png" alt="image-20250703094226102"></p>
<p>具体含义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">struct</span> <span class="title class_">shmid_ds</span></span><br><span class="line">&gt;&#123;</span><br><span class="line">&gt;<span class="keyword">struct</span> <span class="title class_">ipc_perm</span> shm_perm;   <span class="comment">// 权限信息（UID, GID, mode）</span></span><br><span class="line">&gt;<span class="type">size_t</span> shm_segsz;           <span class="comment">// 段大小（字节）</span></span><br><span class="line">&gt;<span class="type">time_t</span> shm_atime;           <span class="comment">// 上次 attach 时间</span></span><br><span class="line">&gt;<span class="type">time_t</span> shm_dtime;           <span class="comment">// 上次 detach 时间</span></span><br><span class="line">&gt;<span class="type">time_t</span> shm_ctime;           <span class="comment">// 创建或上次修改时间</span></span><br><span class="line">&gt;<span class="type">pid_t</span> shm_cpid;             <span class="comment">// 创建该段的进程 PID</span></span><br><span class="line">&gt;<span class="type">pid_t</span> shm_lpid;             <span class="comment">// 最后一次操作该段的进程 PID</span></span><br><span class="line">&gt;<span class="type">shmatt_t</span> shm_nattch;        <span class="comment">// 当前 attach 的进程数量（引用计数）</span></span><br><span class="line">&gt;...</span><br><span class="line">&gt;&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">struct</span> <span class="title class_">ipc_perm</span></span><br><span class="line">&gt;&#123;</span><br><span class="line">&gt;<span class="type">key_t</span>          __key;    	<span class="comment">// 传递给 shmget(2) 的键值</span></span><br><span class="line">&gt;<span class="type">uid_t</span>          uid;      	<span class="comment">// 共享内存拥有者的有效用户ID</span></span><br><span class="line">&gt;<span class="type">gid_t</span>          gid;      	<span class="comment">// 共享内存拥有者的有效组ID</span></span><br><span class="line">&gt;<span class="type">uid_t</span>          cuid;     	<span class="comment">// 创建该共享内存的进程的有效用户ID</span></span><br><span class="line">&gt;<span class="type">gid_t</span>          cgid;     	<span class="comment">// 创建该共享内存的进程的有效组ID</span></span><br><span class="line">&gt;<span class="type">unsigned</span> <span class="type">short</span> mode;     	<span class="comment">// 权限标志位，包含 SHM_DEST 和 SHM_LOCKED 等标志</span></span><br><span class="line">&gt;<span class="type">unsigned</span> <span class="type">short</span> __seq;    	<span class="comment">// 序列号，用于生成唯一标识</span></span><br><span class="line">&gt;&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>如何查看哪个进程还挂着共享内存？</strong></p>
<p>查看 <code>shm_nattch</code>（引用计数），只要 &gt; 0，物理页就不释放！</p>
<hr>
<p>场景示例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">struct</span> <span class="title class_">shmid_ds</span> buf;</span><br><span class="line">&gt;<span class="built_in">shmctl</span>(shmid, IPC_STAT, &amp;buf);</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment">// 查看大小、创建者 PID、引用数</span></span><br><span class="line">&gt;<span class="built_in">printf</span>(<span class="string">&quot;Size: %zu\n&quot;</span>, buf.shm_segsz);</span><br><span class="line">&gt;<span class="built_in">printf</span>(<span class="string">&quot;Creator PID: %d\n&quot;</span>, buf.shm_cpid);</span><br><span class="line">&gt;<span class="built_in">printf</span>(<span class="string">&quot;Nattach: %ld\n&quot;</span>, buf.shm_nattch);</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">shmctl</span>(shmid, IPC_RMID, <span class="literal">NULL</span>);  <span class="comment">// 标记删除</span></span><br><span class="line">&gt;<span class="comment">// 标记删除 ≠ 立刻删除，等引用数归 0 后才真正释放。</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<h4 id="1-查看系统现有的共享内存"><a href="#1-查看系统现有的共享内存" class="headerlink" title="1. 查看系统现有的共享内存"></a>1. 查看系统现有的共享内存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;ipcs -m    <span class="comment"># 查看系统现有的共享内存</span></span><br></pre></td></tr></table></figure>

<h4 id="2-删除指定系统的共享内存"><a href="#2-删除指定系统的共享内存" class="headerlink" title="2. 删除指定系统的共享内存"></a>2. 删除指定系统的共享内存</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;ipcrm -m &lt;shmid&gt;    <span class="comment"># 删除指定共享内存段</span></span><br></pre></td></tr></table></figure></blockquote>
<hr>
<h3 id="5-shmat-——-“挂接内存”"><a href="#5-shmat-——-“挂接内存”" class="headerlink" title="5. shmat —— “挂接内存”"></a>5. <code>shmat</code> —— “挂接内存”</h3><h4 id="1-函数原型"><a href="#1-函数原型" class="headerlink" title="1. 函数原型"></a>1. 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">shmat</span><span class="params">(<span class="type">int</span> shmid, <span class="type">const</span> <span class="type">void</span> *shmaddr, <span class="type">int</span> shmflg)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-作用"><a href="#2-作用" class="headerlink" title="2. 作用"></a>2. 作用</h4><p>进程各自的虚拟地址空间是隔离的，但 <code>shmat</code> 把同一个物理内存页挂接到多个进程的页表里，所以多个进程访问同一块物理页，实现了多进程 <strong>“看到同一份资源”</strong>，到此，多进程间才具备的通信的能力。底层做的是页表映射和引用计数，返回值是可直接访问的指针，真正实现多进程间的零拷贝数据共享（<strong>拷贝少 → 速度快</strong>）。</p>
<h4 id="3-参数详解-1"><a href="#3-参数详解-1" class="headerlink" title="3. 参数详解"></a>3. 参数详解</h4><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>int shmid</code></td>
<td>共享内存段标识符</td>
<td>来自 <code>shmget</code> 的返回值</td>
</tr>
<tr>
<td><code>const void *shmaddr</code></td>
<td>希望映射到进程虚拟空间的 <strong>首选地址</strong></td>
<td>通常写 <code>NULL</code>&#x2F;<code>nullptr</code>（让内核自己找个合适的可用地址）</td>
</tr>
<tr>
<td><code>int shmflg</code></td>
<td>标志位</td>
<td>主要用于指定映射权限或对齐</td>
</tr>
</tbody></table>
<ul>
<li><p><code>shmaddr</code>：</p>
<ul>
<li><p>如果是 <code>NULL</code>，表示“由内核自动分配虚拟地址”，这是 <strong>最常用也最安全的写法</strong>。</p>
</li>
<li><p>如果指定了具体地址：必须是页对齐地址，<code>shmflg</code> 可以带 <code>SHM_RND</code> 表示“按 4KB 对齐”。</p>
</li>
</ul>
</li>
<li><p><code>shmflg</code> 的典型值：</p>
<ul>
<li><strong><code>0</code>：最常用，表示默认读写。</strong></li>
<li><code>SHM_RDONLY</code>：以只读方式挂接（这个进程只能读，别的进程可以写）。</li>
<li><code>SHM_RND</code>：如果指定了 <code>shmaddr</code>，且希望地址自动按 4KB 页对齐，就要加这个。</li>
</ul>
</li>
</ul>
<h4 id="4-返回值-1"><a href="#4-返回值-1" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li><p><strong>成功</strong>：返回共享内存段在当前进程虚拟地址空间中的起始地址（<code>void *</code>）。</p>
</li>
<li><p><strong>失败：</strong> 返回 <code>(void *) -1</code>，并设置 <code>errno</code>。</p>
<ul>
<li><p><code>EINVAL</code>：<code>shmid</code> 不存在或非法。</p>
</li>
<li><p><code>EACCES</code>：权限不足（比如只读段却尝试写挂接）。</p>
</li>
<li><p><code>ENOMEM</code>：找不到可用虚拟地址（尤其是自己指定 <code>shmaddr</code> 时更容易出现）。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="6-shmdt-——-脱挂，释放虚拟空间的映射"><a href="#6-shmdt-——-脱挂，释放虚拟空间的映射" class="headerlink" title="6. shmdt —— 脱挂，释放虚拟空间的映射"></a>6. <code>shmdt</code> —— 脱挂，释放虚拟空间的映射</h3><h4 id="1-作用-2"><a href="#1-作用-2" class="headerlink" title="1. 作用"></a>1. 作用</h4><p>从当前进程的页表中卸载共享内存段的映射区域，并把内核引用计数 -1，不会释放物理页帧，物理段释放要靠 <code>shmctl(IPC_RMID)</code> 和引用计数归零一起决定。</p>
<blockquote>
<p><strong><code>shmdt</code> 负责 “关门走人”，<code>shmctl(IPC_RMID)</code> 负责 “拆掉仓库”。</strong></p>
<table>
<thead>
<tr>
<th>对比</th>
<th><code>shmdt</code></th>
<th><code>shmctl</code></th>
</tr>
</thead>
<tbody><tr>
<td>主要功能</td>
<td><strong>脱挂（取消挂接）</strong></td>
<td><strong>控制（管理）共享内存段</strong></td>
</tr>
<tr>
<td>作用对象</td>
<td>当前进程的虚拟地址空间</td>
<td>内核中整个共享内存段</td>
</tr>
<tr>
<td>是否影响物理内存</td>
<td>❌ 不会直接删除物理页帧</td>
<td>✅ 可以通过 <code>IPC_RMID</code> 标记删除物理页帧</td>
</tr>
<tr>
<td>引用计数影响</td>
<td>调用后，<code>shmid_ds.shm_nattch</code> -1</td>
<td><code>IPC_RMID</code> 后，等引用数归零才真正释放</td>
</tr>
<tr>
<td>调用场景</td>
<td>挂接用完后必须调用，释放虚拟空间</td>
<td>要永久回收内存段时必须调用</td>
</tr>
<tr>
<td>是否必须</td>
<td>一般必须（防止虚拟内存泄漏）</td>
<td>必须（否则段会一直挂在内核 IPC 表）</td>
</tr>
<tr>
<td>错误示例</td>
<td>不脱挂会浪费虚拟地址空间</td>
<td>不标记删除会造成内核残留，需手动 <code>ipcrm</code></td>
</tr>
</tbody></table>
</blockquote>
<h4 id="2-函数原型"><a href="#2-函数原型" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shmdt</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *shmaddr)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-参数详解-2"><a href="#3-参数详解-2" class="headerlink" title="3. 参数详解"></a>3. 参数详解</h4><ul>
<li><strong><code>const void *shmaddr</code>：</strong> 由 <code>shmat</code> 返回的指针，表示要脱挂的共享内存区域的起始虚拟地址。</li>
<li><strong>注意</strong>：这个地址必须是之前 <code>shmat</code> 成功挂接时返回的那个指针。不允许随便传地址！</li>
</ul>
<h4 id="4-返回值-2"><a href="#4-返回值-2" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li>成功：返回 0。</li>
<li>失败：返回 -1。常见错误：<ul>
<li><code>EINVAL</code>：找不到对应挂接（<code>shmaddr</code> 非法）。</li>
<li><code>ENOMEM</code>：有些实现里如果内部释放失败（比较罕见）。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-System-V-共享内存的生命周期随内核"><a href="#3-System-V-共享内存的生命周期随内核" class="headerlink" title="3. System V 共享内存的生命周期随内核"></a>3. System V 共享内存的生命周期随内核</h2><p><strong>结论：System V 共享内存段 &#x3D; 不手动删就不回收，引用计数归零 + IPC_RMID 才是唯一的释放条件！<code>IPC_RMID</code> + <code>shm_nattch == 0</code> → 真正释放物理页。</strong> 如果没 <code>IPC_RMID</code>，引用计数再归零也不删，物理页照样挂着！</p>
<p>System V 共享内存的生命周期和两个东西密切相关：</p>
<ol>
<li>共享内存 <strong>段本身</strong>（<code>shmid_ds</code> 描述的物理页）。</li>
<li>挂接（attach）的 <strong>引用计数</strong>（<code>shm_nattch</code>）。</li>
</ol>
<p>他们俩共同决定：<strong>什么时候物理页还存在，什么时候物理页真正被回收！</strong></p>
<blockquote>
<p>注意：System V 共享内存不会自动回收，必须手动使用 <code>shmctl</code> &#x2F; <code>ipcrm</code>，<strong>内核</strong> 会一直保留这块物理页帧，只要系统 <strong>重启前</strong>，这段共享内存都在 <code>/proc/sysvipc/shm</code> 里挂着！所以 <strong>System V IPC 的最终清理手段 &#x3D; 重启！</strong></p>
<p><strong>System V IPC</strong> 是 Linux 内核维护的全局资源，而 Xshell 是 <strong>一个远程终端工具</strong>，本质就是个 SSH 客户端。它 <strong>不会“托管”共享内存段</strong>，只是帮助登录远程 Linux 主机。关掉 Xshell，只是 SSH 断了，跟远程机器上的进程、内核资源没有必然关系。所以，<strong>关掉 Xshell 对共享内存没有任何直接影响！</strong></p>
</blockquote>
<h2 id="4-示例-Demo"><a href="#4-示例-Demo" class="headerlink" title="4. 示例 Demo"></a>4. 示例 Demo</h2><h3 id="1-System-V-共享内存通信完整步骤"><a href="#1-System-V-共享内存通信完整步骤" class="headerlink" title="1. System V 共享内存通信完整步骤"></a>1. System V 共享内存通信完整步骤</h3><ol>
<li><p><strong><code>ftok</code> （可选，但推荐）：</strong> 生成一个 <strong>key_t</strong>，作为 IPC 对象的唯一标识。本质上就是用路径名+id 生成一个整数 key。</p>
</li>
<li><p><strong><code>shmget</code>：</strong> 内核分配一块 <strong>物理内存页帧</strong>，挂到内核的共享内存表（<code>shmid_ds</code>）。得到一个 <code>shmid</code>（共享内存段标识符）。</p>
</li>
<li><p><strong><code>shmat</code> 挂接（attach）：</strong> 把这块共享内存段映射到调用进程的 <strong>虚拟地址空间</strong>，更新页表。返回一个指针，后续直接对这块物理页读写。</p>
</li>
<li><p><strong>各个进程的读写操作：</strong>……（省略）。</p>
</li>
<li><p><strong><code>shmdt</code>：</strong> 用完后，进程要执行 <code>shmdt</code> 脱挂，把这块内存区域从自己的页表取消映射。</p>
</li>
<li><p><strong><code>shmctl</code>：</strong> 用 <code>IPC_RMID</code> 命令显式标记这块共享内存段为“待删除”。当挂接计数归零时，内核真正回收物理页。</p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250707210159129.png" alt="image-20250707210158998"></p>
<h3 id="2-System-V-共享内存的服务端-客户端模型-Demo"><a href="#2-System-V-共享内存的服务端-客户端模型-Demo" class="headerlink" title="2. System V 共享内存的服务端-客户端模型 Demo"></a>2. System V 共享内存的服务端-客户端模型 Demo</h3><blockquote>
<h3 id="fgets-函数"><a href="#fgets-函数" class="headerlink" title="fgets 函数"></a>fgets 函数</h3><h4 id="1-作用-功能"><a href="#1-作用-功能" class="headerlink" title="1. 作用 &#x2F; 功能"></a>1. 作用 &#x2F; 功能</h4><p>C 标准库提供的一个输入函数，用于 <strong>从指定的文件流中读取一行字符串</strong>，可安全限制最大读取长度，避免缓冲区溢出。常用于读取带空格的一整行输入（包括换行符），常用于：</p>
<ul>
<li>从 <code>stdin</code> 获取用户输入。</li>
<li>从文件中按行读取文本。</li>
</ul>
<h4 id="2-函数原型-1"><a href="#2-函数原型-1" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span>   		<span class="comment">// C++ 推荐使用</span></span></span><br><span class="line">&gt;<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>			<span class="comment">// 或者在纯 C 里用</span></span></span><br><span class="line">&gt;<span class="function"><span class="type">char</span> *<span class="title">fgets</span><span class="params">(<span class="type">char</span> *str, <span class="type">int</span> n, FILE *stream)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-参数详解-3"><a href="#3-参数详解-3" class="headerlink" title="3.参数详解"></a>3.参数详解</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>char *str</code></td>
<td>输入输出参数</td>
<td>指向用于存放读取字符串的缓冲区的指针。读取到的字符串（包括换行符）会存到这里。必须有足够空间。</td>
</tr>
<tr>
<td><code>int n</code></td>
<td>输入参数</td>
<td>要读取的最大字符数（包含结尾的 <code>\0</code>），所以实际最多读取 <code>n - 1</code> 个字符。</td>
</tr>
<tr>
<td><code>FILE *stream</code></td>
<td>输入参数</td>
<td>文件流指针，比如 <code>stdin</code>（标准输入）或用 <code>fopen</code> 打开的文件指针。</td>
</tr>
</tbody></table>
<h4 id="4-返回值-3"><a href="#4-返回值-3" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li><strong>返回值类型：</strong> <code>char *</code>。</li>
<li><strong>成功时：</strong> 返回传入的缓冲区 <code>str</code> 指针。</li>
<li><strong>失败时：</strong> 如果发生错误或遇到文件结尾（EOF）且未读取到任何字符，则返回 <code>NULL</code>。</li>
</ul>
<p>常用的判断写法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">if</span> (<span class="built_in">fgets</span>(buffer, size, stdin) != <span class="literal">NULL</span>)</span><br><span class="line">&gt;&#123;</span><br><span class="line">   <span class="comment">// 成功</span></span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;<span class="keyword">else</span></span><br><span class="line">&gt;&#123;</span><br><span class="line">   <span class="comment">// 读取失败或 EOF</span></span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-代码示例"><a href="#5-代码示例" class="headerlink" title="5. 代码示例"></a>5. 代码示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span>                       <span class="comment">// 引入 fgets 需要的头文件</span></span></span><br><span class="line">&gt;<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span>                      <span class="comment">// exit() 用于异常退出</span></span></span><br><span class="line"></span><br><span class="line">&gt;<span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">&gt;</span>&#123;</span><br><span class="line">   <span class="type">const</span> <span class="type">int</span> SIZE = <span class="number">100</span>;               <span class="comment">// 定义缓冲区大小</span></span><br><span class="line">   <span class="type">char</span> buffer[SIZE];                  <span class="comment">// 创建缓冲区</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;请输入一行文字（最多 %d 个字符）：\n&quot;</span>, SIZE - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">fgets</span>(buffer, SIZE, stdin) != <span class="literal">NULL</span>)      <span class="comment">// 调用 fgets 从 stdin 读取</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;您输入的是：%s&quot;</span>, buffer);         <span class="comment">// fgets 会保留换行符</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">perror</span>(<span class="string">&quot;读取失败&quot;</span>);                       <span class="comment">// 读取出错或 EOF</span></span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure></blockquote>
<h4 id="1-Log-hpp-文件（之前写的日志插件）"><a href="#1-Log-hpp-文件（之前写的日志插件）" class="headerlink" title="1. Log.hpp 文件（之前写的日志插件）"></a>1. Log.hpp 文件（之前写的日志插件）</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>                                      <span class="comment">// exit, perror</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>                                      <span class="comment">// read, write, close</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>                                   <span class="comment">// open, close, read, write, lseek</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>                                    <span class="comment">// mkdir</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>                                       <span class="comment">// open, O_RDONLY, O_WRONLY, O_CREAT, O_APPEND</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span>                                       <span class="comment">// errno</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span>                                    <span class="comment">// gettimeofday, struct timeval</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span>                                         <span class="comment">// localtime_r, struct tm</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 管道错误码</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">FIFO_ERROR_CODE</span></span><br><span class="line">&#123;</span><br><span class="line">    FIFO_CREATE_ERR = <span class="number">1</span>,                                 <span class="comment">// 这是创建管道文件失败的错误码</span></span><br><span class="line">    FIFO_DELETE_ERR = <span class="number">2</span>,                                 <span class="comment">// 这是删除管道文件失败的错误码</span></span><br><span class="line">    FIFO_OPEN_ERR                                        <span class="comment">// 这是打开管道文件失败的错误码（枚举会自动赋值为3）</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志等级</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Log_Level</span></span><br><span class="line">&#123;</span><br><span class="line">    Fatal,                                               <span class="comment">// 最严重级别</span></span><br><span class="line">    Error,                                               <span class="comment">// 严重错误</span></span><br><span class="line">    Warning,                                             <span class="comment">// 警告</span></span><br><span class="line">    Debug,                                               <span class="comment">// 调试信息</span></span><br><span class="line">    Info                                                 <span class="comment">// 普通信息</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Log</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>  enable = <span class="number">1</span>;                                     <span class="comment">// 是否启用日志</span></span><br><span class="line">    <span class="type">int</span>  classification = <span class="number">1</span>;                             <span class="comment">// 是否分类</span></span><br><span class="line">    string log_path = <span class="string">&quot;./log.txt&quot;</span>;                       <span class="comment">// 日志存放路径</span></span><br><span class="line">    <span class="type">int</span>  console_out = <span class="number">1</span>;                                <span class="comment">// 是否输出到终端</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 日志等级转换成字符串</span></span><br><span class="line">    <span class="function">string <span class="title">level_to_string</span><span class="params">(<span class="type">int</span> level)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (level)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> Fatal:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Fatal&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> Error:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> Warning:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Warning&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> Debug:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Debug&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> Info:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Info&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;None&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前计算机的时间，返回格式：YYYY-MM-DD HH:MM:SS.UUUUUU （含微秒）</span></span><br><span class="line">    <span class="function">string <span class="title">get_current_time</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;                               <span class="comment">// timeval：包含秒和微秒</span></span><br><span class="line">        <span class="built_in">gettimeofday</span>(&amp;tv, <span class="literal">nullptr</span>);                      <span class="comment">// 系统调用：获取当前时间（精确到微秒）</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">tm</span> t;                                     <span class="comment">// tm：分解时间，转格式（年、月、日、时、分、秒）</span></span><br><span class="line">        <span class="built_in">localtime_r</span>(&amp;tv.tv_sec, &amp;t);                     <span class="comment">// 把秒转换成年月日时分秒（本地时区）</span></span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">64</span>];                                 <span class="comment">// 定义字符数组作为格式化输出的缓冲区</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">snprintf</span>(buffer, <span class="built_in">sizeof</span>(buffer),</span><br><span class="line">                <span class="string">&quot;%04d-%02d-%02d %02d:%02d:%02d.%06ld&quot;</span>,</span><br><span class="line">                t.tm_year + <span class="number">1900</span>,                        <span class="comment">// 年：tm_year 从 1900 开始计数</span></span><br><span class="line">                t.tm_mon + <span class="number">1</span>,                            <span class="comment">// 月：tm_mon 从 0 开始，0 表示 1 月</span></span><br><span class="line">                t.tm_mday,                               <span class="comment">// 日</span></span><br><span class="line">                t.tm_hour,                               <span class="comment">// 时</span></span><br><span class="line">                t.tm_min,                                <span class="comment">// 分</span></span><br><span class="line">                t.tm_sec,                                <span class="comment">// 秒</span></span><br><span class="line">                tv.tv_usec);                             <span class="comment">// 微秒部分，取自 gettimeofday</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">string</span>(buffer);                           <span class="comment">// 转换成 string 返回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Log</span>() = <span class="keyword">default</span>;                                     <span class="comment">// 使用默认构造</span></span><br><span class="line">    <span class="built_in">Log</span>(<span class="type">int</span> enable, <span class="type">int</span> classification, string log_path, <span class="type">int</span> console_out)</span><br><span class="line">        : <span class="built_in">enable</span>(enable),</span><br><span class="line">        <span class="built_in">classification</span>(classification),</span><br><span class="line">        <span class="built_in">log_path</span>(log_path),</span><br><span class="line">        <span class="built_in">console_out</span>(console_out)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重载函数调用运算符</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> level, <span class="type">const</span> string&amp; content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (enable == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;                                      <span class="comment">// 日志未启用</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        string level_str = <span class="string">&quot;[&quot;</span> + <span class="built_in">level_to_string</span>(level) + <span class="string">&quot;] &quot;</span>;</span><br><span class="line">        string log_message;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classification == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            log_message = level_str + <span class="string">&quot;[&quot;</span> + <span class="built_in">get_current_time</span>() + <span class="string">&quot;] &quot;</span> + content + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (classification == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            log_message = <span class="string">&quot;[&quot;</span> + <span class="built_in">get_current_time</span>() + <span class="string">&quot;] &quot;</span> + content + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;传入的分类参数错误！\n&quot;</span>);              <span class="comment">// 分类未启用</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (console_out == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; log_message;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log_to_file</span>(level, log_message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 文件路径的后缀处理函数：当按照日志等级分类存储并且文件路径是 &quot;./log.txt&quot; 这种有文件扩展名时的处理方法</span></span><br><span class="line">    <span class="function">string <span class="title">Suffix_processing</span><span class="params">(<span class="type">int</span> level, string log_path)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string Path;</span><br><span class="line">        <span class="keyword">if</span> (log_path.<span class="built_in">back</span>() == <span class="string">&#x27;/&#x27;</span>)                      <span class="comment">// 如果是一个目录的路径，比如 &quot;./log/&quot;，则最终文件名为 &quot;log_等级名.txt&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">            Path = log_path + <span class="string">&quot;log_&quot;</span> + <span class="built_in">level_to_string</span>(level) + <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                                             <span class="comment">// 如果是一个文件路径，比如 &quot;./log.txt&quot;，则最终文件名为 &quot;log_等级名.txt&quot;</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">size_t</span> pos = log_path.<span class="built_in">find_last_of</span>(<span class="string">&#x27;.&#x27;</span>);     <span class="comment">// 从后往前找到第一个 &#x27;.&#x27; 的位置，即最后一次出现的 &#x27;.&#x27; 的位置</span></span><br><span class="line">            <span class="keyword">if</span> (pos != string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                string left = log_path.<span class="built_in">substr</span>(<span class="number">0</span>, pos);   <span class="comment">// 去掉后缀，即我所需要的有效的前部分路径</span></span><br><span class="line">                string right = log_path.<span class="built_in">substr</span>(pos);     <span class="comment">// 保留后缀，即有效的文件扩展名</span></span><br><span class="line">                Path = left + <span class="string">&quot;_&quot;</span> + <span class="built_in">level_to_string</span>(level) + right;         <span class="comment">// 组合成新的文件名</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                                         <span class="comment">// 如果没有文件扩展名（比如 &quot;./log&quot;），则直接在文件名后面加上 &quot;_等级名.txt&quot;</span></span><br><span class="line">            &#123;</span><br><span class="line">                Path = log_path + <span class="string">&quot;_&quot;</span> + <span class="built_in">level_to_string</span>(level) + <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心写文件函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">log_to_file</span><span class="params">(<span class="type">int</span> level, <span class="type">const</span> string&amp; log_content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string Path;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classification == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Path = <span class="built_in">Suffix_processing</span>(level, log_path);   <span class="comment">// 按照日志等级分类存储</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (classification == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Path = log_path;                             <span class="comment">// 不分类直接使用传入的 log_path</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 追加写入，文件不存在则创建，权限 0644</span></span><br><span class="line">        <span class="type">int</span> fd = <span class="built_in">open</span>(Path.<span class="built_in">c_str</span>(), O_WRONLY | O_CREAT | O_APPEND, <span class="number">0644</span>);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(FIFO_OPEN_ERR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">write</span>(fd, log_content.<span class="built_in">c_str</span>(), log_content.<span class="built_in">size</span>());</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-comm-hpp-文件"><a href="#2-comm-hpp-文件" class="headerlink" title="2. comm.hpp 文件"></a>2. comm.hpp 文件</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Log.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* pathname = <span class="string">&quot;/home/hcc&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> project_id = <span class="number">0x1234</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> shm_size = <span class="number">4096</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIFO_FILE <span class="string">&quot;./myfifo&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODE 0664</span></span><br><span class="line"><span class="function">Log <span class="title">log</span><span class="params">(<span class="number">1</span>, <span class="number">0</span>, <span class="string">&quot;./log.txt&quot;</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取共享内存的key</span></span><br><span class="line"><span class="function"><span class="type">key_t</span> <span class="title">get_key</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">ftok</span>(pathname, project_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;共享内存的key创建失败！&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建共享内存</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">create_shm</span><span class="params">(<span class="type">int</span> flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> shm_id = <span class="built_in">shmget</span>(<span class="built_in">get_key</span>(), shm_size, flag);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(shm_id == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;共享内存创建失败！&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> shm_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只想创建共享内存，如果存在则报错</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">create_shm_only</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">create_shm</span>(IPC_CREAT | IPC_EXCL | <span class="number">0666</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取共享内存，如果不存在则创建</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">get_shm</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">create_shm</span>(IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-processA-cc-文件"><a href="#3-processA-cc-文件" class="headerlink" title="3. processA.cc 文件"></a>3. processA.cc 文件</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;comm.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> shmid = <span class="built_in">create_shm_only</span>();                            <span class="comment">// 创建共享内存（只创建）</span></span><br><span class="line">    <span class="type">char</span> *shmaddr = (<span class="type">char</span> *)<span class="built_in">shmat</span>(shmid, <span class="literal">nullptr</span>, <span class="number">0</span>);         <span class="comment">// 挂接共享内存</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(FIFO_FILE, O_RDONLY);                       <span class="comment">// 打开管道文件</span></span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;打开文件失败！&quot;</span>);</span><br><span class="line">        <span class="built_in">log</span>(Error, <span class="string">&quot;打开文件失败！&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(FIFO_OPEN_ERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">shmid_ds</span> shmds;                                    <span class="comment">// 共享内存信息结构体</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> c;                                               <span class="comment">// 读取字符</span></span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">read</span>(fd, &amp;c, <span class="number">1</span>);                          <span class="comment">// 读取管道文件</span></span><br><span class="line">        <span class="keyword">if</span>(s &lt; <span class="number">0</span> || s == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;客户说：&quot;</span> &lt;&lt; shmaddr &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);                                             <span class="comment">// 模拟业务处理时间，延迟1秒</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">shmctl</span>(shmid, IPC_STAT, &amp;shmds);                      <span class="comment">// 获取共享内存信息</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;段大小: &quot;</span> &lt;&lt; shmds.shm_segsz &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;附着进程数: &quot;</span> &lt;&lt; shmds.shm_nattch &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;传递给进程的键值: 0x%x\n&quot;</span>,  shmds.shm_perm.__key);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;访问模式: &quot;</span> &lt;&lt; shmds.shm_perm.mode &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">shmdt</span>(shmaddr);                                           <span class="comment">// 脱挂共享内存</span></span><br><span class="line">    <span class="built_in">shmctl</span>(shmid, IPC_RMID, <span class="literal">nullptr</span>);                         <span class="comment">// 删除共享内存</span></span><br><span class="line">    <span class="built_in">close</span>(fd);                                                <span class="comment">// 关闭文件描述符</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-processB-cc-文件"><a href="#4-processB-cc-文件" class="headerlink" title="4. processB.cc 文件"></a>4. processB.cc 文件</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;comm.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> shmid = <span class="built_in">get_shm</span>();                                    <span class="comment">// 获取共享内存ID</span></span><br><span class="line">    <span class="type">char</span> *shmaddr = (<span class="type">char</span>*)<span class="built_in">shmat</span>(shmid, <span class="literal">nullptr</span>, <span class="number">0</span>);          <span class="comment">// 挂接共享内存</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(FIFO_FILE, O_WRONLY);                       <span class="comment">// 打开FIFO文件</span></span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;打开文件失败！&quot;</span>);</span><br><span class="line">        <span class="built_in">log</span>(Error, <span class="string">&quot;打开文件失败！&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(FIFO_OPEN_ERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;请输入要发送的消息：&quot;</span>;</span><br><span class="line">        <span class="built_in">fgets</span>(shmaddr, <span class="number">4096</span>, stdin);                          <span class="comment">// 从标准输入读取消息</span></span><br><span class="line">        <span class="built_in">write</span>(fd, <span class="string">&quot;c&quot;</span>, <span class="number">1</span>);                                    <span class="comment">// 发送消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">shmdt</span>(shmaddr);                                           <span class="comment">// 脱挂共享内存</span></span><br><span class="line">    <span class="built_in">close</span>(fd);                                                <span class="comment">// 关闭FIFO文件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-运行示例"><a href="#5-运行示例" class="headerlink" title="5. 运行示例"></a>5. 运行示例</h4><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vY32ziEGc/?spm_id_from=333.1387.upload.video_card.click">System V 共享内存 Demo</a></p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/9524.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://www.minbit.top/posts/9524.html')">034 进程间通信 —— System V 共享内存</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/9524.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=034 进程间通信 —— System V 共享内存&amp;url=https://www.minbit.top/posts/9524.html&amp;pic=https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=310655a6-6c39-cf83-30a5-291a83bcaa41" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">MIT</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">50</span></a><a class="post-meta__box__tags" href="/tags/%E8%BF%9B%E7%A8%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>进程<span class="tagsPageCount">15</span></a><a class="post-meta__box__tags" href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>地址空间<span class="tagsPageCount">6</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125923408.png?_r_=589997d1-2591-0775-e5e3-4f301a7db57f" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/45891.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=f4d324be-3752-4fe5-2898-39794065be9d" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">033 日志</div></div></a></div><div class="next-post pull-right"><a href="/posts/30975.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=edb9b18f-bb9c-4cf8-1feb-25a7389d7a47" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">035 System V 消息队列和信号量（了解）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/28370.html" title="019 进程控制 —— 进程程序替换"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314141714221.png?_r_=2028e6a3-a9d3-6bb2-e21b-afd1282e09aa" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-22</div><div class="title">019 进程控制 —— 进程程序替换</div></div></a></div><div><a href="/posts/15091.html" title="038 进程信号 —— 信号的处理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=f4f69d5d-4e01-0d28-77da-9c353eaae86e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-20</div><div class="title">038 进程信号 —— 信号的处理</div></div></a></div><div><a href="/posts/4610.html" title="011 Linux进程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=b7283d6f-6f3c-334e-3ac0-438795bd22dd" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-24</div><div class="title">011 Linux进程</div></div></a></div><div><a href="/posts/22624.html" title="012 进程状态和优先级"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314130519403.jpg?_r_=53cae4a3-980c-3b1e-7686-d1c380b3ba52" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-26</div><div class="title">012 进程状态和优先级</div></div></a></div><div><a href="/posts/14630.html" title="014 Linux 2.6内核进程调度队列（了解）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314140243649.png?_r_=234ada37-df24-e798-65f5-192dac52f222" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-01</div><div class="title">014 Linux 2.6内核进程调度队列（了解）</div></div></a></div><div><a href="/posts/59037.html" title="017 进程控制 —— 终止进程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125923408.png?_r_=4db6fb89-b05f-5f8c-67bf-cbb8831b1f26" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-11</div><div class="title">017 进程控制 —— 终止进程</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~<br>建议优先查看置顶的 <a href="https://www.minbit.top/posts/17934.html">网站说明</a> 哦~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1-%E2%80%94%E2%80%94-System-V-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">进程间通信 —— System V 共享内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-System-V-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E7%9B%B4%E6%8E%A5%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">1. System V 共享内存的直接原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E2%80%9C%E6%8C%82%E6%8E%A5%E2%80%9D"><span class="toc-number">1.1.1.</span> <span class="toc-text">深入理解 “挂接”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2. 系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ftok-%E2%80%94%E2%80%94-%E7%94%9F%E6%88%90-IPC-key%EF%BC%88%E4%B8%BA%E5%90%8E%E9%9D%A2%E7%9A%84-shmget-%E9%93%BA%E5%9E%AB%EF%BC%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. ftok —— 生成 IPC key（为后面的 shmget 铺垫）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1. 作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ftok-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">2. ftok 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%80%8E%E4%B9%88%E7%94%9F%E6%88%90%EF%BC%9F"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">3. 怎么生成？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">4. 返回值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">5. 示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-shmget-%E2%80%94%E2%80%94-%E5%88%9B%E5%BB%BA-%E8%8E%B7%E5%8F%96%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. shmget —— 创建&#x2F;获取共享内存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%9C%E7%94%A8-1"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">1. 作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-shmget-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2. shmget 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">3. 参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%B8%B8%E7%94%A8%E7%9A%84-shmflg"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">4. 常用的 shmflg</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">5. 返回值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.2.6.</span> <span class="toc-text">6. 示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BA%8C%E8%80%85%E5%85%B3%E7%B3%BB%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 二者关系总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-shmctl-%E2%80%94%E2%80%94-%E5%88%A0%E9%99%A4%EF%BC%88%E6%8E%A7%E5%88%B6-%E7%AE%A1%E7%90%86%EF%BC%89%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. shmctl —— 删除（控制&#x2F;管理）共享内存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-shmctl-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">1. shmctl 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">2. 参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">3. 返回值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shmid-ds-%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">shmid_ds 结构体：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E7%8E%B0%E6%9C%89%E7%9A%84%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">1. 查看系统现有的共享内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">2. 删除指定系统的共享内存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-shmat-%E2%80%94%E2%80%94-%E2%80%9C%E6%8C%82%E6%8E%A5%E5%86%85%E5%AD%98%E2%80%9D"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. shmat —— “挂接内存”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">1. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">2. 作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-1"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">3. 参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-1"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">4. 返回值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-shmdt-%E2%80%94%E2%80%94-%E8%84%B1%E6%8C%82%EF%BC%8C%E9%87%8A%E6%94%BE%E8%99%9A%E6%8B%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E6%98%A0%E5%B0%84"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. shmdt —— 脱挂，释放虚拟空间的映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%9C%E7%94%A8-2"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">1. 作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-2"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">3. 参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-2"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">4. 返回值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-System-V-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%9A%8F%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.</span> <span class="toc-text">3. System V 共享内存的生命周期随内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%A4%BA%E4%BE%8B-Demo"><span class="toc-number">1.4.</span> <span class="toc-text">4. 示例 Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-System-V-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E9%80%9A%E4%BF%A1%E5%AE%8C%E6%95%B4%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. System V 共享内存通信完整步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-System-V-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%9E%8B-Demo"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. System V 共享内存的服务端-客户端模型 Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fgets-%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.3.</span> <span class="toc-text">fgets 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%9C%E7%94%A8-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">1. 作用 &#x2F; 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B-1"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-3"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">3.参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-3"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">4. 返回值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">5. 代码示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Log-hpp-%E6%96%87%E4%BB%B6%EF%BC%88%E4%B9%8B%E5%89%8D%E5%86%99%E7%9A%84%E6%97%A5%E5%BF%97%E6%8F%92%E4%BB%B6%EF%BC%89"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">1. Log.hpp 文件（之前写的日志插件）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-comm-hpp-%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.7.</span> <span class="toc-text">2. comm.hpp 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-processA-cc-%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.8.</span> <span class="toc-text">3. processA.cc 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-processB-cc-%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.9.</span> <span class="toc-text">4. processB.cc 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.3.10.</span> <span class="toc-text">5. 运行示例</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/62772.html" title="050 传输层 —— UDP"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125923408.png?_r_=589997d1-2591-0775-e5e3-4f301a7db57f" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="050 传输层 —— UDP"/></a><div class="content"><a class="title" href="/posts/62772.html" title="050 传输层 —— UDP">050 传输层 —— UDP</a><time datetime="2025-09-12T04:00:00.000Z" title="发表于 2025-09-12 12:00:00">2025-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/34998.html" title="049 HTTPS 协议原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314131841400.png?_r_=d20d13f8-c4a1-3018-7b57-dfc505aaf25a" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="049 HTTPS 协议原理"/></a><div class="content"><a class="title" href="/posts/34998.html" title="049 HTTPS 协议原理">049 HTTPS 协议原理</a><time datetime="2025-08-28T04:00:00.000Z" title="发表于 2025-08-28 12:00:00">2025-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/63840.html" title="048 HTTP 协议"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=d7eeeb88-b375-c1d2-71d2-9fa4ce942e93" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="048 HTTP 协议"/></a><div class="content"><a class="title" href="/posts/63840.html" title="048 HTTP 协议">048 HTTP 协议</a><time datetime="2025-08-25T04:00:00.000Z" title="发表于 2025-08-25 12:00:00">2025-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=6a0bf21f-d544-710a-2354-ef7b6e11acfb" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="047 网络传输基础：TCP 连接建立与数据序列化"/></a><div class="content"><a class="title" href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化">047 网络传输基础：TCP 连接建立与数据序列化</a><time datetime="2025-08-22T04:00:00.000Z" title="发表于 2025-08-22 12:00:00">2025-08-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/40348.html" title="046 网络编程套接字"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314131841400.png?_r_=235af0ea-4273-916a-faeb-502ab2004876" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="046 网络编程套接字"/></a><div class="content"><a class="title" href="/posts/40348.html" title="046 网络编程套接字">046 网络编程套接字</a><time datetime="2025-08-15T04:00:00.000Z" title="发表于 2025-08-15 12:00:00">2025-08-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。","梦想是不会发光的，发光的是追梦的你！"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="哔哩哔哩"/><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="Gitee"/><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN"/><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="稀土掘金"/><span class="back-menu-item-text">稀土掘金</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 0.88rem;">C++<sup>8</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size: 0.88rem;">IO<sup>3</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>50</sup></a><a href="/tags/Obsidian/" style="font-size: 0.88rem;">Obsidian<sup>1</sup></a><a href="/tags/STL/" style="font-size: 0.88rem;">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size: 0.88rem;">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size: 0.88rem;">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size: 0.88rem;">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size: 0.88rem;">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 0.88rem;">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 0.88rem;">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size: 0.88rem;">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size: 0.88rem;">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 0.88rem;">网站<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>6</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 0.88rem;">进程<sup>15</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("01/01/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2025 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-olive-one.vercel.app/',
      // 自己额外添加的：
      path: location.pathname.replace(/index\.html$/, ''),
      
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-olive-one.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-olive-one.vercel.app/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "xiaomilidedamai@minbit.top";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>//- 留言板页面弹幕
window.addEventListener('load', () => {
  const getnaokuo_danmu = () => {
    if (!window.location.pathname.startsWith('/comments/')) return; //- 判断是否是留言板页面
    const naokuo_danmu = async () => {
      const Danmaku = new EasyDanmaku({
        page: '/comments/', //- 即留言板地址
        el: '#danmu-wrap', //- 弹幕挂载节点
        line: 5, //- 弹幕行数
        speed: 20, //- 弹幕播放速度
        hover: true, //- 鼠标hover时是否暂停播放弹幕
        loop: false, //- 开启循环播放
        colourful: true, //- 开启彩色弹幕
        coefficient: 1.38, //- 弹幕密度系数
        runtime: 10, //- 循环弹幕播放时长
      });
      try {
        let danmuStore = saveToLocal.get('twikoo-danmu');
        if (!danmuStore) {
          const options = {
            method: "POST",
            body: JSON.stringify({
              "event": "GET_RECENT_COMMENTS",
              "includeReply": false,
              "pageSize": 100
            }),
            headers: { 'Content-Type': 'application/json' }
          }
          danmuStore = [];
          const response = await fetch(`https://twikoo-olive-one.vercel.app/`, options);
          if (response.ok) {
            const { data } = await response.json();
            //- console.info(data);
            data.forEach(i => {
              if (i.avatar == undefined) i.avatar = 'https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp'
              danmuStore.push({ avatar: i.avatar, content: i.nick + '：' + formatDanmaku(i.comment), url: i.url + '#' + i.id })
            });
            Danmaku.batchSend(danmuStore, true);
            saveToLocal.set('twikoo-danmu', danmuStore, 0.5)
          }
          //- 格式化评论
          function formatDanmaku(str) {
            str = str.replace(/<\/*br>|[\s\uFEFF\xA0]+/g, '');
            str = str.replace(/<img.*?>/g, '[图片]');
            str = str.replace(/<a.*?>.*?<\/a>/g, '[链接]');
            str = str.replace(/<pre.*?>.*?<\/pre>/g, '[代码块]');
            str = str.replace(/<.*?>/g, '');
            return str
          }
        } else {
          Danmaku.batchSend(danmuStore, true);
        }
      } catch (err) {
        console.error("Error fetching data:", err);
      }

      document.getElementById('danmu-Btn') && (document.getElementById('danmu-Btn').innerHTML = `<button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.remove('hide-danmu')">显示弹幕</button> <button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.add('hide-danmu')">隐藏弹幕</button>`)
    }
    (async () => {
      if (typeof EasyDanmaku === 'function') {
        await naokuo_danmu();
      } else {
        const easyDanmakuScript = await getScript('https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js');
        if (typeof EasyDanmaku === 'function') {
          await naokuo_danmu();
        } else {
          console.error('EasyDanmaku function not found even after loading the script.');
        }
      }
    })();
  }
  getnaokuo_danmu()
  document.addEventListener('pjax:complete', getnaokuo_danmu)
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>