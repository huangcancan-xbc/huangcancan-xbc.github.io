<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>035 System V 消息队列和信号量（了解） | 小米里的大麦</title><meta name="keywords" content="Linux,进程"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="035 System V 消息队列和信号量（了解）"><meta name="application-name" content="035 System V 消息队列和信号量（了解）"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="035 System V 消息队列和信号量（了解）"><meta property="og:url" content="https://www.minbit.top/posts/30975.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="System V 消息队列和信号量（了解） 【Linux】进程间通信 4——system V 消息队列，信号量 | CSDN System V IPC —- 消息队列详解 | CSDN 博客 消息队列的视频 &amp;amp; 博文 | YouTobe System V 消息队列（编程接口指南） 信号量机制"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=9617414a-d2ea-5b1d-9006-64d8e9cd0e98"><meta property="article:author" content="小米里的大麦"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=9617414a-d2ea-5b1d-9006-64d8e9cd0e98"><meta name="description" content="System V 消息队列和信号量（了解） 【Linux】进程间通信 4——system V 消息队列，信号量 | CSDN System V IPC —- 消息队列详解 | CSDN 博客 消息队列的视频 &amp;amp; 博文 | YouTobe System V 消息队列（编程接口指南） 信号量机制"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://www.minbit.top/posts/30975.html"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Cd-RTVhRO2mndEhicN2cvLXbsNxPqFC6fSn6ql80eVg"/><meta name="baidu-site-verification" content="codeva-ZG3S9QTvGO"/><meta name="msvalidate.01" content="6DF744D82FE6D1FD11CE18658760B59D"/><meta name="baidu-site-verification" content="codeva-gIjOMzUuhV"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"/><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"友链 + 外链 + 无限进步！欢迎欣赏和贡献！","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"小米里的大麦","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":4,"basicWordCount":1999,"key":"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv","Referer":"https://www.minbit.top/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"Jp8wwGQpp21utaFQ","LingQueMonitorID":"Jp8ztDRrxmTf7LDj"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-olive-one.vercel.app/',
  commentBarrageConfig:{"enable":true,"maxBarrage":10,"barrageTime":5000,"accessToken":"25c96851dd8a790c4819ad4bfbaf153c","mailMd5":"7b12ebc2be80f9159099f6ab0e16573c"},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 小米里的大麦","link":"链接: ","source":"来源: 小米里的大麦","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '小米里的大麦',
  title: '035 System V 消息队列和信号量（了解）',
  postAI: '这篇文章讲述了System V消息队列和信号量，这是UNIX/Linux下的一种进程间通信（IPC）机制，允许不同进程以消息为单位交换数据，消息以先进先出的队列形式组织。System V消息队列通过在内核中维护一个带有类型标记的FIFO队列，实现了同一物理队列内多逻辑队列的分发能力，所有消息存在内核缓冲区，进程间通过`msgsnd`/`msgrcv`异步收发，OS负责元数据管理与调度。消息队列的核心特征包括内核维护队列、消息结构包含类型标签和数据块、队列操作先进先出等。消息队列的原理和系统调用包括`ftok`生成唯一`key_t`、`msgget`创建或打开队列、`msgsnd`发送消息、`msgrcv`接收消息、`msgctl`控制队列等。文章还介绍了信号量机制，用于解决并发环境下多个执行流共享同一份资源时可能出现的数据不一致问题，通过互斥访问保证数据一致性。信号量在旧的书籍中也称信号灯，其本质是一把计数器，类似`int count = n`，它的值代表了可用临界资源的数量，应用程序通过申请和释放这个计数器来间接地申请和释放临界资源。信号量系统调用包括`semget`创建信号量集、`semop`操作信号量、`semctl`控制信号量等。',
  pageFillDescription: 'System V 消息队列和信号量（了解）, 1. 消息队列的原理, 2. 柔性数组, 1. 什么是柔性数组？, 2. System V 消息队列里的体现, 3. 发送时是怎么用的？, 3. 系统调用（类比共享内存中 shmget 等函数）, 1. ftok —— 生成唯一的 key_t供 msgget 使用, 2. msgget —— 创建, 1. 功能, 2. 函数原型, 3. msgflg 常用标志, 4. 返回值, 3. msgsnd —— 发送x2F写操作, 1. 功能, 2. 函数原型, 3. 参数, 4. 返回值, 4. msgrcv —— 接收x2F读操作, 1. 功能, 2. 函数原型, 3. 参数详解, 4. 返回值, 5. msgctl —— 删除（控制）, 1. 功能, 2. 函数原型, 3. 参数详解, 4. 返回值, 4. 代码示例, 1. comm.hpp 文件, 2. consumer.cpp 文件, 3. producer.cpp 文件, 4. 运行示例, 5. 信号量（线程详解）, 1. 背景, 2. 解决方案：互斥访问, 3. 临界资源 amp 临界区, 4. 如何实现互斥？, 5. 小结, 6. 理解信号量, 7. System V 信号量系统调用和使用流程（最难多线程部分详解）, 8. 信号量为什么属于 IPC？消息队列和信号量了解进程间通信消息队列信号量消息队列详解博客消息队列的视频博文消息队列编程接口指南信号量机制讲解消息队列的原理消息队列是下的一种进程间通信机制它允许不同进程以消息为单位交换数据消息以先进先出的队列形式组织异步通信发送者发送后可以立即返回接收者可随时读取消息队列通过在内核中维护一个带有类型标记的队列实现了同一物理队列内多逻辑队列的分发能力所有消息存在内核缓冲区进程间通过异步收发负责元数据管理与调度如果只是一味地读数据进程怎么知道哪些才是应该要读取的数据这就是的意义把一个大变成多条逻辑子队列这也是和单纯的管道的关键区别管道只能消息队列支持过滤类型分发核心特征内核维护队列由操作系统内核创建并管理内存中的消息队列不落盘系统重启消失消息结构每条消息包含正整数类型标签类型标识数据块正文数据用户定义的内容柔性数组队列操作先进先出发送写操作消息追加到队尾基础队列满时默认阻塞支持非阻塞接收读操作按选择性读取读队首消息读匹配类型的第一条消息可打破读类型值的最小类型消息无匹配消息时默认阻塞生命周期与权限独立于进程队列需显式删除否则持久存在通过权限结构读写模式控制访问当中存在多个消息队列自然也需要进行管理这就又是先描述再组织先有数据的抽象描述如再有内核中的组织与管理结构和消息链表柔性数组什么是柔性数组柔性数组简称是引入的一种特殊语法结构体的最后一个成员可以声明为大小未知的数组用来在结构体后面动态附加可变长度的数据作用允许在一个结构体后面连续存放额外的数据而不需要在结构体里写死数组长度消息队列里的体现来看标准定义手册示例消息类型消息正文这里的很多人看到会觉得奇怪为什么写不是写这是典型的柔性数组的老写法在老式库中常这么用因为没有正式的或语法在现代写法里更标准的是正确的柔性数组发送时是怎么用的当调用时内核不会管你写多长它只看你参数里指定的大小所以只是占个位真正的内存是由你自己分配这就是柔性数组的经典用法结构体头动态数据块组成真正的消息消息队列的是一个固定头可变长正文的数据结构本质是柔性数组这让同一个消息结构既可以描述元信息也可以承载变长数据传给内核时内核只看并按字节拷贝消息队列用来封装任意长度的消息内容保证在同一个内存块中连续存储和简化了内核拷贝和用户态对齐系统调用类比共享内存中等函数生成唯一的供使用上一节已经讲过使用方法一模一样就不多赘述了对于下面的同样适用同样的非必须但推荐创建功能创建或打开一个消息队列函数原型常用标志若不存在则创建和一起用若已存在则报错权限位如所有用户可读写所有者读写其他用户只读返回值成功消息队列标识符非负整数失败设置常见错误时队列已存在队列不存在且未指定权限不足发送写操作功能发送消息函数原型参数队列消息结构体指针不包括的消息长度可用非阻塞返回值成功失败设置常见错误非阻塞模式下队列满队列被删除无写权限参数无效接收读操作功能接收消息函数原型参数详解参数含义关键点消息队列得到接收消息的结构体指针正文大小不含要接收的类型表示任意类型标志或返回值成功实际接收的字节数长度失败设置常见错误无匹配消息非阻塞模式消息过大且未指定队列被删除删除控制功能对队列做控制操作常用作删除操作函数原型参数详解常用删除消息队列最常用获取队列状态设置参数返回值成功失败设置常见错误队列已被删除权限不足无效队列如何正确删除消息队列是内核资源如果不显式删除进程结束后也不会自动销毁容易出现僵尸消息队列占用系统表删除队列正确做法查看所有消息队列删除指定的消息队列替换为实际的代码示例文件文件消息类型消息内容队列已删除文件消息发送成功运行示例信号量线程详解背景在并发环境下多进程多线程多个执行流共享同一份资源如共享内存文件缓冲区时若没有同步机制保护就可能出现脏读脏写等现象导致数据不一致例如进程正在往一块共享内存写数据还没写完进程此时读了这块内存读到的是未写完整的半成品数据导致拿到的结果是错误的这就是典型的并发访问导致的数据不一致解决方案互斥访问为了保证数据一致性需要在多个执行流之间做互斥即任何时刻同一份共享资源只能被一个执行流访问这里的访问是指执行对资源有读写影响的那段代码临界资源临界区临界资源指在同一时间内只允许一个执行流访问的资源比如共享内存公共变量公共缓冲区设备等临界区指的是访问临界资源的那段代码也就是整个程序中可能只有几行到几十行代码真正操作共享资源只要保证这段代码是互斥执行的数据就一致如何实现互斥最常用的是加锁锁的作用只允许一个执行流进入临界区其它执行流需要等待锁释放锁的概念暂时还没学放到后面讲小结概念含义共享资源被多个执行流共享且需要保护的资源临界资源需要互斥访问的共享资源临界区访问临界资源的那段代码互斥保证同一时刻仅一个执行流访问临界区加锁实现互斥的一种技术手段理解信号量信号量在旧的书籍中也称信号灯其本质是一把计数器类似类似不代表等于它的值代表了可用临界资源的数量应用程序通过申请操作和释放操作这个计数器来间接地申请和释放临界资源申请操作和释放操作是原子的原子的意思是要么不做要做就做完两态的没有正在做这样的概念生活案例理解信号量和临界资源临界资源里面其实被划分很多小块像一个电影厅个座位它最多就只能卖张票当我们还没去看电影先买票的时候买票的本质就是对资源的预定机制每卖出一张票计数器就减减放映厅里面的资源就减少一个当计数器减到资源已经被申请完毕了信号量模型电影院模型计数器初始值可用资源数初始票数放映厅座位总数比如张票操作计数器买走一张票余票数量若余票则买票成功若余票则排队阻塞操作计数器退票余票若有人在排队就给他一张票唤醒计数器抵达余票卖完后续的买票请求都会被放到队列里直到有人退票如果电影院放映厅里面只有一个座位呢超级我们只需要一个值为的计数器只有一个人能抢到只有一个人能进放映厅看电影看电影期间只有一个执行流在访问临界资源这就是互斥我们把值只能为两态的计数器叫做二元信号量本质就是一个锁互斥锁只有一个买票能成功其它排队等待相当于把个座位合并成个整体座位要么全占要么全空信号量系统调用和使用流程最难多线程部分详解步骤系统调用作用创建获取创建或获取一个信号量集初始化设置初始值如资源总量操作对信号量执行加减操作销毁删除信号量集资源回收信号量为什么属于进程间通信的广义定义是任何让两个或多个独立进程之间交换信息或状态的机制都是信号量本质上是由内核维护的一个计数器集合这块计数器是存在内核内存里和文件描述符一样有唯一的可以被多个进程同时打开读写状态变更会直接影响其他进程是否能继续往下执行所以信号量不是像管道那样直接传递业务数据而是传递同步信息我这边可以不可以用了这种状态的传递本身就是通信理解核心通信不等于一定要传业务数据同步信息本身就是信息例说我写好了听见了就去读这就是一种信号通信信号量是所有需要同步的进程都能看到的通过创建信号量集返回的类似于管道文件描述符多个进程只要相同就能访问同一个信号量集信号量在内核里是全局可见能跨父子进程甚至无亲缘关系的进程只要一样权限对得上所以通信不仅是传数据互相协同也是通信要协同就必须有一块能被所有协同方看见且可修改的共享状态这就是信号量',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-12 12:10:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 10 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/custom/css/font.css"><link rel="stylesheet" href="/custom/css/bilibili.css"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://zycs-img-8kd.pages.dev/v2/bFRjgdX.jpeg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="哔哩哔哩"/><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="Gitee"/><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN"/><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="稀土掘金"/><span class="back-menu-item-text">稀土掘金</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://zycs-img-8kd.pages.dev/v2/REbVGGL.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/REbVGGL.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://zycs-img-8kd.pages.dev/v2/1UUolM0.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/1UUolM0.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>8</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size: 1.05rem;">IO<sup>3</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>50</sup></a><a href="/tags/Obsidian/" style="font-size: 1.05rem;">Obsidian<sup>1</sup></a><a href="/tags/STL/" style="font-size: 1.05rem;">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size: 1.05rem;">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size: 1.05rem;">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size: 1.05rem;">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size: 1.05rem;">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 1.05rem;">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 1.05rem;">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size: 1.05rem;">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size: 1.05rem;">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 1.05rem;">网站<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>6</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 1.05rem;">进程<sup>15</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">10</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div id="console-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a><a class="article-meta__tags" href="/tags/%E8%BF%9B%E7%A8%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>进程</span></a></span></div></div><h1 class="post-title" itemprop="name headline">035 System V 消息队列和信号量（了解）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-07-12T04:10:00.000Z" title="发表于 2025-07-12 12:10:00">2025-07-12</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-07-12T04:10:00.000Z" title="更新于 2025-07-12 12:10:00">2025-07-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">3.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>12分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="035 System V 消息队列和信号量（了解）"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=9617414a-d2ea-5b1d-9006-64d8e9cd0e98"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/30975.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><a href="/tags/%E8%BF%9B%E7%A8%8B/" tabindex="-1" itemprop="url">进程</a><h1 id="CrawlerTitle" itemprop="name headline">035 System V 消息队列和信号量（了解）</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-07-12T04:10:00.000Z" title="发表于 2025-07-12 12:10:00">2025-07-12</time><time itemprop="dateCreated datePublished" datetime="2025-07-12T04:10:00.000Z" title="更新于 2025-07-12 12:10:00">2025-07-12</time></header><h1 id="System-V-消息队列和信号量（了解）"><a href="#System-V-消息队列和信号量（了解）" class="headerlink" title="System V 消息队列和信号量（了解）"></a>System V 消息队列和信号量（了解）</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/2301_80224556/article/details/139770820">【Linux】进程间通信 4——system V 消息队列，信号量 | CSDN</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42511997/article/details/106444445">System V IPC —- 消息队列详解 | CSDN 博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.softprayog.in/programming/interprocess-communication-using-system-v-message-queues-in-linux">消息队列的视频 &amp; 博文 | YouTobe</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19683-01/806-4125/svipc-23310/index.html">System V 消息队列（编程接口指南）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18P41187NV/?spm_id_from=333.337.search-card.all.click">信号量机制讲解</a></p>
</blockquote>
<h2 id="1-消息队列的原理"><a href="#1-消息队列的原理" class="headerlink" title="1. 消息队列的原理"></a>1. 消息队列的原理</h2><p><strong>System V 消息队列</strong> 是 UNIX&#x2F;Linux 下的一种 <strong>进程间通信（IPC）机制</strong>，它允许不同进程以 <strong>消息（message）为单位交换数据</strong>，消息以 <strong>先进先出</strong> 的队列形式组织。<strong>异步通信</strong>：发送者发送后可以立即返回，接收者可随时读取。</p>
<blockquote>
<p>  <strong>System V 消息队列通过在内核中维护一个带有类型标记（<code>mtype</code>）的 FIFO 队列，实现了同一物理队列内多逻辑队列的分发能力，所有消息存在内核缓冲区，进程间通过 <code>msgsnd</code>&#x2F;<code>msgrcv</code> 异步收发，OS 负责元数据管理与调度。</strong></p>
<p>  <em>“如果只是一味地读数据，进程怎么知道哪些才是应该要读取的数据？”</em><br>  这就是 <code>mtype</code> 的意义——把“一个大 FIFO”变成“多条逻辑子队列”。这也是 System V MQ 和单纯的管道（Pipe）的关键区别：<strong>管道只能 FIFO，消息队列支持 FIFO + 过滤 + 类型分发。</strong></p>
</blockquote>
<p>核心特征：</p>
<ol>
<li><strong>内核维护队列</strong>：由操作系统内核创建并管理 <strong>内存中的消息队列</strong>（不落盘，系统重启消失）。</li>
<li><strong>消息结构</strong><ul>
<li>每条消息包含：<ul>
<li><strong><code>mtype</code></strong>：正整数类型标签（类型标识）。</li>
<li><strong><code>mtext</code></strong>：数据块&#x2F;正文数据，用户定义的内容（柔性数组）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>队列操作（先进先出）</strong><ul>
<li><strong>发送&#x2F;写操作 (<code>msgsnd</code>)</strong>：<ul>
<li>消息 <strong>追加到队尾</strong>（FIFO 基础）。</li>
<li>队列满时默认 <strong>阻塞</strong>，支持 <code>IPC_NOWAIT</code> 非阻塞。</li>
</ul>
</li>
<li><strong>接收&#x2F;读操作 (<code>msgrcv</code>)</strong>：<ul>
<li><strong>按 <code>mtype</code> 选择性读取</strong>：<ul>
<li><code>type=0</code>：读队首消息。</li>
<li><code>type&gt;0</code>：读匹配类型的 <strong>第一条消息</strong>（可打破 FIFO）。</li>
<li><code>type&lt;0</code>：读类型值 ≤ <code>|type|</code> 的最小类型消息。</li>
</ul>
</li>
<li>无匹配消息时默认 <strong>阻塞</strong>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>生命周期与权限</strong><ul>
<li><strong>独立于进程</strong>：队列需显式删除（<code>msgctl(IPC_RMID)</code>），否则持久存在。</li>
<li>通过权限结构（UID&#x2F;GID、读写模式）控制访问。</li>
</ul>
</li>
</ol>
<p>当 OS 中存在多个消息队列，OS 自然也需要进行管理，这就又是 <strong>先描述再组织</strong>：先有数据的抽象描述（如 <code>msgbuf</code>），再有内核中的组织与管理（<code>msqid_ds</code> 结构和消息链表）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250709094048435.png" alt="image-20250709094041044"></p>
<h2 id="2-柔性数组"><a href="#2-柔性数组" class="headerlink" title="2. 柔性数组"></a>2. 柔性数组</h2><h3 id="1-什么是“柔性数组”？"><a href="#1-什么是“柔性数组”？" class="headerlink" title="1. 什么是“柔性数组”？"></a>1. 什么是“柔性数组”？</h3><p><strong>柔性数组</strong> 简称 FAM，是 C99 引入的一种特殊语法：<strong>结构体的最后一个成员可以声明为大小未知的数组</strong>，用来在结构体后面动态附加可变长度的数据。<strong>作用：</strong> 允许在一个结构体后面连续存放额外的数据，而不需要在结构体里写死数组长度。</p>
<hr>
<h3 id="2-System-V-消息队列里的体现"><a href="#2-System-V-消息队列里的体现" class="headerlink" title="2. System V 消息队列里的体现"></a>2. System V 消息队列里的体现</h3><p>来看标准定义（man 手册示例）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250709101910590.png" alt="image-20250709101910493"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;    <span class="comment">// 消息类型</span></span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">1</span>]; <span class="comment">// 消息正文</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><em>这里的 <code>mtext[1]</code> 很多人看到会觉得奇怪：为什么写 <code>[1]</code> 不是写 <code>[0]</code>？</em> 这是典型的 <strong>柔性数组的老写法</strong>，在老式 UNIX C 库中常这么用，因为 C90 没有正式的 <code>[0]</code> 或 <code>[]</code> 语法。在现代写法里，更标准的是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[]; <span class="comment">// 正确的 C99 柔性数组</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-发送时是怎么用的？"><a href="#3-发送时是怎么用的？" class="headerlink" title="3. 发送时是怎么用的？"></a>3. 发送时是怎么用的？</h3><ul>
<li><p>当调用 <code>msgsnd</code> 时，<strong>内核不会管你 <code>mtext</code> 写多长</strong>，它只看你 <code>msgsz</code> 参数里指定的大小。</p>
</li>
<li><p>所以 <code>mtext</code> 只是占个位，真正的内存是由你自己分配：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">mymsg</span>* m = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">long</span>) + real_size);</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>这就是柔性数组的经典用法：<strong>结构体头 + 动态数据块</strong>，组成真正的消息。System V 消息队列的 <code>msgbuf</code>：是一个 <strong>固定头（mtype）+ 可变长正文（mtext）</strong> 的数据结构。<code>mtext</code> 本质是柔性数组（FAM）。这让同一个消息结构既可以描述元信息，也可以承载变长数据。传给内核时，内核只看 <code>msgsz</code>，并按字节拷贝。<strong>System V 消息队列用 FAM 来封装任意长度的消息内容，保证 <code>msgbuf</code> 在同一个内存块中连续存储 mtype 和 mtext，简化了内核拷贝和用户态对齐。</strong></p>
</blockquote>
<hr>
<h2 id="3-系统调用（类比共享内存中-shmget-等函数）"><a href="#3-系统调用（类比共享内存中-shmget-等函数）" class="headerlink" title="3. 系统调用（类比共享内存中 shmget 等函数）"></a>3. 系统调用（类比共享内存中 <code>shmget</code> 等函数）</h2><h3 id="1-ftok-——-生成唯一的-key-t，供-msgget-使用"><a href="#1-ftok-——-生成唯一的-key-t，供-msgget-使用" class="headerlink" title="1. ftok —— 生成唯一的 key_t，供 msgget 使用"></a>1. <code>ftok</code> —— 生成唯一的 <code>key_t</code>，供 <code>msgget</code> 使用</h3><p>上一节已经讲过 <code>ftok</code>，使用方法一模一样就不多赘述了，对于下面的 <code>msgget</code> 同样适用，同样的 <strong>非必须但推荐</strong>！</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">key_t</span> <span class="title">ftok</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> proj_id)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-msgget-——-创建"><a href="#2-msgget-——-创建" class="headerlink" title="2. msgget —— 创建"></a>2. <code>msgget</code> —— 创建</h3><h4 id="1-功能"><a href="#1-功能" class="headerlink" title="1. 功能"></a>1. 功能</h4><p>创建或打开一个消息队列。</p>
<h4 id="2-函数原型"><a href="#2-函数原型" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">msgget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-msgflg-常用标志"><a href="#3-msgflg-常用标志" class="headerlink" title="3. msgflg 常用标志"></a>3. <code>msgflg</code> 常用标志</h4><ul>
<li><code>IPC_CREAT</code>：若不存在则创建。</li>
<li><code>IPC_EXCL</code>：和 <code>IPC_CREAT</code> 一起用，若已存在则报错。</li>
<li>权限位如 <code>0666</code>（所有用户可读写），<code>0644</code>（所有者读写，其他用户只读）。</li>
</ul>
<h4 id="4-返回值"><a href="#4-返回值" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li><strong>成功</strong>：消息队列标识符（非负整数）。</li>
<li><strong>失败</strong>：-1，设置 <code>errno</code>。常见错误：<ul>
<li><code>EEXIST</code>：<code>IPC_CREAT|IPC_EXCL</code> 时队列已存在。</li>
<li><code>ENOENT</code>：队列不存在且未指定 <code>IPC_CREAT</code>。</li>
<li><code>EACCES</code>：权限不足。</li>
</ul>
</li>
</ul>
<h3 id="3-msgsnd-——-发送-写操作"><a href="#3-msgsnd-——-发送-写操作" class="headerlink" title="3. msgsnd —— 发送&#x2F;写操作"></a>3. <code>msgsnd</code> —— 发送&#x2F;写操作</h3><h4 id="1-功能-1"><a href="#1-功能-1" class="headerlink" title="1. 功能"></a>1. 功能</h4><p>发送消息。</p>
<h4 id="2-函数原型-1"><a href="#2-函数原型-1" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">msgsnd</span><span class="params">(<span class="type">int</span> msqid, <span class="type">const</span> <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-参数"><a href="#3-参数" class="headerlink" title="3. 参数"></a>3. 参数</h4><ul>
<li><code>msqid</code>：队列 ID。</li>
<li><code>msgp</code>：消息结构体指针。</li>
<li><code>msgsz</code>：不包括 <code>mtype</code> 的消息长度。</li>
<li><code>msgflg</code>：可用 <code>IPC_NOWAIT</code> 非阻塞。</li>
</ul>
<h4 id="4-返回值-1"><a href="#4-返回值-1" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li><strong>成功</strong>：0</li>
<li><strong>失败</strong>：-1，设置 <code>errno</code>。常见错误：<ul>
<li><code>EAGAIN</code>：非阻塞模式下队列满。</li>
<li><code>EIDRM</code>：队列被删除。</li>
<li><code>EACCES</code>：无写权限。</li>
<li><code>EINVAL</code>：参数无效。</li>
</ul>
</li>
</ul>
<h3 id="4-msgrcv-——-接收-读操作"><a href="#4-msgrcv-——-接收-读操作" class="headerlink" title="4. msgrcv —— 接收&#x2F;读操作"></a>4. <code>msgrcv</code> —— 接收&#x2F;读操作</h3><h4 id="1-功能-2"><a href="#1-功能-2" class="headerlink" title="1. 功能"></a>1. 功能</h4><p>接收消息。</p>
<h4 id="2-函数原型-2"><a href="#2-函数原型-2" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">msgrcv</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> mtype, <span class="type">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-参数详解"><a href="#3-参数详解" class="headerlink" title="3. 参数详解"></a>3. 参数详解</h4><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
<th>关键点</th>
</tr>
</thead>
<tbody><tr>
<td><code>msqid</code></td>
<td>消息队列 ID</td>
<td><code>msgget</code> 得到</td>
</tr>
<tr>
<td><code>msgp</code></td>
<td>接收消息的结构体指针</td>
<td><code>msgbuf*</code></td>
</tr>
<tr>
<td><code>msgsz</code></td>
<td>正文大小（<strong>不含 mtype</strong>）</td>
<td><code>sizeof(mtext)</code></td>
</tr>
<tr>
<td><code>mtype</code></td>
<td>要接收的类型</td>
<td><code>0</code> 表示任意类型</td>
</tr>
<tr>
<td><code>msgflg</code></td>
<td>标志</td>
<td><code>0</code> 或 <code>IPC_NOWAIT</code></td>
</tr>
</tbody></table>
<h4 id="4-返回值-2"><a href="#4-返回值-2" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li><strong>成功</strong>：实际接收的字节数（<code>mtext</code> 长度）</li>
<li><strong>失败</strong>：-1，设置 <code>errno</code>。常见错误：<ul>
<li><code>ENOMSG</code>：无匹配消息（非阻塞模式）。</li>
<li><code>E2BIG</code>：消息过大且未指定 <code>MSG_NOERROR</code>。</li>
<li><code>EIDRM</code>：队列被删除。</li>
</ul>
</li>
</ul>
<h3 id="5-msgctl-——-删除（控制）"><a href="#5-msgctl-——-删除（控制）" class="headerlink" title="5. msgctl —— 删除（控制）"></a>5. <code>msgctl</code> —— 删除（控制）</h3><h4 id="1-功能-3"><a href="#1-功能-3" class="headerlink" title="1. 功能"></a>1. 功能</h4><p>对队列做控制操作。常用作删除操作。</p>
<h4 id="2-函数原型-3"><a href="#2-函数原型-3" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">msgctl</span><span class="params">(<span class="type">int</span> msqid, <span class="type">int</span> cmd, <span class="keyword">struct</span> msqid_ds *buf)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-参数详解-1"><a href="#3-参数详解-1" class="headerlink" title="3. 参数详解"></a>3. 参数详解</h4><p><strong>常用 <code>cmd</code>：</strong></p>
<ul>
<li><code>IPC_RMID</code>：删除消息队列（最常用）。</li>
<li><code>IPC_STAT</code>：获取队列状态。</li>
<li><code>IPC_SET</code>：设置参数。</li>
</ul>
<h4 id="4-返回值-3"><a href="#4-返回值-3" class="headerlink" title="4. 返回值"></a>4. 返回值</h4><ul>
<li><strong>成功</strong>：0。</li>
<li><strong>失败</strong>：-1，设置 <code>errno</code>。常见错误：<ul>
<li><code>EIDRM</code>：队列已被删除。</li>
<li><code>EPERM</code>：权限不足。</li>
<li><code>EINVAL</code>：无效队列 ID。</li>
</ul>
</li>
</ul>
<p><strong>如何正确删除？</strong></p>
<p>消息队列是内核资源，如果 <strong>不显式删除</strong>：</p>
<ul>
<li>进程结束后也不会自动销毁</li>
<li>容易出现“僵尸消息队列”，占用系统 IPC 表</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">msgctl</span>(msqid, IPC_RMID, <span class="literal">NULL</span>); 		<span class="comment">// 删除队列正确做法</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>查看所有消息队列：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;ipcs -q</span><br></pre></td></tr></table></figure>

<p><strong>删除指定 ID 的消息队列：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;ipcrm -q 65536  <span class="comment"># 替换为实际的 msqid</span></span><br></pre></td></tr></table></figure></blockquote>
<hr>
<h2 id="4-代码示例"><a href="#4-代码示例" class="headerlink" title="4. 代码示例"></a>4. 代码示例</h2><h3 id="1-comm-hpp-文件"><a href="#1-comm-hpp-文件" class="headerlink" title="1. comm.hpp 文件"></a>1. comm.hpp 文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">my_msgbuf</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> key = <span class="built_in">ftok</span>(<span class="string">&quot;./comm.hpp&quot;</span>, <span class="number">66</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-consumer-cpp-文件"><a href="#2-consumer-cpp-文件" class="headerlink" title="2. consumer.cpp 文件"></a>2. consumer.cpp 文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;comm.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="type">key_t</span> = key;</span><br><span class="line">    <span class="type">int</span> msgid = <span class="built_in">msgget</span>(<span class="type">key_t</span>, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(msgid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;msgget failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    my_msgbuf msg;</span><br><span class="line">    <span class="built_in">msgrcv</span>(msgid, &amp;msg, <span class="built_in">sizeof</span>(msg), <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;消息类型：&quot;</span> &lt;&lt; msg.mtype &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;消息内容：&quot;</span> &lt;&lt; msg.mtext &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">msgctl</span>(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;队列已删除&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-producer-cpp-文件"><a href="#3-producer-cpp-文件" class="headerlink" title="3. producer.cpp 文件"></a>3. producer.cpp 文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;comm.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="type">key_t</span> = key;</span><br><span class="line">    <span class="type">int</span> msgid = <span class="built_in">msgget</span>(<span class="type">key_t</span>, IPC_CREAT | <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(msgid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;msgget failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    my_msgbuf msg;</span><br><span class="line">    msg.mtype = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(msg.mtext, <span class="string">&quot;Hello, linux!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">msgsnd</span>(msgid, &amp;msg, <span class="built_in">sizeof</span>(msg), IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;msgsnd failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;消息发送成功！&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-运行示例"><a href="#4-运行示例" class="headerlink" title="4. 运行示例"></a>4. 运行示例</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250714130645593.png" alt="image-20250714130637935"></p>
<hr>
<h2 id="5-信号量（线程详解）"><a href="#5-信号量（线程详解）" class="headerlink" title="5. 信号量（线程详解）"></a>5. 信号量（线程详解）</h2><h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>在并发环境下（多进程、多线程），<strong>多个执行流共享同一份资源</strong>（如共享内存、文件、缓冲区）时，<strong>若没有同步机制保护</strong>，就可能出现 <strong>脏读、脏写</strong> 等现象，导致 <strong>数据不一致</strong>。</p>
<p>例如：</p>
<ul>
<li>进程 A 正在往一块共享内存写数据，还没写完；</li>
<li>进程 B 此时读了这块内存，读到的是 <strong>未写完整</strong> 的半成品数据；</li>
<li>导致 B 拿到的结果是错误的。</li>
</ul>
<p>这就是典型的 <strong>并发访问导致的数据不一致</strong>。</p>
<h3 id="2-解决方案：互斥访问"><a href="#2-解决方案：互斥访问" class="headerlink" title="2. 解决方案：互斥访问"></a>2. 解决方案：互斥访问</h3><p>为了保证数据一致性，需要在多个执行流之间做 <strong>互斥</strong>，即：</p>
<ul>
<li>任何时刻 <strong>同一份共享资源</strong> 只能被 <strong>一个执行流访问</strong>。</li>
<li>这里的“访问”是指执行对资源有读&#x2F;写影响的那段代码。</li>
</ul>
<hr>
<h3 id="3-临界资源-临界区"><a href="#3-临界资源-临界区" class="headerlink" title="3. 临界资源 &amp; 临界区"></a>3. 临界资源 &amp; 临界区</h3><p><strong>临界资源：</strong> 指在同一时间内，只允许一个执行流访问的资源，比如：</p>
<ul>
<li>共享内存</li>
<li>公共变量</li>
<li>公共缓冲区</li>
<li>I&#x2F;O 设备 等</li>
</ul>
<p><strong>临界区：</strong> 指的是 <strong>访问临界资源的那段代码</strong>，也就是：</p>
<ul>
<li>整个程序中，可能只有几行到几十行代码真正操作共享资源；</li>
<li>只要保证这段代码是 <strong>互斥执行</strong> 的，数据就一致！</li>
</ul>
<h3 id="4-如何实现互斥？"><a href="#4-如何实现互斥？" class="headerlink" title="4. 如何实现互斥？"></a>4. 如何实现互斥？</h3><p>最常用的是 <strong>加锁</strong>，锁的作用：<strong>只允许一个执行流进入临界区</strong>，其它执行流需要等待锁释放。锁的概念暂时还没学，<strong>放到后面讲</strong>。</p>
<hr>
<h3 id="5-小结"><a href="#5-小结" class="headerlink" title="5. 小结"></a>5. 小结</h3><table>
<thead>
<tr>
<th>概念</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>共享资源</td>
<td>被多个执行流共享，且需要保护的资源</td>
</tr>
<tr>
<td>临界资源</td>
<td>需要互斥访问的共享资源</td>
</tr>
<tr>
<td><strong>临界区</strong></td>
<td><strong>访问临界资源的那段代码</strong></td>
</tr>
<tr>
<td><strong>互斥</strong></td>
<td><strong>保证同一时刻仅一个执行流访问临界区</strong></td>
</tr>
<tr>
<td>加锁</td>
<td>实现互斥的一种技术手段</td>
</tr>
</tbody></table>
<h3 id="6-理解信号量"><a href="#6-理解信号量" class="headerlink" title="6. 理解信号量"></a>6. 理解信号量</h3><p>信号量在旧的书籍中也称信号灯，其本质是一把计数器，类似 <code>int count = n</code>（<strong>类似不代表等于！</strong>）。</p>
<ul>
<li>它的值代表了 <strong>可用临界资源</strong> 的数量。</li>
<li>应用程序通过 <strong>申请（P 操作）</strong> 和 <strong>释放（V 操作）</strong> 这个计数器来间接地申请和释放临界资源。</li>
</ul>
<blockquote>
<p><strong>申请（P 操作）</strong> 和 <strong>释放（V 操作）</strong> 是 <strong>原子的</strong>！原子的意思是：要么不做，要做就做完 —— 两态的，没有“正在做”这样的概念。</p>
</blockquote>
<p><strong>生活案例理解信号量和临界资源：</strong> 临界资源里面其实被划分很多小块，像一个电影厅 100 个座位，它最多就只能卖 100 张票，当我们还没去看电影先买票的时候，买票的本质就是对资源的预定机制，每卖出一张票，计数器就减减，放映厅里面的资源就减少一个，当计数器减到 0，资源已经被申请完毕了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250714163330329.png" alt="image-20250714163330205"></p>
<table>
<thead>
<tr>
<th>信号量模型</th>
<th>电影院模型</th>
</tr>
</thead>
<tbody><tr>
<td>计数器初始值 &#x3D; 可用资源数</td>
<td>初始票数 &#x3D; 放映厅座位总数（比如 100 张票）</td>
</tr>
<tr>
<td>P 操作（wait）→ 计数器–1</td>
<td>买走一张票 → 余票数量 –1；若余票 &gt; 0，则买票成功；若余票 &#x3D; 0，则排队（阻塞）</td>
</tr>
<tr>
<td>V 操作（signal）→ 计数器+1</td>
<td>退票 → 余票 +1；若有人在排队，就给他一张票（唤醒）</td>
</tr>
<tr>
<td>计数器 抵达 0</td>
<td>余票卖完，后续的买票请求都会被放到队列里，直到有人退票</td>
</tr>
</tbody></table>
<p>如果电影院放映厅里面只有一个座位呢（超级 vip）？我们只需要一个值为 1 的计数器，只有一个人能抢到，只有一个人能进放映厅看电影，看电影期间只有一个执行流在访问临界资源，这就是互斥，我们把值只能为 1，0 两态的计数器叫做 <strong>二元信号量</strong>，本质就是一个 <strong>锁</strong>（互斥锁）。</p>
<ul>
<li>只有一个买票（P）能成功，其它排队等待；</li>
<li>相当于把“100 个座位”合并成“1 个整体座位”，要么全占，要么全空。</li>
</ul>
<h3 id="7-System-V-信号量系统调用和使用流程（最难，多线程部分详解）"><a href="#7-System-V-信号量系统调用和使用流程（最难，多线程部分详解）" class="headerlink" title="7. System V 信号量系统调用和使用流程（最难，多线程部分详解）"></a>7. System V 信号量系统调用和使用流程（最难，多线程部分详解）</h3><table>
<thead>
<tr>
<th>步骤</th>
<th>系统调用</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>创建&#x2F;获取</td>
<td><code>semget()</code></td>
<td>创建或获取一个信号量集</td>
</tr>
<tr>
<td>初始化</td>
<td><code>semctl()</code></td>
<td>设置初始值（如资源总量）</td>
</tr>
<tr>
<td>P&#x2F;V 操作</td>
<td><code>semop()</code></td>
<td>对信号量执行加减操作</td>
</tr>
<tr>
<td>销毁</td>
<td><code>semctl()</code></td>
<td>删除信号量集（资源回收）</td>
</tr>
</tbody></table>
<h3 id="8-信号量为什么属于-IPC？"><a href="#8-信号量为什么属于-IPC？" class="headerlink" title="8. 信号量为什么属于 IPC？"></a>8. 信号量为什么属于 IPC？</h3><p><strong>进程间通信（IPC）</strong> 的广义定义是：“<strong>任何让两个或多个独立进程之间交换信息或状态</strong> 的机制，都是 IPC。”</p>
<p>信号量（System V）本质上是 <strong>由内核维护的一个计数器集合</strong>，这块计数器是：</p>
<ul>
<li>存在内核内存里（和文件描述符一样，有唯一的 <code>semid</code>）。</li>
<li>可以被 <strong>多个进程同时打开、读写</strong>。</li>
<li>状态变更（P&#x2F;V）会直接影响其他进程是否能继续往下执行。</li>
</ul>
<p>所以信号量不是像管道那样直接“传递业务数据”，而是“传递同步信息”：“我这边可以&#x2F;不可以用了！”<strong>这种状态的传递本身就是通信</strong>。</p>
<p><strong>理解核心：</strong></p>
<ol>
<li><p><strong>通信不等于一定要传业务数据</strong>，同步信息本身就是信息。</p>
<ul>
<li>例：A 说“我写好了”，B 听见了就去读 → 这就是一种“信号通信”。</li>
</ul>
</li>
<li><p>信号量是 <strong>所有需要同步的进程都能看到的</strong>：</p>
<ul>
<li><p>通过 <code>semget()</code> 创建信号量集，返回的 <code>semid</code> 类似于管道文件描述符，多个进程只要 <code>ftok</code> + <code>semget</code> 相同，就能访问同一个信号量集。</p>
</li>
<li><p>信号量在内核里是全局可见，能跨父子进程，甚至无亲缘关系的进程（只要 key 一样，权限对得上）。</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>所以：通信不仅是传数据，互相协同也是通信。要协同，就必须有一块能被所有协同方看见、且可修改的共享状态，这就是信号量。</strong></p>
</blockquote>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/bFRjgdX.jpeg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/bFRjgdX.jpeg" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/30975.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://www.minbit.top/posts/30975.html')">035 System V 消息队列和信号量（了解）</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://zycs-img-8kd.pages.dev/v2/REbVGGL.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/REbVGGL.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://zycs-img-8kd.pages.dev/v2/1UUolM0.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/1UUolM0.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/30975.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=035 System V 消息队列和信号量（了解）&amp;url=https://www.minbit.top/posts/30975.html&amp;pic=https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=9617414a-d2ea-5b1d-9006-64d8e9cd0e98" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">50</span></a><a class="post-meta__box__tags" href="/tags/%E8%BF%9B%E7%A8%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>进程<span class="tagsPageCount">15</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=c529c723-4b01-5bf8-fe19-d1438fd9563d" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/9524.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/aKlysyx.png?_r_=9f8646cf-93a6-8545-fb05-b0ee5ef95126" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">034 进程间通信 —— System V 共享内存</div></div></a></div><div class="next-post pull-right"><a href="/posts/62794.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/uH1MN2u.png?_r_=0ac5cd0c-cc23-3aee-c66b-aa07286be0fa" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">036 进程信号 —— 信号的产生</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/4610.html" title="011 Linux进程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/uH1MN2u.png?_r_=d8aca62d-f18a-5698-334e-3d14589b8ae1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-24</div><div class="title">011 Linux进程</div></div></a></div><div><a href="/posts/22624.html" title="012 进程状态和优先级"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=8e155880-809b-e75c-f6b5-d0e4dc7c05aa" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-26</div><div class="title">012 进程状态和优先级</div></div></a></div><div><a href="/posts/14630.html" title="014 Linux 2.6内核进程调度队列（了解）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=5eede737-a0bb-6d1d-9df9-52d9e557bac4" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-01</div><div class="title">014 Linux 2.6内核进程调度队列（了解）</div></div></a></div><div><a href="/posts/9600.html" title="016 进程控制 —— 进程创建"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/Jci6x23.png?_r_=faf0f95a-4ae7-bd43-55ff-7aab839ee21e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-05</div><div class="title">016 进程控制 —— 进程创建</div></div></a></div><div><a href="/posts/59037.html" title="017 进程控制 —— 终止进程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=1cb838ba-0266-6cab-1050-784f5fac1b2b" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-11</div><div class="title">017 进程控制 —— 终止进程</div></div></a></div><div><a href="/posts/28370.html" title="019 进程控制 —— 进程程序替换"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/Jci6x23.png?_r_=170c9974-b1a2-cbc8-b7b1-cbb058ba500a" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-22</div><div class="title">019 进程控制 —— 进程程序替换</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/bFRjgdX.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><span>👋🏻 Hi，我是 <a target="_blank" href="https://huangcancan-xbc.github.io" rel="external nofollow noreferrer noopener" style="font-weight:bold; font-size:1.1em; color:#5166f0;">小米里的大麦</a>，欢迎来看我的博客鸭！</span><br>
<span>👉 建议优先查看置顶的 <a target="_blank" href="https://huangcancan-xbc.github.io/posts/17934.html" rel="external nofollow noreferrer noopener" style="font-weight:bold; font-size:1.1em; color:#5166f0;">网站说明</a>，如有问题欢迎评论区交流！</span><br>
<span>😫 页面异常？尝试<kbd>Ctrl</kbd>+<kbd>F5</kbd></span><br>
<span>📩 联系我：<a href="mailto:hc1960074081@qq.com" rel="external nofollow noreferrer"><b>给我发送邮件🚀</b></a></span>  
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#System-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8C%E4%BF%A1%E5%8F%B7%E9%87%8F%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">System V 消息队列和信号量（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">1. 消息队列的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9F%94%E6%80%A7%E6%95%B0%E7%BB%84"><span class="toc-number">1.2.</span> <span class="toc-text">2. 柔性数组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E2%80%9C%E6%9F%94%E6%80%A7%E6%95%B0%E7%BB%84%E2%80%9D%EF%BC%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 什么是“柔性数组”？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-System-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%87%8C%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. System V 消息队列里的体现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%91%E9%80%81%E6%97%B6%E6%98%AF%E6%80%8E%E4%B9%88%E7%94%A8%E7%9A%84%EF%BC%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 发送时是怎么用的？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%88%E7%B1%BB%E6%AF%94%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E4%B8%AD-shmget-%E7%AD%89%E5%87%BD%E6%95%B0%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">3. 系统调用（类比共享内存中 shmget 等函数）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ftok-%E2%80%94%E2%80%94-%E7%94%9F%E6%88%90%E5%94%AF%E4%B8%80%E7%9A%84-key-t%EF%BC%8C%E4%BE%9B-msgget-%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. ftok —— 生成唯一的 key_t，供 msgget 使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-msgget-%E2%80%94%E2%80%94-%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. msgget —— 创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1. 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-msgflg-%E5%B8%B8%E7%94%A8%E6%A0%87%E5%BF%97"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. msgflg 常用标志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">4. 返回值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-msgsnd-%E2%80%94%E2%80%94-%E5%8F%91%E9%80%81-%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. msgsnd —— 发送&#x2F;写操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD-1"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">1. 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B-1"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3. 参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-1"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">4. 返回值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-msgrcv-%E2%80%94%E2%80%94-%E6%8E%A5%E6%94%B6-%E8%AF%BB%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. msgrcv —— 接收&#x2F;读操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD-2"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">1. 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B-2"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">3. 参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-2"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">4. 返回值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-msgctl-%E2%80%94%E2%80%94-%E5%88%A0%E9%99%A4%EF%BC%88%E6%8E%A7%E5%88%B6%EF%BC%89"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. msgctl —— 删除（控制）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD-3"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">1. 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B-3"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3-1"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">3. 参数详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-3"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">4. 返回值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">4. 代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-comm-hpp-%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. comm.hpp 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-consumer-cpp-%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. consumer.cpp 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-producer-cpp-%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. producer.cpp 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.4.</span> <span class="toc-text">4. 运行示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BF%A1%E5%8F%B7%E9%87%8F%EF%BC%88%E7%BA%BF%E7%A8%8B%E8%AF%A6%E8%A7%A3%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">5. 信号量（线程详解）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%83%8C%E6%99%AF"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E4%BA%92%E6%96%A5%E8%AE%BF%E9%97%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 解决方案：互斥访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%B4%E7%95%8C%E8%B5%84%E6%BA%90-%E4%B8%B4%E7%95%8C%E5%8C%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 临界资源 &amp; 临界区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9F"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 如何实现互斥？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%B0%8F%E7%BB%93"><span class="toc-number">1.5.5.</span> <span class="toc-text">5. 小结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%90%86%E8%A7%A3%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">1.5.6.</span> <span class="toc-text">6. 理解信号量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-System-V-%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8C%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B%EF%BC%88%E6%9C%80%E9%9A%BE%EF%BC%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%83%A8%E5%88%86%E8%AF%A6%E8%A7%A3%EF%BC%89"><span class="toc-number">1.5.7.</span> <span class="toc-text">7. System V 信号量系统调用和使用流程（最难，多线程部分详解）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E4%BF%A1%E5%8F%B7%E9%87%8F%E4%B8%BA%E4%BB%80%E4%B9%88%E5%B1%9E%E4%BA%8E-IPC%EF%BC%9F"><span class="toc-number">1.5.8.</span> <span class="toc-text">8. 信号量为什么属于 IPC？</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/62772.html" title="050 传输层 —— UDP"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=2f802891-8784-4ddb-e5bd-9d61b1397323" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="050 传输层 —— UDP"/></a><div class="content"><a class="title" href="/posts/62772.html" title="050 传输层 —— UDP">050 传输层 —— UDP</a><time datetime="2025-09-12T04:00:00.000Z" title="发表于 2025-09-12 12:00:00">2025-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/34998.html" title="049 HTTPS 协议原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=c529c723-4b01-5bf8-fe19-d1438fd9563d" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="049 HTTPS 协议原理"/></a><div class="content"><a class="title" href="/posts/34998.html" title="049 HTTPS 协议原理">049 HTTPS 协议原理</a><time datetime="2025-08-28T04:00:00.000Z" title="发表于 2025-08-28 12:00:00">2025-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/63840.html" title="048 HTTP 协议"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/aKlysyx.png?_r_=6011401b-b224-1423-1a89-ceeead1936d4" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="048 HTTP 协议"/></a><div class="content"><a class="title" href="/posts/63840.html" title="048 HTTP 协议">048 HTTP 协议</a><time datetime="2025-08-25T04:00:00.000Z" title="发表于 2025-08-25 12:00:00">2025-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/Jci6x23.png?_r_=c7a9f229-9f6b-3f2e-87d5-e6ca5316f5f5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="047 网络传输基础：TCP 连接建立与数据序列化"/></a><div class="content"><a class="title" href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化">047 网络传输基础：TCP 连接建立与数据序列化</a><time datetime="2025-08-22T04:00:00.000Z" title="发表于 2025-08-22 12:00:00">2025-08-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/40348.html" title="046 网络编程套接字"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=c35415b9-7cc5-c591-5bcd-f604827a0a65" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="046 网络编程套接字"/></a><div class="content"><a class="title" href="/posts/40348.html" title="046 网络编程套接字">046 网络编程套接字</a><time datetime="2025-08-15T04:00:00.000Z" title="发表于 2025-08-15 12:00:00">2025-08-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/bFRjgdX.jpeg" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。","梦想是不会发光的，发光的是追梦的你！","答案在风中飘扬"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="哔哩哔哩"/><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="Gitee"/><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN"/><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="稀土掘金"/><span class="back-menu-item-text">稀土掘金</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 0.88rem;">C++<sup>8</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size: 0.88rem;">IO<sup>3</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>50</sup></a><a href="/tags/Obsidian/" style="font-size: 0.88rem;">Obsidian<sup>1</sup></a><a href="/tags/STL/" style="font-size: 0.88rem;">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size: 0.88rem;">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size: 0.88rem;">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size: 0.88rem;">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size: 0.88rem;">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 0.88rem;">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 0.88rem;">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size: 0.88rem;">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size: 0.88rem;">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 0.88rem;">网站<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>6</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 0.88rem;">进程<sup>15</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight, 500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("01/01/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `这里是 小米里的大麦`,
    `芝兰生于深谷，不以无人而不芳。`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2025 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-olive-one.vercel.app/',
      // 自己额外添加的：
      path: location.pathname.replace(/index\.html$/, ''),
      
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-olive-one.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-olive-one.vercel.app/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "xiaomilidedamai@minbit.top";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>//- 留言板页面弹幕
window.addEventListener('load', () => {
  const getnaokuo_danmu = () => {
    if (!window.location.pathname.startsWith('/comments/')) return; //- 判断是否是留言板页面
    const naokuo_danmu = async () => {
      const Danmaku = new EasyDanmaku({
        page: '/comments/', //- 即留言板地址
        el: '#danmu-wrap', //- 弹幕挂载节点
        line: 5, //- 弹幕行数
        speed: 20, //- 弹幕播放速度
        hover: true, //- 鼠标hover时是否暂停播放弹幕
        loop: false, //- 开启循环播放
        colourful: true, //- 开启彩色弹幕
        coefficient: 1.38, //- 弹幕密度系数
        runtime: 10, //- 循环弹幕播放时长
      });
      try {
        let danmuStore = saveToLocal.get('twikoo-danmu');
        if (!danmuStore) {
          const options = {
            method: "POST",
            body: JSON.stringify({
              "event": "GET_RECENT_COMMENTS",
              "includeReply": false,
              "pageSize": 100
            }),
            headers: { 'Content-Type': 'application/json' }
          }
          danmuStore = [];
          const response = await fetch(`https://twikoo-olive-one.vercel.app/`, options);
          if (response.ok) {
            const { data } = await response.json();
            //- console.info(data);
            data.forEach(i => {
              if (i.avatar == undefined) i.avatar = 'https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp'
              danmuStore.push({ avatar: i.avatar, content: i.nick + '：' + formatDanmaku(i.comment), url: i.url + '#' + i.id })
            });
            Danmaku.batchSend(danmuStore, true);
            saveToLocal.set('twikoo-danmu', danmuStore, 0.5)
          }
          //- 格式化评论
          function formatDanmaku(str) {
            str = str.replace(/<\/*br>|[\s\uFEFF\xA0]+/g, '');
            str = str.replace(/<img.*?>/g, '[图片]');
            str = str.replace(/<a.*?>.*?<\/a>/g, '[链接]');
            str = str.replace(/<pre.*?>.*?<\/pre>/g, '[代码块]');
            str = str.replace(/<.*?>/g, '');
            return str
          }
        } else {
          Danmaku.batchSend(danmuStore, true);
        }
      } catch (err) {
        console.error("Error fetching data:", err);
      }

      document.getElementById('danmu-Btn') && (document.getElementById('danmu-Btn').innerHTML = `<button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.remove('hide-danmu')">显示弹幕</button> <button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.add('hide-danmu')">隐藏弹幕</button>`)
    }
    (async () => {
      if (typeof EasyDanmaku === 'function') {
        await naokuo_danmu();
      } else {
        const easyDanmakuScript = await getScript('https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js');
        if (typeof EasyDanmaku === 'function') {
          await naokuo_danmu();
        } else {
          console.error('EasyDanmaku function not found even after loading the script.');
        }
      }
    })();
  }
  getnaokuo_danmu()
  document.addEventListener('pjax:complete', getnaokuo_danmu)
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>