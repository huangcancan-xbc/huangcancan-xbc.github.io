<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>042 生产者 - 消费者模型 | 小米里的大麦</title><meta name="keywords" content="Linux"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="042 生产者 - 消费者模型"><meta name="application-name" content="042 生产者 - 消费者模型"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="042 生产者 - 消费者模型"><meta property="og:url" content="https://www.minbit.top/posts/46846.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="生产者 - 消费者模型（CP 问题）1. 生产者-消费者模型（CP 问题）是什么？这是并发编程中最经典的问题之一，主要描述 两个线程&amp;#x2F;进程之间的数据交换协作问题：  生产者：不断生产数据，放入缓冲区（仓库、通道）。 消费者：不断从缓冲区中取出数据进行处理。  但问题在于：  缓冲区有 容量"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=41f5b431-c278-6f22-8d77-b77c2a3e65ac"><meta property="article:author" content="小米里的大麦"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=41f5b431-c278-6f22-8d77-b77c2a3e65ac"><meta name="description" content="生产者 - 消费者模型（CP 问题）1. 生产者-消费者模型（CP 问题）是什么？这是并发编程中最经典的问题之一，主要描述 两个线程&amp;#x2F;进程之间的数据交换协作问题：  生产者：不断生产数据，放入缓冲区（仓库、通道）。 消费者：不断从缓冲区中取出数据进行处理。  但问题在于：  缓冲区有 容量"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://www.minbit.top/posts/46846.html"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Cd-RTVhRO2mndEhicN2cvLXbsNxPqFC6fSn6ql80eVg"/><meta name="baidu-site-verification" content="codeva-ZG3S9QTvGO"/><meta name="msvalidate.01" content="6DF744D82FE6D1FD11CE18658760B59D"/><meta name="baidu-site-verification" content="codeva-gIjOMzUuhV"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"/><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"友链 + 外链 + 无限进步！欢迎欣赏和贡献！","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"小米里的大麦","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":4,"basicWordCount":1999,"key":"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv","Referer":"https://www.minbit.top/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"Jp8wwGQpp21utaFQ","LingQueMonitorID":"Jp8ztDRrxmTf7LDj"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-olive-one.vercel.app/',
  commentBarrageConfig:{"enable":true,"maxBarrage":10,"barrageTime":5000,"accessToken":"25c96851dd8a790c4819ad4bfbaf153c","mailMd5":"7b12ebc2be80f9159099f6ab0e16573c"},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 小米里的大麦","link":"链接: ","source":"来源: 小米里的大麦","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '小米里的大麦',
  title: '042 生产者 - 消费者模型',
  postAI: '这篇文章讲述了生产者-消费者模型（CP 问题），这是并发编程中最经典的问题之一，主要描述两个线程/进程之间的数据交换协作问题。生产者不断生产数据放入缓冲区，消费者从缓冲区中取出数据进行处理。由于缓冲区有容量限制，且多线程并发会导致竞争访问资源，因此需要设计同步机制如互斥锁、条件变量、信号量等，保证生产者不能在缓冲区满时继续放，消费者不能在缓冲区空时继续取，多个线程操作共享资源不会冲突。解耦是降低系统组件或模块之间的依赖关系，使它们能够独立运行和变化，提高系统的可扩展性和灵活性。在CP问题中，通过缓冲区实现生产者和消费者之间的间接通信，实现了解耦。现实类比中，供应链的供货商-超市-消费者模型展示了生产者-消费者模型的实际应用，超市作为交易场所，有容量上限，是中间角色，解耦了供货商和消费者之间的依赖。文章还介绍了基于BlockingQueue和环形队列的生产者-消费者模型，以及POSIX信号量的使用，这些技术和方法都是实现生产者-消费者模型的关键。',
  pageFillDescription: '生产者 - 消费者模型（CP 问题）, 1. 生产者-消费者模型（CP 问题）是什么？, 2. 什么是解耦？为什么要解耦？, 1. 解耦的本质, 2. 为什么要解耦？, 3. 现实类比：供应链的供货商 - 超市 - 消费者, 1. 现实类比, 2. 321 原则 理解 CP 问题, 1. 3 种关系, 2. 2 种角色, 3. 1 个交易场所, 4. 代码示例 —— 基于 BlockingQueue 的生产者消费者模型, 1. BlockingQueue.hpp, 2. Task.hpp, 3. main.cpp, 5. POSIX 信号量, 1. 什么是 POSIX 信号量？有什么用？, 2. POSIX 信号量函数, 3. 代码示例, 6. 基于环形队列的生产消费模型, 1. 什么是环形队列生产消费模型？, 2. 特点, 3. 环形队列中判空 x2F 判满的处理（重点）, 4. 常见解决方案, 5. 代码示例, 1. RingQueue.hpp, 2. Task.hpp, 3. Main.cc生产者消费者模型问题生产者消费者模型问题是什么这是并发编程中最经典的问题之一主要描述两个线程进程之间的数据交换协作问题生产者不断生产数据放入缓冲区仓库通道消费者不断从缓冲区中取出数据进行处理但问题在于缓冲区有容量限制多线程并发会导致竞争访问资源所以需要设计好同步机制比如互斥锁条件变量信号量等保证生产者不能在缓冲区满的时候继续放消费者不能在缓冲区空的时候继续取多个线程操作共享资源不会冲突什么是解耦为什么要解耦解耦的本质解耦指的是将系统中的不同组件或模块之间的依赖关系降低使它们能够独立地进行开发修改和维护在生产者消费者模型中解耦就是要让生产者和消费者之间的直接关联尽可能减少各自可以独立地运行和变化而不会因为一方的改变对另一方造成过大的影响简单来说解耦就是降低模块之间的依赖性提高系统的可扩展性和灵活性在问题中供货商和消费者通过缓冲区超市进行间接通信实现了解耦为什么要解耦不解耦的弊端供货商得知道哪个消费者要什么什么时候要耦合性太强代码难维护解耦后的优势可以任意增加减少生产者或消费者数量线程扩展方便各自只关心缓冲区的状态不需要处理对方的逻辑模块职责清晰便于调试优化和扩展现实类比供应链的供货商超市消费者现实类比角色类比现实意义供货商生产者批量生产商品的人超市缓冲区仓库商品流通的中转站有货架仓库消费者消费者前来购物的顾客原则理解问题种关系生产者生产者互斥不同的供货商之间存在竞争关系例如两家不同品牌的饮料供货商他们都希望自己的产品能够在超市中占据更多的货架空间获得更高的销量为了实现这一目标他们会在产品质量价格营销策略等方面展开竞争这种竞争关系就是互斥的因为在一定的市场份额下一家供货商销量的增加往往意味着其他供货商销量的减少消费者消费者互斥消费者之间也存在一定的互斥关系比如在超市进行促销活动时某些热门商品的数量有限消费者之间就会为了抢购这些商品而产生竞争例如限量版的鞋子热门的电子产品等先到的消费者有更大的机会购买到而后到的消费者可能就会错失购买机会生产者消费者互斥同步互斥供货商希望以较高的价格出售商品以获取更多利润而消费者则希望以较低的价格购买到心仪的商品双方在价格方面存在利益冲突这是互斥的表现同步供货商需要根据消费者的需求来生产商品如果生产的商品不符合消费者的需求就会造成库存积压而消费者的购买行为也会影响供货商的生产计划例如当某种商品的销量大增时供货商可能会增加该商品的生产所以生产者和消费者之间需要保持一定的同步关系以维持市场的供需平衡供货商与消费者不需要彼此知道对方是谁通过中间的缓冲区超市就能协作完成商品流转这就是解耦种角色角色行为生产者供货商负责生成产品放入缓冲区消费者顾客负责从缓冲区获取产品进行消费注意二者不直接通信不依赖对方的状态只是对缓冲区的操作要同步协调个交易场所缓冲区就像是交易中转站相当于现实生活的超市个交易场所超市就是生产者供货商和消费者进行交易的场所超市为供货商提供了销售渠道将众多供货商的商品集中展示方便消费者进行选购特点有容量上限超市货架就这么大不能无限放是中间角色解耦了供货商和消费者之间的依赖代码示例基于的生产者消费者模型阻塞队列类模板提供线程安全的任务存储和同步机制队列存储实际数据队列最大容量互斥锁保护共享资源非空条件变量消费者等待非满条件变量生产者等待队列默认初始容量构造函数初始化队列和同步变量初始化互斥锁初始化非空条件变量初始化非满条件变量析构函数清理资源销毁互斥锁销毁非空条件变量销毁非满条件变量生产者添加元素进行入队加锁保护共享资源队列已满等待非满条件变量使用防止虚假唤醒等待队列有空间入队唤醒等待的消费者线程解锁消费者取出元素进行出队加锁队列空则等待使用防止虚假唤醒等待队列有数据获取队首元素出队唤醒等待的生产者线程解锁返回元素任务类封装数学运算任务的执行和结果处理错误代码枚举成功除零错误取模零错误两个操作数运算结果操作符错误代码构造函数初始化任务参数执行运算任务除零错误取模零错误未知操作符错误重载函数调用操作符使对象可以像函数一样调用执行运算获取任务描述字符串格式获取运算结果字符串错误代码主程序创建多个生产者线程生成随机任务多个消费者线程处理任务并输出结果操作符全局任务队列指针全局打印互斥锁确保输出尽量不交错获取当前时间戳毫秒用于标识消息的产生时间时间结构体获取当前时间转换为毫秒时间戳线程安全的打印函数添加时间戳便于观察执行顺序加锁防止输出交错带时间戳的输出解锁消费者线程函数获取线程持续消费从队列取出任务可能阻塞等待执行任务运算构造消费完成的消息消费者完成了任务结果为线程安全的打印带时间戳延迟控制消费速度线程退出生产者线程函数获取线程设置随机种子避免重复持续生产生成随机数范围更小便于观察生成随机数随机选择操作符创建任务对象先打印生产消息再放入队列生产者生产了任务线程安全的打印带时间戳将任务放入队列可能阻塞等待秒延迟控制生产速度线程退出创建容量为的阻塞队列线程数组创建个消费者线程创建个消费者线程创建消费者线程创建个生产者线程创建个生产者线程创建生产者线程等待所有线程结束实际程序不会退出等待消费者线程等待生产者线程释放队列内存信号量什么是信号量有什么用信号量和信号量作用相同都是用于同步操作达到无冲突的访问共享资源目的但可以用于线程间同步属于标准的一部分定义在头文件中主要用于控制对共享资源的访问避免竞争条件实现互斥与同步信号量函数同样的这部分函数和之前的系列函数十分相似这里就不详细讲解了类比使用即可注意头文件是作用函数原型参数说明返回值初始化信号量信号量指针表示用于线程间共享非表示进程间共享初始值表示资源初始数量表示成功非表示失败可用获取错误销毁信号量信号量指针成功非失败等待操作信号量指如果则减一并继续执行值为则阻塞等待成功失败非阻塞等待信号量指针如果资源不足不会阻塞而是立即返回错误适合用于非阻塞检测场景成功失败发布增加信号量操作信号量指针将信号量值加如果有等待线程将唤醒其中一个成功失败这里把信号量的工作流程操作单拎出来进行强调操作含义行为描述操作当前线程尝试获取资源若信号量值获取成功减若则阻塞等待操作当前线程释放资源信号量值若有等待线程唤醒一个代码示例请求信号量如果值为则阻塞等待获取到了信号量模拟工作释放信号量释放了信号量初始化信号量最多允许个线程同时进入清理资源基于环形队列的生产消费模型什么是环形队列生产消费模型基于环形队列的生产者消费者模型也是一种常见的并发编程设计其核心是通过环形队列循环队列作为缓冲区协调生产者和消费者两个角色的工作生产者负责生成数据并放入队列消费者负责从队列中取出数据并处理从而实现生产者与消费者之间的数据传递和解耦需要注意的是双方互不直接通信而是通过队列进行异步协作特点环形队列是一个固定容量首尾相接的循环缓冲区使用两个指针消费者读取位置生产者写入位置每次写或读都会环形移动取模环形队列中判空判满的处理重点由于和都在循环移动当队列为空或为满时都会出现的情况因此环形队列最关键的难点就是如何区分队列空与队列满常见解决方案方法原理判空条件判满条件优缺点多空一法保留一个空位即浪费一个存储单元规定队列容量为时最多存个元素简单高效逻辑清晰边界状态安全实际可用容量为浪费一个单元空间引入计数器使用一个变量单独记录当前队列中元素数量空间完全利用需要额外同步变量线程并发时处理更复杂标志记位法设置一个标志位来判断当前状态读写位置逻辑简洁清晰实现复杂易出错代码示例基于信号量和互斥锁实现的线程安全环形队列模板类使用两个信号量分别控制数据资源和空间资源两个互斥锁保护生产者和消费者的并发访问位置环形队列默认容量操作等待信号量资源减少等待信号量原子操作操作释放信号量资源增加释放信号量原子操作加锁操作加锁获取互斥锁原子操作解锁操作解锁释放互斥锁原子操作初始化消费者数据信号量为初始无数据初始化生产者空间信号量为初始全部空间初始化消费者互斥锁初始化生产者互斥锁销毁消费者数据信号量销毁生产者空间信号量销毁消费者互斥锁销毁生产者互斥锁生产者向环形队列添加元素等待可用空间空间资源加锁保护生产者写入位置在生产者位置写入数据位置后移维持环形特性生产者下标后移取模实现环形解锁增加数据资源唤醒消费者消费者从环形队列取出元素等待可用数据数据资源加锁保护消费者读取位置从消费者位置读取数据位置后移维持环形特性消费者下标后移取模实现环形解锁增加空间资源唤醒生产者存储数据的环形数组队列容量消费者当前位置下标生产者当前位置下标消费者关注的数据资源信号量有多少数据可消费生产者关注的空间资源信号量有多少空间可生产消费者互斥锁保护消费者位置生产者互斥锁保护生产者位置封装数学运算任务的类支持加减乘除取模五种运算包含错误处理机制提供任务执行和结果获取功能支持的操作符集合错误代码枚举定义成功除零错误取模零错误未知操作符错误默认构造函数带参数构造函数初始化任务参数验证操作符是否合法默认为加法设置错误码执行运算任务重置结果和错误码避免重复调用时的问题除零错误取模零错误未知操作符错误重载函数调用操作符使对象可以像函数一样调用执行运算获取任务描述字符串格式获取运算结果字符串错误代码获取操作符获取第一个操作数获取第二个操作数获取运算结果获取错误代码析构函数两个操作数运算结果操作符错误代码创建多个生产者和消费者线程生产者生成随机运算任务放入环形队列消费者从队列取出任务并执行计算演示多线程协作的生产消费模型线程数据结构传递给线程函数环形队列指针线程名称生产者线程函数获取线程数据获取环形队列获取线程名称操作符个数持续生产获取数据生成随机任务生成随机数微秒延迟生成随机数随机选择操作符创建任务对象生产数据将任务放入环形队列生产任务修复打印格式添加换行符使输出更清晰生产任务秒生产间隔消费者线程函数获取线程数据获取环形队列获取线程名称持续消费消费数据从环形队列取出任务创建任务对象消费任务阻塞等待处理数据执行任务并输出结果执行运算修复打印格式添加换行符使输出更清晰消费任务结果环形队列生产者消费者模型设置随机种子创建容量为的环形队列小一点便于测试创建多个消费者和生产者创建个生产者线程创建个生产者线程创建线程数据设置环形队列生产者设置线程名称创建生产者线程创建个消费者线程创建个消费者线程创建线程数据设置环形队列消费者设置线程名称创建消费者线程等待线程结束实际程序不会退出等待生产者线程等待消费者线程释放内存',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-03 12:00:00',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 10 || hour >= 20
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="哔哩哔哩"/><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="Gitee"/><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN"/><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="稀土掘金"/><span class="back-menu-item-text">稀土掘金</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 1.05rem;">C++<sup>8</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size: 1.05rem;">IO<sup>3</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>50</sup></a><a href="/tags/Obsidian/" style="font-size: 1.05rem;">Obsidian<sup>1</sup></a><a href="/tags/STL/" style="font-size: 1.05rem;">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size: 1.05rem;">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size: 1.05rem;">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size: 1.05rem;">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size: 1.05rem;">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 1.05rem;">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 1.05rem;">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size: 1.05rem;">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size: 1.05rem;">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 1.05rem;">网站<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>6</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 1.05rem;">进程<sup>15</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">10</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div id="console-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a></span></div></div><h1 class="post-title" itemprop="name headline">042 生产者 - 消费者模型</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-08-03T04:00:00.000Z" title="发表于 2025-08-03 12:00:00">2025-08-03</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-08-03T04:00:00.000Z" title="更新于 2025-08-03 12:00:00">2025-08-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="042 生产者 - 消费者模型"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=41f5b431-c278-6f22-8d77-b77c2a3e65ac"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/46846.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><h1 id="CrawlerTitle" itemprop="name headline">042 生产者 - 消费者模型</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-08-03T04:00:00.000Z" title="发表于 2025-08-03 12:00:00">2025-08-03</time><time itemprop="dateCreated datePublished" datetime="2025-08-03T04:00:00.000Z" title="更新于 2025-08-03 12:00:00">2025-08-03</time></header><h1 id="生产者-消费者模型（CP-问题）"><a href="#生产者-消费者模型（CP-问题）" class="headerlink" title="生产者 - 消费者模型（CP 问题）"></a>生产者 - 消费者模型（CP 问题）</h1><h2 id="1-生产者-消费者模型（CP-问题）是什么？"><a href="#1-生产者-消费者模型（CP-问题）是什么？" class="headerlink" title="1. 生产者-消费者模型（CP 问题）是什么？"></a>1. 生产者-消费者模型（CP 问题）是什么？</h2><p>这是并发编程中最经典的问题之一，主要描述 <strong>两个线程&#x2F;进程之间的数据交换协作问题</strong>：</p>
<ul>
<li><strong>生产者</strong>：不断生产数据，放入缓冲区（仓库、通道）。</li>
<li><strong>消费者</strong>：不断从缓冲区中取出数据进行处理。</li>
</ul>
<p>但问题在于：</p>
<ol>
<li>缓冲区有 <strong>容量限制</strong>。</li>
<li>多线程并发会导致 <strong>竞争访问资源</strong>。</li>
</ol>
<p>所以需要设计好 <strong>同步机制</strong>（比如互斥锁、条件变量、信号量等）保证：</p>
<ul>
<li>生产者不能在缓冲区满的时候继续放；</li>
<li>消费者不能在缓冲区空的时候继续取；</li>
<li>多个线程操作共享资源不会冲突。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250803204315930.png" alt="image-20250803204315786"></p>
<h2 id="2-什么是“解耦”？为什么要解耦？"><a href="#2-什么是“解耦”？为什么要解耦？" class="headerlink" title="2. 什么是“解耦”？为什么要解耦？"></a>2. 什么是“解耦”？为什么要解耦？</h2><h3 id="1-解耦的本质"><a href="#1-解耦的本质" class="headerlink" title="1. 解耦的本质"></a>1. 解耦的本质</h3><p>解耦指的是将系统中的不同组件或模块之间的依赖关系降低，使它们能够独立地进行开发、修改和维护。在生产者 - 消费者模型中，解耦就是要让生产者和消费者之间的直接关联尽可能减少，各自可以独立地运行和变化，而不会因为一方的改变对另一方造成过大的影响。简单来说 <strong>解耦就是降低模块之间的依赖性，提高系统的可扩展性和灵活性</strong>。</p>
<blockquote>
<p>  在 CP 问题中，供货商和消费者通过缓冲区（超市）进行 <strong>间接通信</strong>，实现了解耦。</p>
</blockquote>
<h3 id="2-为什么要解耦？"><a href="#2-为什么要解耦？" class="headerlink" title="2. 为什么要解耦？"></a>2. 为什么要解耦？</h3><ul>
<li><strong>不解耦的弊端</strong>：供货商得知道哪个消费者要什么、什么时候要，耦合性太强，代码难维护。</li>
<li><strong>解耦后的优势</strong>：<ul>
<li>可以任意增加&#x2F;减少生产者或消费者数量（线程扩展方便）。</li>
<li>各自只关心“缓冲区的状态”，不需要处理对方的逻辑。</li>
<li>模块职责清晰，便于调试、优化和扩展。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-现实类比：供应链的“供货商-超市-消费者”"><a href="#3-现实类比：供应链的“供货商-超市-消费者”" class="headerlink" title="3. 现实类比：供应链的“供货商 - 超市 - 消费者”"></a>3. 现实类比：供应链的“供货商 - 超市 - 消费者”</h2><h3 id="1-现实类比"><a href="#1-现实类比" class="headerlink" title="1. 现实类比"></a>1. 现实类比</h3><table>
<thead>
<tr>
<th>角色</th>
<th>类比</th>
<th>现实意义</th>
</tr>
</thead>
<tbody><tr>
<td>供货商</td>
<td><strong>生产者</strong></td>
<td>批量生产商品的人</td>
</tr>
<tr>
<td>超市</td>
<td><strong>缓冲区 Buffer &#x2F; 仓库</strong></td>
<td>商品流通的中转站，有货架&#x2F;仓库</td>
</tr>
<tr>
<td>消费者</td>
<td><strong>消费者</strong></td>
<td>前来购物的顾客</td>
</tr>
</tbody></table>
<h3 id="2-“321-原则”-理解-CP-问题"><a href="#2-“321-原则”-理解-CP-问题" class="headerlink" title="2. “321 原则” 理解 CP 问题"></a>2. “321 原则” 理解 CP 问题</h3><hr>
<h4 id="1-“3-种关系”"><a href="#1-“3-种关系”" class="headerlink" title="1. “3 种关系”"></a>1. “3 种关系”</h4><ul>
<li><strong>生产者 vs 生产者（互斥）</strong>：不同的供货商之间存在竞争关系。例如，两家不同品牌的饮料供货商，他们都希望自己的产品能够在超市中占据更多的货架空间，获得更高的销量。为了实现这一目标，他们会在产品质量、价格、营销策略等方面展开竞争，这种竞争关系就是互斥的，因为在一定的市场份额下，一家供货商销量的增加往往意味着其他供货商销量的减少。</li>
<li><strong>消费者 vs 消费者（互斥）</strong>：消费者之间也存在一定的互斥关系。比如在超市进行促销活动时，某些热门商品的数量有限，消费者之间就会为了抢购这些商品而产生竞争。例如，限量版的鞋子、热门的电子产品等，先到的消费者有更大的机会购买到，而后到的消费者可能就会错失购买机会。</li>
<li><strong>生产者 vs 消费者（互斥、同步）：</strong><ul>
<li><strong>互斥</strong>：供货商希望以较高的价格出售商品以获取更多利润，而消费者则希望以较低的价格购买到心仪的商品，双方在价格方面存在利益冲突，这是互斥的表现。</li>
<li><strong>同步</strong>：供货商需要根据消费者的需求来生产商品，如果生产的商品不符合消费者的需求，就会造成库存积压。而消费者的购买行为也会影响供货商的生产计划，例如当某种商品的销量大增时，供货商可能会增加该商品的生产。所以生产者和消费者之间需要保持一定的同步关系，以维持市场的供需平衡。</li>
</ul>
</li>
</ul>
<blockquote>
<p>供货商与消费者 <strong>不需要彼此知道对方是谁</strong>，通过中间的缓冲区（超市）就能协作完成“商品流转” —— 这就是 <strong>解耦</strong>。</p>
</blockquote>
<h4 id="2-“2-种角色”"><a href="#2-“2-种角色”" class="headerlink" title="2. “2 种角色”"></a>2. “2 种角色”</h4><table>
<thead>
<tr>
<th>角色</th>
<th>行为</th>
</tr>
</thead>
<tbody><tr>
<td>生产者（供货商）</td>
<td>负责生成产品，放入缓冲区</td>
</tr>
<tr>
<td>消费者（顾客）</td>
<td>负责从缓冲区获取产品，进行消费</td>
</tr>
</tbody></table>
<p>注意：</p>
<ul>
<li>二者不直接通信，不依赖对方的状态；</li>
<li>只是“对缓冲区”的操作要同步协调。</li>
</ul>
<h4 id="3-“1-个交易场所”"><a href="#3-“1-个交易场所”" class="headerlink" title="3. “1 个交易场所”"></a>3. “1 个交易场所”</h4><blockquote>
<p>  缓冲区就像是“交易中转站”，相当于现实生活的“<strong>超市</strong>”。</p>
</blockquote>
<p><strong>1 个交易场所</strong>：超市就是生产者（供货商）和消费者进行交易的场所。超市为供货商提供了销售渠道，将众多供货商的商品集中展示，方便消费者进行选购。</p>
<p>特点：</p>
<ul>
<li>有容量上限：超市货架就这么大，不能无限放。</li>
<li>是中间角色：解耦了供货商和消费者之间的依赖。</li>
</ul>
<hr>
<h2 id="4-代码示例-——-基于-BlockingQueue-的生产者消费者模型"><a href="#4-代码示例-——-基于-BlockingQueue-的生产者消费者模型" class="headerlink" title="4. 代码示例 —— 基于 BlockingQueue 的生产者消费者模型"></a>4. 代码示例 —— 基于 BlockingQueue 的生产者消费者模型</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250803204513839.png" alt="image-20250803204513691"></p>
<h3 id="1-BlockingQueue-hpp"><a href="#1-BlockingQueue-hpp" class="headerlink" title="1. BlockingQueue.hpp"></a>1. BlockingQueue.hpp</h3><p>阻塞队列类模板，提供线程安全的任务存储和同步机制。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockingQueue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    queue&lt;T&gt; q_;                                                     <span class="comment">// STL队列，存储实际数据</span></span><br><span class="line">    <span class="type">int</span> max_capacity;                                                <span class="comment">// 队列最大容量</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> mutex_;                                          <span class="comment">// 互斥锁，保护共享资源</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> not_empty_;                                       <span class="comment">// 非空条件变量，消费者等待</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> not_full_;                                        <span class="comment">// 非满条件变量，生产者等待</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> DEFAULT_MAX_CAPACITY = <span class="number">10</span>;                      <span class="comment">// 队列默认初始容量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数：初始化队列和同步变量</span></span><br><span class="line">    <span class="built_in">BlockingQueue</span>(<span class="type">int</span> max_capacity = DEFAULT_MAX_CAPACITY)</span><br><span class="line">        :<span class="built_in">max_capacity</span>(max_capacity)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;mutex_, <span class="literal">nullptr</span>);                        <span class="comment">// 初始化互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;not_empty_, <span class="literal">nullptr</span>);                     <span class="comment">// 初始化非空条件变量</span></span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;not_full_, <span class="literal">nullptr</span>);                      <span class="comment">// 初始化非满条件变量</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构函数：清理资源</span></span><br><span class="line">    ~<span class="built_in">BlockingQueue</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_destroy</span>(&amp;mutex_);                              <span class="comment">// 销毁互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_cond_destroy</span>(&amp;not_empty_);                           <span class="comment">// 销毁非空条件变量</span></span><br><span class="line">        <span class="built_in">pthread_cond_destroy</span>(&amp;not_full_);                            <span class="comment">// 销毁非满条件变量</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生产者添加元素进行入队</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T&amp; item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex_);                                 <span class="comment">// 加锁，保护共享资源</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 队列已满，等待非满条件变量</span></span><br><span class="line">        <span class="comment">// 使用while防止虚假唤醒</span></span><br><span class="line">        <span class="keyword">while</span> (q_.<span class="built_in">size</span>() &gt;= max_capacity)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pthread_cond_wait</span>(&amp;not_full_, &amp;mutex_);                  <span class="comment">// 等待队列有空间</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        q_.<span class="built_in">push</span>(item);                                               <span class="comment">// 入队</span></span><br><span class="line">        <span class="built_in">pthread_cond_signal</span>(&amp;not_empty_);                            <span class="comment">// 唤醒等待的消费者线程</span></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex_);                               <span class="comment">// 解锁</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费者取出元素进行出队</span></span><br><span class="line">    <span class="function">T <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex_);                                 <span class="comment">// 加锁</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 队列空则等待</span></span><br><span class="line">        <span class="comment">// 使用while防止虚假唤醒</span></span><br><span class="line">        <span class="keyword">while</span> (q_.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pthread_cond_wait</span>(&amp;not_empty_, &amp;mutex_);                 <span class="comment">// 等待队列有数据</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        T item = q_.<span class="built_in">front</span>();                                         <span class="comment">// 获取队首元素</span></span><br><span class="line">        q_.<span class="built_in">pop</span>();                                                    <span class="comment">// 出队</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_cond_signal</span>(&amp;not_full_);                             <span class="comment">// 唤醒等待的生产者线程</span></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex_);                               <span class="comment">// 解锁</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> item;                                                 <span class="comment">// 返回元素</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-Task-hpp"><a href="#2-Task-hpp" class="headerlink" title="2. Task.hpp"></a>2. Task.hpp</h3><p>任务类，封装数学运算任务的执行和结果处理。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误代码枚举</span></span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    SUCCESS = <span class="number">0</span>,                                                     <span class="comment">// 成功</span></span><br><span class="line">    DIV_ERROR = <span class="number">1</span>,                                                   <span class="comment">// 除零错误</span></span><br><span class="line">    MOD_ERROR = <span class="number">2</span>,                                                   <span class="comment">// 取模零错误</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> _x, _y;                                                      <span class="comment">// 两个操作数</span></span><br><span class="line">    <span class="type">int</span> _ret;                                                        <span class="comment">// 运算结果</span></span><br><span class="line">    <span class="type">char</span> _op;                                                        <span class="comment">// 操作符</span></span><br><span class="line">    <span class="type">int</span> _code;                                                       <span class="comment">// 错误代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造函数：初始化任务参数</span></span><br><span class="line">    <span class="built_in">Task</span>(<span class="type">int</span> x = <span class="number">0</span>, <span class="type">int</span> y = <span class="number">0</span>, <span class="type">char</span> op = <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        :_x(x),</span><br><span class="line">        _y(y),</span><br><span class="line">        _op(op),</span><br><span class="line">        _ret(<span class="number">0</span>),</span><br><span class="line">        _code(SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行运算任务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(_op)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">                _ret = _x + _y;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                _ret = _x - _y;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">                _ret = _x * _y;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span>(_y == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _code = DIV_ERROR;                               <span class="comment">// 除零错误</span></span><br><span class="line">                    _ret = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _ret = _x / _y;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span>(_y == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _code = MOD_ERROR;                               <span class="comment">// 取模零错误</span></span><br><span class="line">                    _ret = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _ret = _x % _y;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                _code = MOD_ERROR;                                   <span class="comment">// 未知操作符错误</span></span><br><span class="line">                _ret = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重载函数调用操作符，使Task对象可以像函数一样调用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">run</span>();                                                       <span class="comment">// 执行运算</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取任务描述字符串</span></span><br><span class="line">    <span class="function">string <span class="title">get_task</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">to_string</span>(_x) + _op + <span class="built_in">to_string</span>(_y) + <span class="string">&quot;= ???&quot;</span>;        <span class="comment">// 格式：x op y = ???</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取运算结果字符串</span></span><br><span class="line">    <span class="function">string <span class="title">get_ret</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string ret = <span class="built_in">to_string</span>(_x) + _op + <span class="built_in">to_string</span>(_y) + <span class="string">&quot;=&quot;</span> + <span class="built_in">to_string</span>(_ret) + </span><br><span class="line">                     <span class="string">&quot; [错误代码]：&quot;</span> + <span class="built_in">to_string</span>(_code);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-main-cpp"><a href="#3-main-cpp" class="headerlink" title="3. main.cpp"></a>3. main.cpp</h3><p>主程序，创建多个生产者线程生成随机任务，多个消费者线程处理任务并输出结果。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BlockingQueue.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Task.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> string ops = <span class="string">&quot;+-*/%&quot;</span>;                                          <span class="comment">// 操作符</span></span><br><span class="line">BlockingQueue&lt;Task&gt;* TaskQueue;                                      <span class="comment">// 全局任务队列指针</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> g_print_mutex = PTHREAD_MUTEX_INITIALIZER;           <span class="comment">// 全局打印互斥锁，确保输出尽量不交错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前时间戳（毫秒），用于标识消息的产生时间</span></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">get_timestamp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;                                               <span class="comment">// 时间结构体</span></span><br><span class="line">    <span class="built_in">gettimeofday</span>(&amp;tv, <span class="literal">nullptr</span>);                                      <span class="comment">// 获取当前时间</span></span><br><span class="line">    <span class="keyword">return</span> tv.tv_sec * <span class="number">1000</span> + tv.tv_usec / <span class="number">1000</span>;                     <span class="comment">// 转换为毫秒时间戳</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程安全的打印函数，添加时间戳便于观察执行顺序</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">safe_print</span><span class="params">(<span class="type">const</span> string&amp; message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;g_print_mutex);                              <span class="comment">// 加锁，防止输出交错</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; <span class="built_in">get_timestamp</span>() &lt;&lt; <span class="string">&quot;] &quot;</span> &lt;&lt; message &lt;&lt; endl;       <span class="comment">// 带时间戳的输出</span></span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;g_print_mutex);                            <span class="comment">// 解锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">consumer</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = *(<span class="type">int</span>*)arg;                                             <span class="comment">// 获取线程ID</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)                                                      <span class="comment">// 持续消费</span></span><br><span class="line">    &#123;</span><br><span class="line">        Task task = TaskQueue-&gt;<span class="built_in">pop</span>();                                <span class="comment">// 从队列取出任务（可能阻塞等待）</span></span><br><span class="line">        <span class="built_in">task</span>();                                                      <span class="comment">// 执行任务运算</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构造消费完成的消息</span></span><br><span class="line">        string s = <span class="string">&quot;[消费者 &quot;</span> + <span class="built_in">to_string</span>(id) + <span class="string">&quot;] 完成了任务：&quot;</span> + task.<span class="built_in">get_task</span>() + <span class="string">&quot;，结果为：&quot;</span> + task.<span class="built_in">get_ret</span>();</span><br><span class="line">        <span class="built_in">safe_print</span>(s);                                               <span class="comment">// 线程安全的打印，带时间戳</span></span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">500000</span>);                                              <span class="comment">// 500ms延迟，控制消费速度</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="literal">nullptr</span>);                                           <span class="comment">// 线程退出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">producer</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = *(<span class="type">int</span>*)arg;                                             <span class="comment">// 获取线程ID</span></span><br><span class="line">    <span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>) + id * <span class="number">1000</span>);                                <span class="comment">// 设置随机种子，避免重复</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)                                                      <span class="comment">// 持续生产</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> x = <span class="built_in">rand</span>() % <span class="number">50</span> + <span class="number">1</span>;                                     <span class="comment">// 生成随机数 [1, 50]，范围更小便于观察</span></span><br><span class="line">        <span class="type">int</span> y = <span class="built_in">rand</span>() % <span class="number">50</span> + <span class="number">1</span>;                                     <span class="comment">// 生成随机数 [1, 50]</span></span><br><span class="line">        <span class="type">char</span> op = ops[<span class="built_in">rand</span>() % ops.<span class="built_in">size</span>()];                          <span class="comment">// 随机选择操作符</span></span><br><span class="line"></span><br><span class="line">        <span class="function">Task <span class="title">task</span><span class="params">(x, y, op)</span></span>;                                         <span class="comment">// 创建任务对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先打印生产消息，再放入队列</span></span><br><span class="line">        string s = <span class="string">&quot;[生产者 &quot;</span> + <span class="built_in">to_string</span>(id) + <span class="string">&quot;] 生产了任务：&quot;</span> + task.<span class="built_in">get_task</span>();</span><br><span class="line">        <span class="built_in">safe_print</span>(s);                                               <span class="comment">// 线程安全的打印，带时间戳</span></span><br><span class="line">        </span><br><span class="line">        TaskQueue-&gt;<span class="built_in">push</span>(task);                                       <span class="comment">// 将任务放入队列（可能阻塞等待）</span></span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">1000000</span>);                                             <span class="comment">// 1秒延迟，控制生产速度</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="literal">nullptr</span>);                                           <span class="comment">// 线程退出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TaskQueue = <span class="keyword">new</span> <span class="built_in">BlockingQueue</span>&lt;Task&gt;(<span class="number">5</span>);                          <span class="comment">// 创建容量为5的阻塞队列</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ids[<span class="number">5</span>] = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;                                  <span class="comment">// 线程ID数组</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建2个消费者线程</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;创建 2 个消费者线程&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="type">pthread_t</span> Consumers[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;Consumers[i], <span class="literal">nullptr</span>, consumer, &amp;ids[i]);   <span class="comment">// 创建消费者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建3个生产者线程</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;创建 3 个生产者线程&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="type">pthread_t</span> Producers[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;Producers[i], <span class="literal">nullptr</span>, producer, &amp;ids[i<span class="number">+2</span>]); <span class="comment">// 创建生产者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待所有线程结束（实际程序不会退出）</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(Consumers[i], <span class="literal">nullptr</span>);                         <span class="comment">// 等待消费者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(Producers[i], <span class="literal">nullptr</span>);                         <span class="comment">// 等待生产者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span> TaskQueue;                                                <span class="comment">// 释放队列内存</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-POSIX-信号量"><a href="#5-POSIX-信号量" class="headerlink" title="5. POSIX 信号量"></a>5. POSIX 信号量</h2><h3 id="1-什么是-POSIX-信号量？有什么用？"><a href="#1-什么是-POSIX-信号量？有什么用？" class="headerlink" title="1. 什么是 POSIX 信号量？有什么用？"></a>1. 什么是 POSIX 信号量？有什么用？</h3><p>POSIX 信号量和 SystemV 信号量作用相同，都是用于同步操作，达到无冲突的访问共享资源目的。 但 POSIX 可以用于线程间同步，属于 POSIX 标准的一部分（定义在 <code>&lt;semaphore.h&gt;</code> 头文件中），主要用于控制对共享资源的访问，避免竞争条件，实现互斥与同步。</p>
<h3 id="2-POSIX-信号量函数"><a href="#2-POSIX-信号量函数" class="headerlink" title="2. POSIX 信号量函数"></a>2. POSIX 信号量函数</h3><p>同样的，这部分函数和之前的 <code>pthread_mutex_init</code> 系列函数十分相似，这里就不详细讲解了，类比使用即可。<strong>注意头文件是 <code>&lt;semaphore.h&gt;</code>。</strong></p>
<table>
<thead>
<tr>
<th>作用</th>
<th>函数原型</th>
<th>参数说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td><strong>初始化</strong> 信号量</td>
<td><code>int sem_init(sem_t *sem, int pshared, unsigned int value);</code></td>
<td><code>sem</code>：信号量指针 <br><code>pshared</code>：0 表示用于线程间共享；非 0 表示进程间共享<br><code>value</code>：初始值，表示资源初始数量</td>
<td>0 表示成功，非 0 表示失败（可用 <code>errno</code> 获取错误）</td>
</tr>
<tr>
<td><strong>销毁</strong> 信号量</td>
<td><code>int sem_destroy(sem_t *sem);</code></td>
<td><code>sem</code>：信号量指针</td>
<td>0 成功，非 0 失败</td>
</tr>
<tr>
<td><strong>等待</strong>（P 操作）</td>
<td><code>int sem_wait(sem_t *sem);</code></td>
<td><code>sem</code>：信号量指，如果 <code>sem &gt; 0</code>，则减一并继续执行；值为 0，则阻塞等待</td>
<td>0 成功，-1 失败</td>
</tr>
<tr>
<td>非阻塞等待</td>
<td><code>int sem_trywait(sem_t *sem);</code></td>
<td><code>sem</code>：信号量指针   如果资源不足，不会阻塞，而是立即返回错误（适合用于非阻塞检测场景）</td>
<td>0 成功，-1 失败</td>
</tr>
<tr>
<td><strong>发布</strong>（增加）信号量（V 操作）</td>
<td><code>int sem_post(sem_t *sem);</code></td>
<td><code>sem</code>：信号量指针   将信号量值加 1，如果有等待线程，将唤醒其中一个</td>
<td>0 成功，-1 失败</td>
</tr>
</tbody></table>
<p>这里把信号量的工作流程（P&#x2F;V 操作）单拎出来进行强调：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>含义</th>
<th>行为描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>sem_wait()</code></td>
<td><strong>P 操作</strong>（wait）</td>
<td>当前线程尝试获取资源： 若信号量值 &gt; 0，获取成功（减 1） 若 &#x3D; 0，则阻塞等待</td>
</tr>
<tr>
<td><code>sem_post()</code></td>
<td><strong>V 操作</strong>（signal）</td>
<td>当前线程释放资源： 信号量值 +1，若有等待线程，唤醒一个</td>
</tr>
</tbody></table>
<h3 id="3-代码示例"><a href="#3-代码示例" class="headerlink" title="3. 代码示例"></a>3. 代码示例</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> sem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">worker</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = *(<span class="type">int</span>*)arg;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;sem);                        <span class="comment">// 请求信号量（如果值为0，则阻塞等待）</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread：&quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; 获取到了信号量&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);                              <span class="comment">// 模拟工作</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;sem);                        <span class="comment">// 释放信号量</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread：&quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; 释放了信号量&quot;</span> &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;sem, <span class="number">0</span>, <span class="number">3</span>);                   <span class="comment">// 初始化信号量，最多允许3个线程同时进入</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> threads[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> ids[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ids[i] = i;</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;threads[i], <span class="literal">nullptr</span>, worker, &amp;ids[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(threads[i], <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sem_destroy</span>(&amp;sem);                      <span class="comment">// 清理资源</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-基于环形队列的生产消费模型"><a href="#6-基于环形队列的生产消费模型" class="headerlink" title="6. 基于环形队列的生产消费模型"></a>6. 基于环形队列的生产消费模型</h2><h3 id="1-什么是环形队列生产消费模型？"><a href="#1-什么是环形队列生产消费模型？" class="headerlink" title="1. 什么是环形队列生产消费模型？"></a>1. 什么是环形队列生产消费模型？</h3><p><strong>基于环形队列的生产者-消费者模型</strong> 也是一种常见的并发编程设计，其核心是通过环形队列（循环队列）作为缓冲区，协调 “生产者” 和 “消费者” 两个角色的工作：生产者负责生成数据并放入队列，消费者负责从队列中取出数据并处理。从而实现生产者与消费者之间的数据传递和解耦。需要注意的是双方互不直接通信，而是通过队列进行 <strong>异步协作</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250803203650401.png" alt="image-20250803203650239"></p>
<h3 id="2-特点"><a href="#2-特点" class="headerlink" title="2. 特点"></a>2. 特点</h3><ul>
<li>环形队列是一个 <strong>固定容量、首尾相接的循环缓冲区</strong>。</li>
<li>使用两个指针：<ul>
<li><code>head</code> &#x2F; <code>front</code> → 消费者读取位置。</li>
<li><code>tail</code> &#x2F; <code>rear</code> → 生产者写入位置。</li>
</ul>
</li>
<li>每次写或读都会环形移动（取模）。</li>
</ul>
<h3 id="3-环形队列中判空-判满的处理（重点）"><a href="#3-环形队列中判空-判满的处理（重点）" class="headerlink" title="3. 环形队列中判空 &#x2F; 判满的处理（重点）"></a>3. 环形队列中判空 &#x2F; 判满的处理（重点）</h3><p>由于 <code>front</code> 和 <code>rear</code> 都在循环移动，<strong>当队列为空或为满时，都会出现 <code>front == rear</code> 的情况</strong>，因此环形队列最关键的难点就是 <strong>如何区分“队列空”与“队列满”</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250803203221278.png" alt="image-20250803203221100"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250803203514519.png" alt="image-20250803203514374"></p>
<h3 id="4-常见解决方案"><a href="#4-常见解决方案" class="headerlink" title="4. 常见解决方案"></a>4. 常见解决方案</h3><table>
<thead>
<tr>
<th>方法</th>
<th>原理</th>
<th>判空条件</th>
<th>判满条件</th>
<th>优缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>1. 多空一法（保留一个空位，即浪费一个存储单元</strong></td>
<td>规定队列容量为 <code>N</code> 时，最多存 <code>N-1</code> 个元素。</td>
<td><code>head == tail</code></td>
<td><code>(tail + 1) % size == head</code></td>
<td>✅ 简单高效，逻辑清晰，边界状态安全<br>❌ 实际可用容量为 <code>size - 1</code>，浪费一个单元空间</td>
</tr>
<tr>
<td><strong>2. 引入计数器 <code>count</code></strong></td>
<td>使用一个 <code>int count</code> 变量单独记录当前队列中元素数量。</td>
<td><code>count == 0</code></td>
<td><code>count == size</code></td>
<td>✅ 空间完全利用<br>❌ 需要额外同步 <code>count</code> 变量，线程并发时处理更复杂</td>
</tr>
<tr>
<td><strong>3. 标志（记）位法（flag）</strong></td>
<td>设置一个标志位 <code>bool full</code> 来判断当前状态。</td>
<td><code>head == tail &amp;&amp; !full</code></td>
<td><code>head == tail &amp;&amp; full</code></td>
<td>✅ 读写位置逻辑简洁清晰<br>❌ 实现复杂，易出错</td>
</tr>
</tbody></table>
<hr>
<h3 id="5-代码示例"><a href="#5-代码示例" class="headerlink" title="5. 代码示例"></a>5. 代码示例</h3><h4 id="1-RingQueue-hpp"><a href="#1-RingQueue-hpp" class="headerlink" title="1. RingQueue.hpp"></a>1. RingQueue.hpp</h4><p>基于信号量和互斥锁实现的线程安全环形队列模板类，使用两个信号量分别控制数据资源和空间资源，两个互斥锁保护生产者和消费者的并发访问位置。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">static</span> <span class="type">int</span> default_capacity = <span class="number">5</span>;                               <span class="comment">// 环形队列默认容量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RingQueue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// P操作：等待信号量（资源减少）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">P</span><span class="params">(<span class="type">sem_t</span>&amp; sem)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">sem_wait</span>(&amp;sem);                                              <span class="comment">// 等待信号量，原子操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// V操作：释放信号量（资源增加）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">V</span><span class="params">(<span class="type">sem_t</span>&amp; sem)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">sem_post</span>(&amp;sem);                                              <span class="comment">// 释放信号量，原子操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加锁操作</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Lock</span><span class="params">(<span class="type">pthread_mutex_t</span>&amp; mutex)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);                                  <span class="comment">// 加锁（获取互斥锁），原子操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解锁操作</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Unlock</span><span class="params">(<span class="type">pthread_mutex_t</span>&amp; mutex)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);                                <span class="comment">// 解锁（释放互斥锁），原子操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">RingQueue</span>(<span class="type">int</span> capacity = default_capacity)</span><br><span class="line">        :<span class="built_in">ringqueue_</span>(capacity),</span><br><span class="line">        <span class="built_in">capacity_</span>(capacity),</span><br><span class="line">        <span class="built_in">c_index_</span>(<span class="number">0</span>),</span><br><span class="line">        <span class="built_in">p_index_</span>(<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sem_init</span>(&amp;cdata_sem_, <span class="number">0</span>, <span class="number">0</span>);                                 <span class="comment">// 初始化消费者数据信号量为0（初始无数据）</span></span><br><span class="line">        <span class="built_in">sem_init</span>(&amp;pspace_sem_, <span class="number">0</span>, capacity_);                        <span class="comment">// 初始化生产者空间信号量为cap（初始全部空间）</span></span><br><span class="line">    </span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;c_mutex_, <span class="literal">nullptr</span>);                      <span class="comment">// 初始化消费者互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;p_mutex_, <span class="literal">nullptr</span>);                      <span class="comment">// 初始化生产者互斥锁</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">RingQueue</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sem_destroy</span>(&amp;cdata_sem_);                                    <span class="comment">// 销毁消费者数据信号量</span></span><br><span class="line">        <span class="built_in">sem_destroy</span>(&amp;pspace_sem_);                                   <span class="comment">// 销毁生产者空间信号量</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_destroy</span>(&amp;c_mutex_);                            <span class="comment">// 销毁消费者互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_destroy</span>(&amp;p_mutex_);                            <span class="comment">// 销毁生产者互斥锁</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生产者：向环形队列添加元素</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Push</span><span class="params">(<span class="type">const</span> T&amp; in)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">P</span>(pspace_sem_);                                              <span class="comment">// 等待可用空间（空间资源-1）</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Lock</span>(p_mutex_);                                              <span class="comment">// 加锁保护生产者写入位置</span></span><br><span class="line">        ringqueue_[p_index_] = in;                                   <span class="comment">// 在生产者位置写入数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 位置后移，维持环形特性</span></span><br><span class="line">        p_index_++;                                                  <span class="comment">// 生产者下标后移</span></span><br><span class="line">        p_index_ %= capacity_;                                       <span class="comment">// 取模实现环形</span></span><br><span class="line">        <span class="built_in">Unlock</span>(p_mutex_);                                            <span class="comment">// 解锁</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">V</span>(cdata_sem_);                                               <span class="comment">// 增加数据资源（唤醒消费者）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费者：从环形队列取出元素</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Pop</span><span class="params">(T* out)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">P</span>(cdata_sem_);                                               <span class="comment">// 等待可用数据（数据资源-1）</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Lock</span>(c_mutex_);                                              <span class="comment">// 加锁保护消费者读取位置</span></span><br><span class="line">        *out = ringqueue_[c_index_];                                 <span class="comment">// 从消费者位置读取数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 位置后移，维持环形特性</span></span><br><span class="line">        c_index_++;                                                  <span class="comment">// 消费者下标后移</span></span><br><span class="line">        c_index_ %= capacity_;                                       <span class="comment">// 取模实现环形</span></span><br><span class="line">        <span class="built_in">Unlock</span>(c_mutex_);                                            <span class="comment">// 解锁</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">V</span>(pspace_sem_);                                              <span class="comment">// 增加空间资源（唤醒生产者）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    vector&lt;T&gt; ringqueue_;                                            <span class="comment">// 存储数据的环形数组</span></span><br><span class="line">    <span class="type">int</span> capacity_;                                                   <span class="comment">// 队列容量</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> c_index_;                                                    <span class="comment">// 消费者当前位置下标</span></span><br><span class="line">    <span class="type">int</span> p_index_;                                                    <span class="comment">// 生产者当前位置下标</span></span><br><span class="line"></span><br><span class="line">    <span class="type">sem_t</span> cdata_sem_;                                                <span class="comment">// 消费者关注的数据资源信号量（有多少数据可消费）</span></span><br><span class="line">    <span class="type">sem_t</span> pspace_sem_;                                               <span class="comment">// 生产者关注的空间资源信号量（有多少空间可生产）</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_mutex_t</span> c_mutex_;                                        <span class="comment">// 消费者互斥锁，保护消费者位置</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> p_mutex_;                                        <span class="comment">// 生产者互斥锁，保护生产者位置</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-Task-hpp-1"><a href="#2-Task-hpp-1" class="headerlink" title="2. Task.hpp"></a>2. Task.hpp</h4><p>封装数学运算任务的类，支持加减乘除取模五种运算，包含错误处理机制，提供任务执行和结果获取功能。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> string opers = <span class="string">&quot;+-*/%&quot;</span>;                                        <span class="comment">// 支持的操作符集合</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误代码枚举定义</span></span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    SUCCESS = <span class="number">0</span>,                                                     <span class="comment">// 成功</span></span><br><span class="line">    DIV_ERROR = <span class="number">1</span>,                                                   <span class="comment">// 除零错误</span></span><br><span class="line">    MOD_ERROR = <span class="number">2</span>,                                                   <span class="comment">// 取模零错误</span></span><br><span class="line">    UNKNOWN_ERROR = <span class="number">3</span>                                                <span class="comment">// 未知操作符错误</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 默认构造函数</span></span><br><span class="line">    <span class="built_in">Task</span>()</span><br><span class="line">        :_x(<span class="number">0</span>), _y(<span class="number">0</span>), _op(<span class="string">&#x27;+&#x27;</span>), _ret(<span class="number">0</span>), _code(SUCCESS)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带参数构造函数：初始化任务参数</span></span><br><span class="line">    <span class="built_in">Task</span>(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">char</span> op = <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        :_x(x),</span><br><span class="line">        _y(y),</span><br><span class="line">        _op(op),</span><br><span class="line">        _ret(<span class="number">0</span>),</span><br><span class="line">        _code(SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 验证操作符是否合法</span></span><br><span class="line">        <span class="keyword">if</span>(op != <span class="string">&#x27;+&#x27;</span> &amp;&amp; op != <span class="string">&#x27;-&#x27;</span> &amp;&amp; op != <span class="string">&#x27;*&#x27;</span> &amp;&amp; op != <span class="string">&#x27;/&#x27;</span> &amp;&amp; op != <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _op = <span class="string">&#x27;+&#x27;</span>;                                               <span class="comment">// 默认为加法</span></span><br><span class="line">            _code = UNKNOWN_ERROR;                                   <span class="comment">// 设置错误码</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行运算任务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 重置结果和错误码（避免重复调用时的问题）</span></span><br><span class="line">        _ret = <span class="number">0</span>;</span><br><span class="line">        _code = SUCCESS;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span>(_op)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">                _ret = _x + _y;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                _ret = _x - _y;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">                _ret = _x * _y;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span>(_y == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _code = DIV_ERROR;                               <span class="comment">// 除零错误</span></span><br><span class="line">                    _ret = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _ret = _x / _y;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span>(_y == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _code = MOD_ERROR;                               <span class="comment">// 取模零错误</span></span><br><span class="line">                    _ret = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _ret = _x % _y;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                _code = UNKNOWN_ERROR;                               <span class="comment">// 未知操作符错误</span></span><br><span class="line">                _ret = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重载函数调用操作符，使Task对象可以像函数一样调用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">run</span>();                                                       <span class="comment">// 执行运算</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取任务描述字符串</span></span><br><span class="line">    <span class="function">string <span class="title">get_task</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">to_string</span>(_x) + _op + <span class="built_in">to_string</span>(_y) + <span class="string">&quot;= ???&quot;</span>;        <span class="comment">// 格式：x op y = ???</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取运算结果字符串</span></span><br><span class="line">    <span class="function">string <span class="title">get_ret</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string ret = <span class="built_in">to_string</span>(_x) + _op + <span class="built_in">to_string</span>(_y) + <span class="string">&quot;=&quot;</span> + <span class="built_in">to_string</span>(_ret) + </span><br><span class="line">                     <span class="string">&quot; [错误代码：&quot;</span> + <span class="built_in">to_string</span>(_code) + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取操作符</span></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">get_operator</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取第一个操作数</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_first_operand</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取第二个操作数</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_second_operand</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取运算结果</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_result</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取错误代码</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_error_code</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    ~<span class="built_in">Task</span>()</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> _x, _y;                                                      <span class="comment">// 两个操作数</span></span><br><span class="line">    <span class="type">int</span> _ret;                                                        <span class="comment">// 运算结果</span></span><br><span class="line">    <span class="type">char</span> _op;                                                        <span class="comment">// 操作符</span></span><br><span class="line">    <span class="type">int</span> _code;                                                       <span class="comment">// 错误代码</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="3-Main-cc"><a href="#3-Main-cc" class="headerlink" title="3. Main.cc"></a>3. Main.cc</h4><p>创建多个生产者和消费者线程，生产者生成随机运算任务放入环形队列，消费者从队列取出任务并执行计算，演示多线程协作的生产消费模型。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RingQueue.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Task.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程数据结构，传递给线程函数</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ThreadData</span></span><br><span class="line">&#123;</span><br><span class="line">    RingQueue&lt;Task&gt; *rq;                                             <span class="comment">// 环形队列指针</span></span><br><span class="line">    string threadname;                                               <span class="comment">// 线程名称</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">Productor</span><span class="params">(<span class="type">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ThreadData *td = <span class="built_in">static_cast</span>&lt;ThreadData*&gt;(args);                 <span class="comment">// 获取线程数据</span></span><br><span class="line">    RingQueue&lt;Task&gt; *rq = td-&gt;rq;                                    <span class="comment">// 获取环形队列</span></span><br><span class="line">    string name = td-&gt;threadname;                                    <span class="comment">// 获取线程名称</span></span><br><span class="line">    <span class="type">int</span> len = opers.<span class="built_in">size</span>();                                          <span class="comment">// 操作符个数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)                                                     <span class="comment">// 持续生产</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据：生成随机任务</span></span><br><span class="line">        <span class="type">int</span> data1 = <span class="built_in">rand</span>() % <span class="number">10</span> + <span class="number">1</span>;                                 <span class="comment">// 生成[1,10]随机数</span></span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">10</span>);                                                  <span class="comment">// 微秒延迟</span></span><br><span class="line">        <span class="type">int</span> data2 = <span class="built_in">rand</span>() % <span class="number">10</span>;                                     <span class="comment">// 生成[0,9]随机数</span></span><br><span class="line">        <span class="type">char</span> op = opers[<span class="built_in">rand</span>() % len];                               <span class="comment">// 随机选择操作符</span></span><br><span class="line">        <span class="function">Task <span class="title">t</span><span class="params">(data1, data2, op)</span></span>;                                    <span class="comment">// 创建任务对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 生产数据：将任务放入环形队列</span></span><br><span class="line">        rq-&gt;<span class="built_in">Push</span>(t);                                                 <span class="comment">// 生产任务</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 修复打印格式，添加换行符使输出更清晰</span></span><br><span class="line">        cout &lt;&lt; name &lt;&lt; <span class="string">&quot; 生产任务：&quot;</span> &lt;&lt; t.<span class="built_in">get_task</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);                                                    <span class="comment">// 1秒生产间隔</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">Consumer</span><span class="params">(<span class="type">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ThreadData *td = <span class="built_in">static_cast</span>&lt;ThreadData*&gt;(args);                 <span class="comment">// 获取线程数据</span></span><br><span class="line">    RingQueue&lt;Task&gt; *rq = td-&gt;rq;                                    <span class="comment">// 获取环形队列</span></span><br><span class="line">    string name = td-&gt;threadname;                                    <span class="comment">// 获取线程名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)                                                     <span class="comment">// 持续消费</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1. 消费数据：从环形队列取出任务</span></span><br><span class="line">        Task t;                                                      <span class="comment">// 创建任务对象</span></span><br><span class="line">        rq-&gt;<span class="built_in">Pop</span>(&amp;t);                                                 <span class="comment">// 消费任务（阻塞等待）</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 2. 处理数据：执行任务并输出结果</span></span><br><span class="line">        <span class="built_in">t</span>();                                                         <span class="comment">// 执行运算</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 修复打印格式，添加换行符使输出更清晰</span></span><br><span class="line">        cout &lt;&lt; name &lt;&lt; <span class="string">&quot; 消费任务：&quot;</span> &lt;&lt; t.<span class="built_in">get_task</span>() &lt;&lt; <span class="string">&quot; 结果：&quot;</span> &lt;&lt; t.<span class="built_in">get_ret</span>() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;=== 环形队列生产者-消费者模型 ===&quot;</span> &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>) ^ <span class="built_in">getpid</span>());                                 <span class="comment">// 设置随机种子</span></span><br><span class="line">    RingQueue&lt;Task&gt; *rq = <span class="keyword">new</span> <span class="built_in">RingQueue</span>&lt;Task&gt;(<span class="number">10</span>);                   <span class="comment">// 创建容量为10的环形队列（小一点便于测试）</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> consumers[<span class="number">3</span>], producers[<span class="number">2</span>];                            <span class="comment">// 创建多个消费者和生产者</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建2个生产者线程</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;创建 2 个生产者线程...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ThreadData *td = <span class="keyword">new</span> <span class="built_in">ThreadData</span>();                           <span class="comment">// 创建线程数据</span></span><br><span class="line">        td-&gt;rq = rq;                                                 <span class="comment">// 设置环形队列</span></span><br><span class="line">        td-&gt;threadname = <span class="string">&quot;[生产者-&quot;</span> + <span class="built_in">to_string</span>(i) + <span class="string">&quot;]&quot;</span>;            <span class="comment">// 设置线程名称</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;producers[i], <span class="literal">nullptr</span>, Productor, td);       <span class="comment">// 创建生产者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建3个消费者线程</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;创建 3 个消费者线程...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ThreadData *td = <span class="keyword">new</span> <span class="built_in">ThreadData</span>();                           <span class="comment">// 创建线程数据</span></span><br><span class="line">        td-&gt;rq = rq;                                                 <span class="comment">// 设置环形队列</span></span><br><span class="line">        td-&gt;threadname = <span class="string">&quot;[消费者-&quot;</span> + <span class="built_in">to_string</span>(i) + <span class="string">&quot;]&quot;</span>;             <span class="comment">// 设置线程名称</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;consumers[i], <span class="literal">nullptr</span>, Consumer, td);        <span class="comment">// 创建消费者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待线程结束（实际程序不会退出）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(producers[i], <span class="literal">nullptr</span>);                         <span class="comment">// 等待生产者线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(consumers[i], <span class="literal">nullptr</span>);                         <span class="comment">// 等待消费者线程</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> rq;                                                       <span class="comment">// 释放内存</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/46846.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://www.minbit.top/posts/46846.html')">042 生产者 - 消费者模型</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212543768.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250403212622868.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/46846.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=042 生产者 - 消费者模型&amp;url=https://www.minbit.top/posts/46846.html&amp;pic=https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125732989.png?_r_=41f5b431-c278-6f22-8d77-b77c2a3e65ac" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">MIT</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">50</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125923408.png?_r_=589997d1-2591-0775-e5e3-4f301a7db57f" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/17300.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=db02b3f9-f56f-032b-f799-9be56383925c" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">041 深入理解线程间同步与互斥</div></div></a></div><div class="next-post pull-right"><a href="/posts/64232.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314141714221.png?_r_=519243df-0c97-234c-7f2f-6d61c78297c2" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">043 线程池与线程封装</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/55415.html" title="002 创建普通账户（为朋友创建、删除账户）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=1afc30bf-9522-d21e-c511-fb0d5268d01d" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-17</div><div class="title">002 创建普通账户（为朋友创建、删除账户）</div></div></a></div><div><a href="/posts/49772.html" title="001 环境搭建"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314131841400.png?_r_=9ee1bafa-e274-33f1-613b-cf20cefc2127" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-11</div><div class="title">001 环境搭建</div></div></a></div><div><a href="/posts/42463.html" title="003 系统和入门指令"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=d939bc67-5e7e-b6d8-2dbc-a5d4fdfebdd8" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-22</div><div class="title">003 系统和入门指令</div></div></a></div><div><a href="/posts/15646.html" title="006 yum和Linux生态"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125923408.png?_r_=7afd205c-337c-0453-4e8f-74036342b67a" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-17</div><div class="title">006 yum和Linux生态</div></div></a></div><div><a href="/posts/62462.html" title="007 Linux 开发工具（上）—— vim、解放sudo、gc+"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314140243649.png?_r_=3002b45c-41db-6654-7ddb-65027b7dfb1e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-17</div><div class="title">007 Linux 开发工具（上）—— vim、解放sudo、gc+</div></div></a></div><div><a href="/posts/9242.html" title="004 Linux基本指令"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314141714221.png?_r_=441cb07d-893e-bc36-8a9c-1b54f47db664" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-28</div><div class="title">004 Linux基本指令</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~<br>建议优先查看置顶的 <a href="https://www.minbit.top/posts/17934.html">网站说明</a> 哦~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%EF%BC%88CP-%E9%97%AE%E9%A2%98%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">生产者 - 消费者模型（CP 问题）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%EF%BC%88CP-%E9%97%AE%E9%A2%98%EF%BC%89%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">1. 生产者-消费者模型（CP 问题）是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BB%80%E4%B9%88%E6%98%AF%E2%80%9C%E8%A7%A3%E8%80%A6%E2%80%9D%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%A7%A3%E8%80%A6%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">2. 什么是“解耦”？为什么要解耦？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%A7%A3%E8%80%A6%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 解耦的本质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%A7%A3%E8%80%A6%EF%BC%9F"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 为什么要解耦？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%8E%B0%E5%AE%9E%E7%B1%BB%E6%AF%94%EF%BC%9A%E4%BE%9B%E5%BA%94%E9%93%BE%E7%9A%84%E2%80%9C%E4%BE%9B%E8%B4%A7%E5%95%86-%E8%B6%85%E5%B8%82-%E6%B6%88%E8%B4%B9%E8%80%85%E2%80%9D"><span class="toc-number">1.3.</span> <span class="toc-text">3. 现实类比：供应链的“供货商 - 超市 - 消费者”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%8E%B0%E5%AE%9E%E7%B1%BB%E6%AF%94"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 现实类比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E2%80%9C321-%E5%8E%9F%E5%88%99%E2%80%9D-%E7%90%86%E8%A7%A3-CP-%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. “321 原则” 理解 CP 问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E2%80%9C3-%E7%A7%8D%E5%85%B3%E7%B3%BB%E2%80%9D"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1. “3 种关系”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E2%80%9C2-%E7%A7%8D%E8%A7%92%E8%89%B2%E2%80%9D"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. “2 种角色”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E2%80%9C1-%E4%B8%AA%E4%BA%A4%E6%98%93%E5%9C%BA%E6%89%80%E2%80%9D"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. “1 个交易场所”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-%E2%80%94%E2%80%94-%E5%9F%BA%E4%BA%8E-BlockingQueue-%E7%9A%84%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">4. 代码示例 —— 基于 BlockingQueue 的生产者消费者模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-BlockingQueue-hpp"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. BlockingQueue.hpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Task-hpp"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. Task.hpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-main-cpp"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. main.cpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-POSIX-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">1.5.</span> <span class="toc-text">5. POSIX 信号量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-POSIX-%E4%BF%A1%E5%8F%B7%E9%87%8F%EF%BC%9F%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 什么是 POSIX 信号量？有什么用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-POSIX-%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. POSIX 信号量函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 代码示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%9F%BA%E4%BA%8E%E7%8E%AF%E5%BD%A2%E9%98%9F%E5%88%97%E7%9A%84%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.</span> <span class="toc-text">6. 基于环形队列的生产消费模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%8E%AF%E5%BD%A2%E9%98%9F%E5%88%97%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B%EF%BC%9F"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. 什么是环形队列生产消费模型？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%89%B9%E7%82%B9"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%8E%AF%E5%BD%A2%E9%98%9F%E5%88%97%E4%B8%AD%E5%88%A4%E7%A9%BA-%E5%88%A4%E6%BB%A1%E7%9A%84%E5%A4%84%E7%90%86%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 环形队列中判空 &#x2F; 判满的处理（重点）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.4.</span> <span class="toc-text">4. 常见解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.5.</span> <span class="toc-text">5. 代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-RingQueue-hpp"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">1. RingQueue.hpp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Task-hpp-1"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">2. Task.hpp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Main-cc"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">3. Main.cc</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/62772.html" title="050 传输层 —— UDP"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314125923408.png?_r_=589997d1-2591-0775-e5e3-4f301a7db57f" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="050 传输层 —— UDP"/></a><div class="content"><a class="title" href="/posts/62772.html" title="050 传输层 —— UDP">050 传输层 —— UDP</a><time datetime="2025-09-12T04:00:00.000Z" title="发表于 2025-09-12 12:00:00">2025-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/34998.html" title="049 HTTPS 协议原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314131841400.png?_r_=d20d13f8-c4a1-3018-7b57-dfc505aaf25a" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="049 HTTPS 协议原理"/></a><div class="content"><a class="title" href="/posts/34998.html" title="049 HTTPS 协议原理">049 HTTPS 协议原理</a><time datetime="2025-08-28T04:00:00.000Z" title="发表于 2025-08-28 12:00:00">2025-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/63840.html" title="048 HTTP 协议"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=d7eeeb88-b375-c1d2-71d2-9fa4ce942e93" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="048 HTTP 协议"/></a><div class="content"><a class="title" href="/posts/63840.html" title="048 HTTP 协议">048 HTTP 协议</a><time datetime="2025-08-25T04:00:00.000Z" title="发表于 2025-08-25 12:00:00">2025-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250817000335747.png?_r_=6a0bf21f-d544-710a-2354-ef7b6e11acfb" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="047 网络传输基础：TCP 连接建立与数据序列化"/></a><div class="content"><a class="title" href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化">047 网络传输基础：TCP 连接建立与数据序列化</a><time datetime="2025-08-22T04:00:00.000Z" title="发表于 2025-08-22 12:00:00">2025-08-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/40348.html" title="046 网络编程套接字"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250314131841400.png?_r_=235af0ea-4273-916a-faeb-502ab2004876" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="046 网络编程套接字"/></a><div class="content"><a class="title" href="/posts/40348.html" title="046 网络编程套接字">046 网络编程套接字</a><time datetime="2025-08-15T04:00:00.000Z" title="发表于 2025-08-15 12:00:00">2025-08-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.com/huangcancan-xbc/Drawing-bed/blob/master/Blog/20250307201719879.png?raw=true" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。","梦想是不会发光的，发光的是追梦的你！"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">6</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GitHub"/><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="哔哩哔哩"/><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="Gitee"/><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="CSDN"/><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="稀土掘金"/><span class="back-menu-item-text">稀土掘金</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size: 0.88rem;">C++<sup>8</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size: 0.88rem;">IO<sup>3</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>50</sup></a><a href="/tags/Obsidian/" style="font-size: 0.88rem;">Obsidian<sup>1</sup></a><a href="/tags/STL/" style="font-size: 0.88rem;">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size: 0.88rem;">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size: 0.88rem;">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size: 0.88rem;">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size: 0.88rem;">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 0.88rem;">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 0.88rem;">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size: 0.88rem;">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size: 0.88rem;">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 0.88rem;">网站<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>6</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 0.88rem;">进程<sup>15</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("01/01/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2025 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-olive-one.vercel.app/',
      // 自己额外添加的：
      path: location.pathname.replace(/index\.html$/, ''),
      
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-olive-one.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-olive-one.vercel.app/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "xiaomilidedamai@minbit.top";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>//- 留言板页面弹幕
window.addEventListener('load', () => {
  const getnaokuo_danmu = () => {
    if (!window.location.pathname.startsWith('/comments/')) return; //- 判断是否是留言板页面
    const naokuo_danmu = async () => {
      const Danmaku = new EasyDanmaku({
        page: '/comments/', //- 即留言板地址
        el: '#danmu-wrap', //- 弹幕挂载节点
        line: 5, //- 弹幕行数
        speed: 20, //- 弹幕播放速度
        hover: true, //- 鼠标hover时是否暂停播放弹幕
        loop: false, //- 开启循环播放
        colourful: true, //- 开启彩色弹幕
        coefficient: 1.38, //- 弹幕密度系数
        runtime: 10, //- 循环弹幕播放时长
      });
      try {
        let danmuStore = saveToLocal.get('twikoo-danmu');
        if (!danmuStore) {
          const options = {
            method: "POST",
            body: JSON.stringify({
              "event": "GET_RECENT_COMMENTS",
              "includeReply": false,
              "pageSize": 100
            }),
            headers: { 'Content-Type': 'application/json' }
          }
          danmuStore = [];
          const response = await fetch(`https://twikoo-olive-one.vercel.app/`, options);
          if (response.ok) {
            const { data } = await response.json();
            //- console.info(data);
            data.forEach(i => {
              if (i.avatar == undefined) i.avatar = 'https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp'
              danmuStore.push({ avatar: i.avatar, content: i.nick + '：' + formatDanmaku(i.comment), url: i.url + '#' + i.id })
            });
            Danmaku.batchSend(danmuStore, true);
            saveToLocal.set('twikoo-danmu', danmuStore, 0.5)
          }
          //- 格式化评论
          function formatDanmaku(str) {
            str = str.replace(/<\/*br>|[\s\uFEFF\xA0]+/g, '');
            str = str.replace(/<img.*?>/g, '[图片]');
            str = str.replace(/<a.*?>.*?<\/a>/g, '[链接]');
            str = str.replace(/<pre.*?>.*?<\/pre>/g, '[代码块]');
            str = str.replace(/<.*?>/g, '');
            return str
          }
        } else {
          Danmaku.batchSend(danmuStore, true);
        }
      } catch (err) {
        console.error("Error fetching data:", err);
      }

      document.getElementById('danmu-Btn') && (document.getElementById('danmu-Btn').innerHTML = `<button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.remove('hide-danmu')">显示弹幕</button> <button class="hide-Btn" onclick="document.getElementById('danmu-wrap').classList.add('hide-danmu')">隐藏弹幕</button>`)
    }
    (async () => {
      if (typeof EasyDanmaku === 'function') {
        await naokuo_danmu();
      } else {
        const easyDanmakuScript = await getScript('https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js');
        if (typeof EasyDanmaku === 'function') {
          await naokuo_danmu();
        } else {
          console.error('EasyDanmaku function not found even after loading the script.');
        }
      }
    })();
  }
  getnaokuo_danmu()
  document.addEventListener('pjax:complete', getnaokuo_danmu)
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>