<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>051 传输层 —— TCP（上） | 小米里的大麦</title><meta name="keywords" content="Linux,网络"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="051 传输层 —— TCP（上）"><meta name="application-name" content="051 传输层 —— TCP（上）"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="051 传输层 —— TCP（上）"><meta property="og:url" content="https://www.minbit.top/posts/42057.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="传输层 —— TCP（上） 你管这破玩意叫 TCP？| B 站（荐） 传输层协议 ——— TCP 协议 | CSDN Linux：TCP 保证可靠性的方案（1）| CSDN  1. 传输控制协议1. TCP 的本质：传输控制协议 —— “控制”二字是灵魂 TCP 全称 Transmission Co"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=0f19e815-8b67-c290-cc36-cf5e36871ff1"><meta property="article:author" content="小米里的大麦"><meta property="article:tag" content="技术博客,Linux,C++,后端开发,编程学习,个人博客,技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=0f19e815-8b67-c290-cc36-cf5e36871ff1"><meta name="description" content="传输层 —— TCP（上） 你管这破玩意叫 TCP？| B 站（荐） 传输层协议 ——— TCP 协议 | CSDN Linux：TCP 保证可靠性的方案（1）| CSDN  1. 传输控制协议1. TCP 的本质：传输控制协议 —— “控制”二字是灵魂 TCP 全称 Transmission Co"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "051 传输层 —— TCP（上）",
  "description": "传输层 —— TCP（上） 你管这破玩意叫 TCP？| B 站（荐） 传输层协议 ——— TCP 协议 | CSDN Linux：TCP 保证可靠性的方案（1）| CSDN  1. 传输控制协议1. TCP 的本质：传输控制协议 —— “控制”二字是灵魂 TCP 全称 Transmission Co",
  "image": "https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=0f19e815-8b67-c290-cc36-cf5e36871ff1",
  "datePublished": "2025-09-20T04:00:00.000Z",
  "dateModified": "2025-10-03T04:00:00.000Z",
  "author": {
    "@type": "Person",
    "name": "小米里的大麦",
    "url": "https://www.minbit.top"
  },
  "publisher": {
    "@type": "Organization",
    "name": "小米里的大麦",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.minbit.top/img/Profile%20picture.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.minbit.top/posts/42057.html"
  },
  "keywords": "Linux, 网络"
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "首页",
      "item": "https://www.minbit.top"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "051 传输层 —— TCP（上）",
      "item": "https://www.minbit.top/posts/42057.html"
    }
  ]
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "小米里的大麦",
  "url": "https://www.minbit.top",
  "image": "https://www.minbit.top/img/Profile%20picture.png",
  "description": "时间好像总会留下点什么，或许是一个人，或许是一个梦，或许……是一段有意义的经历~"
}</script><link rel="shortcut icon" href="/img/icons/funny.svg"><link rel="canonical" href="https://www.minbit.top/posts/42057.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//bsz.dusays.com:9001"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"友链 + 外链 + 无限进步！欢迎欣赏和贡献！",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"小米里的大麦",mode:"local",switchBtn:!1,btnLink:"https://afdian.net/item/886a79d4db6711eda42a52540025c377",randomNum:4,basicWordCount:1999,key:"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv",Referer:"https://www.minbit.top/"},diytitle:{enable:!0,leaveTitle:"w(ﾟДﾟ)w 不要走！再看看嘛！",backTitle:"♪(^∇^*)欢迎肥来！"},LA51:{enable:!0,ck:"Jp8wwGQpp21utaFQ",LingQueMonitorID:"Jp8ztDRrxmTf7LDj"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.minbit.top/",commentBarrageConfig:{enable:!0,maxBarrage:10,barrageTime:5e3,accessToken:"25c96851dd8a790c4819ad4bfbaf153c",mailMd5:"7b12ebc2be80f9159099f6ab0e16573c"},music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:void 0,navMusic:!0,mainTone:{mode:"both",api:"https://img2color-go.vercel.app/api?img=",cover_change:!0},authorStatus:{skills:["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"距上次更新已过去",messageNext:"天了，这篇文章的内容可能已经过时了。"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!0,limitCount:150,languages:{author:"作者: 小米里的大麦",link:"链接: ",source:"来源: 小米里的大麦",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"小米里的大麦",title:"051 传输层 —— TCP（上）",postAI:"这篇文章讲述了TCP协议的本质及其在网络传输中的核心作用，强调了TCP协议对数据传输过程的精细控制，包括动态调整发送速率、处理丢包重传和乱序重组等，确保数据可靠传输。文章探讨了TCP与文件系统的关联，展示了Linux中“一切皆文件”的哲学体现，以及网络I/O和文件I/O在抽象层面的统一。此外，文章还分析了TCP协议段格式，包括源端口、目的端口、序号、确认序号、首部长度、标志位、窗口大小、检验和等关键字段的功能和作用，并解释了TCP如何通过端口号区分不同的进程通信。文章还深入探讨了TCP的确认应答机制、超时重传机制以及连接管理机制，包括三次握手和四次挥手的过程和必要性，突出了TCP协议在不可靠网络环境中实现可靠传输的智能调度和错误恢复能力。",pageFillDescription:"传输层 —— TCP（上）, 1. 传输控制协议, 1. TCP 的本质：传输控制协议 —— 控制二字是灵魂, 2. TCP 和文件系统的关联？—— 一切皆文件的完美体现, 3. 不考虑可靠性数据在网络中如何流动？, 4. 为什么 UDP 无发送缓冲区而 TCP 必须有？, 5. TCP 小结 —— 一个智能缓冲区控制器, 2. 协议段格式, 1. TCP 的协议段格式, 2. 逐字段详解（重要）, 1. 16 位源端口号 amp 目的端口号（各 16 位共 2+2 x3D 4 字节）, 2. 32 位序号（4 字节）, 3. 32 位确认序号（4 字节）, 4. 4 位首部长度（4 位 0.5 字节）, 5. 保留字段（6 位 0.75 字节了解）, 6. 6 个标志位（0.75 字节）, 7. 16 位窗口大小（2 字节）, 8. 16 位检验和（2 字节了解）, 9. 16 位紧急指针（2 字节）, 10. 选项（了解）, 11. 数据（了解）, 3. TCP 报头如何分离数据？, 4. 如何交付给上层？, 5. 关于 16 位校验和, 6. 为什么 TCP 报头没有长度字段？, 7. TCP 连接建立可能失败, 8. 连接怎样才算成功建立？, 3. 确认应答（ACK）机制, 4. 超时重传机制, 5. 连接管理机制, 1. TCP 是面向连接的协议, 2. 操作系统如何管理 TCP 连接？, 3. 为什么建立连接需要三次握手？, 1. 一次握手行不行？, 2. 两次握手行不行？, 3. 三次握手如何解决？, 4. 三次握手绝对可靠吗？, 4. 为什么断开连接需要四次挥手？, 5. 套接字（Socket）、connect、accept 与三次握手的关系, 1. connect() 的本质, 2. accept() 的本质, 3. 没有 accept() 能建立 TCP 连接吗？, 6. 小结, 6. 理解 TIME_WAIT 状态, 1. 如何触发 TIME_WAIT？, 2. 用 netstat 查看 TIME_WAIT, 3. 2MSL 是什么？, 7. 解决 TIME_WAIT 状态引起的 bind 失败的方法（作业）, 8. 理解 CLOSE_WAIT 状态, 1. 如何进入 CLOSE_WAIT？, 2. CLOSE_WAIT 的问题, 3. 排查 CLOSE_WAIT传输层上你管这破玩意叫站荐传输层协议协议保证可靠性的方案传输控制协议的本质传输控制协议控制二字是灵魂全称传输控制协议人如其名它的核心职责不是传输数据而是对数据的传输过程进行精细动态可靠的控制我们平时调用的等函数要么将用户缓冲区的内容拷贝到发送缓冲区要么将接受缓冲区的内容拷贝到用户缓冲区进行处理本质上都是缓冲区拷贝函数将用户缓冲区数据拷贝到内核的发送缓冲区将内核的接收缓冲区数据拷贝到用户缓冲区通过协议控制网络传输将可靠性数据从一台主机的发送缓冲区安全地交付到另一台主机的接收缓冲区要求数据原封不动的发送过去所谓发送本质上是一种也是一种跨网络的拷贝其本质就是不断把数据放到网络中而数据何时发送发多少丢包后怎么重传拥塞时怎么降速乱序时怎么重组这些全部由协议栈自主决策应用程序完全无感知当然对方也可以对我们发送因为是全双工的有自己的发送缓冲区和接受缓冲区和文件系统的关联一切皆文件的完美体现在中文件和网络在抽象层面高度统一都遵循缓冲区内核硬件的模型对比文件网络用户调用数据去向内核页缓存发送缓冲区最终目标磁盘慢速设备网卡远程主机更慢不可靠刷新时机缓冲区刷到磁盘盘由决定由协议决定如窗口拥塞控制出错处理磁盘错误罕见概率极低通常忽略文件需经过网络需要有来确保可靠性核心思想文件是本地存储的抽象是远程通信的抽象但它们在模型缓冲区管理阻塞非阻塞行为上高度一致这就是一切皆文件的哲学体现统一接口统一缓冲统一调度只是底层驱动不同补充在中也有文件描述符也能用也能设置也能被监控完全兼容文件接口不考虑可靠性数据在网络中如何流动我们想要发送一个网络数据先在应用层通过相关的协议对结构化数据做序列化然后放到发送缓冲区中然后会帮我们在适当的时机把数据发送到对方的接收缓冲区等待对方的应用层通过读取此时一般会出现两种情况接收方处理慢数据堆积在接收缓冲区对方上层由于忙碌始终无法处理使得多次发送的报文都堆积在接收缓冲区当他不忙碌时可能一次就都读上去了然后上层再需要对这些数据解析成一个个完整报文因为是面向字节流的然后反序列化成结构化数据供上层使用而如果凑不齐一个报文就将他们暂时存储在自己的用户层缓冲区等下次的时候如果凑齐了再一起拿出来解析发送方不发网络拥塞接收方阻塞对方的上层会在合适的时机进行但是如果发送方始终没有发送或者网络太拥堵导致接收缓冲区一直没有数据那么就会阻塞住然后就会把这个进程设置为状态而当缓冲区有数据的时候也就是说某些资源就绪的时候会再次调度这个进程去把数据从缓冲区读上来所以以前我们觉得某些资源不就绪从而使得进程暂时进入状态大多数指的是硬件的速度比较慢所以需要等待硬件资源就绪但是今天我们发现在网络的情况中也有可能是因为对方始终不给你发数据或者由于网络拥塞造成接收缓冲区没有数据可处理也是属于资源不就绪的情况此时调用的这个进程就必须阻塞住资源不就绪不仅指本地硬件磁盘键盘也包括远程资源网络数据未到达网络的等待本质是等待不可控的外部世界这是分布式系统复杂性的根源为什么无发送缓冲区而必须有发了就是发了他并不关心对方的接收缓冲区是不是满了如果满了他就会丢包此时我们是无感的不保证可靠性但是需要保证可靠性啊核心区别在于可靠性保证直接把数据交给层发出发完就不管了对方收没收到接收缓冲区满不满它都不关心应用层必须自己处理丢包乱序等问题必须保证数据可靠送达所以发送缓冲区是必不可少的暂存应用层写入的数据等对方确认后再清除应对对方接收缓冲区不足对方的窗口大小会告诉你我还能收多少如果满了就得把数据先留在发送缓冲区应对网络抖动丢包或超时重传时也得从发送缓冲区里重新取出数据再发如果没有发送缓冲区应用层写的数据就会丢在半路因为网络或接收方不可能一直实时响应那就完全无法做到可靠传输小结一个智能缓冲区控制器层面的角色对应用层提供可靠字节流抽象屏蔽网络复杂性对内核管理发送接收缓冲区实现流量拥塞控制对网络动态调整发送策略对抗丢包延迟乱序对哲学体现控制本质不是搬运工而是调度大师不是管道而是智能调度器缓冲区管理器错误恢复引擎它让不可靠的网络看起来像可靠的本地内存拷贝协议段格式的协议段格式这依然是一个逻辑结构图仅用来表示首部中各字段的位置大小和含义实际传输时数据是连续的字节流按顺序排列在包中在物理传输层面无论是还是数据最终都以字节流比特流的形式在网络介质中传输逐字段详解重要位源端口号目的端口号各位共字节作用标识通信双方的应用程序用途实现多路复用一台主机同时跑多个连接源端口发送方的应用使用的端口如客户端随机端口目的端口接收方应用监听的端口比如默认默认示例客户端服务器位序号字节作用给每个字节编号实现可靠传输排序重传从而保证数据能按顺序组装是字节流协议不是像那样一包一包发出去的每个字节在字节流里都有编号每个字节都有一个唯一的序号初始值由系统随机生成防止攻击发送时递增接收方根据序号判断是否乱序或丢失示例第一个包序号载荷字节下一个包序号接收方收到后会检查序号是否连续否则要求重传位确认序号字节作用告诉对方我下一个想收到的字节号只有当标志位为时有效用于确认对方已成功接收数据举例如果确认号说明我已经收到对方号字节之前的所有数据期待下一个是这是可靠传输的核心机制发送方根据确认号判断数据是否成功送达示例发送了序号的数据字节收到后回复表示我收到了期待下一个是提示示例中里的是确认序号不是标志位的值只有当标志位为时确认序号才有效这里默认标志位为表明已收到序号之前的所有数据位首部长度位字节表示首部的长度以位即字节为单位最小是单位以字节为个单位即字节因为基本首部固定就是字节提示这里单位可能有点不好理解多读两遍即可范围即字节最小值字节无选项如果有选项首部就会变长从而大于比如三次握手时常见的选项保留字段位字节了解必须设为供未来扩展个标志位字节这是中最核心的部分之一控制连接建立释放和数据传输标志全称含义作用常见场景紧急指针有效表示报文中有紧急数据接收方要优先处理这部分数据跳过普通队列几乎不用现在应用层自己处理优先级确认序号是否有效几乎总是表明报文头的字段生效用于确认收到对方的数据或请求建立连接之后几乎所有报文都带三次握手数据传输四次挥手全过程推送数据提示接收方立即交给应用层即提示接收端应用程序立刻从缓冲区把数据读走不要等缓冲区填满再交付偶尔用交互式应用实时输入实时输出强制断开异常连接或拒绝无效请求对方会要求重新建立连接我们把携带标识的称为复位报文段端口未监听时回应异常关闭攻击防御用于同步序号请求建立连接同时传递初始序列号发起连接时置同时我们把携带标识的称为同步报文段三次握手的第步和第步请求关闭连接表示本端数据发完了准备断开四次挥手的第步和第步特别重要三次握手和四次挥手都依赖这些标志位位窗口大小字节作用告诉对方我还能接收多少字节的数据单位字节比如窗口说明从我期望的确认号开始我还能接收个字节这样发送方就不会把数据塞爆接收方的缓冲区直到收到新窗口通知这是流量控制的关键防止发送方过快导致接收方缓冲区溢出动态变化接收方每收到数据就更新窗口大小并回传位检验和字节了解对整个段包括伪首部首部数据进行校验检测传输错误若检验和不匹配丢弃该报文注意检验和是必须计算的而检验和是可选的位紧急指针字节搭配标志使用仅当标志位为时有效用于指出本报文中紧急数据的最后一个字节位置现代应用几乎不用简单了解就好示例序号紧急指针紧急数据从到选项了解可变长度最多字节总首部最大字节常见选项最大报文段长度协商双方最大发送大小选择性确认提高重传效率时间戳用于测量和防重放填充用保持对齐数据了解紧跟在首部之后长度由总长度首部长度首部长度决定由上层应用如提供你这四个问题其实正好把报文头的关键设计思想给串起来了我帮你捋清楚报头如何分离数据先读字节再看首部长度根据首部长度决定选项大小剩下的就是数据第一步读取前字节最小头部固定部分报头最短字节这部分字段顺序固定源端口目的端口序号确认号第二步解析首部长度字段在这个字节里有一个首部长度字段它是位单位是字节提示这里位是二进制数最小值是即十进制的表示个字节字节如果首部长度表示字节没有选项只有固定部分如果首部长度表示字节有字节选项第三步跳过头部剩余部分就是数据数据起始位置数据报起始位置头部长度头部长度数据长度总长度头部长度头部长度和类似区别在于的报头固定字节而且直接有个字段长度所以简单粗暴因为要扩展功能才搞了个首部长度选项的自描述方式有了自描述头部长度然后从层借总长度来推算数据长度如何交付给上层用端口号来做区分每个进程通过套接字端口来绑定通信报文里的源端口目的端口就告诉内核这是谁发的源端口应该交给哪个进程目的端口所以收到数据后靠目的端口查路由表找到本机监听该端口的进程把数据放进它的接收缓冲区应用层再关于位校验和校验和不光包含头和数据还要算上一个伪首部里面有源目的协议号等字段为什么要多此一举因为要防止收到了正确的数据但收错了目的地这种事伪首部相当于再确认一次这数据确实是发给我的校验和覆盖范围头数据伪首部如果校验失败接收方直接丢掉报文不给上层进程为什么报头没有长度字段这个设计正是因为面向字节流是面向报文一发就是一块必须告诉你这块有多长所以有把数据看作一个连续的字节流应用层想写多少就写多少内核可能拆成多个报文段发出去接收方只管把这些字节按顺序拼接起来对来说什么时候算一条完整的消息由应用层自己决定所以报头里没必要放长度字段只需要知道首部多长方便找到数据起点知道数据流的位置靠序号字段来标记每个字节像快递小哥一单一单送包裹上贴着这是一个的包裹所以每个报文都带长度像水管输水不管你倒一桶还是倒十桶水流不断过去水分段传输但水的总量是靠序号控制的不需要每次标记这一桶多大连接建立可能失败虽然保证已建立连接后的数据传输可靠性但连接建立过程本身可能失败三次握手过程中任何一个步骤出现问题都会导致连接失败第一次握手失败客户端包丢失或被防火墙过滤第二次握手失败服务器包丢失第三次握手失败客户端包丢失连接怎样才算成功建立连接的成功建立需要双方都进入状态但客户端和服务器进入该状态的时机不同客户端视角在收到服务器的后立即发送并同时进入状态此时即使该报文后续丢失客户端仍认为连接已建立可立即发送数据服务器视角必须实际收到客户端的第三次握手后才从状态转入状态认为连接真正建立因此只有当双方都进入状态时连接才算完全成功建立若第三次握手丢失服务器会重传最多次一般默认次若仍无响应则放弃连接而客户端若已发送数据服务器在收到数据时也可推断连接应已建立从而完成状态转换这是的优化机制之一确认应答机制的确认应答机制就是接收方通过告诉发送方到某个字节为止我都收到了下一个字节从这里开始发发送方据此判断哪些数据已经成功送达哪些需要重传从而保证数据传输的可靠性和有序性将每个字节的数据都做了编号即为序列号每一个都带有对应的确认序列号意思是告诉发送者我已经收到了哪些数据下一次你从哪里开始发超时重传机制的超时重传机制是为了在网络不可靠的环境中确保数据可靠传输而设计的重要机制其核心思想是当发送方如主机发送数据后若在一定时间内未收到接收方如主机返回的确认应答就认为该数据可能丢失从而触发重传没收到可能是因为数据包丢了也可能是自己丢了通过序列号来识别重复数据避免重复交付由于网络状况动态变化固定的超时时间难以适应所有场景设得太短会导致不必要的重复重传浪费带宽设得太长则会降低传输效率因此采用动态调整的超时时间并结合指数退避策略来平衡效率与可靠性具体机制如下基于序列号去重接收方利用报文中的序列号识别重复数据包自动丢弃重复内容确保数据不被重复处理初始超时时间系统通常以毫秒秒为基本单位如等首次重传的超时时间设为的整数倍指数退避若重传后仍未收到则下一次重传的等待时间按指数增长例如第次重传等待第次重传等待第次重传等待第次重传等待以此类推即每次重传间隔翻倍重传上限当重传次数达到系统设定的阈值如默认约次会判定连接异常如网络中断或对端宕机主动终止连接通过这种动态自适应的超时重传机制便能在各种网络环境下兼顾传输的可靠性与效率连接管理机制是面向连接的协议什么是面向连接不是直接在两台主机之间通信而是在两个端点之间建立一条虚拟的可靠的逻辑通道这条通道称为连接每个连接由四元组唯一标识源源端口目标目标端口一台服务器可以同时与多个客户端建立多个独立的连接为什么需要连接如果没有连接的概念服务器只有一个全局接收缓冲区所有客户端的数据都会混在一起无法区分来源也无法保证顺序可靠性等连接的存在使得每个通信对都有独立的发送接收缓冲区序列号窗口状态等从而实现可靠传输结论的所有可靠性机制如重传确认流量控制拥塞控制都是基于连接的而不是主机到主机的操作系统如何管理连接采用先描述再组织的方式管理连接描述用一个内核数据结构如或来描述一个连接包含四元组信息发送接收缓冲区序列号确认号状态等超时重传计时器拥塞控制参数等组织将所有连接结构体组织成高效的数据结构如哈希表链表红黑树主要是采用分层哈希链表的混合结构便于快速查找插入删除建立连接分配并初始化一个连接结构体插入管理结构断开连接从管理结构中移除释放资源缓冲区内存等成本每个连接都占用内存和资源因此高并发服务器需优化连接管理如使用连接池等为什么建立连接需要三次握手一次握手行不行如果客户端发服务器收到后直接认为连接建立那么就会产生问题服务器无法确认客户端是否真的能收到自己的响应如果是旧的重复包比如网络延迟很久后到达服务器会错误地建立连接浪费资源两次握手行不行客户端发服务器回认为连接已建立客户端收到后开始发数据产生的问题如果客户端的丢失了即服务器的未被客户端收到客户端不会重发但服务器已经认为连接建立了会一直等待数据资源浪费攻击原理更严重的是服务器无法确认客户端是否具备接收能力洪水攻击什么是华为云服务器在处理连接时维护两个关键队列半连接队列存放已收到客户端回复了但尚未收到最终的半连接全连接队列则存放三次握手已完成等待应用程序如服务调用处理的全连接当半连接因客户端未回而超时全连接队列溢出或客户端与服务器对连接状态认知不一致时就会出现连接不一致问题导致资源浪费甚至正常连接被拒绝洪水正是利用半连接队列的弱点攻击者发送大量伪造源的请求却故意不回使服务器堆积大量无效半连接耗尽队列资源为放大攻击效果黑客通常操控大量被控制的肉机即傀儡机组成僵尸网络协同发起攻击年初那种人多肉机多在浏览器上不断点刷新让服务器无响应的攻击本质是早期简单的分布式拒绝服务虽和洪水利用漏洞的原理不同但核心都是靠大量肉机或真实用户设备持续提升请求量耗尽服务器的带宽内存等资源最终让服务器无法响应正常用户三次握手如何解决第一次客户端证明自己能发第二次服务器证明自己能收能发第三次客户端证明自己能收确认收到服务器的三次握手确保了双方都能收能发双向通信能力验证防止历史重复连接请求造成错误建立初始化双方的序列号避免数据混淆三次是最小可靠次数少于三次无法同时验证双向通信能力多于三次则冗余三次握手绝对可靠吗在正常网络下三次握手能可靠建立连接但在极端情况仍可能失败不过的设计目标是在不可靠网络上提供可靠传输三次握手是理论和实践平衡下的最优解为什么断开连接需要四次挥手因为是全双工的数据可以同时双向传输断开时每个方向都要独立关闭为什么不能合并第步第步是对客户端的确认必须立即响应否则客户端会重传第步是服务器主动发起关闭但服务器可能还有数据要发送不能立刻发所以和通常不能合并除非服务器在收到时恰好没有待发数据此时可合并为一次类似但叫套接字与三次握手的关系的本质客户端调用触发第一次握手内核自动完成后续两次握手返回时三次握手已完成连接已建立的本质服务器调用后进入监听状态当收到客户端的第一次握手内核会为该连接创建一个新的结构体子的作用是从已完成连接队列中取出这个新并返回给应用程序注意三次握手在调用之前就已完成关键结论三次握手由操作系统内核自动完成与应用程序是否调用无关即使服务器没有调用只要了内核仍会响应完成三次握手并将连接放入已完成队列如果不及时调用队列满后新连接会被拒绝限制没有能建立连接吗没有方法能建立连接吗站能连接在内核层面已经建立状态但应用程序无法通过获取该连接的也就无法读写数据连接会一直占用内核资源直到超时或被关闭小结问题回答为什么是面向连接的为了隔离不同通信对提供独立的可靠传输通道缓冲区序列号等操作系统如何管理连接用结构体描述连接用数据结构组织增删查改即连接管理为什么三次握手最小次数验证双方收发能力防止历史连接干扰两次不够一次更不行三次握手绝对可靠吗在常规网络下可靠是工程与理论的最优平衡为什么四次挥手全双工需双向关闭每方向关闭需第次挥手为何不能合并服务器需先客户端再等自己数据发完才发自己的的本质触发握手从内核队列取已建立的连接没有能建立连接吗能三次握手由内核完成只是应用层获取连接句柄连接建立成功和有关系吗无直接关系连接在前已建立只是领取连接理解状态如何触发当主动关闭连接的一方即首先发送的那一端完成四次挥手的最后一步发送最后一个后会进入状态并持续一段时间通常是举例客户端调用发送最终进入用查看或更详细是什么表示报文在网络中最大存活时间通常为秒中默认秒超过的报文会被路由器丢弃是可靠关闭的保障机制即的持续时间默认秒目的有两个确保最后一个能到达对方如果丢失对方会重发本端仍处于可再次响应避免对方在防止旧连接的迷途报文干扰新连接等待后网络中所有属于该连接的旧报文都已消失此时即使复用相同四元组如快速重启服务也不会混淆数据可以控制状态的超时时间即本端发了对方了但对方迟迟不发自己的但它不影响的持续时间的时长仅由决定在中硬编码为秒不可通过直接修改默认秒影响始终是秒不受此参数影响将时间缩短到秒虽不可改时长但可优化其影响使用避免服务器主动关闭连接让客户端先调整限制数量超限则提前清除解决状态引起的失败的方法作业这是我们经常会遇到的一个问题服务器程序如服务监听程序退出后立即重启调用失败会报错原因上次连接由服务器主动关闭服务器进入期间四元组特别是本地端口仍被占用新程序尝试同一个端口内核拒绝默认不允许复用处于的地址解决方法使用选项作用允许新绑定到处于状态的地址端口注意不能复用状态的端口只对有效这就是为什么几乎所有服务器程序在前都会设置理解状态如何进入对端如客户端发送本端服务器收到后内核自动回复此时本端状态变为表示对端已关闭本端应尽快调用关闭自己的方向的问题本身是正常状态但如果长期存在说明应用程序忘记调用后果文件描述符泄漏内存泄漏接收缓冲区不释放最终耗尽系统资源服务崩溃排查查看进程打开的根本解决检查代码确保在读到返回后调用",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-10-03 12:00:00",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach(e=>{c.setAttribute(e,t[e])}),document.head.appendChild(c)}),e.getCSS=(e,t=!1)=>new Promise((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=10||e>=20?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())})}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/custom/css/font.css"><link rel="stylesheet" href="/custom/css/bilibili.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="小米里的大麦" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/Profile%20picture.png"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">算法</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://ac.nowcoder.com/acm/contest/profile/517073385" title="牛客"><img class="back-menu-item-icon" src="/img/icons/think.svg" alt="牛客"><span class="back-menu-item-text">牛客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/1367427" title="洛谷"><img class="back-menu-item-icon" src="/img/icons/funny.svg" alt="洛谷"><span class="back-menu-item-text">洛谷</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" alt="微信" src="/img/wechat.webp"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="/img/alipay.webp"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:1.05rem">AI<sup>2</sup></a><a href="/tags/C/" style="font-size:1.05rem">C++<sup>11</sup></a><a href="/tags/Git/" style="font-size:1.05rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:1.05rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:1.05rem">Linux<sup>59</sup></a><a href="/tags/MySQL/" style="font-size:1.05rem">MySQL<sup>9</sup></a><a href="/tags/Redis/" style="font-size:1.05rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:1.05rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:1.05rem">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:1.05rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:1.05rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:1.05rem">历程<sup>2</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:1.05rem">地址空间<sup>6</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size:1.05rem">工具<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:1.05rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:1.05rem">模板<sup>1</sup></a><a href="/tags/%E7%81%B5%E5%85%89%E8%8D%9F%E8%90%83/" style="font-size:1.05rem">灵光荟萃<sup>3</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:1.05rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:1.05rem">线程<sup>5</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:1.05rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:1.05rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:1.05rem">进程<sup>15</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">一月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a><a class="article-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>网络</span></a></span></div></div><h1 class="post-title" itemprop="name headline">051 传输层 —— TCP（上）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-09-20T04:00:00.000Z" title="发表于 2025-09-20 12:00:00">2025-09-20</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-03T04:00:00.000Z" title="更新于 2025-10-03 12:00:00">2025-10-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.3k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>26分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="051 传输层 —— TCP（上）"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=0f19e815-8b67-c290-cc36-cf5e36871ff1"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/42057.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><a href="/tags/%E7%BD%91%E7%BB%9C/" tabindex="-1" itemprop="url">网络</a><h1 id="CrawlerTitle" itemprop="name headline">051 传输层 —— TCP（上）</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-09-20T04:00:00.000Z" title="发表于 2025-09-20 12:00:00">2025-09-20</time><time itemprop="dateCreated datePublished" datetime="2025-10-03T04:00:00.000Z" title="更新于 2025-10-03 12:00:00">2025-10-03</time></header><h1 id="传输层-——-TCP（上）"><a href="#传输层-——-TCP（上）" class="headerlink" title="传输层 —— TCP（上）"></a>传输层 —— TCP（上）</h1><blockquote><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1WT6SYXE2S/?share_source=copy_web&vd_source=872e5e3ccf44874c39edaf42e30ab0de">你管这破玩意叫 TCP？| B 站（荐）</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenlong_cxy/article/details/125234768">传输层协议 ——— TCP 协议 | CSDN</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_51142926/article/details/143895259">Linux：TCP 保证可靠性的方案（1）| CSDN</a></p></blockquote><h2 id="1-传输控制协议"><a href="#1-传输控制协议" class="headerlink" title="1. 传输控制协议"></a>1. 传输控制协议</h2><h3 id="1-TCP-的本质：传输控制协议-——-“控制”二字是灵魂"><a href="#1-TCP-的本质：传输控制协议-——-“控制”二字是灵魂" class="headerlink" title="1. TCP 的本质：传输控制协议 —— “控制”二字是灵魂"></a>1. TCP 的本质：传输控制协议 —— “控制”二字是灵魂</h3><blockquote><p>TCP 全称 <strong>Transmission Control Protocol（传输控制协议）</strong> —— 人如其名，它的核心职责不是“传输数据”，而是 <strong>对数据的传输过程进行精细、动态、可靠的控制</strong>。</p></blockquote><p>我们平时调用的 <code>write</code>、<code>send</code>、<code>read</code>、<code>recv</code> 等函数，要么将用户缓冲区的内容拷贝到发送缓冲区，要么将接受缓冲区的内容拷贝到用户缓冲区进行处理，本质上都是 <strong>缓冲区拷贝函数</strong>：</p><ul><li><code>send/write</code> → 将用户缓冲区数据拷贝到内核的 <strong>TCP 发送缓冲区</strong>。</li><li><code>recv/read</code> → 将内核的 <strong>TCP 接收缓冲区</strong> 数据拷贝到用户缓冲区。</li></ul><p>通过 TCP 协议控制网络传输，将可靠性数据从一台主机的发送缓冲区安全地交付到另一台主机的接收缓冲区，要求数据原封不动的发送过去，所谓发送，本质上是一种也是一种跨网络的拷贝！其本质就是不断把数据放到网络中。而数据何时发送？发多少？丢包后怎么重传？拥塞时怎么降速？乱序时怎么重组？—— 这些全部由 <strong>TCP 协议栈自主决策</strong>，应用程序完全无感知！当然，对方也可以对我们发送，因为 TCP 是全双工的，有自己的发送缓冲区和接受缓冲区！</p><h3 id="2-TCP-和文件系统的关联？——-“一切皆文件”的完美体现"><a href="#2-TCP-和文件系统的关联？——-“一切皆文件”的完美体现" class="headerlink" title="2. TCP 和文件系统的关联？—— “一切皆文件”的完美体现"></a>2. TCP 和文件系统的关联？—— “一切皆文件”的完美体现</h3><p>在 Linux 中，<strong>文件 I&#x2F;O 和网络 I&#x2F;O 在抽象层面高度统一</strong>，都遵循“缓冲区 → 内核 → 硬件”的模型：</p><table><thead><tr><th>对比</th><th>文件 I&#x2F;O</th><th>网络 I&#x2F;O (TCP)</th></tr></thead><tbody><tr><td>用户调用</td><td><code>write(fd, buf, len)</code></td><td><code>send(sockfd, buf, len, 0)</code></td></tr><tr><td>数据去向</td><td>内核页缓存（Page Cache）</td><td>TCP 发送缓冲区</td></tr><tr><td>最终目标</td><td>磁盘（慢速设备）</td><td>网卡（远程主机，更慢+不可靠）</td></tr><tr><td>刷新时机</td><td>缓冲区刷到磁盘盘由 OS 决定</td><td>由 TCP 协议决定（如窗口、拥塞控制）</td></tr><tr><td>出错处理</td><td>磁盘错误罕见、概率极低，通常忽略</td><td>文件需经过网络，需要有 TCP 来确保可靠性</td></tr></tbody></table><p><strong>核心思想</strong>：</p><ul><li>“文件”是本地存储的抽象，“Socket”是远程通信的抽象 —— 但它们在 I&#x2F;O 模型、缓冲区管理、阻塞&#x2F;非阻塞行为上高度一致。</li><li>这就是 <strong>“Linux 一切皆文件”</strong> 的哲学体现 —— 统一接口，统一缓冲，统一调度，只是底层驱动不同。</li><li>补充：在 Linux 中，socket 也有文件描述符（fd），也能用 <code>read/write</code>，也能设置 <code>O_NONBLOCK</code>，也能被 <code>select/poll/epoll</code> 监控 —— 完全兼容文件接口！</li></ul><h3 id="3-不考虑可靠性，数据在网络中如何流动？"><a href="#3-不考虑可靠性，数据在网络中如何流动？" class="headerlink" title="3. 不考虑可靠性，数据在网络中如何流动？"></a>3. 不考虑可靠性，数据在网络中如何流动？</h3><p>我们想要发送一个网络数据，先在应用层通过相关的协议对结构化数据做序列化，然后放到发送缓冲区中，然后 TCP 会帮我们在适当的时机把数据发送到对方的接收缓冲区，等待对方的应用层通过 read 读取。此时一般会出现两种情况：</p><ol><li><strong>接收方处理慢 → 数据堆积在接收缓冲区：</strong> 对方上层由于忙碌始终无法处理，使得多次发送的报文都堆积在接收缓冲区，当他不忙碌时可能一次 read 就都读上去了！！然后上层再需要对这些数据解析成一个个完整报文（因为是面向字节流的），然后反序列化成结构化数据供上层使用。而如果凑不齐一个报文，就将他们暂时存储在自己的用户层缓冲区，等下次 read 的时候如果凑齐了再一起拿出来解析。</li><li><strong>发送方不发 &#x2F; 网络拥塞 → 接收方 <code>recv</code> 阻塞：</strong> 对方的上层会在合适的时机进行 read，但是如果发送方始终没有发送，或者网络太拥堵导致接收缓冲区一直没有数据，那么 read 就会阻塞住，然后 OS 就会把这个进程设置为 S（Sleep） 状态，而当缓冲区有数据的时候（也就是说 OS 某些资源就绪的时候）OS 会再次调度这个进程去把数据从缓冲区读上来！！！</li></ol><p>所以以前我们觉得 OS 某些资源不就绪从而使得进程暂时进入 S 状态大多数指的是硬件的速度比较慢，所以需要等待硬件资源就绪，但是今天我们发现在网络的情况中，也有可能是因为对方始终不给你发数据，或者由于网络拥塞造成接收缓冲区没有数据可处理，也是属于资源不就绪的情况，此时调用 read 的这个进程就必须阻塞住！！</p><blockquote><p>“资源不就绪”不仅指本地硬件（磁盘、键盘），也包括 <strong>远程资源（网络数据未到达）</strong>。网络 I&#x2F;O 的“等待”，本质是等待 <strong>不可控的外部世界</strong> —— 这是分布式系统复杂性的根源。</p></blockquote><h3 id="4-为什么-UDP-无发送缓冲区，而-TCP-必须有？"><a href="#4-为什么-UDP-无发送缓冲区，而-TCP-必须有？" class="headerlink" title="4. 为什么 UDP 无发送缓冲区，而 TCP 必须有？"></a>4. 为什么 UDP 无发送缓冲区，而 TCP 必须有？</h3><blockquote><p>UDP 发了就是发了，他并不关心对方的接收缓冲区是不是满了，如果满了他就会丢包，此时我们是无感的，UDP 不保证可靠性，但是 TCP 需要保证可靠性啊！</p></blockquote><p>核心区别在于：<strong>可靠性保证</strong>。</p><ol><li><strong>UDP</strong>：直接把数据交给 IP 层发出，发完就不管了，对方收没收到、接收缓冲区满不满，它都不关心，应用层必须自己处理丢包、乱序等问题。</li><li><strong>TCP</strong>：必须保证数据可靠送达，所以发送缓冲区是必不可少的：<ol><li><strong>暂存应用层写入的数据</strong>，等对方确认 ACK 后再清除。</li><li><strong>应对对方接收缓冲区不足</strong>：对方的窗口大小会告诉你“我还能收多少”，如果满了，就得把数据先留在发送缓冲区。</li><li><strong>应对网络抖动</strong>：丢包或超时重传时，也得从发送缓冲区里重新取出数据再发。</li></ol></li></ol><p>如果没有发送缓冲区：应用层写的数据就会“丢在半路”，因为网络或接收方不可能一直实时响应，那就完全无法做到“可靠传输”。</p><h3 id="5-TCP-小结-——-一个“智能缓冲区控制器”"><a href="#5-TCP-小结-——-一个“智能缓冲区控制器”" class="headerlink" title="5. TCP 小结 —— 一个“智能缓冲区控制器”"></a>5. TCP 小结 —— 一个“智能缓冲区控制器”</h3><table><thead><tr><th>层面</th><th>TCP 的角色</th></tr></thead><tbody><tr><td>对应用层</td><td>提供“可靠字节流”抽象，屏蔽网络复杂性</td></tr><tr><td>对内核</td><td>管理发送&#x2F;接收缓冲区，实现流量&#x2F;拥塞控制</td></tr><tr><td>对网络</td><td>动态调整发送策略，对抗丢包、延迟、乱序</td></tr><tr><td>对哲学</td><td>体现“控制”本质 —— 不是搬运工，而是调度大师</td></tr></tbody></table><blockquote><p><strong>TCP 不是“管道”，而是“智能调度器 + 缓冲区管理器 + 错误恢复引擎”，它让不可靠的网络，看起来像“可靠的本地内存拷贝”。</strong></p></blockquote><h2 id="2-协议段格式"><a href="#2-协议段格式" class="headerlink" title="2. 协议段格式"></a>2. 协议段格式</h2><h3 id="1-TCP-的协议段格式"><a href="#1-TCP-的协议段格式" class="headerlink" title="1. TCP 的协议段格式"></a>1. TCP 的协议段格式</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250912191940636.png" alt="PixPin_2025-09-12_19-18-58"></p><p>这依然是一个 <strong>逻辑结构图</strong>，仅用来表示 TCP 首部中各字段的位置、大小和含义。实际传输时，TCP 数据是 <strong>连续的字节流</strong>，按顺序排列在 IP 包中。</p><blockquote><p>在物理传输层面，无论是 TCP 还是 UDP，数据最终都以字节流（比特流）的形式在网络介质中传输。</p></blockquote><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250912200616461.png" alt="PixPin_2025-09-12_20-06-11"></p><h3 id="2-逐字段详解（重要）"><a href="#2-逐字段详解（重要）" class="headerlink" title="2. 逐字段详解（重要）"></a>2. 逐字段详解（重要）</h3><h4 id="1-16-位源端口号-目的端口号（各-16-位，共-2-2-4-字节）"><a href="#1-16-位源端口号-目的端口号（各-16-位，共-2-2-4-字节）" class="headerlink" title="1. 16 位源端口号 &amp; 目的端口号（各 16 位，共 2+2 &#x3D; 4 字节）"></a>1. 16 位源端口号 &amp; 目的端口号（各 16 位，共 2+2 &#x3D; 4 字节）</h4><p><strong>作用：标识通信双方的应用程序，用途：实现多路复用，一台主机同时跑多个 TCP 连接。</strong></p><ul><li><p><strong>源端口</strong>：发送方的应用使用的端口（如客户端随机端口 54321）。</p></li><li><p><strong>目的端口</strong>：接收方应用监听的端口（比如 HTTP 默认 80，HTTPS 默认 443）。</p></li><li><p><strong>示例：</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端 (192.168.1.100:54321) → 服务器 (192.168.1.1:80)</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-32-位序号（4-字节）"><a href="#2-32-位序号（4-字节）" class="headerlink" title="2. 32 位序号（4 字节）"></a>2. 32 位序号（4 字节）</h4><p><strong>作用：给每个字节编号，实现可靠传输、排序、重传，从而保证数据能按顺序组装。</strong> TCP 是 <strong>字节流协议</strong>，不是像 UDP 那样一包一包，发出去的每个字节在字节流里都有编号。</p><ul><li>每个字节都有一个唯一的序号。</li><li>初始值（ISN）由系统随机生成，防止攻击。</li><li>发送时递增，接收方根据序号判断是否乱序或丢失。</li><li>示例：<ul><li>第一个包序号 &#x3D; 1000，载荷 100 字节 → 下一个包序号 &#x3D; 1100</li><li>接收方收到后，会检查序号是否连续，否则要求重传。</li></ul></li></ul><h4 id="3-32-位确认序号（4-字节）"><a href="#3-32-位确认序号（4-字节）" class="headerlink" title="3. 32 位确认序号（4 字节）"></a>3. 32 位确认序号（4 字节）</h4><p><strong>作用：告诉对方“我下一个想收到的字节号”。</strong> 只有当 ACK 标志位为 1 时有效，用于确认对方已成功接收数据。举例：如果确认号 &#x3D; 2001，说明我已经收到对方 <strong>2000 号字节</strong> 之前的所有数据，期待下一个是 2001。这是 <strong>可靠传输</strong> 的核心机制：发送方根据确认号判断数据是否成功送达。示例：</p><ul><li>A 发送了序号 1000~1099 的数据（100 字节）</li><li>B 收到后，回复 ACK &#x3D; 1100，表示“我收到了 1000~1099，期待下一个是 1100”。提示：示例中 “ACK &#x3D; 1100” 里的 1100 是 <strong>确认序号</strong>，不是 ACK 标志位的值。只有当 ACK 标志位为 1 时，确认序号才有效，这里默认 ACK 标志位为 1，表明已收到序号 1100 之前的所有数据。</li></ul><h4 id="4-4-位首部长度（4-位-0-5-字节）"><a href="#4-4-位首部长度（4-位-0-5-字节）" class="headerlink" title="4. 4 位首部长度（4 位 0.5 字节）"></a>4. 4 位首部长度（4 位 0.5 字节）</h4><p>表示 TCP 首部的长度（<strong>以 32 位即 4 字节为单位</strong>）。最小是 5，单位：<strong>以 4 字节为 1 个单位</strong>（即 4*5 &#x3D; 20 字节），因为基本首部固定就是 20 字节。提示：这里单位可能有点不好理解，多读两遍即可。</p><ul><li>范围：5 ~ 15（即 20 ~ 60 字节）。</li><li>最小值 5 → 20 字节（无选项）。</li><li>如果有选项，首部就会变长，从而大于 5，比如三次握手时常见的 MSS 选项。</li></ul><h4 id="5-保留字段（6-位-0-75-字节，了解）"><a href="#5-保留字段（6-位-0-75-字节，了解）" class="headerlink" title="5. 保留字段（6 位 0.75 字节，了解）"></a>5. 保留字段（6 位 0.75 字节，了解）</h4><p>必须设为 0，供未来扩展。</p><h4 id="6-6-个标志位（0-75-字节）"><a href="#6-6-个标志位（0-75-字节）" class="headerlink" title="6. 6 个标志位（0.75 字节）"></a>6. 6 个标志位（0.75 字节）</h4><p>这是 TCP 中最核心的部分之一，控制连接建立、释放和数据传输：</p><table><thead><tr><th>标志</th><th>全称</th><th>含义&#x2F;作用</th><th>常见场景</th></tr></thead><tbody><tr><td><strong>URG</strong></td><td>Urgent</td><td><strong>紧急指针有效</strong>，表示报文中有紧急数据，接收方要 <strong>优先</strong> 处理这部分数据（跳过普通队列）</td><td><strong>几乎不用</strong>，现在应用层自己处理优先级</td></tr><tr><td><strong>ACK</strong></td><td>Acknowledgment</td><td><strong>确认序号是否有效</strong>（几乎总是 1），表明报文头的 <code>ack</code> 字段生效，用于确认收到对方的数据或请求，建立连接之后几乎所有报文都带 ACK</td><td>三次握手、数据传输、四次挥手全过程</td></tr><tr><td><strong>PSH</strong></td><td>Push</td><td>推送数据，提示接收方立即交给应用层，即提示接收端应用程序立刻从 TCP 缓冲区把数据读走，不要等缓冲区填满再交付</td><td><strong>偶尔用</strong>，Telnet、SSH、交互式应用（实时输入 → 实时输出）</td></tr><tr><td><strong>RST</strong></td><td>Reset</td><td>强制断开异常连接，或拒绝无效请求，对方会要求重新建立连接，我们把携带 RST 标识的称为 <strong>复位报文段</strong></td><td>端口未监听时回应、异常关闭、攻击防御</td></tr><tr><td><strong>SYN</strong></td><td>Synchronize</td><td>用于同步序号，<strong>请求建立连接，同时传递初始序列号</strong>，发起连接时置 1。同时，我们把携带 SYN 标识的称为 <strong>同步报文段</strong></td><td>三次握手的第 1 步和第 2 步</td></tr><tr><td><strong>FIN</strong></td><td>Finish</td><td><strong>请求关闭连接</strong>，表示本端数据发完了，准备断开</td><td>四次挥手的第 1 步和第 3 步</td></tr></tbody></table><blockquote><p><strong>特别重要：三次握手（SYN, SYN+ACK, ACK）和四次挥手（FIN, ACK, FIN, ACK）都依赖这些标志位！</strong></p></blockquote><h4 id="7-16-位窗口大小（2-字节）"><a href="#7-16-位窗口大小（2-字节）" class="headerlink" title="7. 16 位窗口大小（2 字节）"></a>7. 16 位窗口大小（2 字节）</h4><p>作用：告诉对方“我还能接收多少字节的数据”（单位：字节）。比如：窗口 &#x3D; 3000，说明“从我期望的确认号开始，我还能接收 3000 个字节”。这样，发送方就不会把数据塞爆接收方的缓冲区，直到收到新窗口通知。</p><ul><li>这是 TCP <strong>流量控制</strong> 的关键，防止发送方过快导致接收方缓冲区溢出。</li><li>动态变化：接收方每收到数据，就更新窗口大小并回传。</li></ul><h4 id="8-16-位检验和（2-字节，了解）"><a href="#8-16-位检验和（2-字节，了解）" class="headerlink" title="8. 16 位检验和（2 字节，了解）"></a>8. 16 位检验和（2 字节，了解）</h4><p>对整个 TCP 段（包括伪首部、首部、数据）进行校验。检测传输错误，若检验和不匹配，丢弃该报文。</p><blockquote><p><strong>注意：TCP 检验和是 必须计算的，而 UDP 检验和是可选的。</strong></p></blockquote><h4 id="9-16-位紧急指针（2-字节）"><a href="#9-16-位紧急指针（2-字节）" class="headerlink" title="9. 16 位紧急指针（2 字节）"></a>9. 16 位紧急指针（2 字节）</h4><p>搭配 URG 标志使用，仅当 URG 标志位为 1 时有效，用于指出本报文中紧急数据的最后一个字节位置。现代应用几乎不用，简单了解就好。示例：序号 &#x3D; 1000，紧急指针 &#x3D; 5 → 紧急数据从 1000 到 1005。</p><h4 id="10-选项（了解）"><a href="#10-选项（了解）" class="headerlink" title="10. 选项（了解）"></a>10. 选项（了解）</h4><p>可变长度，最多 40 字节（总首部最大 60 字节）。常见选项：</p><ul><li><strong>MSS（Maximum Segment Size）</strong>：最大报文段长度，协商双方最大发送大小。</li><li><strong>SACK（Selective ACK）</strong>：选择性确认，提高重传效率。</li><li><strong>Timestamps</strong>：时间戳，用于 RTT 测量和防重放。</li><li><strong>NOP</strong>：填充用，保持对齐。</li></ul><h4 id="11-数据（了解）"><a href="#11-数据（了解）" class="headerlink" title="11. 数据（了解）"></a>11. 数据（了解）</h4><p>紧跟在首部之后，长度由 <code>IP 总长度 - IP 首部长度 - TCP 首部长度</code> 决定，由上层应用（如 HTTP、FTP）提供。</p><p>你这四个问题其实正好把 <strong>TCP 报文头的关键设计思想</strong> 给串起来了，我帮你捋清楚。</p><hr><h3 id="3-TCP-报头如何分离数据？"><a href="#3-TCP-报头如何分离数据？" class="headerlink" title="3. TCP 报头如何分离数据？"></a>3. TCP 报头如何分离数据？</h3><blockquote><p><strong>先读 20 字节 → 再看首部长度 → 根据首部长度决定选项大小 → 剩下的就是数据。</strong></p></blockquote><ol><li><strong>第一步：读取前 20 字节（最小头部）。</strong> 固定部分：TCP 报头最短 <strong>20 字节</strong>，这部分字段顺序固定（源端口、目的端口、序号、确认号…）。</li><li><strong>第二步：解析“首部长度”字段。</strong> 在这 20 个字节里，有一个 <strong>首部长度字段</strong>，它是 4 位，单位是 <strong>32 bit（4 字节）</strong>。提示：这里 4 位是二进制数，最小值是 0101（即十进制的 5），表示 5 个 4 字节，5 × 4 &#x3D; 20 字节。<ul><li>如果首部长度 &#x3D; 5，表示 5 × 4 &#x3D; 20 字节 → 没有选项，只有固定部分。</li><li>如果首部长度 &#x3D; 6，表示 6 × 4 &#x3D; 24 字节 → 有 4 字节选项。</li></ul></li><li><strong>第三步：跳过头部，剩余部分就是“数据”。</strong><ul><li>数据起始位置 &#x3D; <code>IP 数据报起始位置 + IP 头部长度 + TCP 头部长度</code></li><li>数据长度 &#x3D; <code>IP 总长度 - IP 头部长度 - TCP 头部长度</code></li></ul></li></ol><p>和 UDP 类似，区别在于 UDP 的报头固定 8 字节，而且直接有个字段长度，所以简单粗暴。TCP 因为要扩展功能，才搞了个“首部长度 + 选项”的自描述方式。有了“自描述头部长度”，然后从 IP 层“借”总长度来推算数据长度。</p><h3 id="4-如何交付给上层？"><a href="#4-如何交付给上层？" class="headerlink" title="4. 如何交付给上层？"></a>4. 如何交付给上层？</h3><p>TCP 用 <strong>端口号</strong> 来做区分。每个进程通过 <strong>套接字 (socket &#x3D; IP + 端口)</strong> 来绑定通信，报文里的 <strong>源端口 &#x2F; 目的端口</strong> 就告诉内核：</p><ul><li>这是谁发的？（源端口）</li><li>应该交给哪个进程？（目的端口）</li></ul><p>所以 TCP 收到数据后，靠目的端口查路由表 → 找到本机监听该端口的进程 → 把数据放进它的接收缓冲区 → 应用层再 <code>read()</code>。</p><h3 id="5-关于-16-位校验和"><a href="#5-关于-16-位校验和" class="headerlink" title="5. 关于 16 位校验和"></a>5. 关于 16 位校验和</h3><p>TCP 校验和不光包含 TCP 头和数据，还要算上一个 <strong>伪首部</strong>，里面有源 IP、目的 IP、协议号等字段。</p><p><strong>为什么要多此一举？</strong><br>因为要防止“<strong>收到了正确的数据，但收错了目的地</strong>”这种事。伪首部相当于再确认一次，这数据确实是发给我的。</p><blockquote><p><strong>TCP 校验和覆盖范围 &#x3D; TCP 头 + TCP 数据 + 伪首部，如果校验失败，接收方直接丢掉报文，不给上层进程。</strong></p></blockquote><h3 id="6-为什么-TCP-报头没有长度字段？"><a href="#6-为什么-TCP-报头没有长度字段？" class="headerlink" title="6. 为什么 TCP 报头没有长度字段？"></a>6. 为什么 TCP 报头没有长度字段？</h3><p>这个设计正是因为 <strong>TCP 面向字节流</strong>。UDP 是 <strong>面向报文</strong>，一发就是一块，必须告诉你这块有多长 → 所以有 <code>length</code>。TCP 把数据看作一个 <strong>连续的字节流</strong>，应用层想写多少就写多少，内核可能拆成多个报文段发出去。接收方只管把这些字节按顺序拼接起来。</p><p>对 TCP 来说，<strong>什么时候算一条完整的消息</strong>，由应用层自己决定。所以 TCP 报头里没必要放 “长度”字段，只需要：</p><ul><li>知道首部多长（方便找到数据起点）；</li><li>知道数据流的位置（靠序号 <code>seq</code> 字段来标记每个字节）。</li></ul><blockquote><ul><li><strong>UDP</strong>：像快递小哥，一单一单送，包裹上贴着“这是一个 2kg 的包裹”，所以每个报文都带长度。</li><li><strong>TCP</strong>：像水管输水，不管你倒一桶还是倒十桶，水流不断过去。水分段传输，但水的“总量”是靠序号控制的，不需要每次标记“这一桶多大”。</li></ul></blockquote><h3 id="7-TCP-连接建立可能失败"><a href="#7-TCP-连接建立可能失败" class="headerlink" title="7. TCP 连接建立可能失败"></a>7. TCP 连接建立可能失败</h3><p>TCP 虽然保证 <strong>已建立连接后的数据传输可靠性</strong>，但 <strong>连接建立过程本身可能失败</strong>。三次握手过程中任何一个步骤出现问题都会导致连接失败：</p><ol><li><strong>第一次握手失败</strong>：客户端 SYN 包丢失或被防火墙过滤。</li><li><strong>第二次握手失败</strong>：服务器 SYN-ACK 包丢失。</li><li><strong>第三次握手失败</strong>：客户端 ACK 包丢失。</li></ol><h3 id="8-连接怎样才算成功建立？"><a href="#8-连接怎样才算成功建立？" class="headerlink" title="8. 连接怎样才算成功建立？"></a>8. 连接怎样才算成功建立？</h3><p>TCP 连接的“成功建立”需要 <strong>双方都进入 ESTABLISHED 状态</strong>，但客户端和服务器进入该状态的时机不同：</p><ol><li><strong>客户端视角：</strong> 在收到服务器的 SYN-ACK 后，立即发送 ACK，并 <strong>同时进入 ESTABLISHED 状态</strong>。此时即使该 ACK 报文后续丢失，<strong>客户端仍认为连接已建立</strong>，可立即发送数据。</li><li><strong>服务器视角：</strong> 必须 <strong>实际收到客户端的 ACK</strong>（第三次握手）后，才从 SYN-RCVD 状态转入 ESTABLISHED 状态，认为连接真正建立。</li></ol><blockquote><p><strong>因此，只有当双方都进入 ESTABLISHED 状态时，TCP 连接才算完全成功建立。</strong><br>若第三次握手丢失，服务器会重传 SYN-ACK（最多 <code>tcp_synack_retries</code> 次，一般默认 5 次），若仍无响应则放弃连接；而客户端若已发送数据，服务器在收到数据时也可推断连接应已建立，从而完成状态转换（这是 TCP 的优化机制之一）。</p></blockquote><h2 id="3-确认应答（ACK）机制"><a href="#3-确认应答（ACK）机制" class="headerlink" title="3. 确认应答（ACK）机制"></a>3. 确认应答（ACK）机制</h2><p><strong>TCP 的确认应答机制就是：接收方通过 ACK 告诉发送方“到某个字节为止我都收到了，下一个字节从这里开始发”，发送方据此判断哪些数据已经成功送达、哪些需要重传，从而保证数据传输的可靠性和有序性。</strong></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250912232946880.png" alt="PixPin_2025-09-12_23-29-42"></p><p>TCP 将每个字节的数据都做了编号，即为序列号。每一个 ACK 都带有对应的确认序列号，意思是告诉发送者，我已经收到了哪些数据，下一次你从哪里开始发。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20250912233052792.png" alt="image-20250912233052654"></p><h2 id="4-超时重传机制"><a href="#4-超时重传机制" class="headerlink" title="4. 超时重传机制"></a>4. 超时重传机制</h2><p>TCP 的超时重传机制是为了在网络不可靠的环境中确保数据可靠传输而设计的重要机制。其核心思想是：<strong>当发送方（如主机 A）发送数据后，若在一定时间内未收到接收方（如主机 B）返回的确认应答（ACK），就认为该数据可能丢失，从而触发重传。</strong> ACK 没收到，可能是因为数据包丢了，也可能是 ACK 自己丢了。TCP 通过 <strong>序列号</strong> 来识别重复数据，避免重复交付。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251003000427268.png"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251003000510790.png" alt="PixPin_2025-10-03_00-05-06"></p><p>由于网络状况动态变化，固定的超时时间难以适应所有场景：设得太短会导致不必要的重复重传，浪费带宽；设得太长则会降低传输效率。因此，TCP 采用 <strong>动态调整的超时时间</strong>，并结合 <strong>指数退避策略</strong> 来平衡效率与可靠性。具体机制如下：</p><ol><li><p><strong>基于序列号去重</strong>：接收方利用 TCP 报文中的序列号识别重复数据包，自动丢弃重复内容，确保数据不被重复处理。</p></li><li><p><strong>初始超时时间</strong>：系统通常以 500 毫秒（0.5 秒）为基本单位（如 Linux、BSD、Windows 等），首次重传的超时时间设为 500ms 的整数倍。</p></li><li><p><strong>指数退避（Exponential Backoff）</strong>：若重传后仍未收到 ACK，则下一次重传的等待时间按指数增长，例如：</p><ul><li>第 1 次重传：等待 1 × 500ms</li><li>第 2 次重传：等待 2 × 500ms</li><li>第 3 次重传：等待 4 × 500ms</li><li>第 4 次重传：等待 8 × 500ms</li><li>以此类推（即每次重传间隔翻倍）。</li></ul></li><li><p><strong>重传上限</strong>：当重传次数达到系统设定的阈值（如 Linux 默认约 15 次），TCP 会判定连接异常（如网络中断或对端宕机），主动终止连接。</p></li></ol><p>通过这种动态、自适应的超时重传机制，TCP 便能在各种网络环境下 <strong>兼顾传输的可靠性与效率</strong>。</p><h2 id="5-连接管理机制"><a href="#5-连接管理机制" class="headerlink" title="5. 连接管理机制"></a>5. 连接管理机制</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251003000535741.png" alt="PixPin_2025-10-03_00-05-33"></p><h3 id="1-TCP-是“面向连接”的协议"><a href="#1-TCP-是“面向连接”的协议" class="headerlink" title="1. TCP 是“面向连接”的协议"></a>1. TCP 是“面向连接”的协议</h3><p><strong>什么是“面向连接”：</strong> TCP 不是直接在两台主机之间通信，而是在 <strong>两个端点（socket）之间建立一条虚拟的、可靠的逻辑通道</strong>，这条通道称为“连接”。 每个连接由 <strong>四元组</strong> 唯一标识：<code>(源IP, 源端口, 目标IP, 目标端口)</code>，一台服务器可以同时与多个客户端建立多个独立的 TCP 连接。</p><p><strong>为什么需要“连接”：</strong> 如果没有连接的概念，服务器只有一个全局接收缓冲区，所有客户端的数据都会混在一起，无法区分来源，也无法保证顺序、可靠性等。<strong>连接的存在，使得每个通信对都有独立的发送&#x2F;接收缓冲区、序列号、窗口、状态等</strong>，从而实现可靠传输。</p><blockquote><p><strong>结论</strong>：TCP 的所有可靠性机制（如重传、确认、流量控制、拥塞控制）都是 <strong>基于连接</strong> 的，而不是主机到主机的。</p></blockquote><h3 id="2-操作系统如何管理-TCP-连接？"><a href="#2-操作系统如何管理-TCP-连接？" class="headerlink" title="2. 操作系统如何管理 TCP 连接？"></a>2. 操作系统如何管理 TCP 连接？</h3><p>OS 采用“<strong>先描述，再组织</strong>”的方式管理连接：</p><ul><li><p><strong>描述</strong>：用一个内核数据结构（如 <code>struct sock</code> 或 <code>TCB</code> – Transmission Control Block）来描述一个连接，包含：四元组信息、发送&#x2F;接收缓冲区、序列号、确认号、状态（LISTEN、ESTABLISHED、CLOSE_WAIT 等）、超时重传计时器、拥塞控制参数等。</p></li><li><p><strong>组织</strong>：将所有连接结构体组织成高效的数据结构（如哈希表、链表、红黑树，<strong>主要是采用分层 + 哈希 + 链表的混合结构</strong>），便于快速查找、插入、删除。</p></li><li><p><strong>建立连接</strong> &#x3D; 分配并初始化一个连接结构体 + 插入管理结构 。</p></li><li><p><strong>断开连接</strong> &#x3D; 从管理结构中移除 + 释放资源（缓冲区、内存等）。</p></li></ul><blockquote><p>⚠️ <strong>成本</strong>：每个连接都占用内存和 CPU 资源，因此高并发服务器需优化连接管理（如使用连接池、epoll 等）。</p></blockquote><h3 id="3-为什么建立连接需要“三次握手”？"><a href="#3-为什么建立连接需要“三次握手”？" class="headerlink" title="3. 为什么建立连接需要“三次握手”？"></a>3. 为什么建立连接需要“三次握手”？</h3><h4 id="1-一次握手行不行？"><a href="#1-一次握手行不行？" class="headerlink" title="1. 一次握手行不行？"></a>1. 一次握手行不行？</h4><p>如果客户端发 SYN → 服务器收到后直接认为连接建立？那么就会产生 <strong>问题</strong>：服务器无法确认客户端是否真的能收到自己的响应。如果 SYN 是旧的重复包（比如网络延迟很久后到达），服务器会错误地建立连接，浪费资源。</p><h4 id="2-两次握手行不行？"><a href="#2-两次握手行不行？" class="headerlink" title="2. 两次握手行不行？"></a>2. 两次握手行不行？</h4><ul><li>客户端发 SYN</li><li>服务器回 SYN+ACK，认为连接已建立</li><li>客户端收到后开始发数据</li></ul><p><strong>产生的问题</strong>：如果客户端的 SYN 丢失了 ACK（即服务器的 SYN+ACK 未被客户端收到），客户端不会重发，但服务器已经认为连接建立了，会一直等待数据 → <strong>资源浪费（SYN Flood 攻击原理）</strong>，更严重的是：<strong>服务器无法确认客户端是否具备接收能力</strong>。</p><blockquote><p><a target="_blank" rel="noopener" href="https://www.cloudflare.com/zh-cn/learning/ddos/syn-flood-ddos-attack/">SYN 洪水攻击 | cloudflare</a></p><p><a target="_blank" rel="noopener" href="https://info.support.huawei.com/info-finder/encyclopedia/zh/SYN+Flood.html">什么是 SYN Flood？| 华为云</a></p><p>服务器在处理 TCP 连接时维护两个关键队列：<strong>半连接队列</strong> 存放已收到客户端 SYN、回复了 SYN+ACK 但尚未收到最终 ACK 的“半连接”；<strong>全连接队列</strong> 则存放三次握手已完成、等待应用程序（如 Web 服务）调用 <code>accept()</code> 处理的“全连接”。当半连接因客户端未回 ACK 而超时、全连接队列溢出，或客户端与服务器对连接状态认知不一致时，就会出现 <strong>连接不一致问题</strong>，导致资源浪费甚至正常连接被拒绝。</p><p><strong>SYN 洪水（SYN Flood）</strong> 正是利用半连接队列的弱点：攻击者发送大量伪造源 IP 的 SYN 请求，却故意不回 ACK，使服务器堆积大量无效半连接，耗尽队列资源。为放大攻击效果，黑客通常操控大量被控制的“<strong><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%82%89%E6%9C%BA/956813">肉机</a></strong>”（即傀儡机）组成僵尸网络，协同发起攻击。2000 年初那种 “人多 → 肉机多，在浏览器上不断点刷新让服务器无响应” 的攻击，本质是早期简单的分布式拒绝服务（DDoS），虽和 SYN 洪水利用 TCP 漏洞的原理不同，但核心都是靠大量肉机（或真实用户设备）持续提升请求量，耗尽服务器的带宽、CPU、内存等资源，最终让服务器无法响应正常用户。</p></blockquote><h4 id="3-三次握手如何解决？"><a href="#3-三次握手如何解决？" class="headerlink" title="3. 三次握手如何解决？"></a>3. 三次握手如何解决？</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251003185009119.png" alt="PixPin_2025-10-03_18-49-58"></p><ol><li><strong>第一次</strong>：客户端证明自己能发</li><li><strong>第二次</strong>：服务器证明自己能收+能发</li><li><strong>第三次</strong>：客户端证明自己能收（确认收到服务器的 SYN）</li></ol><p><strong>三次握手确保了</strong>：</p><ul><li>双方都能收、能发（<strong>双向通信能力验证</strong>）</li><li><strong>防止历史重复连接请求造成错误建立</strong></li><li><strong>初始化双方的序列号（避免数据混淆）</strong></li></ul><blockquote><p><strong>三次是最小可靠次数</strong>：少于三次无法同时验证双向通信能力；多于三次则冗余。</p></blockquote><h4 id="4-三次握手绝对可靠吗？"><a href="#4-三次握手绝对可靠吗？" class="headerlink" title="4. 三次握手绝对可靠吗？"></a>4. 三次握手绝对可靠吗？</h4><p>在 <strong>正常网络</strong> 下，三次握手能可靠建立连接。但在极端情况，仍可能失败。不过 TCP 的设计目标是在 <strong>不可靠网络上提供可靠传输</strong>，三次握手是理论和实践平衡下的最优解。</p><h3 id="4-为什么断开连接需要“四次挥手”？"><a href="#4-为什么断开连接需要“四次挥手”？" class="headerlink" title="4. 为什么断开连接需要“四次挥手”？"></a>4. 为什么断开连接需要“四次挥手”？</h3><p>因为 TCP 是 <strong>全双工</strong> 的：数据可以同时双向传输。断开时，<strong>每个方向都要独立关闭</strong>。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Linux/20251003185056144.png" alt="PixPin_2025-10-03_18-50-53"></p><p><strong>为什么不能合并第 2、3 步？</strong></p><ul><li>第 2 步是 <strong>对客户端 FIN 的确认</strong>，必须立即响应（否则客户端会重传 FIN）。</li><li>第 3 步是 <strong>服务器主动发起关闭</strong>，但服务器可能还有数据要发送，不能立刻发 FIN。</li></ul><blockquote><p>所以：<strong>ACK 和 FIN 通常不能合并</strong>（除非服务器在收到 FIN 时恰好没有待发数据，此时可合并为一次：SYN+ACK 类似，但叫 FIN+ACK）。</p></blockquote><h3 id="5-套接字（Socket）、connect、accept-与三次握手的关系"><a href="#5-套接字（Socket）、connect、accept-与三次握手的关系" class="headerlink" title="5. 套接字（Socket）、connect、accept 与三次握手的关系"></a>5. 套接字（Socket）、connect、accept 与三次握手的关系</h3><h4 id="1-connect-的本质"><a href="#1-connect-的本质" class="headerlink" title="1. connect() 的本质"></a>1. connect() 的本质</h4><p>客户端调用 <code>connect()</code> → 触发 <strong>第一次握手（SYN）</strong>，内核自动完成后续两次握手，<code>connect()</code> 返回时，<strong>三次握手已完成，连接已建立（ESTABLISHED）</strong>。</p><h4 id="2-accept-的本质"><a href="#2-accept-的本质" class="headerlink" title="2. accept() 的本质"></a>2. accept() 的本质</h4><p>服务器调用 <code>listen()</code> 后进入监听状态，当收到客户端的 SYN（第一次握手），内核会为该连接创建一个 <strong>新的 socket 结构体</strong>（子 socket），<code>accept()</code> 的作用是：<strong>从已完成连接队列中取出这个新 socket，并返回给应用程序，注意：</strong> 三次握手在 <code>accept()</code> 调用 <strong>之前</strong> 就已完成！</p><blockquote><p><strong>关键结论：三次握手由操作系统内核自动完成，与应用程序是否调用 <code>accept()</code> 无关。即使服务器没有调用 <code>accept()</code>，只要 <code>listen()</code> 了，内核仍会响应 SYN，完成三次握手，并将连接放入“已完成队列”。如果 <code>accept()</code> 不及时调用，队列满后新连接会被拒绝（backlog 限制）。</strong></p></blockquote><h4 id="3-没有-accept-能建立-TCP-连接吗？"><a href="#3-没有-accept-能建立-TCP-连接吗？" class="headerlink" title="3. 没有 accept() 能建立 TCP 连接吗？"></a>3. 没有 accept() 能建立 TCP 连接吗？</h4><blockquote><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vF411M7Vi/?share_source=copy_web&vd_source=872e5e3ccf44874c39edaf42e30ab0de">没有 accept 方法，能建立 TCP 连接吗？| B 站</a></p></blockquote><p><strong>能</strong>！连接在内核层面已经建立（ESTABLISHED 状态）。但应用程序无法通过 <code>accept()</code> 获取该连接的 socket，也就无法读写数据。连接会一直占用内核资源，直到超时或被关闭。</p><h3 id="6-小结"><a href="#6-小结" class="headerlink" title="6. 小结"></a>6. 小结</h3><table><thead><tr><th>问题</th><th>回答</th></tr></thead><tbody><tr><td><strong>为什么 TCP 是面向连接的？</strong></td><td>为了隔离不同通信对，提供独立的可靠传输通道（缓冲区、序列号等）。</td></tr><tr><td><strong>操作系统如何管理连接？</strong></td><td>用结构体描述连接，用数据结构组织，增删查改即连接管理。</td></tr><tr><td><strong>为什么三次握手？</strong></td><td>最小次数验证双方收发能力，防止历史连接干扰。两次不够，一次更不行。</td></tr><tr><td><strong>三次握手绝对可靠吗？</strong></td><td>在常规网络下可靠，是工程与理论的最优平衡。</td></tr><tr><td><strong>为什么四次挥手？</strong></td><td>全双工需双向关闭，每方向关闭需 FIN+ACK。</td></tr><tr><td><strong>第 2、3 次挥手为何不能合并？</strong></td><td>服务器需先 ACK 客户端 FIN，再等自己数据发完才发自己的 FIN。</td></tr><tr><td><strong>connect&#x2F;accept 的本质？</strong></td><td><code>connect</code> 触发握手；<code>accept</code> 从内核队列取已建立的连接。</td></tr><tr><td><strong>没有 accept 能建立连接吗？</strong></td><td>能！三次握手由内核完成，<code>accept</code> 只是应用层获取连接句柄。</td></tr><tr><td><strong>连接建立成功和 accept 有关系吗？</strong></td><td><strong>无直接关系</strong>。连接在 <code>accept</code> 前已建立，<code>accept</code> 只是“领取”连接。</td></tr></tbody></table><hr><h2 id="6-理解-TIME-WAIT-状态"><a href="#6-理解-TIME-WAIT-状态" class="headerlink" title="6. 理解 TIME_WAIT 状态"></a>6. 理解 TIME_WAIT 状态</h2><h3 id="1-如何触发-TIME-WAIT？"><a href="#1-如何触发-TIME-WAIT？" class="headerlink" title="1. 如何触发 TIME_WAIT？"></a>1. 如何触发 TIME_WAIT？</h3><p>当 <strong>主动关闭连接的一方</strong>（即首先发送 <code>FIN</code> 的那一端）完成四次挥手的最后一步（发送最后一个 <code>ACK</code>）后，<strong>会进入 <code>TIME_WAIT</code> 状态</strong>，并持续一段时间（通常是 <strong>2MSL</strong>）。</p><blockquote><p>举例：客户端调用 <code>close()</code> → 发送 FIN → 最终进入 TIME_WAIT。</p></blockquote><h3 id="2-用-netstat-查看-TIME-WAIT"><a href="#2-用-netstat-查看-TIME-WAIT" class="headerlink" title="2. 用 netstat 查看 TIME_WAIT"></a>2. 用 <code>netstat</code> 查看 TIME_WAIT</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -nltp		<span class="comment"># root</span></span><br><span class="line">netstat -an | grep TIME_WAIT</span><br><span class="line"><span class="comment"># 或更详细</span></span><br><span class="line">ss -tan state time-wait</span><br></pre></td></tr></table></figure><h3 id="3-2MSL-是什么？"><a href="#3-2MSL-是什么？" class="headerlink" title="3. 2MSL 是什么？"></a>3. 2MSL 是什么？</h3><p>MSL（Maximum Segment Lifetime）表示 TCP 报文在网络中 <strong>最大存活时间</strong>（通常为 30~120 秒，Linux 中 MSL 默认 <strong>30 秒</strong>），超过 MSL 的报文会被路由器丢弃。</p><p><strong>TIME_WAIT &#x3D; 2MSL 是 TCP 可靠关闭的保障机制，即：2MSL &#x3D; 2 × MSL</strong></p><ul><li>TIME_WAIT 的持续时间 &#x3D; <strong>2MSL</strong>（Linux 默认 <strong>2×30 &#x3D; 60 秒</strong>）。</li><li><strong>目的有两个</strong>：<ol><li><strong>确保最后一个 ACK 能到达对方：</strong> 如果 ACK 丢失，对方会重发 FIN，本端仍处于 TIME_WAIT 可再次响应 ACK，避免对方 stuck 在 LAST_ACK。</li><li><strong>防止旧连接的“迷途报文”干扰新连接：</strong> 等待 2MSL 后，网络中所有属于该连接的旧报文都已消失，此时即使复用相同四元组（如快速重启服务），也不会混淆数据。</li></ol></li></ul><blockquote><p><strong><code>tcp_fin_timeout</code> 可以控制 FIN_WAIT_2 状态的超时时间（即本端发了 FIN，对方 ACK 了，但对方迟迟不发自己的 FIN）。但它不影响 TIME_WAIT 的持续时间 TIME_WAIT 的时长仅由 2MSL 决定，在 Linux 中硬编码为 60 秒（不可通过 sysctl 直接修改）。</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">cat</span> /proc/sys/net/ipv4/tcp_fin_timeout  <span class="comment"># 默认 60（秒），影响 FIN_WAIT_2</span></span><br><span class="line">&gt;# TIME_WAIT 始终是 60 秒（2 * 30），不受此参数影响</span><br><span class="line">   </span><br><span class="line">&gt;<span class="built_in">echo</span> 30 &gt; /proc/sys/net/ipv4/tcp_fin_timeout	<span class="comment"># 将 FIN_WAIT_2 时间缩短到 30 秒</span></span><br></pre></td></tr></table></figure><p>TIME_WAIT 虽不可改时长，但可优化其影响：使用 <code>SO_REUSEADDR</code>，避免服务器主动关闭连接（让客户端先 close），调整 <code>net.ipv4.tcp_max_tw_buckets</code>（限制 TIME_WAIT 数量，超限则提前清除）。</p></blockquote><h2 id="7-解决-TIME-WAIT-状态引起的-bind-失败的方法（作业）"><a href="#7-解决-TIME-WAIT-状态引起的-bind-失败的方法（作业）" class="headerlink" title="7. 解决 TIME_WAIT 状态引起的 bind 失败的方法（作业）"></a>7. 解决 TIME_WAIT 状态引起的 bind 失败的方法（作业）</h2><p>这是我们经常会遇到的一个问题：服务器程序（如 Web 服务）监听 <code>0.0.0.0:8080</code>，程序退出后立即重启 → 调用 <code>bind(8080)</code> 失败，会报错：<strong>Address already in use</strong>。</p><p><strong>原因：</strong></p><ol><li>上次连接由服务器主动关闭 → 服务器进入 TIME_WAIT。</li><li>TIME_WAIT 期间，<strong>四元组（特别是本地 IP+端口）仍被占用</strong>。</li><li>新程序尝试 <code>bind</code> 同一个端口 → 内核拒绝（默认不允许复用处于 TIME_WAIT 的地址）。</li></ol><p><strong>解决方法：使用 <code>SO_REUSEADDR</code> 选项（<code>man setsockopt</code>）</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt));</span><br></pre></td></tr></table></figure><ul><li><strong>作用</strong>：允许新 socket 绑定到处于 TIME_WAIT 状态的地址&#x2F;端口。</li><li><strong>注意</strong>：<code>SO_REUSEADDR</code> <strong>不能复用 ESTABLISHED 状态的端口</strong>，只对 TIME_WAIT 有效。</li></ul><blockquote><p>这就是为什么几乎所有服务器程序在 <code>bind</code> 前都会设置 <code>SO_REUSEADDR</code>。</p></blockquote><h2 id="8-理解-CLOSE-WAIT-状态"><a href="#8-理解-CLOSE-WAIT-状态" class="headerlink" title="8. 理解 CLOSE_WAIT 状态"></a>8. 理解 CLOSE_WAIT 状态</h2><h3 id="1-如何进入-CLOSE-WAIT？"><a href="#1-如何进入-CLOSE-WAIT？" class="headerlink" title="1. 如何进入 CLOSE_WAIT？"></a>1. 如何进入 CLOSE_WAIT？</h3><p>对端（如客户端）发送 FIN → 本端（服务器）收到后，内核自动回复 ACK，此时本端 TCP 状态变为 <strong>CLOSE_WAIT，表示：对端已关闭，本端应尽快调用 <code>close()</code> 关闭自己的方向</strong>。</p><h3 id="2-CLOSE-WAIT-的问题"><a href="#2-CLOSE-WAIT-的问题" class="headerlink" title="2. CLOSE_WAIT 的问题"></a>2. CLOSE_WAIT 的问题</h3><p><strong>CLOSE_WAIT 本身是正常状态，但如果长期存在，说明应用程序忘记调用 <code>close()</code>！后果：</strong></p><ul><li>文件描述符泄漏。</li><li>内存泄漏（接收缓冲区不释放）。</li><li>最终耗尽系统资源，服务崩溃。</li></ul><h3 id="3-排查-CLOSE-WAIT"><a href="#3-排查-CLOSE-WAIT" class="headerlink" title="3. 排查 CLOSE_WAIT"></a>3. 排查 CLOSE_WAIT</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -an | grep CLOSE_WAIT</span><br><span class="line">lsof -p &lt;pid&gt;  <span class="comment"># 查看进程打开的 fd</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>根本解决</strong>：检查代码，确保在读到 EOF（recv 返回 0）后调用 <code>close()</code>。</p></blockquote></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/42057.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://www.minbit.top/posts/42057.html")'>051 传输层 —— TCP（上）</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/42057.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=051 传输层 —— TCP（上）&amp;url=https://www.minbit.top/posts/42057.html&amp;pic=https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=0f19e815-8b67-c290-cc36-cf5e36871ff1" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">59</span></a><a class="post-meta__box__tags" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>网络<span class="tagsPageCount">11</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=ebdc8f73-2df6-eb02-56e4-2e58830a0423" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/6432.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=98974973-7627-1818-7b1a-cc3b5c2c5204" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">02 数据库基础</div></div></a></div><div class="next-post pull-right"><a href="/posts/30632.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=541839c0-e83e-5922-ef43-3857b6d4819c" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">临时邮箱汇总</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/47537.html" title="045 网络基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/IAdmxAt.png?_r_=f8ae69f3-be23-058e-b3ed-f44bbc08347d" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-12</div><div class="title">045 网络基础</div></div></a></div><div><a href="/posts/38905.html" title="047 网络传输基础：TCP 连接建立与数据序列化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=1f628b9b-ebc6-05dd-4e6f-f847d84f7767" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-22</div><div class="title">047 网络传输基础：TCP 连接建立与数据序列化</div></div></a></div><div><a href="/posts/34998.html" title="049 HTTPS 协议原理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=1f23abb0-1c76-3d16-4bbb-2d38417dcc91" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-28</div><div class="title">049 HTTPS 协议原理</div></div></a></div><div><a href="/posts/63840.html" title="048 HTTP 协议"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/12THR4h.png?_r_=c489c29a-d1cd-463d-c6a3-cfe289dbec3e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-25</div><div class="title">048 HTTP 协议</div></div></a></div><div><a href="/posts/40348.html" title="046 网络编程套接字"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=fe0b3dd7-ebf2-525d-1485-d1c8d5f2b78c" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-15</div><div class="title">046 网络编程套接字</div></div></a></div><div><a href="/posts/23032.html" title="052 传输层 —— TCP（下）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=f3a39255-670f-3481-069b-60d99044a24e" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-10-05</div><div class="title">052 传输层 —— TCP（下）</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><span>👋🏻 Hi，我是 <a target="_blank" href="https://huangcancan-xbc.github.io" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">小米里的大麦</a>，欢迎来看我的博客鸭！</span><br><span>👉 建议优先查看置顶的 <a target="_blank" href="https://huangcancan-xbc.github.io/posts/17934.html" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">网站说明</a>，如有问题欢迎评论区交流！</span><br><span>😫 页面异常？尝试<kbd>Ctrl</kbd>+<kbd>F5</kbd></span><br><span>📩 联系我：<a href="mailto:hc1960074081@qq.com" rel="external nofollow noreferrer"><b>给我发送邮件🚀</b></a></span></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82-%E2%80%94%E2%80%94-TCP%EF%BC%88%E4%B8%8A%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">传输层 —— TCP（上）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.1.</span> <span class="toc-text">1. 传输控制协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-TCP-%E7%9A%84%E6%9C%AC%E8%B4%A8%EF%BC%9A%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE-%E2%80%94%E2%80%94-%E2%80%9C%E6%8E%A7%E5%88%B6%E2%80%9D%E4%BA%8C%E5%AD%97%E6%98%AF%E7%81%B5%E9%AD%82"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. TCP 的本质：传输控制协议 —— “控制”二字是灵魂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-TCP-%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%85%B3%E8%81%94%EF%BC%9F%E2%80%94%E2%80%94-%E2%80%9C%E4%B8%80%E5%88%87%E7%9A%86%E6%96%87%E4%BB%B6%E2%80%9D%E7%9A%84%E5%AE%8C%E7%BE%8E%E4%BD%93%E7%8E%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. TCP 和文件系统的关联？—— “一切皆文件”的完美体现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%8D%E8%80%83%E8%99%91%E5%8F%AF%E9%9D%A0%E6%80%A7%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%9C%A8%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%A6%82%E4%BD%95%E6%B5%81%E5%8A%A8%EF%BC%9F"><span class="toc-number">1.1.3.</span> <span class="toc-text">3. 不考虑可靠性，数据在网络中如何流动？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%BA%E4%BB%80%E4%B9%88-UDP-%E6%97%A0%E5%8F%91%E9%80%81%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%8C%E8%80%8C-TCP-%E5%BF%85%E9%A1%BB%E6%9C%89%EF%BC%9F"><span class="toc-number">1.1.4.</span> <span class="toc-text">4. 为什么 UDP 无发送缓冲区，而 TCP 必须有？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-TCP-%E5%B0%8F%E7%BB%93-%E2%80%94%E2%80%94-%E4%B8%80%E4%B8%AA%E2%80%9C%E6%99%BA%E8%83%BD%E7%BC%93%E5%86%B2%E5%8C%BA%E6%8E%A7%E5%88%B6%E5%99%A8%E2%80%9D"><span class="toc-number">1.1.5.</span> <span class="toc-text">5. TCP 小结 —— 一个“智能缓冲区控制器”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8D%8F%E8%AE%AE%E6%AE%B5%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">2. 协议段格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-TCP-%E7%9A%84%E5%8D%8F%E8%AE%AE%E6%AE%B5%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. TCP 的协议段格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%80%90%E5%AD%97%E6%AE%B5%E8%AF%A6%E8%A7%A3%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 逐字段详解（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-16-%E4%BD%8D%E6%BA%90%E7%AB%AF%E5%8F%A3%E5%8F%B7-%E7%9B%AE%E7%9A%84%E7%AB%AF%E5%8F%A3%E5%8F%B7%EF%BC%88%E5%90%84-16-%E4%BD%8D%EF%BC%8C%E5%85%B1-2-2-4-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">1. 16 位源端口号 &amp; 目的端口号（各 16 位，共 2+2 &#x3D; 4 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-32-%E4%BD%8D%E5%BA%8F%E5%8F%B7%EF%BC%884-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2. 32 位序号（4 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-32-%E4%BD%8D%E7%A1%AE%E8%AE%A4%E5%BA%8F%E5%8F%B7%EF%BC%884-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">3. 32 位确认序号（4 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E4%BD%8D%E9%A6%96%E9%83%A8%E9%95%BF%E5%BA%A6%EF%BC%884-%E4%BD%8D-0-5-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">4. 4 位首部长度（4 位 0.5 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E4%BF%9D%E7%95%99%E5%AD%97%E6%AE%B5%EF%BC%886-%E4%BD%8D-0-75-%E5%AD%97%E8%8A%82%EF%BC%8C%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">5. 保留字段（6 位 0.75 字节，了解）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-6-%E4%B8%AA%E6%A0%87%E5%BF%97%E4%BD%8D%EF%BC%880-75-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.6.</span> <span class="toc-text">6. 6 个标志位（0.75 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-16-%E4%BD%8D%E7%AA%97%E5%8F%A3%E5%A4%A7%E5%B0%8F%EF%BC%882-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.7.</span> <span class="toc-text">7. 16 位窗口大小（2 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-16-%E4%BD%8D%E6%A3%80%E9%AA%8C%E5%92%8C%EF%BC%882-%E5%AD%97%E8%8A%82%EF%BC%8C%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">1.2.2.8.</span> <span class="toc-text">8. 16 位检验和（2 字节，了解）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-16-%E4%BD%8D%E7%B4%A7%E6%80%A5%E6%8C%87%E9%92%88%EF%BC%882-%E5%AD%97%E8%8A%82%EF%BC%89"><span class="toc-number">1.2.2.9.</span> <span class="toc-text">9. 16 位紧急指针（2 字节）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-%E9%80%89%E9%A1%B9%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">1.2.2.10.</span> <span class="toc-text">10. 选项（了解）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-%E6%95%B0%E6%8D%AE%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">1.2.2.11.</span> <span class="toc-text">11. 数据（了解）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-TCP-%E6%8A%A5%E5%A4%B4%E5%A6%82%E4%BD%95%E5%88%86%E7%A6%BB%E6%95%B0%E6%8D%AE%EF%BC%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. TCP 报头如何分离数据？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%A6%82%E4%BD%95%E4%BA%A4%E4%BB%98%E7%BB%99%E4%B8%8A%E5%B1%82%EF%BC%9F"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 如何交付给上层？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%85%B3%E4%BA%8E-16-%E4%BD%8D%E6%A0%A1%E9%AA%8C%E5%92%8C"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 关于 16 位校验和</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%B8%BA%E4%BB%80%E4%B9%88-TCP-%E6%8A%A5%E5%A4%B4%E6%B2%A1%E6%9C%89%E9%95%BF%E5%BA%A6%E5%AD%97%E6%AE%B5%EF%BC%9F"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 为什么 TCP 报头没有长度字段？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-TCP-%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E5%8F%AF%E8%83%BD%E5%A4%B1%E8%B4%A5"><span class="toc-number">1.2.7.</span> <span class="toc-text">7. TCP 连接建立可能失败</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E8%BF%9E%E6%8E%A5%E6%80%8E%E6%A0%B7%E6%89%8D%E7%AE%97%E6%88%90%E5%8A%9F%E5%BB%BA%E7%AB%8B%EF%BC%9F"><span class="toc-number">1.2.8.</span> <span class="toc-text">8. 连接怎样才算成功建立？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%A1%AE%E8%AE%A4%E5%BA%94%E7%AD%94%EF%BC%88ACK%EF%BC%89%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">3. 确认应答（ACK）机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%B6%85%E6%97%B6%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">4. 超时重传机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text">5. 连接管理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-TCP-%E6%98%AF%E2%80%9C%E9%9D%A2%E5%90%91%E8%BF%9E%E6%8E%A5%E2%80%9D%E7%9A%84%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. TCP 是“面向连接”的协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86-TCP-%E8%BF%9E%E6%8E%A5%EF%BC%9F"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 操作系统如何管理 TCP 连接？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E9%9C%80%E8%A6%81%E2%80%9C%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E2%80%9D%EF%BC%9F"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 为什么建立连接需要“三次握手”？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%80%E6%AC%A1%E6%8F%A1%E6%89%8B%E8%A1%8C%E4%B8%8D%E8%A1%8C%EF%BC%9F"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">1. 一次握手行不行？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%A4%E6%AC%A1%E6%8F%A1%E6%89%8B%E8%A1%8C%E4%B8%8D%E8%A1%8C%EF%BC%9F"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">2. 两次握手行不行？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">3. 三次握手如何解决？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%BB%9D%E5%AF%B9%E5%8F%AF%E9%9D%A0%E5%90%97%EF%BC%9F"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">4. 三次握手绝对可靠吗？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5%E9%9C%80%E8%A6%81%E2%80%9C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E2%80%9D%EF%BC%9F"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 为什么断开连接需要“四次挥手”？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A5%97%E6%8E%A5%E5%AD%97%EF%BC%88Socket%EF%BC%89%E3%80%81connect%E3%80%81accept-%E4%B8%8E%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.5.5.</span> <span class="toc-text">5. 套接字（Socket）、connect、accept 与三次握手的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-connect-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">1. connect() 的本质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-accept-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">2. accept() 的本质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%B2%A1%E6%9C%89-accept-%E8%83%BD%E5%BB%BA%E7%AB%8B-TCP-%E8%BF%9E%E6%8E%A5%E5%90%97%EF%BC%9F"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">3. 没有 accept() 能建立 TCP 连接吗？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%B0%8F%E7%BB%93"><span class="toc-number">1.5.6.</span> <span class="toc-text">6. 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%90%86%E8%A7%A3-TIME-WAIT-%E7%8A%B6%E6%80%81"><span class="toc-number">1.6.</span> <span class="toc-text">6. 理解 TIME_WAIT 状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91-TIME-WAIT%EF%BC%9F"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. 如何触发 TIME_WAIT？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%A8-netstat-%E6%9F%A5%E7%9C%8B-TIME-WAIT"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 用 netstat 查看 TIME_WAIT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2MSL-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 2MSL 是什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E8%A7%A3%E5%86%B3-TIME-WAIT-%E7%8A%B6%E6%80%81%E5%BC%95%E8%B5%B7%E7%9A%84-bind-%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%88%E4%BD%9C%E4%B8%9A%EF%BC%89"><span class="toc-number">1.7.</span> <span class="toc-text">7. 解决 TIME_WAIT 状态引起的 bind 失败的方法（作业）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E7%90%86%E8%A7%A3-CLOSE-WAIT-%E7%8A%B6%E6%80%81"><span class="toc-number">1.8.</span> <span class="toc-text">8. 理解 CLOSE_WAIT 状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A6%82%E4%BD%95%E8%BF%9B%E5%85%A5-CLOSE-WAIT%EF%BC%9F"><span class="toc-number">1.8.1.</span> <span class="toc-text">1. 如何进入 CLOSE_WAIT？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-CLOSE-WAIT-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.2.</span> <span class="toc-text">2. CLOSE_WAIT 的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8E%92%E6%9F%A5-CLOSE-WAIT"><span class="toc-number">1.8.3.</span> <span class="toc-text">3. 排查 CLOSE_WAIT</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/22243.html" title="2025 年度总结"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=ebdc8f73-2df6-eb02-56e4-2e58830a0423" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2025 年度总结"></a><div class="content"><a class="title" href="/posts/22243.html" title="2025 年度总结">2025 年度总结</a><time datetime="2025-12-31T16:00:00.000Z" title="发表于 2026-01-01 00:00:00">2026-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/39993.html" title="08 表的增删改查下"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=784b23fb-15a7-eb8f-33eb-0d96dfe181cb" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="08 表的增删改查下"></a><div class="content"><a class="title" href="/posts/39993.html" title="08 表的增删改查下">08 表的增删改查下</a><time datetime="2025-12-12T16:00:00.000Z" title="发表于 2025-12-13 00:00:00">2025-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38170.html" title="Ubuntu 22.04 中安装 thefuck 与 tldr 工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/IAdmxAt.png?_r_=2efc2a28-f1f4-769a-5e7b-21833cf2c899" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Ubuntu 22.04 中安装 thefuck 与 tldr 工具"></a><div class="content"><a class="title" href="/posts/38170.html" title="Ubuntu 22.04 中安装 thefuck 与 tldr 工具">Ubuntu 22.04 中安装 thefuck 与 tldr 工具</a><time datetime="2025-11-22T04:00:00.000Z" title="发表于 2025-11-22 12:00:00">2025-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/31539.html" title="CodeX CLI 的使用备忘"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=19ad5a3e-ac75-3d2f-1d77-6c1b4b007131" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="CodeX CLI 的使用备忘"></a><div class="content"><a class="title" href="/posts/31539.html" title="CodeX CLI 的使用备忘">CodeX CLI 的使用备忘</a><time datetime="2025-11-19T04:00:00.000Z" title="发表于 2025-11-19 12:00:00">2025-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=36336436-a4b8-d24d-99f7-94bfb59134b6" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="免费白嫖 ChatGPT Go 套餐"></a><div class="content"><a class="title" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐">免费白嫖 ChatGPT Go 套餐</a><time datetime="2025-11-04T16:00:00.000Z" title="发表于 2025-11-05 00:00:00">2025-11-05</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile picture.png" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 - 2026 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType(){fetch("https://v1.hitokoto.cn").then(t=>t.json()).then(t=>{{const e="出自 "+t.from,n=["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","《答案在风中飘扬》（Blowing in The Wind）","梦想是不会发光的，发光的是追梦的你！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。"];n.unshift(t.hitokoto,e),window.typed=new Typed("#footer-type-tips",{strings:n,startDelay:300,typeSpeed:150,loop:!0,backSpeed:50})}})}"function"==typeof Typed?subtitleType():getScript("https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js").then(subtitleType)</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">93</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">算法</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://ac.nowcoder.com/acm/contest/profile/517073385" title="牛客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/think.svg" alt="牛客"><span class="back-menu-item-text">牛客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/1367427" title="洛谷"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/funny.svg" alt="洛谷"><span class="back-menu-item-text">洛谷</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:.88rem">AI<sup>2</sup></a><a href="/tags/C/" style="font-size:.88rem">C++<sup>11</sup></a><a href="/tags/Git/" style="font-size:.88rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:.88rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:.88rem">Linux<sup>59</sup></a><a href="/tags/MySQL/" style="font-size:.88rem">MySQL<sup>9</sup></a><a href="/tags/Redis/" style="font-size:.88rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:.88rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:.88rem">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:.88rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:.88rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:.88rem">历程<sup>2</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:.88rem">地址空间<sup>6</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size:.88rem">工具<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:.88rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:.88rem">模板<sup>1</sup></a><a href="/tags/%E7%81%B5%E5%85%89%E8%8D%9F%E8%90%83/" style="font-size:.88rem">灵光荟萃<sup>3</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:.88rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:.88rem">线程<sup>5</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:.88rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:.88rem">进程<sup>15</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("01/01/2025 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["这里是 小米里的大麦","芝兰生于深谷，不以无人而不芳。","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2025 By 安知鱼 V1.7.1"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.minbit.top/",path:window.location.pathname,region:"ap-shanghai",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then(o=>{t.textContent=o[0].count}).catch(t=>{console.error(t)})})()};anzhiyu.loadComment(document.getElementById("twikoo-wrap"),t)})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",pageSize:6,includeReply:!0}).then((function(t){const n=t.map(e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t});saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)})</script><script async data-pjax src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="xiaomilidedamai@minbit.top"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="https://events.vercount.one/js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>window.addEventListener("load",()=>{const t=()=>{if(!window.location.pathname.startsWith("/comments/"))return;const t=async()=>{const t=new EasyDanmaku({page:"/comments/",el:"#danmu-wrap",line:5,speed:20,hover:!0,loop:!1,colourful:!0,coefficient:1.38,runtime:10});try{let a=saveToLocal.get("twikoo-danmu");if(a)t.batchSend(a,!0);else{const n={method:"POST",body:JSON.stringify({event:"GET_RECENT_COMMENTS",includeReply:!1,pageSize:100}),headers:{"Content-Type":"application/json"}};a=[];const o=await fetch("https://twikoo.minbit.top/",n);if(o.ok){const{data:n}=await o.json();n.forEach(t=>{null==t.avatar&&(t.avatar="https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp"),a.push({avatar:t.avatar,content:t.nick+"："+e(t.comment),url:t.url+"#"+t.id})}),t.batchSend(a,!0),saveToLocal.set("twikoo-danmu",a,.5)}function e(t){return t=(t=(t=(t=(t=t.replace(/<\/*br>|[\s\uFEFF\xA0]+/g,"")).replace(/<img.*?>/g,"[图片]")).replace(/<a.*?>.*?<\/a>/g,"[链接]")).replace(/<pre.*?>.*?<\/pre>/g,"[代码块]")).replace(/<.*?>/g,"")}}}catch(t){console.error("Error fetching data:",t)}document.getElementById("danmu-Btn")&&(document.getElementById("danmu-Btn").innerHTML="<button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.remove('hide-danmu')\">显示弹幕</button> <button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.add('hide-danmu')\">隐藏弹幕</button>")};(async()=>{if("function"==typeof EasyDanmaku)await t();else{await getScript("https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js");"function"==typeof EasyDanmaku?await t():console.error("EasyDanmaku function not found even after loading the script.")}})()};t(),document.addEventListener("pjax:complete",t)})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>