<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>056 高级 IO | 小米里的大麦</title><meta name="keywords" content="Linux,IO"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="056 高级 IO"><meta name="application-name" content="056 高级 IO"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="056 高级 IO"><meta property="og:url" content="https://www.minbit.top/posts/7814.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="高级 IO Linux 高级 IO | CSDN  1. 正确认识 IO1. IO 的本质I&amp;#x2F;O（Input &amp;#x2F; Output）指的是 CPU 与外设之间的数据交互过程。在冯·诺依曼结构中，系统由：CPU（运算与控制）、内存（暂存数据与指令）、外设（磁盘、网卡、显示器、键盘等）组"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=62a2c9b9-baa7-7f9f-8ee4-eedc6c0f4edd"><meta property="article:author" content="小米里的大麦"><meta property="article:tag" content="技术博客,Linux,C++,后端开发,编程学习,个人博客,技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=62a2c9b9-baa7-7f9f-8ee4-eedc6c0f4edd"><meta name="description" content="高级 IO Linux 高级 IO | CSDN  1. 正确认识 IO1. IO 的本质I&amp;#x2F;O（Input &amp;#x2F; Output）指的是 CPU 与外设之间的数据交互过程。在冯·诺依曼结构中，系统由：CPU（运算与控制）、内存（暂存数据与指令）、外设（磁盘、网卡、显示器、键盘等）组"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "056 高级 IO",
  "description": "高级 IO Linux 高级 IO | CSDN  1. 正确认识 IO1. IO 的本质I&#x2F;O（Input &#x2F; Output）指的是 CPU 与外设之间的数据交互过程。在冯·诺依曼结构中，系统由：CPU（运算与控制）、内存（暂存数据与指令）、外设（磁盘、网卡、显示器、键盘等）组",
  "image": "https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=62a2c9b9-baa7-7f9f-8ee4-eedc6c0f4edd",
  "datePublished": "2025-10-14T04:00:00.000Z",
  "dateModified": "2025-10-22T04:00:00.000Z",
  "author": {
    "@type": "Person",
    "name": "小米里的大麦",
    "url": "https://www.minbit.top"
  },
  "publisher": {
    "@type": "Organization",
    "name": "小米里的大麦",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.minbit.top/img/minbit.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.minbit.top/posts/7814.html"
  },
  "keywords": "Linux, IO"
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "首页",
      "item": "https://www.minbit.top"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "056 高级 IO",
      "item": "https://www.minbit.top/posts/7814.html"
    }
  ]
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "小米里的大麦",
  "url": "https://www.minbit.top",
  "image": "https://www.minbit.top/img/minbit.png",
  "description": "时间好像总会留下点什么，或许是一个人，或许是一个梦，或许……是一段有意义的经历~"
}</script><link rel="shortcut icon" href="/img/icons/funny.svg"><link rel="canonical" href="https://www.minbit.top/posts/7814.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//bsz.dusays.com:9001"><meta name="google-site-verification" content="Cd-RTVhRO2mndEhicN2cvLXbsNxPqFC6fSn6ql80eVg"><meta name="baidu-site-verification" content="codeva-1H2kM6MEtN"><meta name="msvalidate.01" content="6DF744D82FE6D1FD11CE18658760B59D"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"友链 + 外链 + 无限进步！欢迎欣赏和贡献！",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"小米里的大麦",mode:"local",switchBtn:!1,btnLink:"https://afdian.net/item/886a79d4db6711eda42a52540025c377",randomNum:4,basicWordCount:1999,key:"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv",Referer:"https://www.minbit.top/"},diytitle:{enable:!0,leaveTitle:"w(ﾟДﾟ)w 不要走！再看看嘛！",backTitle:"♪(^∇^*)欢迎肥来！"},LA51:{enable:!0,ck:"Jp8wwGQpp21utaFQ",LingQueMonitorID:"Jp8ztDRrxmTf7LDj"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.minbit.top/",commentBarrageConfig:{enable:!0,maxBarrage:10,barrageTime:5e3,accessToken:"25c96851dd8a790c4819ad4bfbaf153c",mailMd5:"7b12ebc2be80f9159099f6ab0e16573c"},music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:void 0,navMusic:!0,mainTone:{mode:"both",api:"https://img2color-go.vercel.app/api?img=",cover_change:!0},authorStatus:{skills:["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!0,limitCount:150,languages:{author:"作者: 小米里的大麦",link:"链接: ",source:"来源: 小米里的大麦",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"小米里的大麦",title:"056 高级 IO",postAI:"这篇文章讲述了Linux高级IO的概念和实现方式，首先介绍了IO的本质，即CPU与外设之间的数据交互过程，并阐述了IO的关键特征，如慢速和异步性。文章进一步探讨了文件IO与网络IO的区别，指出在系统调用层面，C/C++通过`read`和`write`函数实现IO操作。接着，文章详细解释了五种IO模型，包括阻塞式IO、非阻塞式IO、信号驱动式IO、多路复用/转接和异步IO，并深入分析了IO操作的思维模型，即“等待数据准备好”和“数据从内核缓冲区拷贝到用户空间”两个阶段。此外，文章还介绍了`fcntl`函数，它是Linux文件描述符控制的“瑞士军刀”，用于对已打开的文件描述符进行各种控制操作，如设置非阻塞模式。最后，文章详细讲解了`select`函数，它是最早的I/O多路复用函数，用于同时监控多个文件描述符是否可读、可写或有异常事件，并解释了其函数原型和参数解释。这篇文章全面介绍了Linux高级IO的相关知识，对于理解和管理系统中的IO操作具有重要意义。",pageFillDescription:"高级 IO, 1. 正确认识 IO, 1. IO 的本质, 2. IO 的关键特征, 3. 文件 IO 与 网络 IO, 4. 系统调用层面, 2. 五种 IO 模型, 1. 小故事入题, 2. 深入理解 IO x3D 等 + 拷贝 的思维模型, 3. fcntl 函数原型, 1. 功能 x2F 作用, 2. 函数原型, 3. 参数详解, 1. 第二个参数（cmd）—— 要执行的操作类型, 2. 第三个参数（arg）—— 状态标志, 3. 快速记忆法, 4. 返回值, 5. 示例：设置非阻塞套接字, 4. IO 多路转接之 select 函数原型, 1. 作用, 2. 函数原型, 3. 参数解释, 1. nfds 参数, 2. fd_set 的本质, 3. 常用辅助宏, 4. struct timeval 的含义, 4. 返回值, 5. 使用示例, 6. 快速上手 select 的编写步骤（重要）, 7. select 优缺点总结, 5. poll 的函数原型, 1. 作用, 2. 函数原型, 3. 参数解释, 1. struct pollfd 结构体, 2. 事件标志（events 和 revents 的取值）, 3. 超时x2F最长等待时间（timeout）含义, 4. 返回值, 5. 使用示例, 6. poll 小结, 1. poll 的优点, 2. poll 的缺点, 3. 与 select 的核心区别高级高级正确认识的本质指的是与外设之间的数据交互过程在冯诺依曼结构中系统由运算与控制内存暂存数据与指令外设磁盘网卡显示器键盘等组成就是数据在内存外设之间的传输所以输入外设内存例如键盘输入磁盘读文件网卡收包输出内存外设例如屏幕显示磁盘写文件网卡发包的关键特征慢外设的速度远慢于和内存因此通常是性能瓶颈异步性外设工作时可去做别的事操作系统通过中断直接内存访问来提高效率文件与网络类型外设操作系统抽象本质文件磁盘文件描述符把数据从磁盘读入内存或写出网络网卡套接字把数据从网卡缓冲区读入内存或写出对操作系统来说一切皆文件无论是磁盘文件管道套接字本质都是文件描述符缓冲区上的读写操作系统调用层面层面对的最底层接口如下从读数据到内存从内存写数据到读文件时数据路径是磁盘内核缓存用户内存读网络时数据路径是网卡内核缓冲区用户内存应用层的时候本质就是把数据从用户层写给即拷贝函数此时我们只需要知道等拷贝要进行拷贝必须先判断读写事件这个条件成立什么叫做高效呢知道等拷贝后就可以得出结论单位时间内的过程中等的比重越小效率越高反之等的比重越大效率越低几乎所有提高效率的策略本质就是这个五种模型小故事入题张三是个钓鱼佬他的钓鱼方式是一根儿鱼竿儿钓鱼时就一直一动不动地盯着鱼漂直到有鱼上钩在这段时间内他不能干别的事我们管这种方式叫做阻塞式对应到计算机上一调用就会阻塞当前线程操作系统先等数据准备好等待阶段数据准备好后再拷贝到用户空间拷贝阶段两步都做完才返回特点简单直观但效率最低在等鱼的时间被浪费掉李四也是钓鱼佬他也是一根儿鱼竿儿但他的钓鱼方式是抛完杆儿等一会了去喝个茶回来看一看上没上鱼看会书回来看一看睡一觉回来看一看跟张三说完话回来看一看张三并不想搭理李四这种方式叫做非阻塞式即非阻塞轮询特点线程不会被卡死但不停在空转查询效率依然不高多线程或高并发场景中非常浪费王五一样但是他很聪明他在鱼竿上绑了一个铃铛期间可以看书睡觉打游戏摸鱼当铃铛响了说明上鱼了才去看鱼竿儿这属于信号驱动式系统上程序先注册一个信号回调函数当内核检测到数据可读时会发信号通知用户进程用户进程再调用把数据拷贝到用户空间特点通过信号机制通知事件比轮询更高效但信号机制复杂调度开销大所以实际使用较少赵六是个有钱人他直接开了一大卡车的鱼竿儿机械化钓鱼就假设他布置好了根鱼竿儿他不可能盯着每一根于是雇了个助手助手负责统一盯着所有鱼竿一旦某根竿有动静就通知他此时水里的鱼是一定的但赵六上鱼的概率远远高于其他人这就是多路复用转接这就是的核心思想系统提供一个统一的接口一次性监听多个文件描述符鱼竿当其中任意一个准备就绪时再通知进程特点可同时管理大量连接高并发赵六只需要等通知即可效率大大提升是高性能网络服务器如最常用的模式田七照样是个有钱人看到他们在钓鱼于是也想吃鱼就准备一起但是很不巧临时有事要走他一想我就想吃鱼怎么来的不重要于是就叫随行的司机拿着工具去钓鱼田七则去办其他的事情告诉司机等他钓好鱼后直接给他打电话就行这就是异步值得注意的是这里的司机其实就是系统中用户调用之后立即返回操作系统后台完成数据准备拷贝两个阶段完成后通过事件或回调通知应用特点真正的非阻塞无等待可以同时干别的工作适用于密集型高并发场景我们知道等拷贝所有模型的区别都在于这两个阶段是谁在做怎么做在这个钓鱼的过程中只有田七是异步其他人都属于同步因为其他人都直接参与了等的环节但田七则是间接做了等的操作实际不参与田七只是发起最后拿结果就行就像我交给你一个黑盒我不管你干了什么到时候我从黑盒中拿结果就行还有一点就是同步是属于线程同步吗答案是老婆和老婆饼的关系没有关系深入理解等拷贝的思维模型无论哪种本质都要经历两个阶段等待数据准备好等待鱼上钩数据从内核缓冲区拷贝到用户空间把鱼拽上来区别在于谁来等线程自己统一管理者还是操作系统什么时候返回等完再返回还是先返回之后回调模型类型等待阶段拷贝阶段是否阻塞谁来等典型调用适用场景阻塞阻塞阻塞是应用线程简单场景非阻塞轮询阻塞否轮询应用线程少量连接信号驱动信号触发阻塞否内核发信号特殊场合多路复用阻塞等待事件阻塞拷贝部分阻塞统一等待者高并发服务器高性能异步非阻塞非阻塞否全交给内核真正异步场景函数原型功能作用它是文件描述符控制的瑞士军刀非常常见于网络编程和模型设置中比如设置非阻塞套接字用于对已打开的文件描述符进行各种控制操作几乎所有修改文件描述符行为的操作都要通过它完成例如设置清除文件描述符的标志如非阻塞模式获取修改文件状态复制文件描述符锁定文件调整文件特性等函数原型参数详解参数位置含义第个参数要操作哪个文件描述符文件等第个参数要执行的命令控制操作告诉内核你想干什么第个参数可选如果需要就传入新的标志值常用旧标志新功能第二个参数要执行的操作类型命令含义第三个参数常用场景获取文件状态标志无读取当前的打开模式只读非阻塞等设置文件状态标志新标志通常是旧标志新标志修改行为如设为非阻塞获取文件描述符标志无判断是否带有设置文件描述符标志等设置执行时是否自动关闭复制一个新的文件描述符最小可用编号类似但可指定起始编号设置文件锁非阻塞文件加锁不会阻塞设置文件锁阻塞文件加锁会阻塞等待获取文件锁状态查询当前文件锁实际开发中最常用的就是和尤其用于设置非阻塞设置追加写第三个参数状态标志标志含义常见场景只读打开打开文件用只写打开打开文件用可读可写打开文件用写操作追加到文件末尾日志文件非阻塞模式网络同步写入每次写都落盘文件系统安全要求高的场景异步模式很少单独使用不存在则创建文件打开打开时清空文件内容文件重写执行时自动关闭防止文件描述符泄漏快速记忆法操作类型缩写记忆用途控制读写行为控制描述符自身属性设置非阻塞执行新程序时关闭返回值成功返回值依赖于一般为非负数失败返回并设置示例设置非阻塞套接字获取原来文件描述符的属性在原标志基础上加上非阻塞设置为非阻塞模式成功设置成为非阻塞如果底层数据没有就绪返回值会以出错的形式返回错误形式的两种情况真的出错底层没有就绪怎么区分呢需要通过区分创建套接字获取当前文件状态标志设置非阻塞模式加上套接字已设置为非阻塞模式多路转接之函数原型多路转接作用是最早的多路复用函数用来同时监控多个文件描述符是否可读可写或有异常事件函数原型参数解释参数名含义监控的最大文件描述符例如要监控就写想监控可读事件的文件描述符集合如是否不阻塞想监控可写事件的文件描述符集合如是否不阻塞监控异常事件的文件描述符集合一般不用传超时时间阻塞多久传就是一直阻塞参数要监控的最高文件描述符编号想监控最高是就写想监控最高是就是不是系统最大支持的文件描述符大小那个值通常很大如或不需要监控那么多记住是一个范围会检查从到这个范围内的所有只要在里设置了它们就是这个范围的上限不包含简化记忆会在这个范围内看你里标记了哪些然后监控它们的本质是内核与用户空间之间传递文件描述符就绪信息的一张位图阶段谁在操作含义输入阶段用户内核用户调用前告诉内核我关心这些读写异常输出阶段内核用户内核执行完检查后告诉用户这些已经就绪比特位也就是说是输入输出双向参数既是输入也会被输出修改每一位对应一个表示就绪表示未就绪调用后必须重新设置因为会修改它的内部形式本质就是一个位图每个对应一个文件描述符号位号比如的第位的核心用户传一张关注表给内核内核帮你看这些是否有事件等结果出来后内核再把结果表写回给你常用辅助宏把从集合中移除对应判断是否在集合中就绪返回把加入集合设置对应清空集合所有置一般是这么操作的定义一个集合清空集合把加入关注集合把标准输入加入集合调用监听读事件可读标准输入可读调用后会被内核修改表示哪些已经就绪的含义就是给设置一个最长等待时间的闹钟如果在闹钟响之前有事就绪就立即叫醒你返回如果闹钟响了还没事未就绪也叫醒你返回如果设置为永不响就会一直睡阻塞如果设置为立刻响就不会睡非阻塞秒微秒秒微秒最多等待秒微秒如果在这个时间之内有你监控的就绪了会立即返回告诉你哪些就绪了剩余的等待时间会被写回到结构体中通常在实际编程中会每次都重新设置这个值如果这个时间之内没有任何你监控的就绪会超时返回返回值为示例永久阻塞传统阻塞式最多阻塞秒带超时的阻塞不阻塞非阻塞轮询式返回值有多少个文件描述符就绪可读可写异常超时没有任何事件发生没有错误但是也没有就绪出错一般是信号中断或参数错误使用示例创建集合清空集合把标准输入加入监控集合最多阻塞秒等待输入中检测到输入你输入了超时没有输入出错一个基于系统调用的单进程单线程服务器完整代码请前往进行查看默认端口号计算能容纳的最大文件描述符数量每个位代表一个无效文件描述符用来标识数组中空闲的位置将数组中所有位置都初始化为表示空闲关闭监听初始化服务器创建绑定端口开始监听创建监听绑定端口开始监听打印当前在线的文件描述符列表在线列表输出提示信息遍历数组如果是空闲位置跳过输出有效的文件描述符连接事件已经就绪客户端的客户端的端口从监听获取新的连接不会阻塞因为已经告诉我们有连接事件就绪如果失败直接返回新连接建立成功客户端客户端端口新连接建立成功客户端客户端端口将新连接的文件描述符存入数组中从数组索引开始找空闲位置索引存放监听查找数组中空闲的位置如果当前位置不为空继续找下一个找到空闲位置跳出循环如果遍历完整个数组都没找到空闲位置服务器已满立即关闭服务器已满关闭新连接服务器已满立即关闭找到了空闲位置将新连接的放入数组打印当前在线的列表后续可能还有其他处理处理数据接收的函数是需要读取数据的文件描述符是该在数组中的位置接收客户端数据临时缓冲区用于存储接收的数据从指定读取数据到缓冲区预留字节给字符串结束符读取到数据手动添加字符串结束符收到一条消息输出接收到的消息客户端断开连接读到文件结束符客户端退出了关闭连接的文件描述符是记录客户端断开日志关闭该连接的文件描述符将数组中对应位置重置为表示该位置空闲这里本质是从中移除该读取错误接收文件错误描述符是记录接收错误日志关闭该连接的文件描述符将数组中对应位置重置为表示该位置空闲这里本质是从中移除该事件分发函数根据返回的结果处理就绪的文件描述符是调用后被修改的其中包含了就绪的获取数组中第个位置的如果是无效跳过检查这个是否在返回的就绪集合中宏用于检查是否在集合中如果就绪的是监听说明有新的连接请求调用处理如果就绪的不是监听而是普通的数据连接调用处理数据接收服务器主循环使用实现多路复用获取监听的文件描述符将监听放在数组第个位置程序启动时只有数组第个位置有值是监听的但是程序运行过程中会向数组中其他位置添加新的连接无限循环服务器持续运行定义一个变量用于存储待检测的读就绪文件描述符集合清空集合将所有位都设置为每次进入循环都要重新构建集合因为会修改它记录当前最大的文件描述符值用于调用第一次循环遍历数组准备的参数如果数组中该位置是空闲的跳过这个非常有用如果不跳过是会出错或行为未定义并且如果当前只有监听数组后面的位置都是这个循环会遍历所有位置但由于只有有效的比如监听会被处理将有效的添加到集合中让监控这些的读就绪状态更新最大值最大文件描述符更新最大文件描述符为最大文件描述符更新最大文件描述符为调用系统调用监控个文件描述符到是读就绪集合表示不监控写和异常最后一个参数为表示不超时阻塞等待现在监控的是到范围内所有在位图中被置位的如果只有监听它只监控监听如果有多个连接它会监控监听和所有已连接的根据返回值进行处理超时处理调用出错处理成功处理得到了一个新的连接请求调用处理所有就绪的事件监听对象服务器端口号文件描述符数组用于维护当前所有有效的连接包括监听扩展写事件处理测试连接尝试输入一些内容初学时这段代码要理解其实有一定难度让我们详细梳理一下初始状态监听的默认被占用就不解释了到都是第一次循环被清空遍历只有值为有效所以被调用监控假设现在客户端连接服务器发现监听可读有新连接返回值进入遍历为真为真调用执行被调用获取客户端的连接假设此时进程内最小可用是因为被占用是监听所以返回开始查找中的空闲位置找到空闲位置不等于所以执行分支将客户端的存入数组第二次循环被清空遍历监听有效更新为客户端的有效更新为到跳过被调用现在监控和假设现在客户端发送了一条消息发现客户端的可读有数据到达返回值进入遍历检查因为这次是就绪没就绪所以为假跳过检查因为这次是就绪所以为真为真进入分支调用被成功调用了执行从客户端的读取数据并处理它例如打印关键点返回的不是监听的它返回的是一个全新的代表新客户端连接的的这个新会被存储到中循环中的循环会持续更新监控的集合每次循环它都会将中所有非的包括监听和所有已连接的客户端都添加到监控集合中循环会持续检查中所有非的看它们是否在返回的就绪集合中如果就绪的是监听的说明有新连接走如果就绪的是中某个已存储的客户端的即说明这个特定客户端发送了数据走中查找空闲位置的意义是服务器用来追踪和管理所有当前连接包括监听的本地数据结构返回的必须被记录下来否则服务器就无法知道有哪些客户端连接也无法监控它们查找空闲位置并存入是为了让和能够知道这个新连接的存在并将其加入到的监控范围和事件分发范围中检查是为了防止被填满实现连接数限制注意非常重要且会被使用每当任何一个已连接的客户端发送数据时就会检测到该客户端对应的就绪就会找到该在中的位置并调用来处理该客户端的数据和的查找逻辑是实现多客户端管理的关键快速上手的编写步骤重要想象你是一个服务员要同时服务多个客户文件描述符准备工具创建一个想象成一个点名册清空它记录客户把你需要服务的客户文件描述符一个个记到点名册上比如客户客户确定范围看看你记下的客户里编号最大的是谁比如是客户就是这个最大编号也就是告诉老板操作系统我要服务编号到的客户开始观察调用点名册你开始观察点名册上记录的客户等待他们有需要比如按铃表示可读响应需求告诉你哪些客户按铃了你再次查看点名册看具体是哪个客户按的然后去服务这个客户比如读取数据循环往复回到第步继续准备记录观察响应编写步骤初始化创建监听绑定监听准备容器用一个数组如或链表存储所有要监控的主循环清空遍历你的容器将所有有效添加到同时记录这些中的最大值调用事件分发再次遍历你的容器对于每个有效用检查它是否在返回的就绪集合中如果是监听就绪调用如果是普通连接就绪调用或相应的处理函数处理连接得到新将其添加到你的容器中处理数据读取数据处理如果连接断开从你的容器中移除该设置为核心思想用一个容器数组链表管理所有用监控这个容器里的所有用的返回结果分发事件给相应的处理函数优缺点总结优点可同时等待多个文件描述符提高利用率等待与操作分离操作本身不会被阻塞实现简单兼容性好几乎所有平台都支持缺点数量有限通常上限每次调用都要重置集合使用繁琐用户态到内核态频繁拷贝开销大内核遍历所有检查状态效率低用户态也需维护集合多次遍历复杂度高能多路等待但机制老开销大扩展性差设计比较久远具有局限性对初学者也并不友好于是就有了的多路转接方案是对的改进版解决了它的一些局限的函数原型作用用数组替代位图的功能一样但更方便无上限是比新的多路复用函数用来同时监控多个文件描述符的可读可写或异常事件功能和一样但使用方式更简单限制更少函数原型参数解释参数名含义与对比一个结构体数组每个元素描述一个要监控的类似于三个集合的合并版数组中有多少个元素即可以传入多少个文件描述符等价于的监控的数量超时最长等待时间毫秒功能同的只是单位不同毫秒结构体要监控的文件描述符想监控哪些事件输入参数实际发生的事件输出参数由内核填充事件标志和的取值事件描述是否可作为输入是否可作为输出数据包括普通数据和优先数据可读是是普通数据可读是是优先级带数据可读不支持是是高优先级数据可读比如带外数据是是数据包括普通数据和优先数据可写是是普通数据可写是是优先级带数据可写是是连接被对方关闭或者对方关闭了写操作它由引入是是错误否是挂起比如管道的写端被关闭后读端描述符上将收到事件否是文件描述符没有打开否是常用的事件标志含义可读读缓冲区有数据可写写缓冲区可用错误比如连接异常对端关闭连接挂断无效的超时最长等待时间含义取值含义最多等待指定毫秒数超时返回立即返回非阻塞轮询一直阻塞直到有事件返回值有多少个就绪超时出错使用示例完整代码请前往查看默认端口号数组的最大容量最多同时监听个文件描述符无效文件描述符用来标识数组中空闲的位置初始化每个位置的为表示未使用初始化每个位置的监听事件为不监听任何事件初始化每个位置的返回事件为无事件发生关闭监听初始化服务器创建绑定端口开始监听创建监听绑定端口开始监听打印当前在线的文件描述符列表在线列表输出提示信息遍历数组如果是空闲位置为跳过输出有效的文件描述符有新的客户端连接请求到来客户端的客户端的端口接收新的客户端连接如果失败直接返回新连接建立成功客户端客户端端口新连接建立成功客户端客户端端口将新连接的文件描述符添加到数组中从数组索引开始找空闲位置索引存放监听查找数组中空闲的位置如果当前位置已被占用不为继续找下一个找到空闲位置跳出循环如果遍历完整个数组都没找到空闲位置服务器已满立即关闭服务器连接数已达上限关闭新连接服务器已满立即关闭找到了空闲位置将新连接的放入数组设置该的监听事件为监听数据可读清空返回事件打印当前在线的列表后续可能还有其他处理处理数据接收的函数是需要读取数据的文件描述符是该在数组中的位置接收客户端发送的数据临时缓冲区用于存储接收的数据从指定读取数据到缓冲区预留字节给字符串结束符读取到数据手动添加字符串结束符收到一条消息输出接收到的消息客户端断开连接读到文件结束符客户端退出了关闭连接的文件描述符是记录客户端断开日志关闭该连接的文件描述符将数组中对应位置重置为表示该位置空闲从监听列表中移除该读取错误接收文件错误描述符是记录接收错误日志关闭该连接的文件描述符将数组中对应位置重置为表示该位置空闲从监听列表中移除该事件分发函数处理所有就绪的事件遍历数组检查哪些的事件已经就绪获取数组中第个位置的如果是无效跳过如果这个的事件已经就绪有数据可读如果就绪的是监听说明有新的连接请求调用处理如果就绪的不是监听而是普通的数据连接调用处理数据接收服务器主循环使用实现多路复用把监听的放到数组的第一个位置监听只关心事件新连接请求设置超时时间为毫秒秒如果秒内没有事件发生会返回服务器无限循环持续监听和处理事件调用等待事件发生根据返回值进行处理超时处理时间内没有事件发生超时没有事件发生调用出错处理调用出错成功处理有事件发生得到了一个新的连接请求成功有事件发生注意这里注释可能不准确有事件发生不一定都是连接请求调用处理所有就绪的事件监听对象服务器端口号需要的数组存储要监听的和事件结构体数组数组每一个位置都是结构体扩展写事件处理小结的优点输入输出参数分离里有输入和输出不像那样每次都要重新设置集合监控数量不限不再受的比特位限制想监控多少个就传多少个元素具体监控多少个由第二个参数决定同时等待多个提高效率等的时间可以重叠效率比阻塞式高得多的缺点返回后仍需遍历需要遍历整个数组找出哪些已经就绪用户态与内核态拷贝开销大每次调用都要把整个数组复制进内核多时性能会明显下降内核仍是线性扫描内核依然要挨个检查每个就绪检测效率低当数量非常大时性能退化明显与的核心区别对比项表达方式位图结构体数组数量限制有通常理论无限由系统资源决定参数是否要重置每次都要重新设置不用重置只更新有变化的项内核检测机制遍历所有同样遍历但结构更清晰是的改良版解决了数量上限和参数重置的问题但底层依然是遍历式检测性能瓶颈依旧",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-10-22 12:00:00",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach(e=>{c.setAttribute(e,t[e])}),document.head.appendChild(c)}),e.getCSS=(e,t=!1)=>new Promise((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=10||e>=20?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())})}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/custom/css/font.css"><link rel="stylesheet" href="/custom/css/bilibili.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="小米里的大麦" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/minbit.png"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" alt="微信" src="/img/wechat.webp"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="/img/alipay.webp"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:1.05rem">AI<sup>1</sup></a><a href="/tags/C/" style="font-size:1.05rem">C++<sup>8</sup></a><a href="/tags/ChatGPT/" style="font-size:1.05rem">ChatGPT<sup>1</sup></a><a href="/tags/Git/" style="font-size:1.05rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:1.05rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:1.05rem">Linux<sup>58</sup></a><a href="/tags/MySQL/" style="font-size:1.05rem">MySQL<sup>4</sup></a><a href="/tags/Obsidian/" style="font-size:1.05rem">Obsidian<sup>1</sup></a><a href="/tags/Redis/" style="font-size:1.05rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:1.05rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:1.05rem">VS Code<sup>1</sup></a><a href="/tags/%E4%B8%B4%E6%97%B6%E9%82%AE%E7%AE%B1/" style="font-size:1.05rem">临时邮箱<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:1.05rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:1.05rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:1.05rem">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:1.05rem">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:1.05rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:1.05rem">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:1.05rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:1.05rem">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:1.05rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:1.05rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:1.05rem">进程<sup>15</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div id="console-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a><a class="article-meta__tags" href="/tags/IO/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>IO</span></a></span></div></div><h1 class="post-title" itemprop="name headline">056 高级 IO</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-10-14T04:00:00.000Z" title="发表于 2025-10-14 12:00:00">2025-10-14</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-22T04:00:00.000Z" title="更新于 2025-10-22 12:00:00">2025-10-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">10.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="056 高级 IO"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=62a2c9b9-baa7-7f9f-8ee4-eedc6c0f4edd"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/7814.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><a href="/tags/IO/" tabindex="-1" itemprop="url">IO</a><h1 id="CrawlerTitle" itemprop="name headline">056 高级 IO</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-10-14T04:00:00.000Z" title="发表于 2025-10-14 12:00:00">2025-10-14</time><time itemprop="dateCreated datePublished" datetime="2025-10-22T04:00:00.000Z" title="更新于 2025-10-22 12:00:00">2025-10-22</time></header><h1 id="高级-IO"><a href="#高级-IO" class="headerlink" title="高级 IO"></a>高级 IO</h1><blockquote><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenlong_cxy/article/details/126050039">Linux 高级 IO | CSDN</a></p></blockquote><h2 id="1-正确认识-IO"><a href="#1-正确认识-IO" class="headerlink" title="1. 正确认识 IO"></a>1. 正确认识 IO</h2><h3 id="1-IO-的本质"><a href="#1-IO-的本质" class="headerlink" title="1. IO 的本质"></a>1. IO 的本质</h3><p>I&#x2F;O（Input &#x2F; Output）指的是 <strong>CPU 与外设之间的数据交互过程</strong>。在冯·诺依曼结构中，系统由：<strong>CPU</strong>（运算与控制）、<strong>内存</strong>（暂存数据与指令）、<strong>外设</strong>（磁盘、网卡、显示器、键盘等）组成。</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/huangcancan-xbc/Drawing-bed@master/Blog/20250623200921613.png"></p><p>I&#x2F;O 就是：数据在「内存 ↔ 外设」之间的传输。所以：</p><ul><li><strong>输入（Input）</strong>：外设 → 内存（例如：键盘输入、磁盘读文件、网卡收包）。</li><li><strong>输出（Output）</strong>：内存 → 外设（例如：屏幕显示、磁盘写文件、网卡发包）。</li></ul><h3 id="2-IO-的关键特征"><a href="#2-IO-的关键特征" class="headerlink" title="2. IO 的关键特征"></a>2. IO 的关键特征</h3><ol><li><strong>慢</strong>：外设的速度远慢于 CPU 和内存。因此，IO 通常是性能瓶颈。</li><li><strong>异步性</strong>：外设工作时 CPU 可去做别的事。操作系统通过 <strong>中断、DMA（直接内存访问）</strong> 来提高效率。</li></ol><h3 id="3-文件-IO-与-网络-IO"><a href="#3-文件-IO-与-网络-IO" class="headerlink" title="3. 文件 IO 与 网络 IO"></a>3. 文件 IO 与 网络 IO</h3><table><thead><tr><th>IO 类型</th><th>外设</th><th>操作系统抽象</th><th>本质</th></tr></thead><tbody><tr><td>文件 IO</td><td>磁盘</td><td>文件描述符（fd）</td><td>把数据从磁盘读入内存或写出</td></tr><tr><td>网络 IO</td><td>网卡</td><td>套接字（socket）</td><td>把数据从网卡缓冲区读入内存或写出</td></tr></tbody></table><p>对操作系统来说，<strong>一切皆文件</strong>，无论是磁盘文件、管道、套接字，本质都是「文件描述符 + 缓冲区」上的读写操作。</p><h3 id="4-系统调用层面"><a href="#4-系统调用层面" class="headerlink" title="4. 系统调用层面"></a>4. 系统调用层面</h3><p>C&#x2F;C++ 层面对 IO 的最底层接口如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span></span>;   <span class="comment">// 从 fd 读数据到内存</span></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span></span>;  <span class="comment">// 从内存写数据到 fd</span></span><br></pre></td></tr></table></figure><ul><li>读文件时，数据路径是：磁盘 → 内核缓存 → 用户内存。</li><li>读网络时，数据路径是：网卡 → 内核缓冲区 → 用户内存。</li></ul><blockquote><p><strong>应用层 <code>read</code> &amp;&amp; <code>write</code> 的时候，本质就是把数据从用户层写给 OS，即“拷贝函数”。此时我们只需要知道：<span style="color:red">IO &#x3D; 等 + 拷贝</span>。要进行拷贝，必须先判断读写事件这个条件成立！</strong></p><p><strong>什么叫做高效 IO 呢？知道 IO &#x3D; 等 + 拷贝后，就可以得出结论：单位时间内，IO 的过程中，等的比重越小，IO 效率越高！反之，等的比重越大，IO 效率越低。几乎所有提高 IO 效率的策略，本质就是这个！</strong></p></blockquote><hr><h2 id="2-五种-IO-模型"><a href="#2-五种-IO-模型" class="headerlink" title="2. 五种 IO 模型"></a>2. 五种 IO 模型</h2><h3 id="1-小故事入题"><a href="#1-小故事入题" class="headerlink" title="1. 小故事入题"></a>1. 小故事入题</h3><ol><li><p>张三是个钓鱼佬，他的钓鱼方式是一根儿鱼竿儿，钓鱼时就一直一动不动地盯着鱼漂，直到有鱼上钩。在这段时间内他不能干别的事，我们管这种方式叫做 <strong>阻塞式 IO</strong>。</p><ul><li>对应到计算机上：<code>read()</code> 一调用，就会 <strong>阻塞当前线程</strong>，操作系统先等数据准备好（等待阶段），数据准备好后，再拷贝到用户空间（拷贝阶段），两步都做完，<code>read()</code> 才返回。<strong>特点</strong>：简单、直观，但效率最低。CPU 在“等鱼”的时间被浪费掉。</li></ul></li><li><p>李四也是钓鱼佬，他也是一根儿鱼竿儿，但他的钓鱼方式是：抛完杆儿，等一会了去喝个茶回来看一看上没上鱼，看会书回来看一看，睡一觉回来看一看，跟张三说完话回来看一看（张三并不想搭理李四），这种方式叫做 <strong>非阻塞式 IO，即非阻塞轮询，特点：</strong> 线程不会被卡死，但 CPU 不停在空转查询，效率依然不高（多线程或高并发场景中非常浪费 CPU）。</p></li><li><p>王五一样，但是他很聪明，他在鱼竿上绑了一个铃铛，期间可以看书、睡觉、打游戏，摸鱼……当铃铛响了说明上鱼了，才去看鱼竿儿，这属于 <strong>信号驱动式 IO</strong>。</p><ul><li>系统上：程序先注册一个信号回调函数（<code>sigaction</code>），当内核检测到数据可读时，会发信号通知用户进程，用户进程再调用 <code>read()</code> 把数据拷贝到用户空间。<strong>特点</strong>：通过信号机制通知事件，比轮询更高效。但信号机制复杂、调度开销大，所以实际使用较少。</li></ul></li><li><p>赵六是个有钱人，他直接开了一大卡车的鱼竿儿，机械化钓鱼，就假设他布置好了 1000 根鱼竿儿，他不可能盯着每一根，于是雇了个助手，<br>助手负责统一盯着所有鱼竿，一旦某根竿有动静就通知他。此时水里的鱼是一定的，但赵六上鱼的概率远远高于其他人，这就是 <strong>多路复用&#x2F;转接。</strong></p><ul><li><strong>这就是 select&#x2F;poll&#x2F;epoll 的核心思想。</strong> 系统提供一个统一的接口，一次性监听多个文件描述符（鱼竿），当其中任意一个“准备就绪”时再通知进程。<strong>特点</strong>：可同时管理大量连接（高并发）、赵六只需要等“通知”即可，效率大大提升、是高性能网络服务器（如 Nginx、Redis）最常用的模式。</li></ul></li><li><p>田七照样是个有钱人，看到他们在钓鱼，于是也想吃鱼，就准备一起，但是很不巧临时有事要走，他一想：我就想吃鱼，怎么来的不重要，于是就叫随行的司机拿着工具去钓鱼，田七则去办其他的事情，告诉司机等他钓好鱼后直接给他打电话就行。这就是 <strong>异步 IO，值得注意的是这里的司机其实就是 OS</strong>。</p><ul><li>系统中：用户调用 <code>aio_read()</code> 之后立即返回，操作系统后台完成“数据准备 + 拷贝”两个阶段，完成后通过事件或回调通知应用。<strong>特点</strong>：真正的 <strong>非阻塞 + 无等待</strong>，CPU 可以同时干别的工作，适用于 I&#x2F;O 密集型高并发场景。</li></ul></li></ol><p>我们知道 <strong>IO &#x3D; 等 + 拷贝</strong>，所有 IO 模型的区别，都在于这两个阶段是 <strong>谁在做</strong>、<strong>怎么做</strong>。在这个钓鱼的过程中只有田七是异步 IO，其他人都属于同步 IO，因为其他人都直接参与了等的环节，但田七则是间接做了等的操作，实际不参与 IO，田七只是发起 IO，最后拿结果就行，就像我交给你一个黑盒，我不管你干了什么，到时候我从黑盒中拿结果就行。还有一点就是同步 IO 是&#x2F;属于线程同步吗？答案是老婆和老婆饼的关系 —— 没有关系！</p><h3 id="2-深入理解-IO-等-拷贝-的思维模型"><a href="#2-深入理解-IO-等-拷贝-的思维模型" class="headerlink" title="2. 深入理解 IO &#x3D; 等 + 拷贝 的思维模型"></a>2. 深入理解 IO &#x3D; 等 + 拷贝 的思维模型</h3><p>无论哪种 IO，本质都要经历两个阶段：</p><ol><li><strong>等待数据准备好</strong>（等待鱼上钩）。</li><li><strong>数据从内核缓冲区拷贝到用户空间</strong>（把鱼拽上来）。</li></ol><p>区别在于：谁来“等”（线程自己、统一管理者、还是操作系统），什么时候返回（等完再返回，还是先返回之后回调）。</p><table><thead><tr><th>模型类型</th><th>等待阶段</th><th>拷贝阶段</th><th>是否阻塞</th><th>谁来等</th><th>典型调用</th><th>适用场景</th></tr></thead><tbody><tr><td>阻塞 I&#x2F;O</td><td>阻塞</td><td>阻塞</td><td>是</td><td>应用线程</td><td><code>read()</code></td><td>简单场景</td></tr><tr><td>非阻塞 I&#x2F;O</td><td>轮询</td><td>阻塞</td><td>否（轮询）</td><td>应用线程</td><td><code>fcntl(fd, O_NONBLOCK)</code></td><td>少量连接</td></tr><tr><td>信号驱动 I&#x2F;O</td><td>信号触发</td><td>阻塞</td><td>否</td><td>内核发信号</td><td><code>sigaction()</code></td><td>特殊场合</td></tr><tr><td>I&#x2F;O 多路复用</td><td>阻塞等待事件</td><td>阻塞拷贝</td><td>部分阻塞</td><td>统一等待者（select&#x2F;poll&#x2F;epoll）</td><td>高并发服务器</td><td>高性能</td></tr><tr><td>异步 I&#x2F;O</td><td>非阻塞</td><td>非阻塞</td><td>否</td><td>全交给内核</td><td><code>aio_read()</code></td><td>真正异步场景</td></tr></tbody></table><hr><h2 id="3-fcntl-函数原型"><a href="#3-fcntl-函数原型" class="headerlink" title="3. fcntl 函数原型"></a>3. <code>fcntl</code> 函数原型</h2><h3 id="1-功能-作用"><a href="#1-功能-作用" class="headerlink" title="1. 功能 &#x2F; 作用"></a>1. 功能 &#x2F; 作用</h3><p><code>fcntl()</code> —— 它是 Linux 文件描述符控制的“瑞士军刀”，非常常见于网络编程和 I&#x2F;O 模型设置中，比如设置非阻塞套接字。<code>fcntl()</code>（file control）用于 <strong>对已打开的文件描述符进行各种控制操作</strong>。几乎所有“修改文件描述符行为”的操作都要通过它完成，例如：设置 &#x2F; 清除文件描述符的标志（如非阻塞模式）、获取 &#x2F; 修改文件状态、复制文件描述符、锁定文件、调整文件特性等。</p><h3 id="2-函数原型"><a href="#2-函数原型" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* arg */</span>)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="3-参数详解"><a href="#3-参数详解" class="headerlink" title="3. 参数详解"></a>3. 参数详解</h3><table><thead><tr><th>参数位置</th><th>含义</th></tr></thead><tbody><tr><td><strong>第 1 个参数：fd</strong></td><td>要操作哪个文件描述符（文件、socket 等）</td></tr><tr><td><strong>第 2 个参数：cmd</strong></td><td>要执行的命令&#x2F;控制操作（告诉内核你想干什么）</td></tr><tr><td><strong>第 3 个参数：arg（可选）</strong></td><td>如果需要，就传入新的标志值（常用“旧标志 | 新功能”）</td></tr></tbody></table><h4 id="1-第二个参数（cmd）——-要执行的操作类型"><a href="#1-第二个参数（cmd）——-要执行的操作类型" class="headerlink" title="1. 第二个参数（cmd）—— 要执行的操作类型"></a>1. 第二个参数（cmd）—— 要执行的操作类型</h4><table><thead><tr><th>命令（cmd）</th><th>含义</th><th>第三个参数（arg）</th><th>常用场景</th></tr></thead><tbody><tr><td><strong>F_GETFL</strong></td><td>获取文件状态标志</td><td>无</td><td>读取当前 fd 的打开模式（只读、非阻塞等）</td></tr><tr><td><strong>F_SETFL</strong></td><td>设置文件状态标志</td><td>新标志（通常是“旧标志 | 新标志”）</td><td>修改 fd 行为，如设为非阻塞</td></tr><tr><td><strong>F_GETFD</strong></td><td>获取文件描述符标志</td><td>无</td><td>判断 fd 是否带有 FD_CLOEXEC</td></tr><tr><td><strong>F_SETFD</strong></td><td>设置文件描述符标志</td><td><code>FD_CLOEXEC</code> 等</td><td>设置执行 exec() 时是否自动关闭 fd</td></tr><tr><td><strong>F_DUPFD</strong></td><td>复制一个新的文件描述符</td><td>最小可用 fd 编号</td><td>类似 dup()，但可指定起始编号</td></tr><tr><td><strong>F_SETLK</strong></td><td>设置文件锁（非阻塞）</td><td><code>struct flock *</code></td><td>文件加锁，不会阻塞</td></tr><tr><td><strong>F_SETLKW</strong></td><td>设置文件锁（阻塞）</td><td><code>struct flock *</code></td><td>文件加锁，会阻塞等待</td></tr><tr><td><strong>F_GETLK</strong></td><td>获取文件锁状态</td><td><code>struct flock *</code></td><td>查询当前文件锁</td></tr></tbody></table><p>实际开发中 <strong>最常用的就是 <code>F_GETFL</code> 和 <code>F_SETFL</code></strong>，尤其用于：设置非阻塞 IO（<code>O_NONBLOCK</code>）、设置追加写（<code>O_APPEND</code>）。</p><h4 id="2-第三个参数（arg）——-状态标志"><a href="#2-第三个参数（arg）——-状态标志" class="headerlink" title="2. 第三个参数（arg）—— 状态标志"></a>2. 第三个参数（arg）—— 状态标志</h4><table><thead><tr><th>标志</th><th>含义</th><th>常见场景</th></tr></thead><tbody><tr><td><strong>O_RDONLY</strong></td><td>只读打开</td><td>打开文件用</td></tr><tr><td><strong>O_WRONLY</strong></td><td>只写打开</td><td>打开文件用</td></tr><tr><td><strong>O_RDWR</strong></td><td>可读可写</td><td>打开文件用</td></tr><tr><td><strong>O_APPEND</strong></td><td>写操作追加到文件末尾</td><td>日志文件</td></tr><tr><td><strong>O_NONBLOCK</strong></td><td>非阻塞模式</td><td>网络 I&#x2F;O</td></tr><tr><td><strong>O_SYNC</strong></td><td>同步写入（每次写都落盘）</td><td>文件系统安全要求高的场景</td></tr><tr><td><strong>O_ASYNC</strong></td><td>异步 I&#x2F;O 模式</td><td>很少单独使用</td></tr><tr><td><strong>O_CREAT</strong></td><td>不存在则创建</td><td>文件打开</td></tr><tr><td><strong>O_TRUNC</strong></td><td>打开时清空文件内容</td><td>文件重写</td></tr><tr><td><strong>FD_CLOEXEC</strong></td><td>执行 exec() 时自动关闭 fd</td><td>防止文件描述符泄漏</td></tr></tbody></table><h4 id="3-快速记忆法"><a href="#3-快速记忆法" class="headerlink" title="3. 快速记忆法"></a>3. 快速记忆法</h4><table><thead><tr><th>操作类型</th><th>缩写记忆</th><th>用途</th></tr></thead><tbody><tr><td><code>F_GETFL</code> &#x2F; <code>F_SETFL</code></td><td>FL &#x3D; File status Flags</td><td>控制读写行为</td></tr><tr><td><code>F_GETFD</code> &#x2F; <code>F_SETFD</code></td><td>FD &#x3D; File Descriptor</td><td>控制描述符自身属性</td></tr><tr><td><code>O_NONBLOCK</code></td><td>Non-blocking</td><td>设置非阻塞</td></tr><tr><td><code>FD_CLOEXEC</code></td><td>Close on exec</td><td>执行新程序时关闭 fd</td></tr></tbody></table><h3 id="4-返回值"><a href="#4-返回值" class="headerlink" title="4. 返回值"></a>4. 返回值</h3><ul><li><strong>成功：</strong> 返回值依赖于 <code>cmd</code>，一般为 <strong>非负数</strong>。</li><li><strong>失败：</strong> 返回 <strong>-1</strong>，并设置 <code>errno</code>。</li></ul><h3 id="5-示例：设置非阻塞套接字"><a href="#5-示例：设置非阻塞套接字" class="headerlink" title="5. 示例：设置非阻塞套接字"></a>5. 示例：设置非阻塞套接字</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setNoBlock</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fl = <span class="built_in">fcntl</span>(fd, F_GETFL);                <span class="comment">// 获取原来文件描述符的属性</span></span><br><span class="line">    <span class="keyword">if</span>(fl &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fcntl</span>(fd, F_GETFL, fl | O_NONBLOCK);        <span class="comment">// 在原标志基础上加上非阻塞</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;设置 &quot;</span> &lt;&lt; fd &lt;&lt; <span class="string">&quot; 为非阻塞模式成功！&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setNoBlock</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;please enter: &quot;);</span></span><br><span class="line">        <span class="comment">// fflush(stdout);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ssize_t</span> n = <span class="built_in">read</span>(<span class="number">0</span>, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            buffer[n - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;echo: &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(n == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;read EOF/read done!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;read error, n = &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot;error code: &quot;</span> &lt;&lt; errno &lt;&lt; <span class="string">&quot;error string: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>设置成为非阻塞，如果底层 fd 数据没有就绪，recv&#x2F;read&#x2F;write&#x2F;send, 返回值会以出错的形式返回，错误形式的两种情况：a. 真的出错，b. 底层没有就绪。怎么区分呢？需要通过 errno 区分！！！</strong></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);  <span class="comment">// 创建 TCP 套接字</span></span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前文件状态标志</span></span><br><span class="line">    <span class="type">int</span> flags = <span class="built_in">fcntl</span>(sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fcntl F_GETFL error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置非阻塞模式（加上 O_NONBLOCK）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(sockfd, F_SETFL, flags | O_NONBLOCK) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fcntl F_SETFL error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;套接字已设置为非阻塞模式&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-IO-多路转接之-select-函数原型"><a href="#4-IO-多路转接之-select-函数原型" class="headerlink" title="4. IO 多路转接之 select 函数原型"></a>4. IO 多路转接之 select 函数原型</h2><blockquote><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenlong_cxy/article/details/126189616">IO 多路转接 ——— select、poll、epoll | CSDN</a></p></blockquote><h3 id="1-作用"><a href="#1-作用" class="headerlink" title="1. 作用"></a>1. 作用</h3><p><code>select</code> 是最早的 I&#x2F;O 多路复用函数，用来 <strong>同时监控多个文件描述符（fd）是否可读、可写或有异常事件</strong>。</p><h3 id="2-函数原型-1"><a href="#2-函数原型-1" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">select</span><span class="params">(<span class="type">int</span> nfds,</span></span></span><br><span class="line"><span class="params"><span class="function">           fd_set *readfds,</span></span></span><br><span class="line"><span class="params"><span class="function">           fd_set *writefds,</span></span></span><br><span class="line"><span class="params"><span class="function">           fd_set *exceptfds,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="keyword">struct</span> timeval *timeout)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="3-参数解释"><a href="#3-参数解释" class="headerlink" title="3. 参数解释"></a>3. 参数解释</h3><table><thead><tr><th>参数名</th><th>含义</th></tr></thead><tbody><tr><td><code>nfds</code></td><td><strong>监控的最大文件描述符 + 1</strong>（例如要监控 <code>fd=5</code>，就写 <code>nfds=6</code>）</td></tr><tr><td><code>readfds</code></td><td>想监控“<strong>可读事件</strong>”的文件描述符集合（如 <code>recv()</code>、<code>read()</code> 是否不阻塞）</td></tr><tr><td><code>writefds</code></td><td>想监控“<strong>可写事件</strong>”的文件描述符集合（如 <code>send()</code>、<code>write()</code> 是否不阻塞）</td></tr><tr><td><code>exceptfds</code></td><td>监控“<strong>异常事件</strong>”的文件描述符集合（一般不用，传 <code>NULL</code>）</td></tr><tr><td><code>timeout</code></td><td>超时时间（阻塞多久）。传 <code>NULL</code> 就是 <strong>一直阻塞</strong>。</td></tr></tbody></table><h4 id="1-nfds-参数"><a href="#1-nfds-参数" class="headerlink" title="1. nfds 参数"></a>1. <code>nfds</code> 参数</h4><p><code>nfds</code> &#x3D; <strong>要监控的最高文件描述符编号 + 1</strong>。</p><ul><li>想监控 fd 3, fd 5？最高是 5，<code>nfds</code> 就写 <code>5 + 1 = 6</code>。</li><li>想监控 fd 1, fd 2, fd 100？最高是 100，<code>nfds</code> 就是 <code>100 + 1 = 101</code>。</li><li><strong>不是系统最大支持的文件描述符大小！</strong> 那个值通常很大（如 1024 或 65536），不需要监控那么多。</li></ul><p><strong>记住：<code>nfds</code> 是一个范围</strong>：<code>select</code> 会检查从 0 到 <code>nfds - 1</code> 这个范围内的所有 fd（只要在 <code>fd_set</code> 里设置了它们）。<code>nfds</code> 就是这个范围的 <strong>上限</strong>（不包含）。<strong>简化记忆</strong>：<code>nfds = max_fd + 1</code>。<code>select</code> 会在这个范围 <code>[0, max_fd]</code> 内，看你 <code>fd_set</code> 里标记了哪些 fd，然后监控它们。</p><h4 id="2-fd-set-的本质"><a href="#2-fd-set-的本质" class="headerlink" title="2. fd_set 的本质"></a>2. <code>fd_set</code> 的本质</h4><p><strong><code>fd_set</code> 是内核与用户空间之间传递“文件描述符就绪信息”的一张位图。</strong></p><table><thead><tr><th>阶段</th><th>谁在操作</th><th>含义</th></tr></thead><tbody><tr><td><strong>输入阶段（用户 → 内核）</strong></td><td>用户调用 <code>select()</code> 前</td><td>告诉内核：“我关心这些 fd（读、写、异常）。”</td></tr><tr><td><strong>输出阶段（内核 → 用户）</strong></td><td>内核执行完 I&#x2F;O 检查后</td><td>告诉用户：“这些 fd 已经就绪（比特位 &#x3D; 1）。”</td></tr></tbody></table><p><strong>也就是说：<code>readfds</code> 是输入输出双向参数（既是输入，也会被输出修改），每一位对应一个 <code>fd</code>，<code>1</code> 表示就绪；<code>0</code> 表示未就绪。调用后必须重新设置 <code>fd_set</code>，因为 <code>select</code> 会修改它。<code>fd_set</code> 的内部形式：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> fds_bits[__FD_SETSIZE / (<span class="number">8</span> * <span class="built_in">sizeof</span>(<span class="type">long</span>))];</span><br><span class="line">&#125; fd_set;</span><br></pre></td></tr></table></figure><p>本质就是一个 <strong>位图</strong>，每个 bit 对应一个文件描述符号位（fd 号），比如：<code>fd=3</code> -&gt; <code>fds_bits[0]</code> 的第 3 位。<code>select()</code> 的核心：用户传一张“关注表”（<code>fd_set</code>）给内核，内核帮你看这些 fd 是否有事件，等结果出来后，内核再把“结果表”写回给你。</p><h4 id="3-常用辅助宏"><a href="#3-常用辅助宏" class="headerlink" title="3. 常用辅助宏"></a>3. 常用辅助宏</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FD_CLR</span>(<span class="type">int</span> fd, fd_set* set);		<span class="comment">// 把fd从集合中移除（对应 bit = 0）</span></span><br><span class="line"><span class="built_in">FD_ISSET</span>(<span class="type">int</span> fd, fd_set* set);		<span class="comment">// 判断fd是否在集合中就绪（bit==1 返回 true）</span></span><br><span class="line"><span class="built_in">FD_SET</span>(<span class="type">int</span> fd, fd_set* set);		<span class="comment">// 把fd加入集合（设置对应 bit = 1）</span></span><br><span class="line"><span class="built_in">FD_ZERO</span>(fd_set* set);				<span class="comment">// 清空集合（所有 bit 置 0）</span></span><br></pre></td></tr></table></figure><p>一般是这么操作的：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fd_set readfds;          <span class="comment">// 定义一个fd集合</span></span><br><span class="line"><span class="built_in">FD_ZERO</span>(&amp;readfds);       <span class="comment">// 清空集合</span></span><br><span class="line"><span class="built_in">FD_SET</span>(sockfd, &amp;readfds); <span class="comment">// 把sockfd加入关注集合</span></span><br><span class="line"><span class="built_in">FD_SET</span>(STDIN_FILENO, &amp;readfds); <span class="comment">// 把标准输入加入集合</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用select，监听读事件</span></span><br><span class="line"><span class="type">int</span> ret = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(sockfd, &amp;readfds))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// sockfd 可读</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(STDIN_FILENO, &amp;readfds))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 标准输入可读</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用后，<code>readfds</code> 会被内核修改，表示哪些 fd 已经 <strong>就绪</strong>。</p><h4 id="4-struct-timeval-的含义"><a href="#4-struct-timeval-的含义" class="headerlink" title="4. struct timeval 的含义"></a>4. <code>struct timeval</code> 的含义</h4><blockquote><p><code>timeout</code> 就是给 <code>select</code> 设置一个 <strong>最长等待时间</strong> 的 <strong>闹钟</strong>。如果在闹钟响之前有事（fd 就绪），就立即叫醒你（返回）；如果闹钟响了还没事（fd 未就绪），也叫醒你（返回 0）。如果设置为永不响（<code>NULL</code>），就会一直睡（阻塞）；如果设置为立刻响（<code>{0, 0}</code>），就不会睡（非阻塞）。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">timeval</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">time_t</span>      tv_sec;   <span class="comment">// Seconds —— 秒</span></span><br><span class="line">    <span class="type">suseconds_t</span> tv_usec;  <span class="comment">// Microseconds —— 微秒（1秒=1,000,000微秒）</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>{seconds, microseconds}</code>: <code>select</code> 最多等待 <code>seconds</code> 秒 + <code>microseconds</code> 微秒。</p><ul><li>如果在 <strong>这个时间之内</strong>，有你监控的 fd 就绪了，<code>select</code> 会 <strong>立即返回</strong>，告诉你哪些 fd 就绪了，剩余的等待时间会被写回到 <code>timeout</code> 结构体中（通常在实际编程中，会每次都重新设置这个值）。</li><li>如果 <strong>这个时间之内</strong>，没有任何你监控的 fd 就绪，<code>select</code> 会 <strong>超时返回</strong>（返回值为 0）。</li></ul><p><strong>示例：</strong></p><ul><li><code>NULL</code> → 永久阻塞（传统阻塞式 I&#x2F;O）。</li><li><code>{5,0}</code> → 最多阻塞 5 秒（带超时的阻塞）。</li><li><code>{0,0}</code> → 不阻塞，<strong>非阻塞轮询式 I&#x2F;O</strong>。</li></ul><h3 id="4-返回值-1"><a href="#4-返回值-1" class="headerlink" title="4. 返回值"></a>4. 返回值</h3><ul><li><code>&gt; 0</code>：有多少个文件描述符就绪（可读 &#x2F; 可写 &#x2F; 异常）。</li><li><code>= 0</code>：超时，没有任何事件发生，没有错误，但是也没有 fd 就绪。</li><li><code>&lt; 0</code>：出错（一般是信号中断或参数错误）。</li></ul><h3 id="5-使用示例"><a href="#5-使用示例" class="headerlink" title="5. 使用示例"></a>5. 使用示例</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fd_set readfds;                  <span class="comment">// 创建fd集合</span></span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;readfds);               <span class="comment">// 清空集合</span></span><br><span class="line">    <span class="built_in">FD_SET</span>(STDIN_FILENO, &amp;readfds);  <span class="comment">// 把标准输入加入监控集合</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">    tv.tv_sec = <span class="number">5</span>;                   <span class="comment">// 最多阻塞5秒</span></span><br><span class="line">    tv.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;等待输入中...&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">select</span>(STDIN_FILENO + <span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(STDIN_FILENO, &amp;readfds))</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;检测到输入：&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">read</span>(STDIN_FILENO, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;你输入了: &quot;</span> &lt;&lt; buf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;超时，没有输入&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;select 出错&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><strong>一个基于 <code>select</code> 系统调用的单进程、单线程 TCP 服务器：</strong></p><blockquote><p>完整代码请前往 <a target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc/Linux-Ubuntu/tree/main/Coding/Advanced_IO/select">GitHub</a> 进行查看！</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Socket.hpp&quot;</span></span></span><br><span class="line"><span class="comment">// #include &quot;Log.hpp&quot;</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> defaultport = <span class="number">8080</span>;                   <span class="comment">// 默认端口号8080</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> fd_num_max = (<span class="built_in">sizeof</span>(fd_set) * <span class="number">8</span>);         <span class="comment">// 计算fd_set能容纳的最大文件描述符数量，每个bit位代表一个fd</span></span><br><span class="line"><span class="type">int</span> defaultfd = <span class="number">-1</span>;                                         <span class="comment">// 无效文件描述符，用来标识数组中空闲的位置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SelectServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SelectServer</span>(<span class="type">uint16_t</span> port = defaultport)</span><br><span class="line">        : _port(port)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fd_num_max; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            fd_array[i] = defaultfd;                        <span class="comment">// 将数组中所有位置都初始化为-1，表示空闲</span></span><br><span class="line">            <span class="comment">// std::cout &lt;&lt; &quot;fd_array[&quot; &lt;&lt; i &lt;&lt; &quot;]&quot; &lt;&lt; &quot; : &quot; &lt;&lt; fd_array[i] &lt;&lt; std::endl;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">SelectServer</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        _listensock.<span class="built_in">Close</span>();                                <span class="comment">// 关闭监听socket</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器：创建socket、绑定端口、开始监听</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _listensock.<span class="built_in">Socket</span>();                               <span class="comment">// 创建监听socket</span></span><br><span class="line">        _listensock.<span class="built_in">Bind</span>(_port);                            <span class="comment">// 绑定端口</span></span><br><span class="line">        _listensock.<span class="built_in">Listen</span>();                               <span class="comment">// 开始监听</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印当前在线的文件描述符列表</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">PrintFd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;在线_fd_列表： &quot;</span>;                          <span class="comment">// 输出提示信息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fd_num_max; i++)               <span class="comment">// 遍历fd_array数组</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (fd_array[i] == defaultfd)                  <span class="comment">// 如果是空闲位置，跳过</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            cout &lt;&lt; fd_array[i] &lt;&lt; <span class="string">&quot; &quot;</span>;                    <span class="comment">// 输出有效的文件描述符</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Accepter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 连接事件已经就绪</span></span><br><span class="line">        std::string client_ip;                              <span class="comment">// 客户端的IP</span></span><br><span class="line">        <span class="type">uint16_t</span> client_port;                               <span class="comment">// 客户端的端口</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> sock = _listensock.<span class="built_in">Accept</span>(&amp;client_ip, &amp;client_port);    <span class="comment">// 从监听socket获取新的连接，不会阻塞，因为select已经告诉我们有连接事件就绪</span></span><br><span class="line">        <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// 如果accept失败，直接返回</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;新连接建立成功：客户端IP：%s，客户端端口：%d，socket fd：%d&quot;</span>, client_ip.<span class="built_in">c_str</span>(), client_port, sock);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Info, 新连接建立成功：客户端IP：&quot;</span> &lt;&lt; client_ip &lt;&lt; <span class="string">&quot;，客户端端口：&quot;</span> &lt;&lt; client_port &lt;&lt; <span class="string">&quot;，socket fd：&quot;</span> &lt;&lt; sock &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将新连接的文件描述符存入fd_array数组中</span></span><br><span class="line">        <span class="type">int</span> pos = <span class="number">1</span>;                                       <span class="comment">// 从数组索引1开始找空闲位置（索引0存放监听socket）</span></span><br><span class="line">        <span class="keyword">for</span> (; pos &lt; fd_num_max; pos++)                    <span class="comment">// 查找数组中空闲的位置</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (fd_array[pos] != defaultfd)                <span class="comment">// 如果当前位置不为空（-1），继续找下一个</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                                           <span class="comment">// 找到空闲位置，跳出循环</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pos == fd_num_max)                             <span class="comment">// 如果遍历完整个数组都没找到空闲位置</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Warning, <span class="string">&quot;服务器已满，立即关闭%d！&quot;</span>, sock); <span class="comment">// 服务器已满，关闭新连接</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Warning, 服务器已满，立即关闭&quot;</span> &lt;&lt; sock &lt;&lt; <span class="string">&quot;！&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">close</span>(sock);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                                               <span class="comment">// 找到了空闲位置</span></span><br><span class="line">        &#123;</span><br><span class="line">            fd_array[pos] = sock;                          <span class="comment">// 将新连接的fd放入数组</span></span><br><span class="line">            <span class="built_in">PrintFd</span>();                                     <span class="comment">// 打印当前在线的fd列表</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 后续可能还有其他处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理数据接收的函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Recver</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> pos)</span>                            <span class="comment">// fd是需要读取数据的文件描述符，pos是该fd在数组中的位置</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// demo，接收客户端数据</span></span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>];                                  <span class="comment">// 临时缓冲区，用于存储接收的数据</span></span><br><span class="line">        <span class="type">ssize_t</span> n = <span class="built_in">read</span>(fd, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>);   <span class="comment">// 从指定fd读取数据到缓冲区，预留1字节给字符串结束符</span></span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>)                                          <span class="comment">// 读取到数据</span></span><br><span class="line">        &#123;</span><br><span class="line">            buffer[n] = <span class="number">0</span>;                                  <span class="comment">// 手动添加字符串结束符</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;收到一条消息：&quot;</span> &lt;&lt; buffer &lt;&lt; endl;      <span class="comment">// 输出接收到的消息</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)                                    <span class="comment">// 客户端断开连接（读到文件结束符）</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Info, <span class="string">&quot;客户端退出了，关闭连接的文件描述符是%d&quot;</span>, fd);  <span class="comment">// 记录客户端断开日志</span></span><br><span class="line">            <span class="built_in">close</span>(fd);                                      <span class="comment">// 关闭该连接的文件描述符</span></span><br><span class="line">            fd_array[pos] = defaultfd;                      <span class="comment">// 将数组中对应位置重置为-1，表示该位置空闲（这里本质是从select中移除该fd）</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                                                <span class="comment">// 读取错误</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Warning, <span class="string">&quot;接收文件错误，描述符是: %d&quot;</span>, fd);  <span class="comment">// 记录接收错误日志</span></span><br><span class="line">            <span class="built_in">close</span>(fd);                                      <span class="comment">// 关闭该连接的文件描述符</span></span><br><span class="line">            fd_array[pos] = defaultfd;                      <span class="comment">// 将数组中对应位置重置为-1，表示该位置空闲（这里本质是从select中移除该fd）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发函数：根据select返回的结果，处理就绪的文件描述符</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Dispatcher</span><span class="params">(fd_set&amp; rfds)</span>                           <span class="comment">// rfds是select调用后被修改的fd_set，其中包含了就绪的fd</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fd_num_max; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> fd = fd_array[i];                           <span class="comment">// 获取数组中第i个位置的fd</span></span><br><span class="line">            <span class="keyword">if</span> (fd == defaultfd)                            <span class="comment">// 如果是无效fd（-1），跳过</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查这个fd是否在select返回的就绪fd集合中</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(fd, &amp;rfds))                         <span class="comment">// FD_ISSET宏用于检查fd是否在rfds集合中</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(fd == _listensock.<span class="built_in">Fd</span>())                  <span class="comment">// 如果就绪的fd是监听socket</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">Accepter</span>();                             <span class="comment">// 说明有新的连接请求，调用Accepter处理</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>                                        <span class="comment">// 如果就绪的fd不是监听socket，而是普通的数据连接socket</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">Recver</span>(fd, i);                          <span class="comment">// 调用Recver处理数据接收</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器主循环：使用select实现IO多路复用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> listensock = _listensock.<span class="built_in">Fd</span>();                  <span class="comment">// 获取监听socket的文件描述符</span></span><br><span class="line">        fd_array[<span class="number">0</span>] = listensock;                           <span class="comment">// 将监听socket放在数组第0个位置</span></span><br><span class="line">        <span class="comment">// 程序启动时，只有数组第0个位置有值，是监听socket的fd，但是，程序运行过程中，Accepter 会向数组中其他位置添加新的连接fd！</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;)                                            <span class="comment">// 无限循环，服务器持续运行</span></span><br><span class="line">        &#123;</span><br><span class="line">            fd_set readfds;                                 <span class="comment">// 定义一个fd_set变量，用于存储待检测的读就绪文件描述符集合</span></span><br><span class="line">            <span class="built_in">FD_ZERO</span>(&amp;readfds);                              <span class="comment">// 清空readfds集合，将所有位都设置为0</span></span><br><span class="line">            <span class="comment">// 每次进入循环，都要重新构建readfds集合，因为select会修改它。</span></span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> maxfds = fd_array[<span class="number">0</span>];                       <span class="comment">// 记录当前最大的文件描述符值，用于select调用</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; fd_num_max;i++)          <span class="comment">// 第一次循环，遍历fd_array数组，准备select的参数</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (fd_array[i] == defaultfd)               <span class="comment">// 如果数组中该位置是空闲的（-1），跳过</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">// 这个 continue 非常有用！如果不跳过，fd_array[i] 是 -1，FD_SET(-1, &amp;readfds) 会出错或行为未定义。</span></span><br><span class="line">                    <span class="comment">// 并且，如果当前只有监听socket，数组后面的位置都是-1，这个循环会遍历所有位置，</span></span><br><span class="line">                    <span class="comment">// 但由于 continue，只有有效的fd（比如监听socket）会被处理。</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">FD_SET</span>(fd_array[i], &amp;readfds);              <span class="comment">// 将有效的fd添加到readfds集合中，让select监控这些fd的读就绪状态</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(fd_array[i] &gt; maxfds)</span><br><span class="line">                &#123;</span><br><span class="line">                    maxfds = fd_array[i];                   <span class="comment">// 更新最大fd值</span></span><br><span class="line">                    <span class="built_in">log_</span>(Info,<span class="string">&quot;最大文件描述符更新，最大文件描述符为：%d&quot;</span>, maxfds);</span><br><span class="line">                    std::cout &lt;&lt; <span class="string">&quot;最大文件描述符更新，最大文件描述符为：&quot;</span> &lt;&lt; maxfds &lt;&lt; std::endl;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">timeval</span> timeout = &#123;<span class="number">5</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用select系统调用，监控maxfds+1个文件描述符（0到maxfds），readfds是读就绪集合，nullptr表示不监控写和异常</span></span><br><span class="line">            <span class="type">int</span> n = <span class="built_in">select</span>(maxfds + <span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout); <span class="comment">// 最后一个参数为nullptr表示不超时，阻塞等待</span></span><br><span class="line">            <span class="comment">// select 现在监控的是 0 到 maxfds 范围内所有在 readfds 位图中被置位的 fd。</span></span><br><span class="line">            <span class="comment">// 如果只有监听socket，它只监控监听socket。如果有多个连接，它会监控监听socket 和 所有已连接的socket。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据select返回值进行处理</span></span><br><span class="line">            <span class="keyword">switch</span>(n)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="comment">// select超时处理</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;time out, timeout: &quot;</span> &lt;&lt; timeout.tv_sec &lt;&lt; <span class="string">&quot;.&quot;</span> &lt;&lt; timeout.tv_usec &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// select调用出错处理</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;select error, errno:&quot;</span> &lt;&lt; errno &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// select成功处理</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;得到了一个新的连接请求！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="built_in">Dispatcher</span>(readfds); <span class="comment">// 调用Dispatcher处理所有就绪的事件</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Sock _listensock;                <span class="comment">// 监听socket对象</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;                  <span class="comment">// 服务器端口号</span></span><br><span class="line">    <span class="type">int</span> fd_array[fd_num_max];        <span class="comment">// 文件描述符数组，用于维护当前所有有效的连接fd（包括监听fd）</span></span><br><span class="line">    <span class="comment">// int wfd_array[fd_num_max];    // 扩展写事件处理</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>测试连接：<code>telnet 127.0.0.1 8080</code>，尝试输入一些内容……</strong> 初学时，这段代码要理解其实有一定难度，让我们详细梳理一下：</p><ol><li><p><strong>初始状态</strong>：</p><ul><li><code>listensock = 3</code>，监听 socket 的 fd，0、1、2 默认被占用就不解释了。</li><li><code>fd_array[0] = 3</code>。</li><li><code>fd_array[1]</code> 到 <code>fd_array[fd_num_max-1]</code> 都是 <code>-1</code>。</li></ul></li><li><p><strong>第一次 <code>Start</code> 循环</strong>：</p><ul><li><code>fd_set readfds</code> 被清空。</li><li>遍历 <code>fd_array</code>，只有 <code>fd_array[0]</code> (值为 3) 有效，所以 <code>FD_SET(3, &amp;readfds)</code>。<code>maxfds = 3</code>。</li><li><code>select(4, &amp;readfds, ...)</code> 被调用，监控 fd 3。</li><li>假设现在 <strong>客户端 A</strong> 连接服务器。</li><li><code>select</code> 发现 fd 3 (监听 socket) 可读（有新连接），返回值 &gt; 0。</li><li>进入 <code>Dispatcher(readfds)</code>。</li><li><code>Dispatcher</code> 遍历 <code>fd_array</code>。</li><li><code>i=0</code>: <code>fd = fd_array[0] = 3</code>。<code>FD_ISSET(3, &amp;readfds)</code> 为真。<code>fd (3) == _listensock.Fd()</code> 为真。调用 <code>Accepter()</code>。</li></ul></li><li><p><strong><code>Accepter</code> 执行</strong>：</p><ul><li><code>accept</code> 被调用，获取 <strong>客户端 A</strong> 的连接。</li><li>假设此时进程内最小可用 fd 是 4（因为 0,1,2 被占用，3 是监听 socket），所以 <code>accept</code> 返回 <code>sock = 4</code>。</li><li><code>Accepter</code> 开始查找 <code>fd_array</code> 中的空闲位置：<code>pos = 1</code>: <code>fd_array[1] = -1</code> (defaultfd)。找到空闲位置，<code>break</code>。</li><li><code>pos</code> 不等于 <code>fd_num_max</code>，所以执行 <code>else</code> 分支：<ul><li><code>fd_array[1] = 4</code> (将客户端 A 的 fd 存入数组)。</li><li><code>PrintFd()</code>。</li></ul></li></ul></li><li><p><strong>第二次 <code>Start</code> 循环</strong>：</p><ul><li><code>fd_set readfds</code> 被清空。</li><li>遍历 <code>fd_array</code>：<ul><li><code>i=0</code>: <code>fd_array[0] = 3</code> (监听 socket)。有效，<code>FD_SET(3, &amp;readfds)</code>。<code>maxfds</code> 更新为 3。</li><li><code>i=1</code>: <code>fd_array[1] = 4</code> (客户端 A 的 socket)。有效，<code>FD_SET(4, &amp;readfds)</code>。<code>maxfds</code> 更新为 4。</li><li><code>i=2</code> 到 <code>fd_num_max-1</code>: <code>fd_array[i] = -1</code>。跳过。</li></ul></li><li><code>select(5, &amp;readfds, ...)</code> 被调用，<strong>现在监控 fd 3 和 fd 4</strong>！</li><li>假设现在 <strong>客户端 A</strong> 发送了一条消息 “Hello”。</li><li><code>select</code> 发现 <strong>fd 4</strong> (客户端 A 的 socket) 可读（有数据到达），返回值 &gt; 0。</li><li>进入 <code>Dispatcher(readfds)</code>。</li><li><code>Dispatcher</code> 遍历 <code>fd_array</code>：<ul><li><code>i=0</code>: <code>fd = fd_array[0] = 3</code>。检查 <code>FD_ISSET(3, &amp;readfds)</code>。因为这次是 fd 4 就绪，fd 3 没就绪，所以 <code>FD_ISSET(3, &amp;readfds)</code> 为假。<strong>跳过</strong>。</li><li><code>i=1</code>: <code>fd = fd_array[1] = 4</code>。检查 <code>FD_ISSET(4, &amp;readfds)</code>。因为这次是 fd 4 就绪，所以 <code>FD_ISSET(4, &amp;readfds)</code> 为真。<code>fd (4) != _listensock.Fd()</code> 为真。<strong>进入 <code>else</code> 分支</strong>。</li><li>调用 <code>Recver(4, 1)</code>。<strong><code>Recver</code> 被成功调用了！</strong></li></ul></li></ul></li><li><p><strong><code>Recver</code> 执行</strong>：</p><ul><li><code>Recver</code> 从 fd 4 (客户端 A 的 socket) 读取数据 “Hello”，并处理它（例如打印）。</li></ul></li></ol><p><strong>关键点：</strong></p><ul><li><code>accept</code> 返回的 <strong>不是</strong> 监听 socket 的 fd。它返回的是一个 <strong>全新的、代表新客户端连接的 socket 的 fd</strong>。这个新 fd 会被存储到 <code>fd_array</code> 中。</li><li><code>Start</code> 循环中的 <code>for</code> 循环会 <strong>持续更新</strong> <code>select</code> 监控的 fd 集合 (<code>readfds</code>)。每次循环，它都会将 <code>fd_array</code> 中所有非 <code>-1</code> 的 fd（包括监听 socket 和所有已连接的客户端 socket）都添加到监控集合中。</li><li><code>Dispatcher</code> 循环会 <strong>持续检查</strong> <code>fd_array</code> 中所有非 <code>-1</code> 的 fd，看它们是否在 <code>select</code> 返回的就绪集合 (<code>readfds</code>) 中。</li><li>如果就绪的 fd 是 <strong>监听 socket 的 fd</strong>，说明有新连接，走 <code>Accepter</code>。</li><li>如果就绪的 fd 是 <strong><code>fd_array</code> 中某个已存储的客户端 socket 的 fd</strong>（即 <code>fd != _listensock.Fd()</code>），说明这个特定客户端发送了数据，走 <code>Recver</code>。</li></ul><p><strong><code>Accepter</code> 中查找空闲位置的意义：</strong></p><ul><li><strong><code>fd_array</code></strong> 是服务器用来 <strong>追踪和管理</strong> 所有当前连接（包括监听 socket）的 <strong>本地数据结构</strong>。</li><li><code>accept</code> 返回的 fd 必须被 <strong>记录</strong> 下来，否则服务器就无法知道有哪些客户端连接，也无法监控它们。</li><li>查找空闲位置并存入 <code>fd_array</code>，是为了让 <code>Start</code> 和 <code>Dispatcher</code> 能够 <strong>知道</strong> 这个新连接的存在，并将其加入到 <code>select</code> 的监控范围和事件分发范围中。</li><li><code>if (pos == fd_num_max)</code> 检查是为了防止 <code>fd_array</code> 被填满，实现连接数限制。</li></ul><p><strong>注意：</strong> <code>Recver</code> <strong>非常重要且会被使用</strong>。每当任何一个已连接的客户端发送数据时，<code>select</code> 就会检测到该客户端对应的 fd 就绪，<code>Dispatcher</code> 就会找到该 fd 在 <code>fd_array</code> 中的位置，并调用 <code>Recver</code> 来处理该客户端的数据。<code>fd_array</code> 和 <code>Accepter</code> 的查找逻辑是实现多客户端管理的关键。</p><h3 id="6-快速上手-select-的编写步骤（重要）"><a href="#6-快速上手-select-的编写步骤（重要）" class="headerlink" title="6. 快速上手 select 的编写步骤（重要）"></a>6. 快速上手 <code>select</code> 的编写步骤（重要）</h3><p>想象你是一个 <strong>服务员</strong>，要同时服务多个客户（文件描述符）。</p><ol><li><strong>准备工具</strong>：创建一个 <code>fd_set</code>（想象成一个 <strong>点名册</strong>），清空它 (<code>FD_ZERO</code>)。</li><li><strong>记录客户</strong>：把你需要服务的客户（文件描述符）一个个记到点名册上 (<code>FD_SET</code>)。比如客户 A (fd &#x3D; 3)，客户 B (fd &#x3D; 5)。</li><li><strong>确定范围</strong>：看看你记下的客户里，编号最大的是谁？比如是客户 B (fd &#x3D; 5)。<strong><code>nfds</code> 就是这个最大编号 + 1</strong>，也就是 6。告诉老板（操作系统）：”我要服务编号 0 到 5 的客户”。</li><li><strong>开始观察</strong>：调用 <code>select(6, &amp;点名册, NULL, NULL, NULL)</code>。你开始观察点名册上记录的客户，等待他们有需要（比如按铃表示可读）。</li><li><strong>响应需求</strong>：<code>select</code> 告诉你哪些客户按铃了。你再次查看点名册（<code>FD_ISSET</code>），看具体是哪个客户按的。然后去服务这个客户（比如读取数据）。</li><li><strong>循环往复</strong>：回到第 1 步，继续准备、记录、观察、响应。</li></ol><p><strong>编写步骤：</strong></p><ol><li><strong>初始化</strong>：创建监听 socket，绑定，监听。</li><li><strong>准备容器</strong>：用一个数组（如 <code>fd_array</code>）或链表存储所有要监控的 fd。</li><li><strong>主循环 (<code>Start</code>)</strong>：<ul><li>清空 <code>fd_set</code>。</li><li>遍历你的容器（<code>fd_array</code>），将所有有效 fd (<code>fd != -1</code>) 添加到 <code>fd_set</code> (<code>FD_SET</code>)。</li><li>同时记录这些 fd 中的 <strong>最大值</strong> (<code>maxfd</code>)。</li><li>调用 <code>select(maxfd + 1, &amp;fd_set, ...)</code>.</li></ul></li><li><strong>事件分发 (<code>Dispatcher</code>)</strong>：<ul><li>再次遍历你的容器（<code>fd_array</code>）。</li><li>对于每个有效 fd，用 <code>FD_ISSET(fd, &amp;fd_set)</code> 检查它是否在 <code>select</code> 返回的就绪集合中。</li><li>如果是监听 fd 就绪，调用 <code>Accepter</code>。</li><li>如果是普通连接 fd 就绪，调用 <code>Recver</code> 或相应的处理函数。</li></ul></li><li><strong>处理连接 (<code>Accepter</code>)</strong>：<code>accept</code> 得到新 fd，将其添加到你的容器（<code>fd_array</code>）中。</li><li><strong>处理数据 (<code>Recver</code>)</strong>：读取数据，处理。如果连接断开，从你的容器（<code>fd_array</code>）中移除该 fd（设置为 <code>-1</code>）。</li></ol><p><strong>核心思想</strong>：用一个 <strong>容器</strong>（数组&#x2F;链表）管理所有 fd，用 <code>select</code> <strong>监控</strong> 这个容器里的所有 fd，用 <code>select</code> 的返回结果 <strong>分发</strong> 事件给相应的处理函数。</p><h3 id="7-select-优缺点总结"><a href="#7-select-优缺点总结" class="headerlink" title="7. select 优缺点总结"></a>7. select 优缺点总结</h3><p><strong>优点：</strong></p><ol><li>可同时等待多个文件描述符，提高 IO 利用率。</li><li>“等待”与“操作”分离，IO 操作本身不会被阻塞。</li><li>实现简单，兼容性好，几乎所有平台都支持。</li></ol><p><strong>缺点：</strong></p><ol><li><strong>fd 数量有限</strong>（通常上限 1024）。</li><li><strong>每次调用都要重置 fd 集合</strong>，使用繁琐。</li><li><strong>用户态到内核态频繁拷贝</strong>，开销大。</li><li><strong>内核遍历所有 fd</strong> 检查状态，效率低。</li><li><strong>用户态也需维护 fd 集合</strong>，多次遍历，复杂度高。</li></ol><p>select 能多路等待，但机制老、开销大、扩展性差，设计比较久远，具有局限性，对初学者也并不友好，于是就有了 <strong>Poll 的多路转接方案</strong>，<code>poll</code> 是对 <code>select</code> 的改进版，解决了它的一些局限。</p><h2 id="5-poll-的函数原型"><a href="#5-poll-的函数原型" class="headerlink" title="5. poll 的函数原型"></a>5. poll 的函数原型</h2><h3 id="1-作用-1"><a href="#1-作用-1" class="headerlink" title="1. 作用"></a>1. 作用</h3><blockquote><p><code>poll</code> &#x3D; “用数组替代位图的 select”，功能一样但更方便、无 fd 上限。</p></blockquote><p><code>poll</code> 是比 <code>select</code> 新的 I&#x2F;O 多路复用函数，用来 <strong>同时监控多个文件描述符的可读、可写或异常事件</strong>。功能和 <code>select</code> 一样，但使用方式更简单、限制更少。</p><h3 id="2-函数原型-2"><a href="#2-函数原型-2" class="headerlink" title="2. 函数原型"></a>2. 函数原型</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="3-参数解释-1"><a href="#3-参数解释-1" class="headerlink" title="3. 参数解释"></a>3. 参数解释</h3><table><thead><tr><th>参数名</th><th>含义</th><th>与 <code>select</code> 对比</th></tr></thead><tbody><tr><td><code>fds</code></td><td>一个 <code>pollfd</code> 结构体数组，每个元素描述一个要监控的 fd</td><td>类似于 <code>readfds</code> &#x2F; <code>writefds</code> &#x2F; <code>exceptfds</code> 三个集合的合并版</td></tr><tr><td><code>nfds</code></td><td>数组中有多少个元素，即可以传入多少个文件描述符</td><td>等价于 <code>select</code> 的 <code>nfds</code>（监控的 fd 数量）</td></tr><tr><td><code>timeout</code></td><td>超时&#x2F;最长等待时间（毫秒）</td><td>功能同 <code>select</code> 的 <code>timeout</code>，只是单位不同（毫秒）</td></tr></tbody></table><h4 id="1-struct-pollfd-结构体"><a href="#1-struct-pollfd-结构体" class="headerlink" title="1. struct pollfd 结构体"></a>1. <code>struct pollfd</code> 结构体</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">pollfd</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>   fd;        <span class="comment">// 要监控的文件描述符</span></span><br><span class="line">    <span class="type">short</span> events;    <span class="comment">// 想监控哪些事件（输入参数）</span></span><br><span class="line">    <span class="type">short</span> revents;   <span class="comment">// 实际发生的事件（输出参数，由内核填充）</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="2-事件标志（events-和-revents-的取值）"><a href="#2-事件标志（events-和-revents-的取值）" class="headerlink" title="2. 事件标志（events 和 revents 的取值）"></a>2. 事件标志（<code>events</code> 和 <code>revents</code> 的取值）</h4><table><thead><tr><th>事件</th><th>描述</th><th>是否可作为输入</th><th>是否可作为输出</th></tr></thead><tbody><tr><td><strong><code>POLLIN</code></strong></td><td><strong>数据（包括普通数据和优先数据）可读</strong></td><td><strong>是</strong></td><td><strong>是</strong></td></tr><tr><td>POLLRDNORM</td><td>普通数据可读</td><td>是</td><td>是</td></tr><tr><td>POLLRDBAND</td><td>优先级带数据可读（Linux 不支持）</td><td>是</td><td>是</td></tr><tr><td>POLLPRI</td><td>高优先级数据可读，比如 TCP 带外数据</td><td>是</td><td>是</td></tr><tr><td><strong><code>POLLOUT</code></strong></td><td><strong>数据（包括普通数据和优先数据）可写</strong></td><td><strong>是</strong></td><td><strong>是</strong></td></tr><tr><td>POLLWRNORM</td><td>普通数据可写</td><td>是</td><td>是</td></tr><tr><td>POLLWRBAND</td><td>优先级带数据可写</td><td>是</td><td>是</td></tr><tr><td>POLLRDHUP</td><td>TCP 连接被对方关闭，或者对方关闭了写操作，它由 GNU 引入</td><td>是</td><td>是</td></tr><tr><td><strong><code>POLLERR</code></strong></td><td><strong>错误</strong></td><td><strong>否</strong></td><td><strong>是</strong></td></tr><tr><td>POLLHUP</td><td>挂起。比如管道的写端被关闭后，读端描述符上将收到 POLLHUP 事件</td><td>否</td><td>是</td></tr><tr><td><strong><code>POLLNVAL</code></strong></td><td><strong>文件描述符没有打开</strong></td><td><strong>否</strong></td><td><strong>是</strong></td></tr></tbody></table><table><thead><tr><th><strong>常用的事件标志</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td><strong><code>POLLIN</code></strong></td><td><strong>可读（读缓冲区有数据）</strong></td></tr><tr><td><strong><code>POLLOUT</code></strong></td><td><strong>可写（写缓冲区可用）</strong></td></tr><tr><td><strong><code>POLLERR</code></strong></td><td><strong>错误（比如连接异常）</strong></td></tr><tr><td><strong><code>POLLHUP</code></strong></td><td><strong>对端关闭连接（挂断）</strong></td></tr><tr><td><strong><code>POLLNVAL</code></strong></td><td><strong>无效的 fd</strong></td></tr></tbody></table><h4 id="3-超时-最长等待时间（timeout）含义"><a href="#3-超时-最长等待时间（timeout）含义" class="headerlink" title="3. 超时&#x2F;最长等待时间（timeout）含义"></a>3. 超时&#x2F;最长等待时间（timeout）含义</h4><table><thead><tr><th align="center">取值</th><th>含义</th></tr></thead><tbody><tr><td align="center"><code>&gt;0</code></td><td>最多等待指定毫秒数（超时返回 0）</td></tr><tr><td align="center"><code>0</code></td><td>立即返回（非阻塞轮询）</td></tr><tr><td align="center"><code>-1</code></td><td>一直阻塞（直到有事件）</td></tr></tbody></table><h3 id="4-返回值-2"><a href="#4-返回值-2" class="headerlink" title="4. 返回值"></a>4. 返回值</h3><ul><li><strong><code>&gt;0</code>：</strong> 有多少个 fd 就绪。</li><li><strong><code>=0</code>：</strong> 超时。</li><li><strong><code>&lt;0</code>：</strong> 出错。</li></ul><h3 id="5-使用示例-1"><a href="#5-使用示例-1" class="headerlink" title="5. 使用示例"></a>5. 使用示例</h3><blockquote><p>完整代码请前往 <a target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc/Linux-Ubuntu/tree/main/Coding/Advanced_IO/poll">GitHub</a> 查看。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Socket.hpp&quot;</span></span></span><br><span class="line"><span class="comment">// #include &quot;Log.hpp&quot;</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint16_t</span> defaultport = <span class="number">8080</span>;           <span class="comment">// 默认端口号8080</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> fd_num_max = <span class="number">64</span>;                   <span class="comment">// poll数组的最大容量，最多同时监听64个文件描述符</span></span><br><span class="line"><span class="type">int</span> defaultfd = <span class="number">-1</span>;                                 <span class="comment">// 无效文件描述符，用来标识数组中空闲的位置</span></span><br><span class="line"><span class="type">int</span> no_event = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PollServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">PollServer</span>(<span class="type">uint16_t</span> port = defaultport)</span><br><span class="line">        : _port(port)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fd_num_max; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            _event_fds[i].fd = defaultfd;           <span class="comment">// 初始化每个位置的fd为-1（表示未使用）</span></span><br><span class="line">            _event_fds[i].events = no_event;        <span class="comment">// 初始化每个位置的监听事件为0（不监听任何事件）</span></span><br><span class="line">            _event_fds[i].revents = no_event;       <span class="comment">// 初始化每个位置的返回事件为0（无事件发生）</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// std::cout &lt;&lt; &quot;fd_array[&quot; &lt;&lt; i &lt;&lt; &quot;]&quot; &lt;&lt; &quot; : &quot; &lt;&lt; fd_array[i] &lt;&lt; std::endl;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">PollServer</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        _listensock.<span class="built_in">Close</span>();                        <span class="comment">// 关闭监听socket</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器：创建socket、绑定端口、开始监听</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _listensock.<span class="built_in">Socket</span>();                       <span class="comment">// 创建监听socket</span></span><br><span class="line">        _listensock.<span class="built_in">Bind</span>(_port);                    <span class="comment">// 绑定端口</span></span><br><span class="line">        _listensock.<span class="built_in">Listen</span>();                       <span class="comment">// 开始监听</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印当前在线的文件描述符列表</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">PrintFd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;在线_fd_列表： &quot;</span>;                  <span class="comment">// 输出提示信息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fd_num_max; i++)       <span class="comment">// 遍历_event_fds数组</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_event_fds[i].fd == defaultfd)     <span class="comment">// 如果是空闲位置（fd为-1），跳过</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cout &lt;&lt; _event_fds[i].fd &lt;&lt; <span class="string">&quot; &quot;</span>;       <span class="comment">// 输出有效的文件描述符</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Accepter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 有新的客户端连接请求到来</span></span><br><span class="line">        std::string client_ip;                     <span class="comment">// 客户端的IP</span></span><br><span class="line">        <span class="type">uint16_t</span> client_port;                      <span class="comment">// 客户端的端口</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> sock = _listensock.<span class="built_in">Accept</span>(&amp;client_ip, &amp;client_port);    <span class="comment">// 接收新的客户端连接</span></span><br><span class="line">        <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;                                <span class="comment">// 如果accept失败，直接返回</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;新连接建立成功：客户端IP：%s，客户端端口：%d，socket fd：%d&quot;</span>, client_ip.<span class="built_in">c_str</span>(), client_port, sock);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Info, 新连接建立成功：客户端IP：&quot;</span> &lt;&lt; client_ip &lt;&lt; <span class="string">&quot;，客户端端口：&quot;</span> &lt;&lt; client_port &lt;&lt; <span class="string">&quot;，socket fd：&quot;</span> &lt;&lt; sock &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将新连接的文件描述符添加到poll数组中</span></span><br><span class="line">        <span class="type">int</span> pos = <span class="number">1</span>;                               <span class="comment">// 从数组索引1开始找空闲位置（索引0存放监听socket）</span></span><br><span class="line">        <span class="keyword">for</span> (; pos &lt; fd_num_max; pos++)            <span class="comment">// 查找数组中空闲的位置</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_event_fds[pos].fd != defaultfd)   <span class="comment">// 如果当前位置已被占用（fd不为-1），继续找下一个</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                                   <span class="comment">// 找到空闲位置，跳出循环</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pos == fd_num_max)                     <span class="comment">// 如果遍历完整个数组都没找到空闲位置</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Warning, <span class="string">&quot;服务器已满，立即关闭%d！&quot;</span>, sock);        <span class="comment">// 服务器连接数已达上限，关闭新连接</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Warning, 服务器已满，立即关闭&quot;</span> &lt;&lt; sock &lt;&lt; <span class="string">&quot;！&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">close</span>(sock);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// 找到了空闲位置</span></span><br><span class="line">        &#123;</span><br><span class="line">            _event_fds[pos].fd = sock;             <span class="comment">// 将新连接的fd放入数组</span></span><br><span class="line">            _event_fds[pos].events = POLLIN;       <span class="comment">// 设置该fd的监听事件为POLLIN（监听数据可读）</span></span><br><span class="line">            _event_fds[pos].revents = no_event;    <span class="comment">// 清空返回事件</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">PrintFd</span>();                             <span class="comment">// 打印当前在线的fd列表</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 后续可能还有其他处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理数据接收的函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Recver</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> pos)</span>                   <span class="comment">// fd是需要读取数据的文件描述符，pos是该fd在数组中的位置</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 接收客户端发送的数据</span></span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>];                         <span class="comment">// 临时缓冲区，用于存储接收的数据</span></span><br><span class="line">        <span class="type">ssize_t</span> n = <span class="built_in">read</span>(fd, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>);       <span class="comment">// 从指定fd读取数据到缓冲区，预留1字节给字符串结束符</span></span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>)                                 <span class="comment">// 读取到数据</span></span><br><span class="line">        &#123;</span><br><span class="line">            buffer[n] = <span class="string">&#x27;\0&#x27;</span>;                      <span class="comment">// 手动添加字符串结束符</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;收到一条消息：&quot;</span> &lt;&lt; buffer &lt;&lt; endl;          <span class="comment">// 输出接收到的消息</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)                           <span class="comment">// 客户端断开连接（读到文件结束符）</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Info, <span class="string">&quot;客户端退出了，关闭连接的文件描述符是%d&quot;</span>, fd);   <span class="comment">// 记录客户端断开日志</span></span><br><span class="line">            <span class="built_in">close</span>(fd);                             <span class="comment">// 关闭该连接的文件描述符</span></span><br><span class="line">            _event_fds[pos].fd = defaultfd;        <span class="comment">// 将数组中对应位置重置为-1，表示该位置空闲（从poll监听列表中移除该fd）</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                                       <span class="comment">// 读取错误</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Warning, <span class="string">&quot;接收文件错误，描述符是: %d&quot;</span>, fd);      <span class="comment">// 记录接收错误日志</span></span><br><span class="line">            <span class="built_in">close</span>(fd);                             <span class="comment">// 关闭该连接的文件描述符</span></span><br><span class="line">            _event_fds[pos].fd = defaultfd;        <span class="comment">// 将数组中对应位置重置为-1，表示该位置空闲（从poll监听列表中移除该fd）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发函数：处理所有就绪的事件</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Dispatcher</span><span class="params">()</span>                              <span class="comment">// 遍历poll数组，检查哪些fd的事件已经就绪</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fd_num_max; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> fd = _event_fds[i].fd;             <span class="comment">// 获取数组中第i个位置的fd</span></span><br><span class="line">            <span class="keyword">if</span> (fd == defaultfd)                   <span class="comment">// 如果是无效fd（-1），跳过</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_event_fds[i].revents &amp; POLLIN)    <span class="comment">// 如果这个fd的POLLIN事件已经就绪（有数据可读）</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (fd == _listensock.<span class="built_in">Fd</span>())        <span class="comment">// 如果就绪的fd是监听socket</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">Accepter</span>();                    <span class="comment">// 说明有新的连接请求，调用Accepter处理</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>                               <span class="comment">// 如果就绪的fd不是监听socket，而是普通的数据连接socket</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">Recver</span>(fd, i);                 <span class="comment">// 调用Recver处理数据接收</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器主循环：使用poll实现IO多路复用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _event_fds[<span class="number">0</span>].fd = _listensock.<span class="built_in">Fd</span>();       <span class="comment">// 把监听socket的fd放到数组的第一个位置</span></span><br><span class="line">        _event_fds[<span class="number">0</span>].events = POLLIN;             <span class="comment">// 监听socket只关心POLLIN事件（新连接请求）</span></span><br><span class="line">        <span class="type">int</span> timeout = <span class="number">3000</span>;                        <span class="comment">// 设置poll超时时间为3000毫秒（3秒），如果3秒内没有事件发生，poll会返回0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;)                                   <span class="comment">// 服务器无限循环，持续监听和处理事件</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> n = <span class="built_in">poll</span>(_event_fds, fd_num_max, timeout);   <span class="comment">// 调用poll等待事件发生</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据poll返回值进行处理</span></span><br><span class="line">            <span class="keyword">switch</span> (n)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="comment">// poll超时处理（timeout时间内没有事件发生）</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;time out, timeout: &quot;</span> &lt;&lt; timeout &lt;&lt; endl;   <span class="comment">// poll超时，没有事件发生</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// poll调用出错处理</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;select error, errno:&quot;</span> &lt;&lt; errno &lt;&lt; endl;    <span class="comment">// poll调用出错</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// poll成功处理（有事件发生）</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;得到了一个新的连接请求！&quot;</span> &lt;&lt; endl;           <span class="comment">// poll成功，有事件发生（注意：这里注释可能不准确，有事件发生不一定都是连接请求）</span></span><br><span class="line">                <span class="built_in">Dispatcher</span>();                      <span class="comment">// 调用Dispatcher处理所有就绪的事件</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Sock _listensock;                             <span class="comment">// 监听socket对象</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;                               <span class="comment">// 服务器端口号</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">pollfd</span> _event_fds[fd_num_max];         <span class="comment">// poll需要的数组，存储要监听的fd和事件（结构体数组，数组每一个位置都是结构体）</span></span><br><span class="line">    <span class="comment">// struct pollfd *_event_fds;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// int fd_array[fd_num_max];</span></span><br><span class="line">    <span class="comment">// int wfd_array[fd_num_max];                 // 扩展写事件处理</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-poll-小结"><a href="#6-poll-小结" class="headerlink" title="6. poll 小结"></a>6. <code>poll</code> 小结</h3><h4 id="1-poll-的优点"><a href="#1-poll-的优点" class="headerlink" title="1. poll 的优点"></a>1. <code>poll</code> 的优点</h4><ol><li><strong>输入输出参数分离：</strong> <code>struct pollfd</code> 里有 <code>events</code>（输入）和 <code>revents</code>（输出），不像 <code>select</code> 那样每次都要重新设置集合。</li><li><strong>监控数量不限：</strong> 不再受 <code>fd_set</code> 的 1024 比特位限制，想监控多少个 fd，就传多少个 <code>pollfd</code> 元素，具体监控多少个由第二个参数 <code>nfds</code> 决定。</li><li><strong>同时等待多个 fd，提高效率：</strong>“等”的时间可以重叠，IO 效率比阻塞式 IO 高得多。</li></ol><h4 id="2-poll-的缺点"><a href="#2-poll-的缺点" class="headerlink" title="2. poll 的缺点"></a>2. <code>poll</code> 的缺点</h4><ol><li><strong>返回后仍需遍历：</strong> 需要遍历整个 <code>fds</code> 数组，找出哪些 fd 已经就绪。</li><li><strong>用户态与内核态拷贝开销大：</strong> 每次调用都要把整个 <code>pollfd</code> 数组复制进内核，fd 多时性能会明显下降。</li><li><strong>内核仍是线性扫描：</strong> 内核依然要挨个检查每个 fd，就绪检测效率低，当 fd 数量非常大时，性能退化明显。</li></ol><h4 id="3-与-select-的核心区别"><a href="#3-与-select-的核心区别" class="headerlink" title="3. 与 select 的核心区别"></a>3. 与 <code>select</code> 的核心区别</h4><table><thead><tr><th>对比项</th><th><code>select</code></th><th><code>poll</code></th></tr></thead><tbody><tr><td>fd 表达方式</td><td>位图 (<code>fd_set</code>)</td><td>结构体数组 (<code>pollfd[]</code>)</td></tr><tr><td>fd 数量限制</td><td>有（通常 1024）</td><td>理论无限（由系统资源决定）</td></tr><tr><td>参数是否要重置</td><td>每次都要重新设置</td><td>不用重置，只更新有变化的项</td></tr><tr><td>内核检测机制</td><td>遍历所有 fd</td><td>同样遍历，但结构更清晰</td></tr></tbody></table><blockquote><p><strong><code>poll</code> 是 <code>select</code> 的改良版，解决了 fd 数量上限和参数重置的问题，但底层依然是“遍历式检测”，性能瓶颈依旧。</strong></p></blockquote></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/minbit.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/minbit.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/7814.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://www.minbit.top/posts/7814.html")'>056 高级 IO</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/7814.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=056 高级 IO&amp;url=https://www.minbit.top/posts/7814.html&amp;pic=https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=62a2c9b9-baa7-7f9f-8ee4-eedc6c0f4edd" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">58</span></a><a class="post-meta__box__tags" href="/tags/IO/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>IO<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://zycs-img-8kd.pages.dev/v2/Jci6x23.png?_r_=cd6ab6d9-777f-ddf2-7e99-67e102f8beb2" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/48372.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=7f6981c6-26e1-289f-cab6-5f8b347f400a" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">055 其他重要协议和技术</div></div></a></div><div class="next-post pull-right"><a href="/posts/4211.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/IB9fMsM.png?_r_=d6cd9a90-ea90-0b4a-bc6c-ade1d1774e6d" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">057 高级 IO 之 epoll 详解与 CMake 入门</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/15473.html" title="022 基础 IO —— 文件"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/uH1MN2u.png?_r_=2826762c-23a4-ce36-087c-20b34c120159" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-04</div><div class="title">022 基础 IO —— 文件</div></div></a></div><div><a href="/posts/29393.html" title="023 基础 IO —— 重定向"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=53a5775e-540a-ac08-ce82-153a0fba7a94" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-06</div><div class="title">023 基础 IO —— 重定向</div></div></a></div><div><a href="/posts/36108.html" title="024 基础 IO —— 缓冲区"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=6dd452ee-9eaf-6dbb-68cb-6b5d48b4b627" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-11</div><div class="title">024 基础 IO —— 缓冲区</div></div></a></div><div><a href="/posts/4211.html" title="057 高级 IO 之 epoll 详解与 CMake 入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/IB9fMsM.png?_r_=d6cd9a90-ea90-0b4a-bc6c-ade1d1774e6d" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-10-19</div><div class="title">057 高级 IO 之 epoll 详解与 CMake 入门</div></div></a></div><div><a href="/posts/49772.html" title="001 环境搭建"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/Jci6x23.png?_r_=70808a36-eb74-f9af-1c4c-e468c9b22295" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-11</div><div class="title">001 环境搭建</div></div></a></div><div><a href="/posts/55415.html" title="002 创建普通账户（为朋友创建、删除账户）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=173c50aa-b10a-25f6-d750-29aeefb2da59" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-17</div><div class="title">002 创建普通账户（为朋友创建、删除账户）</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/minbit.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><span>👋🏻 Hi，我是 <a target="_blank" href="https://huangcancan-xbc.github.io" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">小米里的大麦</a>，欢迎来看我的博客鸭！</span><br><span>👉 建议优先查看置顶的 <a target="_blank" href="https://huangcancan-xbc.github.io/posts/17934.html" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">网站说明</a>，如有问题欢迎评论区交流！</span><br><span>😫 页面异常？尝试<kbd>Ctrl</kbd>+<kbd>F5</kbd></span><br><span>📩 联系我：<a href="mailto:hc1960074081@qq.com" rel="external nofollow noreferrer"><b>给我发送邮件🚀</b></a></span></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7-IO"><span class="toc-number">1.</span> <span class="toc-text">高级 IO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%AD%A3%E7%A1%AE%E8%AE%A4%E8%AF%86-IO"><span class="toc-number">1.1.</span> <span class="toc-text">1. 正确认识 IO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-IO-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. IO 的本质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-IO-%E7%9A%84%E5%85%B3%E9%94%AE%E7%89%B9%E5%BE%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. IO 的关键特征</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6-IO-%E4%B8%8E-%E7%BD%91%E7%BB%9C-IO"><span class="toc-number">1.1.3.</span> <span class="toc-text">3. 文件 IO 与 网络 IO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%B1%82%E9%9D%A2"><span class="toc-number">1.1.4.</span> <span class="toc-text">4. 系统调用层面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BA%94%E7%A7%8D-IO-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2. 五种 IO 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B0%8F%E6%95%85%E4%BA%8B%E5%85%A5%E9%A2%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 小故事入题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-IO-%E7%AD%89-%E6%8B%B7%E8%B4%9D-%E7%9A%84%E6%80%9D%E7%BB%B4%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 深入理解 IO &#x3D; 等 + 拷贝 的思维模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-fcntl-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">3. fcntl 函数原型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD-%E4%BD%9C%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 功能 &#x2F; 作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 参数详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%88cmd%EF%BC%89%E2%80%94%E2%80%94-%E8%A6%81%E6%89%A7%E8%A1%8C%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">1. 第二个参数（cmd）—— 要执行的操作类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%AC%AC%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%88arg%EF%BC%89%E2%80%94%E2%80%94-%E7%8A%B6%E6%80%81%E6%A0%87%E5%BF%97"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2. 第三个参数（arg）—— 状态标志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BF%AB%E9%80%9F%E8%AE%B0%E5%BF%86%E6%B3%95"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3. 快速记忆法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 返回值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E8%AE%BE%E7%BD%AE%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. 示例：设置非阻塞套接字</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-IO-%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5%E4%B9%8B-select-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">4. IO 多路转接之 select 函数原型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%9C%E7%94%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. 作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. 参数解释</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-nfds-%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">1. nfds 参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-fd-set-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">2. fd_set 的本质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B8%B8%E7%94%A8%E8%BE%85%E5%8A%A9%E5%AE%8F"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">3. 常用辅助宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-struct-timeval-%E7%9A%84%E5%90%AB%E4%B9%89"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">4. struct timeval 的含义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-1"><span class="toc-number">1.4.4.</span> <span class="toc-text">4. 返回值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.5.</span> <span class="toc-text">5. 使用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-select-%E7%9A%84%E7%BC%96%E5%86%99%E6%AD%A5%E9%AA%A4%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">1.4.6.</span> <span class="toc-text">6. 快速上手 select 的编写步骤（重要）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-select-%E4%BC%98%E7%BC%BA%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.7.</span> <span class="toc-text">7. select 优缺点总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-poll-%E7%9A%84%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.5.</span> <span class="toc-text">5. poll 的函数原型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%9C%E7%94%A8-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B-2"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 函数原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A-1"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 参数解释</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-struct-pollfd-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">1. struct pollfd 结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BA%8B%E4%BB%B6%E6%A0%87%E5%BF%97%EF%BC%88events-%E5%92%8C-revents-%E7%9A%84%E5%8F%96%E5%80%BC%EF%BC%89"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">2. 事件标志（events 和 revents 的取值）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%B6%85%E6%97%B6-%E6%9C%80%E9%95%BF%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%EF%BC%88timeout%EF%BC%89%E5%90%AB%E4%B9%89"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">3. 超时&#x2F;最长等待时间（timeout）含义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%80%BC-2"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 返回值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">1.5.5.</span> <span class="toc-text">5. 使用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-poll-%E5%B0%8F%E7%BB%93"><span class="toc-number">1.5.6.</span> <span class="toc-text">6. poll 小结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-poll-%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">1. poll 的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-poll-%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">2. poll 的缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%B8%8E-select-%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8C%BA%E5%88%AB"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">3. 与 select 的核心区别</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/Jci6x23.png?_r_=cd6ab6d9-777f-ddf2-7e99-67e102f8beb2" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="免费白嫖 ChatGPT Go 套餐"></a><div class="content"><a class="title" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐">免费白嫖 ChatGPT Go 套餐</a><time datetime="2025-11-04T16:00:00.000Z" title="发表于 2025-11-05 00:00:00">2025-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/4211.html" title="057 高级 IO 之 epoll 详解与 CMake 入门"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/IB9fMsM.png?_r_=d6cd9a90-ea90-0b4a-bc6c-ade1d1774e6d" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="057 高级 IO 之 epoll 详解与 CMake 入门"></a><div class="content"><a class="title" href="/posts/4211.html" title="057 高级 IO 之 epoll 详解与 CMake 入门">057 高级 IO 之 epoll 详解与 CMake 入门</a><time datetime="2025-10-19T04:00:00.000Z" title="发表于 2025-10-19 12:00:00">2025-10-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7814.html" title="056 高级 IO"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/0k1JltC.jpeg?_r_=62a2c9b9-baa7-7f9f-8ee4-eedc6c0f4edd" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="056 高级 IO"></a><div class="content"><a class="title" href="/posts/7814.html" title="056 高级 IO">056 高级 IO</a><time datetime="2025-10-14T04:00:00.000Z" title="发表于 2025-10-14 12:00:00">2025-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/48372.html" title="055 其他重要协议和技术"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/fETMVUS.jpeg?_r_=7f6981c6-26e1-289f-cab6-5f8b347f400a" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="055 其他重要协议和技术"></a><div class="content"><a class="title" href="/posts/48372.html" title="055 其他重要协议和技术">055 其他重要协议和技术</a><time datetime="2025-10-12T04:00:00.000Z" title="发表于 2025-10-12 12:00:00">2025-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/19289.html" title="03 库的操作"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://zycs-img-8kd.pages.dev/v2/PXXdojm.png?_r_=71de36aa-d238-3363-c614-84db659e2c15" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="03 库的操作"></a><div class="content"><a class="title" href="/posts/19289.html" title="03 库的操作">03 库的操作</a><time datetime="2025-10-10T16:00:00.000Z" title="发表于 2025-10-11 00:00:00">2025-10-11</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/minbit.png" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType(){fetch("https://v1.hitokoto.cn").then(t=>t.json()).then(t=>{{const e="出自 "+t.from,n=["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。","梦想是不会发光的，发光的是追梦的你！","《答案在风中飘扬》（Blowing in The Wind）"];n.unshift(t.hitokoto,e),window.typed=new Typed("#footer-type-tips",{strings:n,startDelay:300,typeSpeed:150,loop:!0,backSpeed:50})}})}"function"==typeof Typed?subtitleType():getScript("https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js").then(subtitleType)</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">82</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:.88rem">AI<sup>1</sup></a><a href="/tags/C/" style="font-size:.88rem">C++<sup>8</sup></a><a href="/tags/ChatGPT/" style="font-size:.88rem">ChatGPT<sup>1</sup></a><a href="/tags/Git/" style="font-size:.88rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:.88rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:.88rem">Linux<sup>58</sup></a><a href="/tags/MySQL/" style="font-size:.88rem">MySQL<sup>4</sup></a><a href="/tags/Obsidian/" style="font-size:.88rem">Obsidian<sup>1</sup></a><a href="/tags/Redis/" style="font-size:.88rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:.88rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:.88rem">VS Code<sup>1</sup></a><a href="/tags/%E4%B8%B4%E6%97%B6%E9%82%AE%E7%AE%B1/" style="font-size:.88rem">临时邮箱<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:.88rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:.88rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:.88rem">历程<sup>1</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:.88rem">地址空间<sup>6</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:.88rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:.88rem">模板<sup>1</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:.88rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:.88rem">线程<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:.88rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:.88rem">进程<sup>15</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("01/01/2025 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["这里是 小米里的大麦","芝兰生于深谷，不以无人而不芳。","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2025 By 安知鱼 V1.6.14"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.minbit.top/",path:location.pathname.replace(/index\.html$/,""),region:"ap-shanghai",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then(o=>{t.textContent=o[0].count}).catch(t=>{console.error(t)})})()};anzhiyu.loadComment(document.getElementById("twikoo-wrap"),t)})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",pageSize:6,includeReply:!0}).then((function(t){const n=t.map(e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t});saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)})</script><script async data-pjax src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="xiaomilidedamai@minbit.top"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//npm.elemecdn.com/penndu@1.0.0/bsz.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>window.addEventListener("load",()=>{const t=()=>{if(!window.location.pathname.startsWith("/comments/"))return;const t=async()=>{const t=new EasyDanmaku({page:"/comments/",el:"#danmu-wrap",line:5,speed:20,hover:!0,loop:!1,colourful:!0,coefficient:1.38,runtime:10});try{let a=saveToLocal.get("twikoo-danmu");if(a)t.batchSend(a,!0);else{const n={method:"POST",body:JSON.stringify({event:"GET_RECENT_COMMENTS",includeReply:!1,pageSize:100}),headers:{"Content-Type":"application/json"}};a=[];const o=await fetch("https://twikoo.minbit.top/",n);if(o.ok){const{data:n}=await o.json();n.forEach(t=>{null==t.avatar&&(t.avatar="https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp"),a.push({avatar:t.avatar,content:t.nick+"："+e(t.comment),url:t.url+"#"+t.id})}),t.batchSend(a,!0),saveToLocal.set("twikoo-danmu",a,.5)}function e(t){return t=(t=(t=(t=(t=t.replace(/<\/*br>|[\s\uFEFF\xA0]+/g,"")).replace(/<img.*?>/g,"[图片]")).replace(/<a.*?>.*?<\/a>/g,"[链接]")).replace(/<pre.*?>.*?<\/pre>/g,"[代码块]")).replace(/<.*?>/g,"")}}}catch(t){console.error("Error fetching data:",t)}document.getElementById("danmu-Btn")&&(document.getElementById("danmu-Btn").innerHTML="<button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.remove('hide-danmu')\">显示弹幕</button> <button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.add('hide-danmu')\">隐藏弹幕</button>")};(async()=>{if("function"==typeof EasyDanmaku)await t();else{await getScript("https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js");"function"==typeof EasyDanmaku?await t():console.error("EasyDanmaku function not found even after loading the script.")}})()};t(),document.addEventListener("pjax:complete",t)})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>