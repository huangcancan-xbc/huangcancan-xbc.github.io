<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>057 高级 IO 之 epoll 详解与 CMake 入门 | 小米里的大麦</title><meta name="keywords" content="Linux,IO"><meta name="author" content="小米里的大麦"><meta name="copyright" content="小米里的大麦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="057 高级 IO 之 epoll 详解与 CMake 入门"><meta name="application-name" content="057 高级 IO 之 epoll 详解与 CMake 入门"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="057 高级 IO 之 epoll 详解与 CMake 入门"><meta property="og:url" content="https://www.minbit.top/posts/4211.html"><meta property="og:site_name" content="小米里的大麦"><meta property="og:description" content="epoll 和 CMake 的使用1. epoll 简介epoll 是 Linux 系统提供的一种 IO 多路复用机制，用来替代传统的 select 和 poll。它的核心优势是：  高效：性能不会随着监听的文件描述符数量增加而下降。 内存友好：只返回就绪的事件，而不是遍历所有文件描述符。 支持边缘"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=578d71b1-7771-3429-133e-7bea81a56b7a"><meta property="article:author" content="小米里的大麦"><meta property="article:tag" content="技术博客,Linux,C++,后端开发,编程学习,个人博客,技术分享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=578d71b1-7771-3429-133e-7bea81a56b7a"><meta name="description" content="epoll 和 CMake 的使用1. epoll 简介epoll 是 Linux 系统提供的一种 IO 多路复用机制，用来替代传统的 select 和 poll。它的核心优势是：  高效：性能不会随着监听的文件描述符数量增加而下降。 内存友好：只返回就绪的事件，而不是遍历所有文件描述符。 支持边缘"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "057 高级 IO 之 epoll 详解与 CMake 入门",
  "description": "epoll 和 CMake 的使用1. epoll 简介epoll 是 Linux 系统提供的一种 IO 多路复用机制，用来替代传统的 select 和 poll。它的核心优势是：  高效：性能不会随着监听的文件描述符数量增加而下降。 内存友好：只返回就绪的事件，而不是遍历所有文件描述符。 支持边缘",
  "image": "https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=578d71b1-7771-3429-133e-7bea81a56b7a",
  "datePublished": "2025-10-19T04:00:00.000Z",
  "dateModified": "2025-10-29T04:00:00.000Z",
  "author": {
    "@type": "Person",
    "name": "小米里的大麦",
    "url": "https://www.minbit.top"
  },
  "publisher": {
    "@type": "Organization",
    "name": "小米里的大麦",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.minbit.top/img/Profile%20picture.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.minbit.top/posts/4211.html"
  },
  "keywords": "Linux, IO"
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "首页",
      "item": "https://www.minbit.top"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "057 高级 IO 之 epoll 详解与 CMake 入门",
      "item": "https://www.minbit.top/posts/4211.html"
    }
  ]
}</script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "小米里的大麦",
  "url": "https://www.minbit.top",
  "image": "https://www.minbit.top/img/Profile%20picture.png",
  "description": "时间好像总会留下点什么，或许是一个人，或许是一个梦，或许……是一段有意义的经历~"
}</script><link rel="shortcut icon" href="/img/icons/funny.svg"><link rel="canonical" href="https://www.minbit.top/posts/4211.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//bsz.dusays.com:9001"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"友链 + 外链 + 无限进步！欢迎欣赏和贡献！",addFriendPlaceholder:"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:{enable:!0,gptName:"小米里的大麦",mode:"local",switchBtn:!1,btnLink:"https://afdian.net/item/886a79d4db6711eda42a52540025c377",randomNum:4,basicWordCount:1999,key:"93d1622eadde491eb0594b68ade51723.kaEiDD6A3KPzb7xv",Referer:"https://www.minbit.top/"},diytitle:{enable:!0,leaveTitle:"w(ﾟДﾟ)w 不要走！再看看嘛！",backTitle:"♪(^∇^*)欢迎肥来！"},LA51:{enable:!0,ck:"Jp8wwGQpp21utaFQ",LingQueMonitorID:"Jp8ztDRrxmTf7LDj"},greetingBox:{enable:!0,default:"晚上好👋",list:[{greeting:"晚安😴",startTime:0,endTime:5},{greeting:"早上好鸭👋, 祝你一天好心情！",startTime:6,endTime:9},{greeting:"上午好👋, 状态很好，鼓励一下～",startTime:10,endTime:10},{greeting:"11点多啦, 在坚持一下就吃饭啦～",startTime:11,endTime:11},{greeting:"午安👋, 宝贝",startTime:12,endTime:14},{greeting:"🌈充实的一天辛苦啦！",startTime:14,endTime:18},{greeting:"19点喽, 奖励一顿丰盛的大餐吧🍔。",startTime:19,endTime:19},{greeting:"晚上好👋, 在属于自己的时间好好放松😌~",startTime:20,endTime:24}]},twikooEnvId:"https://twikoo.minbit.top/",commentBarrageConfig:{enable:!0,maxBarrage:10,barrageTime:5e3,accessToken:"25c96851dd8a790c4819ad4bfbaf153c",mailMd5:"7b12ebc2be80f9159099f6ab0e16573c"},music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:void 0,navMusic:!0,mainTone:{mode:"both",api:"https://img2color-go.vercel.app/api?img=",cover_change:!0},authorStatus:{skills:["🧐 准备中，就快好了，真的！😭","📚 正在学习中，加油！","🎵 喜欢听音乐，喜欢看动漫"]},algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"距上次更新已过去",messageNext:"天了，这篇文章的内容可能已经过时了。"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:330},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!0,limitCount:150,languages:{author:"作者: 小米里的大麦",link:"链接: ",source:"来源: 小米里的大麦",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#425AEF",bgDark:"#1f1f1f",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.2.0/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"小米里的大麦",title:"057 高级 IO 之 epoll 详解与 CMake 入门",postAI:"这篇文章讲述了Linux系统中的epoll机制及其在CMake环境下的入门使用。epoll是一种高效的IO多路复用技术，用于替代select和poll，其核心优势包括高效性能、内存友好以及支持边缘触发，能够有效管理大量文件描述符，特别适合高并发服务器程序。文章详细介绍了epoll的三大核心函数epoll_create、epoll_ctl和epoll_wait，分别对应创建epoll实例、管理监听列表和等待事件发生。epoll_create用于创建一个epoll实例，返回一个文件描述符，epoll_ctl用于添加、修改或删除要监听的文件描述符，epoll_wait用于阻塞等待事件发生并返回就绪的事件。文章还深入探讨了epoll的底层原理，包括红黑树、就绪队列和回调机制，解释了为什么epoll比select/poll更高效。最后，文章提供了一个基于epoll LT模型的代码示例，展示了如何在CMake环境下实现一个简单的epoll服务器，包括创建监听socket、接受新连接、接收数据和处理断开连接等操作。",pageFillDescription:"epoll 和 CMake 的使用, 1. epoll 简介, 2. epoll 的三大函数, 3. epoll_createx2Fepoll_create1 —— 创建 epoll 实例, 4. epoll_ctl —— 控制监听列表（注册 x2F 修改 x2F 删除 关注的 fd）, 5. epoll_wait —— 等待事件发生, 6. epoll 的底层原理, 1. epoll 的三大核心组件, 2. 一个核心机制：回调 —— epoll 高效的 秘密武器！, 3. 整体流程概览, 4. 内部关键对象：epitem, 5. 特殊处理, 6. 线程安全保障, 7. 为什么比 selectx2Fpoll 高效？, 7. 代码示例（epoll LT）, 8. epoll 的工作方式, 1. 核心区别, 2. ET 模式的编程要点, 3. 疑难解答, 1. LT 模式下如果我把 fd 设为非阻塞并在第一次通知时就循环读完所有数据那和 ET 有什么区别？, 2. 为什么 ET 必须用非阻塞 IO？, 3. ET 模式真的更高效吗？, 9. 代码示例（epoll ET）, 10. 快速上手 CMake, 1. CMake 是干什么的, 2. 安装 CMake, 3. 编写最简 CMakeLists.txt, 4. 编译和运行和的使用简介是系统提供的一种多路复用机制用来替代传统的和它的核心优势是高效性能不会随着监听的文件描述符数量增加而下降内存友好只返回就绪的事件而不是遍历所有文件描述符支持边缘触发可以更灵活地控制事件触发方式的三大函数和是机制的三个核心函数可以类比为创建一个实例相当于创建一个事件监听器管理要监听的文件描述符添加修改删除监听列表中的等待事件发生阻塞等待直到有事件发生或超时这三兄弟的关系就像一个管理系统的三个操作创建一个管理办公室向办公室登记修改删除要监控的员工文件描述符在办公室等待当有员工出事事件发生时进行通知这种设计使得可以高效地管理大量文件描述符特别适合高并发的服务器程序创建实例介绍创建一个实例返回一个文件描述符后续的所有操作都通过这个进行函数原型旧版推荐带如参数告诉内核你大概要监听多少个文件描述符它只是一个提示值在较新的内核中这个参数已经不重要了但必须大于内核会动态调整内部数据结构的大小实际可以监听的数量只受系统资源限制如文件描述符限制内存等定义但实际监听个也没问题常用或在时自动关闭即返回值成功返回一个文件描述符后续用这个来操作失败返回同时设置使用示例创建一个实例预计监听个控制监听列表注册修改删除关注的介绍向实例中添加修改或删除要监听的文件描述符函数原型结构体要监听的事件类型用户数据可以存储或指针可以指向任意数据文件描述符位无符号整数位无符号整数参数返回的文件描述符操作类型告诉要做什么添加一个新的文件描述符到监听列表修改已存在文件描述符的监听事件从监听列表中删除一个文件描述符目标被监控的文件描述符要操作的文件描述符管道文件等指向结构体的指针指定要关注监听的事件常用的事件文件描述符可读文件描述符可写文件描述符错误表示对应的文件描述符有紧急的数据可读这里应该表示有带外数据到来对端文件描述符关闭连接边缘触发模式只监听一次事件当监听完这次事件之后如果还需要继续监听该文件描述符的话需要重新将该文件描述符添加到模型中用于回传用户自定义数据通常存或结构体指针对可传在某些内核版本仍需有效结构传地址更保险注意添加前务必确保是合法且已打开若使用边沿触发必须把设为非阻塞用于修改同一的事件或只有删除操作可以传添加和修改操作必须传有效的指针需要告诉内核监听什么事件必须传需要告诉内核修改成什么事件必须传只是删除不需要指定事件可以传传的含义删除操作不需要关心事件类型只要告诉内核要删除哪个即可内核只需要值就能找到红黑树下文会提到中对应的节点并删除传可以避免传递不必要的参数提高效率返回值成功返回失败返回同时设置使用示例监听可读事件使用边缘触发将客户端保存到中添加客户端到监听列表等待事件发生介绍阻塞等待直到有文件描述符上的事件发生然后返回所有就绪的事件函数原型参数结构体同上返回的文件描述符指向数组的指针用于接收内核返回就绪的事件信息数组大小能接收的最大就绪事件数超时最长等待时间毫秒永久阻塞直到有事件发生非阻塞立即返回最多等待毫秒要点是你在时设置的数据常用来快速拿到对应的或连接结构体返回后应遍历数组并处理每个就绪项不应小于你预计一次处理的并发就绪数通常设置为或更大返回值返回就绪事件的数量超时在指定时间内没有事件发生出错同时设置使用示例等待事件发生最多返回个就绪事件超时时间为永久等待处理所有就绪的事件获取发生事件的文件描述符如果是可读事件处理读操作监听可读说明有新连接客户端可读接收数据的底层原理之所以比快高效不是靠单一技术而是数据结构算法机制的完美结合它用了红黑树就绪队列回调机制这三样核心设计让监听谁谁就绪了怎么取结果都高效完成避免了反复轮询和复制的三大核心组件名称数据结构作用红黑树存放我要关注哪些关心哪些事件的集合监控列表就绪队列存放已经就绪的事件等来取回调机制函数指针当设备驱动检测到某个就绪时自动触发把它加入就绪队列红黑树存储要监听的所有文件描述符就像购物清单记录了所有要关注的商品文件描述符文件描述符天然作为红黑树的查找速度很快每次调用就是在这张清单上增删改项目就绪队列存储已经就绪的文件描述符就像已到货通知单记录了哪些商品已经到了可以取货每次调用就是来取这张通知单这三个东西组合在一起就构成了一个完整的模型对应内核结构一个核心机制回调高效的秘密武器的问题程序问操作系统我关注的这些哪些有数据了操作系统我一个一个帮你查一遍每次都要遍历所有效率随数量增加而下降的聪明做法程序告诉操作系统我要关注这些的事件操作系统在内核里建立回调函数当网卡收到数据时硬件直接通知内核有数据了内核自动调用回调函数把从红黑树移到就绪队列程序调用时直接取就绪队列就行比喻理解想象你在网上购物你每隔几分钟就去快递点问我的包裹到了吗快递员要查所有包裹快递员有你的电话包裹一到就给你打电话你再过去取整体流程概览三个函数分别对应底层三个阶段用户函数内核动作对应的数据结构创建一个实例初始化红黑树就绪队列把添加修改删除到红黑树操作红黑树节点每个节点是等待就绪事件从就绪队列里取出已经准备好的事件内部关键对象每一个通过加入监听的内核都会创建一个对应的结构体红黑树节点对应增删改链表节点对应就绪队列文件描述符信息所属实例要监听的事件类型可以理解为红黑树节点表示我关注了上的这些事件就绪队列节点表示上的事件真的发生了是谁关心什么特殊处理普通模式事件就绪后继续保留在红黑树中下次还会通知模式事件就绪后会自动从红黑树删除想再次监听这个必须重新添加调用常用于多线程模式防止同一个被多个线程同时处理边沿触发只在状态变化时通知一次必须配合非阻塞否则可能漏事件减少系统调用次数进一步提升性能线程安全保障就绪队列用互斥锁保护多线程访问安全等待队列处理多个线程同时访问的情况为什么比高效查找红黑树保证添加删除操作是比数组快按需通知只有事件真正发生时才通知不需要轮询批量处理一次可以返回多个就绪事件内存友好只返回就绪的不是所有代码示例完整代码请前往查看定义事件类型常量可读事件可写事件继承防拷贝基类确保服务器对象不能被拷贝最多返回的事件数量构造函数接收端口号初始化端口号创建监听智能指针创建智能指针关闭监听创建绑定端口开始监听记录监听创建成功日志处理新连接存储客户端存储客户端端口接收新连接如果接收连接成功将新连接的添加到监听列表监听可读事件获得一个新的连接客户端说记录新连接日志处理数据接收临时缓冲区用于接收数据从指定读取数据成功读取到数据添加字符串结束符收到消息输出收到的消息构造回显消息将回显消息写回客户端客户端关闭连接读到文件结束符客户端断开连接记录客户端断开连接日志客户端断开连接输出断开连接信息从监听列表中删除该关闭该连接的文件描述符读取数据出错记录读取错误日志输出错误信息从监听列表中删除该关闭该连接的文件描述符事件分发器处理所有就绪的事件遍历所有就绪的事件获取事件类型获取发生事件的文件描述符如果是可读事件如果是监听可读有新连接处理新连接处理数据接收如果是可写事件可写事件处理逻辑其他事件其他事件处理逻辑启动服务器主循环将监听添加到监听列表创建数组用于接收就绪事件服务器无限循环等待事件发生最多返回个事件有事件发生有事件已经就绪开始处理其文件描述符是记录第一个就绪事件的分发处理所有就绪的事件超时没有事件发生记录超时日志出错记录错误日志出错时可以选择退出循环监听的智能指针对象的智能指针服务器端口号的工作方式核心区别模式触发时机是否重复通知是否必须非阻塞实现复杂度通知频率的默认模式只要内核缓冲区里有数据高电平状态会一直通知不强制可阻塞或非阻塞简单可分多次处理事件高只要事件存在就反复通知只有状态变化时触发从无到有有到多只通知一次必须非阻塞否则可能永久阻塞复杂必须一次性处理完所有数据低仅状态变化时通知一次类比理解可以把内核数据缓冲区理解为水桶模式只要桶里有水数据没读完内核就会一遍又一遍告诉你有水所以你可以慢慢舀不急着一次读完模式只有桶第一次被装满或者水又多了一点时才会告诉你一次之后不会再提醒所以必须一次把水全舀光否则漏掉的数据就永远没人告诉你了性能与设计取舍对比项内核通知次数多每次都通知少状态变化才通知开销稍高更低编程难度简单较高安全性容错性强可多次处理容错性低必须彻底处理实际应用属于使用模式的编程要点必须设置非阻塞循环读写直到返回错误读读完对端关闭正常读取写同理循环直到注册事件时带上疑难解答模式下如果我把设为非阻塞并在第一次通知时就循环读完所有数据那和有什么区别逻辑行为上几乎一样性能也接近但模式仍有条件判断冗余通知的系统开销是内核级别的只在状态变化时触发性能更纯粹仍然会准备通知但因为你已经清空了缓冲区所以下次不会再返回该但仍保留兜底能力万一你漏读了下次还会提醒你所以的优势不是必须更快而是强制你写出高效代码实际上高性能服务器如选择是为了避免意外的重复通知带来的开销尤其是在连接数极高的场景为什么必须用非阻塞因为要求你一次性读完所有数据如果使用阻塞当你读到最后一次缓冲区已空会永远阻塞因为没有新数据到来也不会再通知你非阻塞在无数据时立即返回并设置让你知道本次数据已读完模式真的更高效吗在特定条件下是的减少的唤醒次数降低系统调用开销促使应用层批量处理数据更好的和吞吐窗口优化当接收方快速消费数据强制你这么做接收窗口更大发送方可以一次发更多数据减少小包和开销注意如果实现不当如漏读未设非阻塞反而会导致连接假死比更危险代码示例完整代码请前往查看前向声明和类避免循环包含定义读事件掩码定义写事件掩码定义缓冲区大小为字节定义回调函数类型参数为类型的连接对象定义异常处理函数类型类管理单个客户端连接构造函数接收文件描述符设置连接的回调函数获取文件描述符向输入缓冲区追加数据向输出缓冲区追加数据获取输入缓冲区的引用获取输出缓冲区的引用设置指向服务器的弱引用指针文件描述符输入缓冲区输出缓冲区读回调函数写回调函数异常回调函数指向服务器的弱引用客户端地址客户端端口号类服务器主类支持事件驱动定义事件数组大小为构造函数接收端口号和消息处理函数服务器端口号消息处理函数退出标志对象指针监听对象指针初始化服务器创建设置为非阻塞模式绑定端口开始监听创建成功服务器初始化成功监听端口将监听添加到中设置读事件回调添加一个新的连接添加连接到服务器创建新的连接对象设置连接对象对服务器的弱引用设置连接的回调函数设置客户端和端口将连接添加到连接映射表中将添加到监控列表中成功添加新连接客户端客户端端口链接管理器收到一个新的客户端连接得到的消息只需要设置其他读写异常都设置接受新连接的处理函数将转换为以安全访问连接对象检查转换是否成功无法获取连接对象指针可能已被销毁接受新的客户端连接收到一个新的客户端连接得到的消息收到新的客户端连接客户端客户端端口连接设置新连接为非阻塞模式为新连接添加到服务器管理中设置各种回调函数处理返回错误的情况没有更多连接退出循环被信号中断继续循环调用失败错误码错误信息其他错误退出循环事件管理器客户端断开连接客户端断开连接接收数据的处理函数检查连接对象是否已经过期连接对象已过期无法处理接收事件将转换为以安全访问连接对象从接收数据接收到数据添加到输入缓冲区从客户端接收到字节数据客户端关闭连接客户端消息断开连接退出客户端端口主动断开连接调用异常回调函数处理连接断开处理接收错误客户端数据接收完毕没有更多数据可读退出循环被信号中断继续循环其他错误客户端信息接收错误从客户端接收数据失败错误码错误信息调用上层消息处理函数处理接收到的数据发送数据的处理函数连接对象已过期无法处理发送事件检查连接对象是否已经过期将转换为以安全访问连接对象发送数据到客户端向客户端成功发送字节数据成功发送部分数据从输出缓冲区中删除已发送的数据客户端输出缓冲区已清空缓冲区清空退出循环向客户端发送字节数据发送字节退出处理发送错误客户端发送缓冲区已满等待下次发送缓冲区满退出循环被信号中断继续循环其他错误客户端消息发送错误向客户端发送数据失败错误码错误信息开启对写事件的关心为客户端启用写事件监控关闭对写事件的关心为客户端禁用写事件监控异常处理函数连接对象已过期无法处理异常事件检查连接对象是否已经过期将转换为以安全访问连接对象检查转换是否成功无法获取连接对象指针可能已被销毁异常处理程序套接字文件描述符客户端消息异常退出处理异常连接客户端客户端端口移除对特定的关心关闭异常的文件描述符关闭异常连接的文件描述符从中连接映射表中移除从连接管理器中移除异常连接异常连接处理完成启用或禁用的读写事件监控根据参数设置事件掩码更新的事件监控可读可写是否是否检查指定的文件描述符是否在服务器管理中检查连接安全状态不存在于连接管理器中检查连接安全状态存在于连接管理器中事件分发器处理返回的事件等待事件调用失败错误码错误信息超时未检测到任何事件返回个事件处理读事件处理读事件调用读回调函数处理写事件处理写事件调用写回调函数服务器主循环服务器主循环开始运行端口持续处理事件直到服务器退出可选如果需要打印连接状态可以取消注释服务器主循环结束打印当前连接列表调试用当前连接总数当前连接列表服务器正在关闭清理资源对象指针监听对象指针连接管理映射表事件数组服务器端口号退出标志消息处理函数快速上手是干什么的是一个跨平台的自动化构建工具它的核心作用是根据自动生成然后我们只需执行就能编译整个项目简单说写一份执行自动生成执行生成可执行文件安装检查版本编写最简在项目的根目录中创建一个名为的文件写入内容指定最低版本工程名使用标准生成可执行文件这就是最基本的版本注意严格要求文件名必须是大小写都必须完全匹配原因很简单的解析器在目录下只会自动搜索这个精确名字的文件不是变量名不是模糊匹配也不会识别等写法比如正确错误只是一个工程名字主要用于内部标识与目录名没强绑定通常我们会让它与最终生成的可执行文件同名这样方便编译和运行我们建议在项目根目录执行下面的代码这样生成的临时文件都在里不会污染源代码目录运行命令生成解释表示让去上一级也就是项目根目录找执行完这步后目录里会生成执行编译会自动调用编译并生成可执行文件可选运行程序",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-10-29 12:00:00",postMainColor:""}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach(e=>{c.setAttribute(e,t[e])}),document.head.appendChild(c)}),e.getCSS=(e,t=!1)=>new Promise((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=10||e>=20?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())})}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/custom/css/font.css"><link rel="stylesheet" href="/custom/css/bilibili.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="小米里的大麦" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/Profile%20picture.png"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()}),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",()=>{preloader.initLoading()}),document.addEventListener("pjax:complete",()=>{preloader.endLoading()})</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">算法</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://ac.nowcoder.com/acm/contest/profile/517073385" title="牛客"><img class="back-menu-item-icon" src="/img/icons/think.svg" alt="牛客"><span class="back-menu-item-text">牛客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/1367427" title="洛谷"><img class="back-menu-item-icon" src="/img/icons/funny.svg" alt="洛谷"><span class="back-menu-item-text">洛谷</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">小米里的大麦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wechatANDalipay.webp" target="_blank"><img class="post-qr-code-img" alt="微信/支付宝" src="/img/wechatANDalipay.webp"></a><div class="post-qr-code-desc">微信/支付宝</div></li><li class="reward-item"><a href="/img/PayPal.webp" target="_blank"><img class="post-qr-code-img" alt="PayPal" src="/img/PayPal.webp"></a><div class="post-qr-code-desc">PayPal</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:1.05rem">AI<sup>2</sup></a><a href="/tags/C/" style="font-size:1.05rem">C++<sup>11</sup></a><a href="/tags/Git/" style="font-size:1.05rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:1.05rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:1.05rem">Linux<sup>59</sup></a><a href="/tags/MySQL/" style="font-size:1.05rem">MySQL<sup>9</sup></a><a href="/tags/Redis/" style="font-size:1.05rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:1.05rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:1.05rem">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:1.05rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:1.05rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:1.05rem">历程<sup>2</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:1.05rem">地址空间<sup>6</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size:1.05rem">工具<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:1.05rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:1.05rem">模板<sup>1</sup></a><a href="/tags/%E7%81%B5%E5%85%89%E8%8D%9F%E8%90%83/" style="font-size:1.05rem">灵光荟萃<sup>3</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:1.05rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:1.05rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:1.05rem">线程<sup>5</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:1.05rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:1.05rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:1.05rem">进程<sup>15</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多"> <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">一月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Linux/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>Linux</span></a><a class="article-meta__tags" href="/tags/IO/" tabindex="-1" itemprop="url"> <span><i class="anzhiyufont anzhiyu-icon-hashtag"></i>IO</span></a></span></div></div><h1 class="post-title" itemprop="name headline">057 高级 IO 之 epoll 详解与 CMake 入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-10-19T04:00:00.000Z" title="发表于 2025-10-19 12:00:00">2025-10-19</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-29T04:00:00.000Z" title="更新于 2025-10-29 12:00:00">2025-10-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="057 高级 IO 之 epoll 详解与 CMake 入门"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"> </span><span class="post-meta-position" title="作者IP属地为西安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>西安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=578d71b1-7771-3429-133e-7bea81a56b7a"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">小米里的大麦 GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://www.minbit.top/posts/4211.html"><header><a class="post-meta-categories" href="/categories/Linux/" itemprop="url">Linux</a><a href="/tags/Linux/" tabindex="-1" itemprop="url">Linux</a><a href="/tags/IO/" tabindex="-1" itemprop="url">IO</a><h1 id="CrawlerTitle" itemprop="name headline">057 高级 IO 之 epoll 详解与 CMake 入门</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">小米里的大麦</span><time itemprop="dateCreated datePublished" datetime="2025-10-19T04:00:00.000Z" title="发表于 2025-10-19 12:00:00">2025-10-19</time><time itemprop="dateCreated datePublished" datetime="2025-10-29T04:00:00.000Z" title="更新于 2025-10-29 12:00:00">2025-10-29</time></header><h1 id="epoll-和-CMake-的使用"><a href="#epoll-和-CMake-的使用" class="headerlink" title="epoll 和 CMake 的使用"></a>epoll 和 CMake 的使用</h1><h2 id="1-epoll-简介"><a href="#1-epoll-简介" class="headerlink" title="1. epoll 简介"></a>1. epoll 简介</h2><p>epoll 是 Linux 系统提供的一种 IO 多路复用机制，用来替代传统的 select 和 poll。它的核心优势是：</p><ul><li><strong>高效</strong>：性能不会随着监听的文件描述符数量增加而下降。</li><li><strong>内存友好</strong>：只返回就绪的事件，而不是遍历所有文件描述符。</li><li><strong>支持边缘触发</strong>：可以更灵活地控制事件触发方式。</li></ul><h2 id="2-epoll-的三大函数"><a href="#2-epoll-的三大函数" class="headerlink" title="2. epoll 的三大函数"></a>2. epoll 的三大函数</h2><p><code>epoll_create</code>、<code>epoll_ctl</code> 和 <code>epoll_wait</code> 是 epoll 机制的三个核心函数，可以类比为：</p><ul><li><code>epoll_create()</code>：创建一个 epoll 实例（相当于创建一个事件监听器）。</li><li><code>epoll_ctl()</code>：管理要监听的文件描述符（添加、修改、删除监听列表中的 fd）。</li><li><code>epoll_wait()</code>：等待事件发生（阻塞等待，直到有事件发生或超时）。</li></ul><blockquote><p>这三兄弟的关系就像一个管理系统的三个操作：</p><ol><li><code>epoll_create()</code>：创建一个管理办公室。</li><li><code>epoll_ctl()</code>：向办公室登记&#x2F;修改&#x2F;删除要监控的员工（文件描述符）。</li><li><code>epoll_wait()</code>：在办公室等待，当有员工出事（事件发生）时进行通知。</li></ol><p>这种设计使得 epoll 可以高效地管理大量文件描述符，特别适合高并发的服务器程序。</p></blockquote><h2 id="3-epoll-create-epoll-create1-——-创建-epoll-实例"><a href="#3-epoll-create-epoll-create1-——-创建-epoll-实例" class="headerlink" title="3. epoll_create&#x2F;epoll_create1 —— 创建 epoll 实例"></a>3. <code>epoll_create</code>&#x2F;<code>epoll_create1</code> —— 创建 epoll 实例</h2><p><strong>介绍</strong>：创建一个 epoll 实例，返回一个文件描述符，后续的所有 epoll 操作都通过这个 fd 进行。</p><p><strong>函数原型：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_create</span><span class="params">(<span class="type">int</span> size)</span></span>;			<span class="comment">// 旧版</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_create1</span><span class="params">(<span class="type">int</span> flags)</span></span>;		<span class="comment">// 推荐：带 flags（如 EPOLL_CLOEXEC）</span></span><br></pre></td></tr></table></figure><p><strong>参数</strong>：</p><ul><li><code>size</code>：告诉内核你 <strong>大概</strong> 要监听多少个文件描述符，它只是一个 <strong>提示值</strong>，在较新的内核中这个参数已经不重要了，但必须大于 0，内核会动态调整内部数据结构的大小，实际可以监听的 fd 数量 <strong>只受系统资源限制</strong>（如文件描述符限制、内存等），定义 <code>size = 10</code>，但实际监听 1000 个 fd 也没问题。</li><li><code>flags</code> 常用 <code>0</code> 或 <code>EPOLL_CLOEXEC</code>（在 exec 时自动关闭 epfd），即：<code>epoll_create1(0)</code>、<code>epoll_create1(EPOLL_CLOEXEC)</code>。</li></ul><p><strong>返回值</strong>：</p><ul><li>成功：返回一个 epoll 文件描述符 <code>epfd</code>（&gt;&#x3D; 0），后续用这个 fd 来操作 epoll</li><li>失败：返回 -1，同时设置 errno。</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> epfd = <span class="built_in">epoll_create</span>(<span class="number">1024</span>);  <span class="comment">// 创建一个 epoll 实例，预计监听1024个fd</span></span><br><span class="line"><span class="keyword">if</span> (epfd == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;epoll_create failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="4-epoll-ctl-——-控制监听列表（注册-修改-删除-关注的-fd）"><a href="#4-epoll-ctl-——-控制监听列表（注册-修改-删除-关注的-fd）" class="headerlink" title="4. epoll_ctl —— 控制监听列表（注册 &#x2F; 修改 &#x2F; 删除 关注的 fd）"></a>4. <code>epoll_ctl</code> —— 控制监听列表（注册 &#x2F; 修改 &#x2F; 删除 关注的 fd）</h2><p><strong>介绍</strong>：向 epoll 实例中添加、修改或删除要监听的文件描述符。</p><p><strong>函数原型：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>epoll_event 结构体</strong>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> events;    <span class="comment">// 要监听的事件类型</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data;  <span class="comment">// 用户数据，可以存储fd或指针</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span>        *ptr;   <span class="comment">// 可以指向任意数据</span></span><br><span class="line">    <span class="type">int</span>          fd;    <span class="comment">// 文件描述符</span></span><br><span class="line">    <span class="type">uint32_t</span>     u32;   <span class="comment">// 32位无符号整数</span></span><br><span class="line">    <span class="type">uint64_t</span>     u64;   <span class="comment">// 64位无符号整数</span></span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br></pre></td></tr></table></figure><p><strong>参数：</strong></p><ul><li><p><code>epfd</code>：<code>epoll_create</code> 返回的 epoll 文件描述符。</p></li><li><p><code>op</code>：操作类型，告诉 epoll 要做什么。</p><ul><li><code>EPOLL_CTL_ADD</code>：<strong>添加</strong> 一个新的文件描述符到监听列表。</li><li><code>EPOLL_CTL_MOD</code>：<strong>修改</strong> 已存在文件描述符的监听事件。</li><li><code>EPOLL_CTL_DEL</code>：从监听列表中 <strong>删除</strong> 一个文件描述符。</li></ul></li><li><p><code>fd</code>：目标被监控的文件描述符&#x2F;要操作的文件描述符（socket、管道、文件等）。</p></li><li><p><code>event</code>：指向 epoll_event 结构体的指针。</p><ul><li><code>events</code> 指定要关注&#x2F;监听的事件，<strong>常用的 events 事件</strong>：<ul><li><code>EPOLLIN</code>：文件描述符 <strong>可读</strong>。</li><li><code>EPOLLOUT</code>：文件描述符 <strong>可写</strong>。</li><li><code>EPOLLERR</code>：文件描述符 <strong>错误</strong>。</li><li><code>EPOLLPRI</code>：表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）。</li><li><code>EPOLLRDHUP</code>：对端文件描述符关闭（连接）。</li><li><code>EPOLLET</code>：边缘触发模式。</li><li><code>EPOLLONESHOT</code>：只监听一次事件，当监听完这次事件之后，如果还需要继续监听该文件描述符的话，需要重新将该文件描述符添加到 epoll 模型中。</li></ul></li><li><code>data</code> 用于回传用户自定义数据（通常存 <code>fd</code> 或结构体指针）。<code>event</code> 对 <code>EPOLL_CTL_DEL</code> 可传 <code>NULL</code>（在某些内核版本仍需有效结构，传地址更保险）。</li></ul></li></ul><blockquote><p><strong>注意</strong>：添加前务必确保 fd 是合法且已打开。若使用 <code>EPOLLET</code>（边沿触发），<strong>必须</strong> 把 fd 设为非阻塞（<code>fcntl</code> + <code>O_NONBLOCK</code>），<code>EPOLL_CTL_MOD</code> 用于修改同一 fd 的事件或 user data。</p><p><strong>只有删除操作(EPOLL_CTL_DEL)可以传 nullptr，添加和修改操作必须传有效的 epoll_event 指针：</strong></p><ul><li>EPOLL_CTL_ADD：需要告诉内核监听什么事件 → 必须传 <code>struct epoll_event *</code>。</li><li>EPOLL_CTL_MOD：需要告诉内核修改成什么事件 → 必须传 <code>struct epoll_event *</code>。</li><li>EPOLL_CTL_DEL：只是删除，不需要指定事件 → 可以传 <code>nullptr</code>。</li></ul><p>传 nullptr 的含义：删除操作不需要关心事件类型，只要告诉内核要删除哪个 fd 即可，内核只需要 fd 值就能找到红黑树（下文会提到）中对应的节点并删除，传 nullptr 可以避免传递不必要的参数，提高效率。</p></blockquote><p><strong>返回值</strong>：</p><ul><li>成功：返回 0。</li><li>失败：返回 -1，同时设置 errno。</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">ev.events = EPOLLIN | EPOLLET;  <span class="comment">// 监听可读事件，使用边缘触发</span></span><br><span class="line">ev.data.fd = client_fd;         <span class="comment">// 将客户端fd保存到data中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加客户端fd到epoll监听列表</span></span><br><span class="line"><span class="type">int</span> ret = <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, client_fd, &amp;ev);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl add failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="5-epoll-wait-——-等待事件发生"><a href="#5-epoll-wait-——-等待事件发生" class="headerlink" title="5. epoll_wait —— 等待事件发生"></a>5. <code>epoll_wait</code> —— 等待事件发生</h2><p><strong>介绍</strong>：阻塞等待，直到有文件描述符上的事件发生，然后返回所有就绪的事件。</p><p><strong>函数原型：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>参数（结构体同上）</strong>：</p><ul><li><code>epfd</code>：<code>epoll_create</code> 返回的 epoll 文件描述符。</li><li><code>events</code>：指向 epoll_event 数组的指针，用于接收（内核返回）就绪的事件信息。</li><li><code>maxevents</code>：数组大小（能接收的最大就绪事件数）。</li><li><code>timeout</code>：超时&#x2F;最长等待时间（毫秒）。<ul><li><code>-1</code>：永久阻塞，直到有事件发生。</li><li><code>0</code>：非阻塞，立即返回。</li><li><code>&gt; 0</code>：最多等待 timeout 毫秒。</li></ul></li></ul><blockquote><p><strong>要点</strong>：</p><ul><li><code>events[i].data</code> 是你在 <code>epoll_ctl</code> 时设置的数据（常用来快速拿到对应的 fd 或连接结构体）。</li><li><code>epoll_wait</code> 返回后应遍历 <code>events</code> 数组并处理每个就绪项。</li><li><code>maxevents</code> 不应小于你预计一次处理的并发就绪数，通常设置为 64、128 或更大。</li></ul></blockquote><p><strong>返回值</strong>：</p><ul><li><code>&gt; 0</code>：返回就绪事件的数量（events [0..ret-1]）。</li><li><code>0</code>：超时（在指定时间内没有事件发生）。</li><li><code>-1</code>：出错，同时设置 errno。</li></ul><p><strong>使用示例</strong>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EVENTS 10</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[MAX_EVENTS];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待事件发生，最多返回10个就绪事件，超时时间为-1（永久等待）</span></span><br><span class="line"><span class="type">int</span> num_events = <span class="built_in">epoll_wait</span>(epfd, events, MAX_EVENTS, <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (num_events == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;epoll_wait failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理所有就绪的事件</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_events; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = events[i].data.fd;         <span class="comment">// 获取发生事件的文件描述符</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (events[i].events &amp; EPOLLIN)     <span class="comment">// 如果是可读事件</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 处理读操作</span></span><br><span class="line">        <span class="keyword">if</span> (fd == listen_fd)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 监听socket可读，说明有新连接</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 客户端socket可读，接收数据</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-epoll-的底层原理"><a href="#6-epoll-的底层原理" class="headerlink" title="6. epoll 的底层原理"></a>6. epoll 的底层原理</h2><p><code>epoll</code> 之所以比 <code>select</code>、<code>poll</code> 快、高效不是靠单一技术，而是 <strong>数据结构 + 算法 + 机制</strong> 的完美结合：它用了 <strong>“红黑树 + 就绪队列 + 回调机制”</strong> 这三样核心设计，让“监听谁”“谁就绪了”“怎么取结果”都高效完成，避免了反复轮询和复制。</p><h3 id="1-epoll-的三大核心组件"><a href="#1-epoll-的三大核心组件" class="headerlink" title="1. epoll 的三大核心组件"></a>1. epoll 的三大核心组件</h3><table><thead><tr><th>名称</th><th>数据结构</th><th>作用</th></tr></thead><tbody><tr><td><strong>红黑树 rbr</strong></td><td><code>struct rb_root rbr;</code></td><td>存放“我要关注哪些 fd、关心哪些事件”的集合（监控列表）</td></tr><tr><td><strong>就绪队列 rdlist</strong></td><td><code>struct list_head rdlist;</code></td><td>存放“已经就绪的 fd 事件”，等 <code>epoll_wait</code> 来取</td></tr><tr><td><strong>回调机制 ep_poll_callback</strong></td><td>函数指针</td><td>当设备驱动检测到某个 fd 就绪时自动触发，把它加入就绪队列</td></tr></tbody></table><ul><li><strong>红黑树（rbr）</strong>：存储要监听的所有文件描述符，就像“购物清单”，记录了所有要关注的商品（文件描述符），文件描述符天然作为红黑树的 key，查找速度很快 O(log n)，每次调用 <code>epoll_ctl</code> 就是在这张清单上增删改项目。</li><li><strong>就绪队列（rdlist）</strong>：存储已经就绪的文件描述符，就像“已到货通知单”，记录了哪些商品已经到了，可以取货，每次调用 <code>epoll_wait</code> 就是来取这张通知单。</li></ul><p>这三个东西组合在一起，就构成了一个完整的 epoll 模型（对应内核结构 <code>eventpoll</code>）。</p><h3 id="2-一个核心机制：回调-——-epoll-高效的-秘密武器！"><a href="#2-一个核心机制：回调-——-epoll-高效的-秘密武器！" class="headerlink" title="2. 一个核心机制：回调 —— epoll 高效的 秘密武器！"></a>2. 一个核心机制：回调 —— epoll 高效的 <strong>秘密武器</strong>！</h3><ul><li><strong>select&#x2F;poll 的问题：</strong> 程序问操作系统：”我关注的这些 fd，哪些有数据了？”，操作系统：”我一个一个帮你查一遍…”，每次都要遍历所有 fd，效率随 fd 数量增加而下降。</li><li><strong>epoll 的聪明做法</strong>：程序告诉操作系统：”我要关注这些 fd 的事件”，操作系统在内核里建立回调函数（ep_poll_callback），当网卡收到数据时，硬件直接通知内核：”fd 3 有数据了！”，内核自动调用回调函数，把 fd 3 从红黑树移到就绪队列，程序调用 <code>epoll_wait</code> 时，直接取就绪队列就行。</li></ul><p><strong>比喻理解：</strong> 想象你在网上购物：</p><ul><li><strong>select&#x2F;poll</strong>：你每隔几分钟就去快递点问：”我的包裹到了吗？”，快递员要查所有包裹。</li><li><strong>epoll</strong>：快递员有你的电话，包裹一到就给你打电话，你再过去取。</li></ul><h3 id="3-整体流程概览"><a href="#3-整体流程概览" class="headerlink" title="3. 整体流程概览"></a>3. 整体流程概览</h3><p>三个函数 <code>epoll_create</code>、<code>epoll_ctl</code>、<code>epoll_wait</code>，分别对应底层三个阶段：</p><table><thead><tr><th>用户函数</th><th>内核动作</th><th>对应的数据结构</th></tr></thead><tbody><tr><td><code>epoll_create</code></td><td>创建一个 <code>eventpoll</code> 实例</td><td>初始化红黑树 rbr、就绪队列 rdlist</td></tr><tr><td><code>epoll_ctl</code></td><td>把 fd 添加&#x2F;修改&#x2F;删除到红黑树</td><td>操作红黑树节点（每个节点是 epitem）</td></tr><tr><td><code>epoll_wait</code></td><td>等待就绪事件</td><td>从就绪队列里取出已经准备好的事件</td></tr></tbody></table><h3 id="4-内部关键对象：epitem"><a href="#4-内部关键对象：epitem" class="headerlink" title="4. 内部关键对象：epitem"></a>4. 内部关键对象：<code>epitem</code></h3><p>每一个通过 <code>epoll_ctl</code> 加入监听的 fd，内核都会创建一个对应的结构体 <code>epitem</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epitem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rb_node</span> rbn;            <span class="comment">// 红黑树节点 (对应 epoll_ctl 增删改)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> rdllink;      <span class="comment">// 链表节点 (对应就绪队列)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_filefd</span> ffd;       <span class="comment">// 文件描述符信息</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">eventpoll</span> *ep;          <span class="comment">// 所属 epoll 实例</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> event;      <span class="comment">// 要监听的事件类型</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>可以理解为：红黑树节点：表示我关注了 fd 上的这些事件，就绪队列节点：表示 fd 上的事件真的发生了，ffd + event：是谁、关心什么。</strong></p></blockquote><h3 id="5-特殊处理"><a href="#5-特殊处理" class="headerlink" title="5. 特殊处理"></a>5. 特殊处理</h3><ul><li><strong>普通模式</strong>：事件就绪后，继续保留在红黑树中，下次还会通知。</li><li><strong>EPOLLONESHOT 模式</strong>：事件就绪后，会 <strong>自动从红黑树删除</strong>，想再次监听这个 fd，必须重新添加（调用 <code>epoll_ctl(ADD)</code>），常用于多线程模式，防止同一个 fd 被多个线程同时处理。</li><li><strong>EPOLLET（边沿触发）：</strong> 只在状态变化时通知一次，必须配合非阻塞 IO，否则可能漏事件，减少系统调用次数，进一步提升性能。</li></ul><h3 id="6-线程安全保障"><a href="#6-线程安全保障" class="headerlink" title="6. 线程安全保障"></a>6. 线程安全保障</h3><ul><li>就绪队列用互斥锁保护，多线程访问安全</li><li>等待队列处理多个线程同时访问的情况</li></ul><h3 id="7-为什么比-select-poll-高效？"><a href="#7-为什么比-select-poll-高效？" class="headerlink" title="7. 为什么比 select&#x2F;poll 高效？"></a>7. 为什么比 select&#x2F;poll 高效？</h3><ol><li><strong>O(1) 查找</strong>：红黑树保证添加&#x2F;删除操作是 O(log n)，比数组快。</li><li><strong>按需通知</strong>：只有事件真正发生时才通知，不需要轮询。</li><li><strong>批量处理</strong>：一次 <code>epoll_wait</code> 可以返回多个就绪事件。</li><li><strong>内存友好</strong>：只返回就绪的 fd，不是所有 fd。</li></ol><h2 id="7-代码示例（epoll-LT）"><a href="#7-代码示例（epoll-LT）" class="headerlink" title="7. 代码示例（epoll LT）"></a>7. 代码示例（epoll LT）</h2><blockquote><p><strong>完整代码请前往 <a target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc/Linux-Ubuntu/tree/main/Coding/Advanced_IO/epoll(LT)">GitHub</a> 查看。</strong></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Socket.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;noCopy.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Epoller.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义epoll事件类型常量</span></span><br><span class="line"><span class="type">uint32_t</span> EVENT_IN = (EPOLLIN);                              <span class="comment">// 可读事件（EPOLLIN）</span></span><br><span class="line"><span class="type">uint32_t</span> EVENT_OUT = (EPOLLOUT);                            <span class="comment">// 可写事件（EPOLLOUT）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EpollServer</span> : <span class="keyword">public</span> noCopy                           <span class="comment">// 继承防拷贝基类，确保服务器对象不能被拷贝</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> num = <span class="number">64</span>;                              <span class="comment">// epoll_wait最多返回的事件数量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EpollServer</span>(<span class="type">uint16_t</span> port)                              <span class="comment">// 构造函数，接收端口号</span></span><br><span class="line">        : _port(port),                                      <span class="comment">// 初始化端口号</span></span><br><span class="line">          _listsocket_ptr(<span class="keyword">new</span> <span class="built_in">Sock</span>()),                      <span class="comment">// 创建监听socket智能指针</span></span><br><span class="line">          _epoller_ptr(<span class="keyword">new</span> <span class="built_in">Epoller</span>())                       <span class="comment">// 创建epoller智能指针</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">EpollServer</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        _listsocket_ptr-&gt;<span class="built_in">Close</span>();                            <span class="comment">// 关闭监听socket</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _listsocket_ptr-&gt;<span class="built_in">Socket</span>();                           <span class="comment">// 创建socket</span></span><br><span class="line">        _listsocket_ptr-&gt;<span class="built_in">Bind</span>(_port);                        <span class="comment">// 绑定端口</span></span><br><span class="line">        _listsocket_ptr-&gt;<span class="built_in">Listen</span>();                           <span class="comment">// 开始监听</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;create listen socket success! fd = %d&quot;</span>, _listsocket_ptr-&gt;<span class="built_in">Fd</span>()); <span class="comment">// 记录监听socket创建成功日志</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理新连接</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Accept</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::string client_ip;                               <span class="comment">// 存储客户端IP</span></span><br><span class="line">        <span class="type">uint16_t</span> client_port;                                <span class="comment">// 存储客户端端口</span></span><br><span class="line">        <span class="type">int</span> sockfd = _listsocket_ptr-&gt;<span class="built_in">Accept</span>(&amp;client_ip, &amp;client_port);             <span class="comment">// 接收新连接</span></span><br><span class="line">        <span class="keyword">if</span> (sockfd &gt; <span class="number">0</span>)                                      <span class="comment">// 如果接收连接成功</span></span><br><span class="line">        &#123;</span><br><span class="line">            _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_ADD, sockfd, EVENT_IN);           <span class="comment">// 将新连接的fd添加到epoll监听列表，监听可读事件</span></span><br><span class="line">            <span class="built_in">log_</span>(Info, <span class="string">&quot;获得一个新的连接：客户端说：%s:%d&quot;</span>, client_ip.<span class="built_in">c_str</span>(), client_port);    <span class="comment">// 记录新连接日志</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理数据接收</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Recver</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>];                                  <span class="comment">// 临时缓冲区，用于接收数据</span></span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">read</span>(fd, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>);       <span class="comment">// 从指定fd读取数据</span></span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>)                                          <span class="comment">// 成功读取到数据</span></span><br><span class="line">        &#123;</span><br><span class="line">            buffer[n] = <span class="string">&#x27;\0&#x27;</span>;                               <span class="comment">// 添加字符串结束符</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;收到消息：&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;<span class="comment">// 输出收到的消息</span></span><br><span class="line"></span><br><span class="line">            std::string echo_str = <span class="string">&quot;Sverver echo # &quot;</span> + std::<span class="built_in">string</span>(buffer);     <span class="comment">// 构造回显消息</span></span><br><span class="line">            <span class="built_in">write</span>(fd, echo_str.<span class="built_in">c_str</span>(), echo_str.<span class="built_in">size</span>());   <span class="comment">// 将回显消息写回客户端</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)                                    <span class="comment">// 客户端关闭连接（读到文件结束符）</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Info, <span class="string">&quot;客户端断开连接: fd=%d&quot;</span>, fd);         <span class="comment">// 记录客户端断开连接日志</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;客户端断开连接&quot;</span> &lt;&lt; std::endl;      <span class="comment">// 输出断开连接信息</span></span><br><span class="line">            _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_DEL, fd, <span class="number">0</span>);      <span class="comment">// 从epoll监听列表中删除该fd</span></span><br><span class="line">            <span class="built_in">close</span>(fd);                                      <span class="comment">// 关闭该连接的文件描述符</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>                                                <span class="comment">// 读取数据出错</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_</span>(Error, <span class="string">&quot;read error: fd=%d&quot;</span>, fd);           <span class="comment">// 记录读取错误日志</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;read error&quot;</span> &lt;&lt; std::endl;         <span class="comment">// 输出错误信息</span></span><br><span class="line">            _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_DEL, fd, <span class="number">0</span>);      <span class="comment">// 从epoll监听列表中删除该fd</span></span><br><span class="line">            <span class="built_in">close</span>(fd);                                      <span class="comment">// 关闭该连接的文件描述符</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Dispatcher</span><span class="params">(<span class="keyword">struct</span> epoll_event revs[], <span class="type">int</span> num)</span>     <span class="comment">// 事件分发器，处理所有就绪的事件</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)                       <span class="comment">// 遍历所有就绪的事件</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">uint32_t</span> events = revs[i].events;               <span class="comment">// 获取事件类型</span></span><br><span class="line">            <span class="type">int</span> fd = revs[i].data.fd;                       <span class="comment">// 获取发生事件的文件描述符</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (events &amp; EVENT_IN)                          <span class="comment">// 如果是可读事件</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (fd == _listsocket_ptr-&gt;<span class="built_in">Fd</span>())            <span class="comment">// 如果是监听socket可读（有新连接）</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">Accept</span>();                               <span class="comment">// 处理新连接</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">Recver</span>(fd);                             <span class="comment">// 处理数据接收</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (events &amp; EVENT_OUT)                    <span class="comment">// 如果是可写事件</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 可写事件处理逻辑</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                                            <span class="comment">// 其他事件</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 其他事件处理逻辑</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="built_in">Start</span>()                                            <span class="comment">// 启动服务器主循环</span></span><br><span class="line">    &#123;</span><br><span class="line">        _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_ADD, _listsocket_ptr-&gt;<span class="built_in">Fd</span>(), EVENT_IN);    <span class="comment">// 将监听socket添加到epoll监听列表</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">epoll_event</span> revs[num];                       <span class="comment">// 创建epoll_event数组，用于接收就绪事件</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;)                                            <span class="comment">// 服务器无限循环</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> n = _epoller_ptr-&gt;<span class="built_in">EpollerWait</span>(revs, num);   <span class="comment">// 等待事件发生，最多返回num个事件</span></span><br><span class="line">            <span class="keyword">if</span> (n &gt; <span class="number">0</span>)                                      <span class="comment">// 有事件发生</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">log_</span>(Info, <span class="string">&quot;有事件已经就绪，开始处理……其文件描述符是：%d&quot;</span>, revs[<span class="number">0</span>].data.fd);<span class="comment">// 记录第一个就绪事件的fd</span></span><br><span class="line">                <span class="built_in">Dispatcher</span>(revs, n);                        <span class="comment">// 分发处理所有就绪的事件</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)                                <span class="comment">// 超时（没有事件发生）</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">log_</span>(Info, <span class="string">&quot;timeout...&quot;</span>);                   <span class="comment">// 记录超时日志</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>                                            <span class="comment">// epoll_wait出错</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">log_</span>(Error, <span class="string">&quot;epoll_wait error!&quot;</span>);           <span class="comment">// 记录错误日志</span></span><br><span class="line">                <span class="comment">// break;                                   // 出错时可以选择退出循环</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;Sock&gt; _listsocket_ptr;                  <span class="comment">// 监听socket的智能指针</span></span><br><span class="line">    std::shared_ptr&lt;Epoller&gt; _epoller_ptr;                  <span class="comment">// Epoller对象的智能指针</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;                                         <span class="comment">// 服务器端口号</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="8-epoll-的工作方式"><a href="#8-epoll-的工作方式" class="headerlink" title="8. epoll 的工作方式"></a>8. epoll 的工作方式</h2><h3 id="1-核心区别"><a href="#1-核心区别" class="headerlink" title="1. 核心区别"></a>1. 核心区别</h3><table><thead><tr><th>模式</th><th>触发时机</th><th>是否重复通知</th><th>是否必须非阻塞</th><th>实现复杂度</th><th><strong>通知频率</strong></th></tr></thead><tbody><tr><td><strong>LT（Level Triggered，epoll 的默认模式）</strong></td><td>只要内核缓冲区里有数据（高电平状态）</td><td>会 <strong>一直</strong> 通知</td><td>不强制，可阻塞或非阻塞</td><td>简单：可分多次处理事件</td><td>高（只要事件存在就反复通知）</td></tr><tr><td><strong>ET（Edge Triggered）</strong></td><td>只有“状态变化”时触发（从无到有&#x2F;有到多）</td><td>只通知一次</td><td><strong>必须</strong> 非阻塞（否则可能永久阻塞）</td><td>复杂：必须一次性处理完所有数据</td><td>低（仅状态变化时通知一次）</td></tr></tbody></table><p><strong>类比理解：</strong> 可以把内核数据缓冲区理解为“水桶”：</p><ul><li><strong>LT 模式：</strong> 只要桶里有水（数据没读完），内核就会一遍又一遍告诉你“有水！”，所以你可以慢慢舀，不急着一次读完。</li><li><strong>ET 模式：</strong> 只有桶第一次被装满、或者水又多了一点时，才会告诉你一次，之后不会再提醒。所以必须一次把水全舀光，否则漏掉的数据就永远没人告诉你了。</li></ul><p><strong>性能与设计取舍：</strong></p><table><thead><tr><th>对比项</th><th>LT</th><th>ET</th></tr></thead><tbody><tr><td>内核通知次数</td><td>多（每次都通知）</td><td>少（状态变化才通知）</td></tr><tr><td>CPU 开销</td><td>稍高</td><td>更低</td></tr><tr><td>编程难度</td><td>简单</td><td>较高</td></tr><tr><td>安全性</td><td>容错性强（可多次处理）</td><td>容错性低（必须彻底处理）</td></tr><tr><td>实际应用</td><td>select、poll 属于 LT</td><td>Nginx、Redis 使用 ET</td></tr></tbody></table><h3 id="2-ET-模式的编程要点"><a href="#2-ET-模式的编程要点" class="headerlink" title="2. ET 模式的编程要点"></a>2. ET 模式的编程要点</h3><ol><li><p><strong>必须设置非阻塞：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> flags = <span class="built_in">fcntl</span>(fd, F_GETFL, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">fcntl</span>(fd, F_SETFL, flags | O_NONBLOCK);</span><br></pre></td></tr></table></figure></li><li><p><strong>循环读写直到返回错误：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span> n = <span class="built_in">recv</span>(fd, buf, <span class="built_in">sizeof</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">// 读完</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;recv error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 对端关闭</span></span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 正常读取</span></span><br><span class="line">        <span class="built_in">process</span>(buf, n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写同理，循环 send，直到 EAGAIN</span></span><br></pre></td></tr></table></figure></li><li><p><strong>注册事件时带上 <code>EPOLLET</code>：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">epoll_event ev;</span><br><span class="line">ev.data.fd = fd;</span><br><span class="line">ev.events = EPOLLIN | EPOLLET;</span><br><span class="line"><span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, fd, &amp;ev);</span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="3-疑难解答"><a href="#3-疑难解答" class="headerlink" title="3. 疑难解答"></a>3. 疑难解答</h3><h4 id="1-LT-模式下，如果我把-fd-设为非阻塞，并在第一次通知时就循环读完所有数据，那和-ET-有什么区别？"><a href="#1-LT-模式下，如果我把-fd-设为非阻塞，并在第一次通知时就循环读完所有数据，那和-ET-有什么区别？" class="headerlink" title="1. LT 模式下，如果我把 fd 设为非阻塞，并在第一次通知时就循环读完所有数据，那和 ET 有什么区别？"></a>1. LT 模式下，如果我把 fd 设为非阻塞，并在第一次通知时就循环读完所有数据，那和 ET 有什么区别？</h4><p><strong>逻辑行为上几乎一样，性能也接近</strong>。但 LT 模式仍有“条件判断 + 冗余通知”的系统开销，ET 是内核级别的“只在状态变化时触发”，性能更纯粹：</p><ul><li>LT 仍然会“准备通知”，但因为你已经清空了缓冲区，所以下次 <code>epoll_wait</code> 不会再返回该 fd。</li><li>但 LT 仍保留“兜底”能力：万一你漏读了，下次还会提醒你。</li><li>所以：<strong>ET 的优势不是“必须更快”，而是“强制你写出高效代码”</strong>。</li></ul><blockquote><p>实际上，<strong>高性能服务器（如 Redis、Nginx）选择 ET，是为了避免“意外的重复通知”带来的开销</strong>，尤其是在连接数极高的场景。</p></blockquote><h4 id="2-为什么-ET-必须用非阻塞-IO？"><a href="#2-为什么-ET-必须用非阻塞-IO？" class="headerlink" title="2. 为什么 ET 必须用非阻塞 IO？"></a>2. 为什么 ET 必须用非阻塞 IO？</h4><p>因为 ET 要求你 <strong>一次性读完所有数据</strong>。如果使用阻塞 IO，当你读到最后一次（缓冲区已空），<code>recv</code> 会 <strong>永远阻塞</strong>，因为没有新数据到来，epoll 也不会再通知你。非阻塞 IO 在无数据时立即返回 <code>-1</code> 并设置 <code>errno = EAGAIN</code>，让你知道“本次数据已读完”。</p><h4 id="3-ET-模式真的更高效吗？"><a href="#3-ET-模式真的更高效吗？" class="headerlink" title="3. ET 模式真的更高效吗？"></a>3. ET 模式真的更高效吗？</h4><p><strong>在特定条件下是的</strong>：</p><ul><li><strong>减少 epoll_wait 的唤醒次数</strong> → 降低系统调用开销。</li><li><strong>促使应用层批量处理数据</strong> → 更好的 cache locality 和吞吐。</li><li><strong>TCP 窗口优化</strong>：当接收方快速消费数据（ET 强制你这么做），TCP 接收窗口更大，发送方可以一次发更多数据，减少小包和 ACK 开销。</li></ul><p><strong>注意：如果 ET 实现不当（如漏读、未设非阻塞），反而会导致连接“假死”，比 LT 更危险。</strong></p><h2 id="9-代码示例（epoll-ET）"><a href="#9-代码示例（epoll-ET）" class="headerlink" title="9. 代码示例（epoll ET）"></a>9. 代码示例（epoll ET）</h2><blockquote><p><strong>完整代码请前往 <a target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc/Linux-Ubuntu/tree/main/Coding/Advanced_IO/epoll(ET)">GitHub</a> 查看。</strong></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Log.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;noCopy.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Epoller.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Socket.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Comm.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 前向声明Connection和TcpServer类，避免循环包含</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TcpServer</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> EVENT_IN = (EPOLLIN | EPOLLET);            <span class="comment">// 定义读事件掩码（EPOLLIN | EPOLLET）</span></span><br><span class="line"><span class="type">uint32_t</span> EVENT_OUT = (EPOLLOUT | EPOLLET);          <span class="comment">// 定义写事件掩码（EPOLLOUT | EPOLLET）</span></span><br><span class="line"><span class="type">const</span> <span class="type">static</span> <span class="type">int</span> g_buffer_size = <span class="number">1024</span>;              <span class="comment">// 定义缓冲区大小为1024字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// using func_t = std::function&lt;void(std::shared_ptr&lt;Connection&gt;)&gt;;</span></span><br><span class="line"><span class="keyword">using</span> <span class="type">func_t</span> = std::function&lt;<span class="built_in">void</span>(std::weak_ptr&lt;Connection&gt;)&gt;;      <span class="comment">// 定义回调函数类型，参数为weak_ptr类型的连接对象</span></span><br><span class="line"><span class="keyword">using</span> except_func = std::function&lt;<span class="built_in">void</span>(std::weak_ptr&lt;Connection&gt;)&gt;; <span class="comment">// 定义异常处理函数类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Connection类：管理单个客户端连接</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造函数，接收socket文件描述符</span></span><br><span class="line">    <span class="comment">// Connection(int sock, std::shared_ptr&lt;TcpServer&gt; tcp_server_ptr)</span></span><br><span class="line">    <span class="comment">//     : _sock(sock),</span></span><br><span class="line">    <span class="comment">//     _tcp_server_ptr(tcp_server_ptr)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="built_in">Connection</span>(<span class="type">int</span> sock)</span><br><span class="line">        : _sock(sock)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置连接的回调函数</span></span><br><span class="line">    <span class="comment">// void SetHandler(func_t recv_cb, func_t send_cb, func_t except_cb)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     _recv_cb = recv_cb;</span></span><br><span class="line">    <span class="comment">//     _send_cb = send_cb;</span></span><br><span class="line">    <span class="comment">//     _except_cb = except_cb;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetHandler</span><span class="params">(<span class="type">func_t</span> recv_cb, <span class="type">func_t</span> send_cb, except_func except_cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _recv_cb = recv_cb;</span><br><span class="line">        _send_cb = send_cb;</span><br><span class="line">        _except_cb = except_cb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取socket文件描述符</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">SockFd</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _sock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向输入缓冲区追加数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AppendInBuffer</span><span class="params">(<span class="type">const</span> std::string&amp; data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _inbuffer += data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向输出缓冲区追加数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AppendOutBuffer</span><span class="params">(<span class="type">const</span> std::string&amp; info)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _outbuffer += info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// const std::string&amp; Inbuffer()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     return _inbuffer;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// 获取输入缓冲区的引用</span></span><br><span class="line">    <span class="function">std::string&amp; <span class="title">Inbuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _inbuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取输出缓冲区的引用</span></span><br><span class="line">    <span class="function">std::string&amp; <span class="title">OutBuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _outbuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置指向TCP服务器的弱引用指针</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetWeakPtr</span><span class="params">(std::weak_ptr&lt;TcpServer&gt; tcp_server_ptr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _tcp_server_ptr = tcp_server_ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Connection</span>()</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> _sock;                      <span class="comment">// socket文件描述符</span></span><br><span class="line">    std::string _inbuffer;          <span class="comment">// 输入缓冲区</span></span><br><span class="line">    std::string _outbuffer;         <span class="comment">// 输出缓冲区</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">func_t</span> _recv_cb;                <span class="comment">// 读回调函数</span></span><br><span class="line">    <span class="type">func_t</span> _send_cb;                <span class="comment">// 写回调函数</span></span><br><span class="line">    <span class="comment">// func_t _except_cb;</span></span><br><span class="line">    except_func _except_cb;         <span class="comment">// 异常回调函数</span></span><br><span class="line"></span><br><span class="line">    std::weak_ptr&lt;TcpServer&gt; _tcp_server_ptr;   <span class="comment">// 指向TCP服务器的弱引用</span></span><br><span class="line">    std::string _ip;                <span class="comment">// 客户端IP地址</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;                 <span class="comment">// 客户端端口号</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// TcpServer类：TCP服务器主类，支持epoll事件驱动</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TcpServer</span> : <span class="keyword">public</span> std::enable_shared_from_this&lt;TcpServer&gt;, <span class="keyword">public</span> noCopy</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> num = <span class="number">64</span>;      <span class="comment">// 定义epoll事件数组大小为64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TcpServer</span>(<span class="type">uint16_t</span> port, <span class="type">func_t</span> OnMessage)          <span class="comment">// 构造函数，接收端口号和消息处理函数</span></span><br><span class="line">        : _port(port),                                  <span class="comment">// 服务器端口号</span></span><br><span class="line">        _OnMessage(OnMessage),                          <span class="comment">// 消息处理函数</span></span><br><span class="line">        _quit(<span class="literal">true</span>),                                    <span class="comment">// 退出标志</span></span><br><span class="line">        _epoller_ptr(<span class="keyword">new</span> <span class="built_in">Epoller</span>()),                    <span class="comment">// epoll对象指针</span></span><br><span class="line">        _listensock_ptr(<span class="keyword">new</span> <span class="built_in">Sock</span>())                     <span class="comment">// 监听socket对象指针</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span>                     <span class="comment">// 初始化服务器</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _listensock_ptr-&gt;<span class="built_in">Socket</span>();  <span class="comment">// 创建socket</span></span><br><span class="line">        <span class="built_in">SetNonBlockOrDie</span>(_listensock_ptr-&gt;<span class="built_in">Fd</span>());        <span class="comment">// 设置为非阻塞模式</span></span><br><span class="line">        _listensock_ptr-&gt;<span class="built_in">Bind</span>(_port);   <span class="comment">// 绑定端口</span></span><br><span class="line">        _listensock_ptr-&gt;<span class="built_in">Listen</span>();  <span class="comment">// 开始监听</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// log_(Info, &quot;创建listen socket成功，fd：&quot;, _listensock_ptr-&gt;Fd());</span></span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;TCP服务器初始化成功，监听端口: %d, listen socket fd: %d&quot;</span>, _port, _listensock_ptr-&gt;<span class="built_in">Fd</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将监听socket添加到epoll中，设置读事件回调</span></span><br><span class="line">        <span class="built_in">AddConnection</span>(_listensock_ptr-&gt;<span class="built_in">Fd</span>(), EVENT_IN, std::<span class="built_in">bind</span>(&amp;TcpServer::Accepter, <span class="keyword">this</span>, std::placeholders::_1), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// void AddConnection(int sockfd, uint32_t event, func_t recv_cb, func_t send_cb, func_t except_cb, const std::string &amp;ip = &quot;0.0.0.0&quot;, uint16_t port = 0)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     // std::shared_ptr&lt;Connection&gt; new_connection=std::make_shared&lt;Connection&gt;(sockfd, std::shared_ptr&lt;TcpServer&gt;(this));</span></span><br><span class="line">    <span class="comment">//     std::shared_ptr&lt;Connection&gt; new_connection = std::make_shared&lt;Connection&gt;(sockfd, std::shared_ptr&lt;TcpServer&gt;(this));</span></span><br><span class="line">    <span class="comment">//     new_connection-&gt;SetHandler(recv_cb, send_cb, except_cb);</span></span><br><span class="line">    <span class="comment">//     new_connection-&gt;_ip=ip;</span></span><br><span class="line">    <span class="comment">//     new_connection-&gt;_port=port;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     _connections.insert(std::make_pair(sockfd, new_connection));</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     _epoller_ptr-&gt;EpollerUpdate(EPOLL_CTL_ADD, sockfd, event);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     log_(Debug, &quot;添加一个新的连接，fd：&quot;, sockfd);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// 添加连接到服务器</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddConnection</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint32_t</span> event, <span class="type">func_t</span> recv_cb, <span class="type">func_t</span> send_cb, except_func except_cb, <span class="type">const</span> std::string&amp; ip = <span class="string">&quot;0.0.0.0&quot;</span>, <span class="type">uint16_t</span> port = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::shared_ptr&lt;Connection&gt; <span class="title">new_connection</span><span class="params">(<span class="keyword">new</span> Connection(sockfd))</span></span>;     <span class="comment">// 创建新的连接对象</span></span><br><span class="line">        new_connection-&gt;<span class="built_in">SetWeakPtr</span>(<span class="built_in">shared_from_this</span>());                         <span class="comment">// 设置连接对象对服务器的弱引用</span></span><br><span class="line">        new_connection-&gt;<span class="built_in">SetHandler</span>(recv_cb, send_cb, except_cb);                <span class="comment">// 设置连接的回调函数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置客户端IP和端口</span></span><br><span class="line">        new_connection-&gt;_ip = ip;</span><br><span class="line">        new_connection-&gt;_port = port;</span><br><span class="line"></span><br><span class="line">        _connections.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(sockfd, new_connection));            <span class="comment">// 将连接添加到连接映射表中</span></span><br><span class="line"></span><br><span class="line">        _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_ADD, sockfd, event);              <span class="comment">// 将socket添加到epoll监控列表中</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log_</span>(Debug, <span class="string">&quot;成功添加新连接，fd: %d, 客户端IP: %s, 客户端端口: %d&quot;</span>, sockfd, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 链接管理器</span></span><br><span class="line">    <span class="comment">// void Accepter(std::shared_ptr&lt;Connection&gt; connection)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     while (true)</span></span><br><span class="line">    <span class="comment">//     &#123;</span></span><br><span class="line">    <span class="comment">//         struct sockaddr_in peer;</span></span><br><span class="line">    <span class="comment">//         socklen_t len = sizeof(peer);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//         int sockfd = ::accept(connection-&gt;SockFd(), (struct sockaddr*)&amp;peer, &amp;len);</span></span><br><span class="line">    <span class="comment">//         if (sockfd &gt; 0)</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             uint16_t peer_port = ntohs(peer.sin_port);</span></span><br><span class="line">    <span class="comment">//             char ipbuf[128];</span></span><br><span class="line">    <span class="comment">//             inet_ntop(AF_INET, &amp;peer.sin_addr.s_addr, ipbuf, sizeof(ipbuf));</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//             log_(Debug, &quot;收到一个新的客户端连接，得到的消息：[%s:%d], sockfd：%d&quot;, ipbuf, peer_port, sockfd);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//             SetNonBlockOrDie(sockfd);</span></span><br><span class="line">    <span class="comment">//             // listensock只需要设置_recv_cb，其他sock，读，写，异常都设置</span></span><br><span class="line">    <span class="comment">//             // AddConnection(sockfd, EVENT_IN, nullptr, nullptr, nullptr);</span></span><br><span class="line">    <span class="comment">//             AddConnection(sockfd, EVENT_IN, std::bind(&amp;TcpServer::Recver, this, std::placeholders::_1), std::bind(&amp;TcpServer::Sender, this, std::placeholders::_1), std::bind(&amp;TcpServer::Excepter, this, std::placeholders::_1), ipbuf, peer_port);</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         else</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             if (errno == EWOULDBLOCK)</span></span><br><span class="line">    <span class="comment">//             &#123;</span></span><br><span class="line">    <span class="comment">//                 break;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//             else if (errno == EINTR)</span></span><br><span class="line">    <span class="comment">//             &#123;</span></span><br><span class="line">    <span class="comment">//                 continue;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//             else</span></span><br><span class="line">    <span class="comment">//             &#123;</span></span><br><span class="line">    <span class="comment">//                 break;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接受新连接的处理函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Accepter</span><span class="params">(std::weak_ptr&lt;Connection&gt; connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> connection_ptr = connection.<span class="built_in">lock</span>();                <span class="comment">// 将weak_ptr转换为shared_ptr以安全访问连接对象</span></span><br><span class="line">        <span class="keyword">if</span> (!connection_ptr)                                    <span class="comment">// 检查转换是否成功</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Warning, &quot;无法获取连接对象指针，可能已被销毁&quot;);</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> peer;</span><br><span class="line">            <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(peer);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> sockfd = ::<span class="built_in">accept</span>(connection_ptr-&gt;<span class="built_in">SockFd</span>(), (<span class="keyword">struct</span> sockaddr*)&amp;peer, &amp;len);         <span class="comment">// 接受新的客户端连接</span></span><br><span class="line">            <span class="keyword">if</span> (sockfd &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">uint16_t</span> peer_port = <span class="built_in">ntohs</span>(peer.sin_port);</span><br><span class="line">                <span class="type">char</span> ipbuf[<span class="number">128</span>];</span><br><span class="line">                <span class="built_in">inet_ntop</span>(AF_INET, &amp;peer.sin_addr.s_addr, ipbuf, <span class="built_in">sizeof</span>(ipbuf));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// log_(Debug, &quot;收到一个新的客户端连接，得到的消息：[%s:%d], sockfd：%d&quot;, ipbuf, peer_port, sockfd);</span></span><br><span class="line">                <span class="built_in">log_</span>(Info, <span class="string">&quot;收到新的客户端连接，客户端IP: %s, 客户端端口: %d, 连接fd: %d&quot;</span>, ipbuf, peer_port, sockfd);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">SetNonBlockOrDie</span>(sockfd);       <span class="comment">// 设置新连接为非阻塞模式</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 为新连接添加到服务器管理中，设置各种回调函数</span></span><br><span class="line">                <span class="built_in">AddConnection</span>(sockfd, EVENT_IN,</span><br><span class="line">                    std::<span class="built_in">bind</span>(&amp;TcpServer::Recver, <span class="keyword">this</span>, std::placeholders::_1),</span><br><span class="line">                    std::<span class="built_in">bind</span>(&amp;TcpServer::Sender, <span class="keyword">this</span>, std::placeholders::_1),</span><br><span class="line">                    std::<span class="built_in">bind</span>(&amp;TcpServer::Excepter, <span class="keyword">this</span>, std::placeholders::_1),</span><br><span class="line">                    ipbuf, peer_port);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno == EWOULDBLOCK)       <span class="comment">// 处理accept返回错误的情况</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;                      <span class="comment">// 没有更多连接，退出循环</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;                   <span class="comment">// 被信号中断，继续循环</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_</span>(Error, <span class="string">&quot;accept调用失败，错误码: %d, 错误信息: %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="keyword">break</span>;                      <span class="comment">// 其他错误，退出循环</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件管理器</span></span><br><span class="line">    <span class="comment">// void Recver(std::shared_ptr&lt;Connection&gt; connection)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     // std::cout &lt;&lt; &quot;haha, got you!!!, sockfd:&quot; &lt;&lt; connection-&gt;SockFd() &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">//     int sockfd = connection-&gt;SockFd();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     while(true)</span></span><br><span class="line">    <span class="comment">//     &#123;</span></span><br><span class="line">    <span class="comment">//         char buffer[g_buffer_size];</span></span><br><span class="line">    <span class="comment">//         memset(buffer, 0, sizeof(buffer));</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//         ssize_t n = recv(sockfd, buf, sizeof(buffer) - 1, 0);</span></span><br><span class="line">    <span class="comment">//         if (n &gt; 0)</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             connection-&gt;Append(buffer);</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         else if(n == 0)</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             log_(Debug,&quot;客户端断开连接，&quot; ,sockfd,  connection-&gt;_ip.c_str(),connection-&gt;_port);</span></span><br><span class="line">    <span class="comment">//             connection-&gt;excepter(connection);</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         else</span></span><br><span class="line">    <span class="comment">//         &#123;</span></span><br><span class="line">    <span class="comment">//             if (errno ==EWOULDBLOCK)</span></span><br><span class="line">    <span class="comment">//             &#123;</span></span><br><span class="line">    <span class="comment">//                 break;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//             else if (errno == EINTR)</span></span><br><span class="line">    <span class="comment">//             &#123;</span></span><br><span class="line">    <span class="comment">//                 continue;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//             else</span></span><br><span class="line">    <span class="comment">//             &#123;</span></span><br><span class="line">    <span class="comment">//                 log_(Warning,&quot;sockfd: %d,客户端断开连接，errno: %d&quot;,fd,connection-&gt;_ip.c_str(),connection-&gt;_port);</span></span><br><span class="line">    <span class="comment">//                 connection-&gt;excepter(connection);</span></span><br><span class="line">    <span class="comment">//                 break;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     OnMessage(connection);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收数据的处理函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Recver</span><span class="params">(std::weak_ptr&lt;Connection&gt; connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (connection.<span class="built_in">expired</span>())           <span class="comment">// 检查连接对象是否已经过期</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Warning, &quot;连接对象已过期，无法处理接收事件&quot;);</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将weak_ptr转换为shared_ptr以安全访问连接对象</span></span><br><span class="line">        <span class="keyword">auto</span> connection_ptr = connection.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="type">int</span> sockfd = connection_ptr-&gt;<span class="built_in">SockFd</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> buffer[g_buffer_size];</span><br><span class="line">            <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">            <span class="type">ssize_t</span> n = <span class="built_in">recv</span>(sockfd, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>, <span class="number">0</span>);    <span class="comment">// 从socket接收数据</span></span><br><span class="line">            <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                connection_ptr-&gt;<span class="built_in">AppendInBuffer</span>(buffer);         <span class="comment">// 接收到数据，添加到输入缓冲区</span></span><br><span class="line">                <span class="built_in">log_</span>(Debug, <span class="string">&quot;从客户端fd: %d 接收到 %ld 字节数据&quot;</span>, sockfd, n);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)                                    <span class="comment">// 客户端关闭连接</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// log_(Debug, &quot;sockfd: %d,客户端消息：%s : %d断开连接(退出)&quot;, sockfd, connection_ptr-&gt;_ip.c_str(), connection_ptr-&gt;_port);</span></span><br><span class="line">                <span class="built_in">log_</span>(Info, <span class="string">&quot;客户端fd: %d (IP: %s, 端口: %d) 主动断开连接&quot;</span>, sockfd, connection_ptr-&gt;_ip.<span class="built_in">c_str</span>(), connection_ptr-&gt;_port);</span><br><span class="line">                connection_ptr-&gt;_except_cb(connection_ptr);     <span class="comment">// 调用异常回调函数处理连接断开</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno == EWOULDBLOCK)                       <span class="comment">// 处理接收错误</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log_(Debug, &quot;客户端fd: %d 数据接收完毕&quot;, sockfd);</span></span><br><span class="line">                    <span class="keyword">break</span>;                                      <span class="comment">// 没有更多数据可读，退出循环</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)                        <span class="comment">// 被信号中断，继续循环</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>                                            <span class="comment">// 其他错误</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log_(Warning, &quot;sockfd: %d,客户端信息：%s : %d接收错误&quot;, sockfd, connection_ptr-&gt;_ip.c_str(), connection_ptr-&gt;_port);</span></span><br><span class="line">                    <span class="built_in">log_</span>(Error, <span class="string">&quot;从客户端fd: %d 接收数据失败，错误码: %d, 错误信息: %s&quot;</span>, sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    connection_ptr-&gt;_except_cb(connection_ptr);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _OnMessage(connection_ptr);                             <span class="comment">// 调用上层消息处理函数处理接收到的数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据的处理函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Sender</span><span class="params">(std::weak_ptr&lt;Connection&gt; connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (connection.<span class="built_in">expired</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Warning, &quot;连接对象已过期，无法处理发送事件&quot;);</span></span><br><span class="line">            <span class="keyword">return</span>;             <span class="comment">// 检查连接对象是否已经过期</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将weak_ptr转换为shared_ptr以安全访问连接对象</span></span><br><span class="line">        <span class="keyword">auto</span> connection_ptr = connection.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">auto</span>&amp; outbuffer = connection_ptr-&gt;<span class="built_in">OutBuffer</span>();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 发送数据到客户端</span></span><br><span class="line">            <span class="type">ssize_t</span> n = <span class="built_in">send</span>(connection_ptr-&gt;<span class="built_in">SockFd</span>(), outbuffer.<span class="built_in">c_str</span>(), outbuffer.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// log_(Debug, &quot;向客户端fd: %d 成功发送 %ld 字节数据&quot;, connection_ptr-&gt;SockFd(), n);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 成功发送部分数据，从输出缓冲区中删除已发送的数据</span></span><br><span class="line">                outbuffer.<span class="built_in">erase</span>(<span class="number">0</span>, n);</span><br><span class="line">                <span class="keyword">if</span> (outbuffer.<span class="built_in">empty</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log_(Debug, &quot;客户端fd: %d 输出缓冲区已清空&quot;, connection_ptr-&gt;SockFd());</span></span><br><span class="line">                    <span class="keyword">break</span>;                  <span class="comment">// 缓冲区清空，退出循环</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// log_(Debug, &quot;向客户端fd: %d 发送0字节数据&quot;, connection_ptr-&gt;SockFd());</span></span><br><span class="line">                <span class="keyword">return</span>;                     <span class="comment">// 发送0字节，退出</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 处理发送错误</span></span><br><span class="line">                <span class="keyword">if</span> (errno == EWOULDBLOCK)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_</span>(Debug, <span class="string">&quot;客户端fd: %d socket发送缓冲区已满，等待下次发送&quot;</span>, connection_ptr-&gt;<span class="built_in">SockFd</span>());</span><br><span class="line">                    <span class="keyword">break</span>;                  <span class="comment">// socket缓冲区满，退出循环</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;               <span class="comment">// 被信号中断，继续循环</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>                        <span class="comment">// 其他错误</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log_(Warning, &quot;sockfd: %d, 客户端消息： %s : %d 发送错误&quot;, connection_ptr-&gt;SockFd(), connection_ptr-&gt;_ip.c_str(), connection_ptr-&gt;_port);</span></span><br><span class="line">                    <span class="built_in">log_</span>(Error, <span class="string">&quot;向客户端fd: %d 发送数据失败，错误码: %d, 错误信息: %s&quot;</span>, connection_ptr-&gt;<span class="built_in">SockFd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    connection_ptr-&gt;_except_cb(connection_ptr);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!outbuffer.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 开启对写事件的关心</span></span><br><span class="line">            <span class="built_in">EnableEvent</span>(connection_ptr-&gt;<span class="built_in">SockFd</span>(), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// log_(Debug, &quot;为客户端fd: %d 启用写事件监控&quot;, connection_ptr-&gt;SockFd());</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 关闭对写事件的关心</span></span><br><span class="line">            <span class="built_in">EnableEvent</span>(connection_ptr-&gt;<span class="built_in">SockFd</span>(), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// log_(Debug, &quot;为客户端fd: %d 禁用写事件监控&quot;, connection_ptr-&gt;SockFd());</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常处理函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Excepter</span><span class="params">(std::weak_ptr&lt;Connection&gt; connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (connection.<span class="built_in">expired</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Warning, &quot;连接对象已过期，无法处理异常事件&quot;);</span></span><br><span class="line">            <span class="keyword">return</span>;             <span class="comment">// 检查连接对象是否已经过期</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> conn = connection.<span class="built_in">lock</span>();          <span class="comment">// 将weak_ptr转换为shared_ptr以安全访问连接对象</span></span><br><span class="line">        <span class="keyword">if</span> (!conn)                              <span class="comment">// 检查转换是否成功</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Warning, &quot;无法获取连接对象指针，可能已被销毁&quot;);</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> fd = conn-&gt;<span class="built_in">SockFd</span>();</span><br><span class="line">        <span class="comment">// log_(Warning, &quot;异常处理程序套接字文件描述符: %d, 客户端消息：%s : %d 异常退出&quot;, conn-&gt;SockFd(), conn-&gt;_ip.c_str(), conn-&gt;_port);</span></span><br><span class="line">        <span class="built_in">log_</span>(Warning, <span class="string">&quot;处理异常连接，fd: %d, 客户端IP: %s, 客户端端口: %d&quot;</span>, conn-&gt;<span class="built_in">SockFd</span>(), conn-&gt;_ip.<span class="built_in">c_str</span>(), conn-&gt;_port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 移除对特定fd的关心</span></span><br><span class="line">        <span class="comment">// EnableEvent(connection-&gt;SockFd(), false, false);</span></span><br><span class="line">        _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_DEL, fd, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 2. 关闭异常的文件描述符</span></span><br><span class="line">        <span class="built_in">log_</span>(Debug, <span class="string">&quot;关闭异常连接的文件描述符: %d&quot;</span>, fd);</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        <span class="comment">// 3. 从unordered_map中(连接映射表中)移除</span></span><br><span class="line">        <span class="built_in">log_</span>(Debug, <span class="string">&quot;从连接管理器中移除异常连接: %d&quot;</span>, fd);</span><br><span class="line"></span><br><span class="line">        _connections.<span class="built_in">erase</span>(fd);</span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;异常连接处理完成，fd: %d&quot;</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用或禁用socket的读写事件监控</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">EnableEvent</span><span class="params">(<span class="type">int</span> sock, <span class="type">bool</span> readable, <span class="type">bool</span> writeable)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">uint32_t</span> events = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据参数设置事件掩码</span></span><br><span class="line">        events |= ((readable ? EPOLLIN : <span class="number">0</span>) | (writeable ? EPOLLOUT : <span class="number">0</span>) | EPOLLET);</span><br><span class="line">        _epoller_ptr-&gt;<span class="built_in">EpollerUpdate</span>(EPOLL_CTL_MOD, sock, events);</span><br><span class="line">        <span class="comment">// log_(Debug, &quot;更新socket: %d 的事件监控，可读: %s, 可写: %s&quot;, sock, readable ? &quot;是&quot; : &quot;否&quot;, writeable ? &quot;是&quot; : &quot;否&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查指定的socket文件描述符是否在服务器管理中</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">IsConnectionSafe</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> iter = _connections.<span class="built_in">find</span>(sockfd);</span><br><span class="line">        <span class="keyword">if</span> (iter == _connections.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Debug, &quot;检查连接安全状态，fd: %d 不存在于连接管理器中&quot;, sockfd);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// log_(Debug, &quot;检查连接安全状态，fd: %d 存在于连接管理器中&quot;, sockfd);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发器，处理epoll返回的事件</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Dispatcher</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = _epoller_ptr-&gt;<span class="built_in">EpollerWait</span>(revs, num, timeout);  <span class="comment">// 等待epoll事件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// if (n &lt; 0)</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     log_(Error, &quot;epoll_wait调用失败，错误码: %d, 错误信息: %s&quot;, errno, strerror(errno));</span></span><br><span class="line">        <span class="comment">//     return;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// else if (n == 0)</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     log_(Debug, &quot;epoll_wait超时，未检测到任何事件&quot;);</span></span><br><span class="line">        <span class="comment">//     return;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// log_(Debug, &quot;epoll_wait返回 %d 个事件&quot;, n);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">uint32_t</span> events = revs[i].events;</span><br><span class="line">            <span class="type">int</span> sockfd = revs[i].data.fd;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// if (evets &amp; EPOLLERR)</span></span><br><span class="line">            <span class="comment">// &#123;</span></span><br><span class="line">            <span class="comment">//     events |= (EPOLLIN | EPOLLOUT);</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// if (evets &amp; EPOLLHUP)</span></span><br><span class="line">            <span class="comment">// &#123;</span></span><br><span class="line">            <span class="comment">//     events |= (EPOLLIN | EPOLLOUT);</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理读事件</span></span><br><span class="line">            <span class="keyword">if</span> ((events &amp; EPOLLIN) &amp;&amp; <span class="built_in">IsConnectionSafe</span>(sockfd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_connections[sockfd]-&gt;_recv_cb)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log_(Debug, &quot;处理读事件，fd: %d&quot;, sockfd);</span></span><br><span class="line">                    _connections[sockfd]-&gt;_recv_cb(_connections[sockfd]);   <span class="comment">// 调用读回调函数</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理写事件</span></span><br><span class="line">            <span class="keyword">if</span> ((events &amp; EPOLLOUT) &amp;&amp; <span class="built_in">IsConnectionSafe</span>(sockfd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_connections[sockfd]-&gt;_send_cb)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log_(Debug, &quot;处理写事件，fd: %d&quot;, sockfd);</span></span><br><span class="line">                    _connections[sockfd]-&gt;_send_cb(_connections[sockfd]);   <span class="comment">// 调用写回调函数</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器主循环</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _quit = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;TCP服务器主循环开始运行，端口: %d&quot;</span>, _port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AddConnection(_listensock_ptr-&gt;Fd(), EVENT_IN, std::bind(&amp;TcpServer::Accept, this, std::placeholders::_1),nullptr,nullptr);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!_quit)              <span class="comment">// 持续处理事件直到服务器退出</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Dispatcher</span>(<span class="number">3000</span>);</span><br><span class="line">            <span class="built_in">PrintConnection</span>();      <span class="comment">// 可选，如果需要打印连接状态可以取消注释</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;TCP服务器主循环结束&quot;</span>);</span><br><span class="line">        _quit = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印当前连接列表（调试用）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">PrintConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">log_</span>(Debug, <span class="string">&quot;当前连接总数: %zu&quot;</span>, _connections.<span class="built_in">size</span>());</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;当前连接列表:&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; connection : _connections)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; connection.second-&gt;<span class="built_in">SockFd</span>() &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;inbuffer: &quot;</span> &lt;&lt; connection.second-&gt;<span class="built_in">Inbuffer</span>().<span class="built_in">c_str</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">TcpServer</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_</span>(Info, <span class="string">&quot;TCP服务器正在关闭，清理资源&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;Epoller&gt; _epoller_ptr;      <span class="comment">// epoll对象指针</span></span><br><span class="line">    std::shared_ptr&lt;Sock&gt; _listensock_ptr;      <span class="comment">// 监听socket对象指针</span></span><br><span class="line">    std::unordered_map&lt;<span class="type">int</span>, std::shared_ptr&lt;Connection&gt;&gt; _connections;  <span class="comment">// 连接管理映射表</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> revs[num];               <span class="comment">// epoll事件数组</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;                             <span class="comment">// 服务器端口号</span></span><br><span class="line">    <span class="type">bool</span> _quit;                                 <span class="comment">// 退出标志</span></span><br><span class="line"></span><br><span class="line">    <span class="type">func_t</span> _OnMessage;                          <span class="comment">// 消息处理函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="10-快速上手-CMake"><a href="#10-快速上手-CMake" class="headerlink" title="10. 快速上手 CMake"></a>10. 快速上手 CMake</h2><h3 id="1-CMake-是干什么的"><a href="#1-CMake-是干什么的" class="headerlink" title="1. CMake 是干什么的"></a>1. CMake 是干什么的</h3><p>CMake 是一个跨平台的 <strong>自动化构建工具</strong>。它的核心作用是：<strong>根据 CMakeLists.txt 自动生成 Makefile</strong>，然后我们只需执行 <code>make</code> 就能编译整个项目。</p><p>简单说：写一份 CMakeLists.txt → 执行 cmake → 自动生成 Makefile → 执行 make → 生成可执行文件。</p><h3 id="2-安装-CMake"><a href="#2-安装-CMake" class="headerlink" title="2. 安装 CMake"></a>2. 安装 CMake</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install cmake -y</span><br></pre></td></tr></table></figure><p>检查版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --version</span><br></pre></td></tr></table></figure><h3 id="3-编写最简-CMakeLists-txt"><a href="#3-编写最简-CMakeLists-txt" class="headerlink" title="3. 编写最简 CMakeLists.txt"></a>3. 编写最简 CMakeLists.txt</h3><p>在项目的根目录中创建一个名为 <code>CMakeLists.txt</code> 的文件写入内容：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)		<span class="comment"># 指定最低CMake版本</span></span><br><span class="line"><span class="keyword">project</span>(EpollServer)						<span class="comment"># 工程名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)					<span class="comment"># 使用C++11标准</span></span><br><span class="line"><span class="keyword">add_executable</span>(EpollServer Main.cc log.cpp) <span class="comment"># 生成可执行文件 main</span></span><br></pre></td></tr></table></figure><p>这就是最基本的版本。<strong>注意：CMake 严格要求文件名必须是 <code>CMakeLists.txt</code>，大小写都必须完全匹配。</strong> 原因很简单：CMake 的解析器在目录下只会自动搜索这个 <strong>精确名字</strong> 的文件（<code>CMakeLists.txt</code>）。不是变量名，不是模糊匹配，也不会识别 <code>CMakelists.txt</code>、<code>cmakelist.txt</code> 等写法。比如：</p><ul><li>✅ 正确：<code>CMakeLists.txt</code>。</li><li>❌ 错误：<code>CMakelists.txt</code> &#x2F; <code>cmakelists.txt</code>。</li></ul><blockquote><p><code>project(EpollServer)</code>：只是一个 <strong>工程名字</strong>，主要用于 CMake 内部标识，与目录名没强绑定。通常我们会让它与最终生成的可执行文件同名，这样方便。</p></blockquote><h3 id="4-编译和运行"><a href="#4-编译和运行" class="headerlink" title="4. 编译和运行"></a>4. 编译和运行</h3><p>我们建议在项目根目录执行下面的代码，这样生成的临时文件都在 build 里，不会污染源代码目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br></pre></td></tr></table></figure><p>运行 cmake 命令生成 Makefile</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake ..</span><br></pre></td></tr></table></figure><p>解释：<code>..</code> 表示让 CMake 去上一级（也就是项目根目录）找 <code>CMakeLists.txt</code>。执行完这步后，<code>build/</code> 目录里会生成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Makefile</span><br><span class="line">CMakeCache.txt</span><br><span class="line">CMakeFiles/</span><br></pre></td></tr></table></figure><p>执行 make 编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure><p>CMake 会自动调用 g++ 编译 <code>Main.cc</code> 并生成可执行文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EpollServer</span><br></pre></td></tr></table></figure><p>可选：运行程序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./EpollServer</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">小米里的大麦</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.minbit.top/posts/4211.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://www.minbit.top/posts/4211.html")'>057 高级 IO 之 epoll 详解与 CMake 入门</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wechatANDalipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechatANDalipay.webp" alt="微信/支付宝"></a><div class="post-qr-code-desc">微信/支付宝</div></li><li class="reward-item"><a href="/img/PayPal.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/PayPal.webp" alt="PayPal"></a><div class="post-qr-code-desc">PayPal</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.minbit.top/posts/4211.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=057 高级 IO 之 epoll 详解与 CMake 入门&amp;url=https://www.minbit.top/posts/4211.html&amp;pic=https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=578d71b1-7771-3429-133e-7bea81a56b7a" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 许可协议。转载请注明来自 <a href="https://www.minbit.top" target="_blank">小米里的大麦</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Linux/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span>Linux<span class="tagsPageCount">59</span></a><a class="post-meta__box__tags" href="/tags/IO/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>IO<span class="tagsPageCount">5</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=6fc4a26b-d384-a060-5b79-b0768070ba93" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/57353.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/12THR4h.png?_r_=16db0a8f-806b-29ad-d6cb-e82b0977b958" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">05 数据类型</div></div></a></div><div class="next-post pull-right"><a href="/posts/26657.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/IAdmxAt.png?_r_=efb6dfb5-3c36-82e5-c606-558f2fbfd215" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">C++ 语言层面上的多线程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/29393.html" title="023 基础 IO —— 重定向"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=ecfd3969-1d3f-6037-f72f-732571188fac" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-06</div><div class="title">023 基础 IO —— 重定向</div></div></a></div><div><a href="/posts/36108.html" title="024 基础 IO —— 缓冲区"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=07afb43f-bf82-adb6-160b-225f37b28082" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-11</div><div class="title">024 基础 IO —— 缓冲区</div></div></a></div><div><a href="/posts/15473.html" title="022 基础 IO —— 文件"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/12THR4h.png?_r_=87aca1f7-1898-cb00-5511-ed44c737e3dd" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-04</div><div class="title">022 基础 IO —— 文件</div></div></a></div><div><a href="/posts/7814.html" title="056 高级 IO"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=2e880e29-ca9a-cca4-f000-a0277171e831" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-10-14</div><div class="title">056 高级 IO</div></div></a></div><div><a href="/posts/49772.html" title="001 环境搭建"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/IAdmxAt.png?_r_=1fd2df79-cdb8-578f-4c0c-2de95a298850" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-11</div><div class="title">001 环境搭建</div></div></a></div><div><a href="/posts/55415.html" title="002 创建普通账户（为朋友创建、删除账户）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=46285b48-cba0-53ff-483c-f5c71d93785b" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-17</div><div class="title">002 创建普通账户（为朋友创建、删除账户）</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile%20picture.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"></div></div><div class="author-info__description">时间好像总会留下点什么,或许是一个人,或许是一个梦,或许……是一段有意义的经历~</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">小米里的大麦</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/huangcancan-xbc" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><span>👋🏻 Hi，我是 <a target="_blank" href="https://huangcancan-xbc.github.io" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">小米里的大麦</a>，欢迎来看我的博客鸭！</span><br><span>👉 建议优先查看置顶的 <a target="_blank" href="https://huangcancan-xbc.github.io/posts/17934.html" rel="external nofollow noreferrer noopener" style="font-weight:700;font-size:1.1em;color:#5166f0">网站说明</a>，如有问题欢迎评论区交流！</span><br><span>😫 页面异常？尝试<kbd>Ctrl</kbd>+<kbd>F5</kbd></span><br><span>📩 联系我：<a href="mailto:hc1960074081@qq.com" rel="external nofollow noreferrer"><b>给我发送邮件🚀</b></a></span><br><div style="text-align:center;margin-top:10px"><style>.pp-AN88D43BPZLXN{text-align:center;border:none;border-radius:.25rem;min-width:11.625rem;padding:0 2rem;height:2.625rem;font-weight:700;background-color:#ffd140;color:#003087;font-family:"Helvetica Neue",Arial,sans-serif;font-size:1rem;line-height:1.25rem;cursor:pointer}</style><form action="https://www.paypal.com/ncp/payment/AN88D43BPZLXN" method="post" target="_blank" style="display:inline-grid;justify-items:center;align-content:start;gap:.5rem"><input class="pp-AN88D43BPZLXN" type="submit" value="打赏支持我"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://www.paypalobjects.com/images/Debit_Credit_APM.svg" alt="cards"><section style="font-size:.75rem">技术支持提供方： <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://www.paypalobjects.com/paypal-ui/logos/svg/paypal-wordmark-color.svg" alt="paypal" style="height:.875rem;vertical-align:middle"></section></form></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#epoll-%E5%92%8C-CMake-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">epoll 和 CMake 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-epoll-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1. epoll 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-epoll-%E7%9A%84%E4%B8%89%E5%A4%A7%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">2. epoll 的三大函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-epoll-create-epoll-create1-%E2%80%94%E2%80%94-%E5%88%9B%E5%BB%BA-epoll-%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.3.</span> <span class="toc-text">3. epoll_create&#x2F;epoll_create1 —— 创建 epoll 实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-epoll-ctl-%E2%80%94%E2%80%94-%E6%8E%A7%E5%88%B6%E7%9B%91%E5%90%AC%E5%88%97%E8%A1%A8%EF%BC%88%E6%B3%A8%E5%86%8C-%E4%BF%AE%E6%94%B9-%E5%88%A0%E9%99%A4-%E5%85%B3%E6%B3%A8%E7%9A%84-fd%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">4. epoll_ctl —— 控制监听列表（注册 &#x2F; 修改 &#x2F; 删除 关注的 fd）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-epoll-wait-%E2%80%94%E2%80%94-%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6%E5%8F%91%E7%94%9F"><span class="toc-number">1.5.</span> <span class="toc-text">5. epoll_wait —— 等待事件发生</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-epoll-%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">6. epoll 的底层原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-epoll-%E7%9A%84%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. epoll 的三大核心组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%80%E4%B8%AA%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%EF%BC%9A%E5%9B%9E%E8%B0%83-%E2%80%94%E2%80%94-epoll-%E9%AB%98%E6%95%88%E7%9A%84-%E7%A7%98%E5%AF%86%E6%AD%A6%E5%99%A8%EF%BC%81"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. 一个核心机制：回调 —— epoll 高效的 秘密武器！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 整体流程概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%86%85%E9%83%A8%E5%85%B3%E9%94%AE%E5%AF%B9%E8%B1%A1%EF%BC%9Aepitem"><span class="toc-number">1.6.4.</span> <span class="toc-text">4. 内部关键对象：epitem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%89%B9%E6%AE%8A%E5%A4%84%E7%90%86"><span class="toc-number">1.6.5.</span> <span class="toc-text">5. 特殊处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%BF%9D%E9%9A%9C"><span class="toc-number">1.6.6.</span> <span class="toc-text">6. 线程安全保障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%94-select-poll-%E9%AB%98%E6%95%88%EF%BC%9F"><span class="toc-number">1.6.7.</span> <span class="toc-text">7. 为什么比 select&#x2F;poll 高效？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B%EF%BC%88epoll-LT%EF%BC%89"><span class="toc-number">1.7.</span> <span class="toc-text">7. 代码示例（epoll LT）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-epoll-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">1.8.</span> <span class="toc-text">8. epoll 的工作方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E5%8C%BA%E5%88%AB"><span class="toc-number">1.8.1.</span> <span class="toc-text">1. 核心区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ET-%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%BC%96%E7%A8%8B%E8%A6%81%E7%82%B9"><span class="toc-number">1.8.2.</span> <span class="toc-text">2. ET 模式的编程要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%96%91%E9%9A%BE%E8%A7%A3%E7%AD%94"><span class="toc-number">1.8.3.</span> <span class="toc-text">3. 疑难解答</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-LT-%E6%A8%A1%E5%BC%8F%E4%B8%8B%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%88%91%E6%8A%8A-fd-%E8%AE%BE%E4%B8%BA%E9%9D%9E%E9%98%BB%E5%A1%9E%EF%BC%8C%E5%B9%B6%E5%9C%A8%E7%AC%AC%E4%B8%80%E6%AC%A1%E9%80%9A%E7%9F%A5%E6%97%B6%E5%B0%B1%E5%BE%AA%E7%8E%AF%E8%AF%BB%E5%AE%8C%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%EF%BC%8C%E9%82%A3%E5%92%8C-ET-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">1. LT 模式下，如果我把 fd 设为非阻塞，并在第一次通知时就循环读完所有数据，那和 ET 有什么区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88-ET-%E5%BF%85%E9%A1%BB%E7%94%A8%E9%9D%9E%E9%98%BB%E5%A1%9E-IO%EF%BC%9F"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">2. 为什么 ET 必须用非阻塞 IO？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-ET-%E6%A8%A1%E5%BC%8F%E7%9C%9F%E7%9A%84%E6%9B%B4%E9%AB%98%E6%95%88%E5%90%97%EF%BC%9F"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">3. ET 模式真的更高效吗？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B%EF%BC%88epoll-ET%EF%BC%89"><span class="toc-number">1.9.</span> <span class="toc-text">9. 代码示例（epoll ET）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-CMake"><span class="toc-number">1.10.</span> <span class="toc-text">10. 快速上手 CMake</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CMake-%E6%98%AF%E5%B9%B2%E4%BB%80%E4%B9%88%E7%9A%84"><span class="toc-number">1.10.1.</span> <span class="toc-text">1. CMake 是干什么的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85-CMake"><span class="toc-number">1.10.2.</span> <span class="toc-text">2. 安装 CMake</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99%E6%9C%80%E7%AE%80-CMakeLists-txt"><span class="toc-number">1.10.3.</span> <span class="toc-text">3. 编写最简 CMakeLists.txt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%BC%96%E8%AF%91%E5%92%8C%E8%BF%90%E8%A1%8C"><span class="toc-number">1.10.4.</span> <span class="toc-text">4. 编译和运行</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/22243.html" title="2025 年度总结"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/TISblXc.png?_r_=6fc4a26b-d384-a060-5b79-b0768070ba93" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2025 年度总结"></a><div class="content"><a class="title" href="/posts/22243.html" title="2025 年度总结">2025 年度总结</a><time datetime="2025-12-31T16:00:00.000Z" title="发表于 2026-01-01 00:00:00">2026-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/39993.html" title="08 表的增删改查下"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/12THR4h.png?_r_=6678428a-7043-ada6-7336-f16c60cf0d4e" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="08 表的增删改查下"></a><div class="content"><a class="title" href="/posts/39993.html" title="08 表的增删改查下">08 表的增删改查下</a><time datetime="2025-12-12T16:00:00.000Z" title="发表于 2025-12-13 00:00:00">2025-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/38170.html" title="Ubuntu 22.04 中安装 thefuck 与 tldr 工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/08taomy.jpeg?_r_=c6628b3e-dbb9-69cf-7b52-a1592090642c" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Ubuntu 22.04 中安装 thefuck 与 tldr 工具"></a><div class="content"><a class="title" href="/posts/38170.html" title="Ubuntu 22.04 中安装 thefuck 与 tldr 工具">Ubuntu 22.04 中安装 thefuck 与 tldr 工具</a><time datetime="2025-11-22T04:00:00.000Z" title="发表于 2025-11-22 12:00:00">2025-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/31539.html" title="CodeX CLI 的使用备忘"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/gDpBkQU.png?_r_=de921907-5476-440e-1b3f-76a5b42fc82f" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="CodeX CLI 的使用备忘"></a><div class="content"><a class="title" href="/posts/31539.html" title="CodeX CLI 的使用备忘">CodeX CLI 的使用备忘</a><time datetime="2025-11-19T04:00:00.000Z" title="发表于 2025-11-19 12:00:00">2025-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image-kcm.pages.dev/v2/yPgfhRS.png?_r_=42c13ae0-a861-b4a6-ba61-e7da0a973c91" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="免费白嫖 ChatGPT Go 套餐"></a><div class="content"><a class="title" href="/posts/41191.html" title="免费白嫖 ChatGPT Go 套餐">免费白嫖 ChatGPT Go 套餐</a><time datetime="2025-11-04T16:00:00.000Z" title="发表于 2025-11-05 00:00:00">2025-11-05</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:hc1960074081@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/7913790969" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/Profile picture.png" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 - 2026 By <a class="footer-bar-link" href="/" title="小米里的大麦" target="_blank">小米里的大麦</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType(){fetch("https://v1.hitokoto.cn").then(t=>t.json()).then(t=>{{const e="出自 "+t.from,n=["《左传》载曰：“太上有立德，其次有立功，其次有立言，虽久不废，此之谓不朽。”","纸上得来终觉浅，绝知此事要躬行！","《答案在风中飘扬》（Blowing in The Wind）","梦想是不会发光的，发光的是追梦的你！","你太专注于未来，却没有意识到，今天正是你多年前祈求的模样，因为你眺望远方视而不见。"];n.unshift(t.hitokoto,e),window.typed=new Typed("#footer-type-tips",{strings:n,startDelay:300,typeSpeed:150,loop:!0,backSpeed:50})}})}"function"==typeof Typed?subtitleType():getScript("https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js").then(subtitleType)</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub主页">GitHub主页</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">93</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">社交</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/huangcancan-xbc" title="GitHub"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/lollipop.svg" alt="GitHub"><span class="back-menu-item-text">GitHub</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1918272544" title="哔哩哔哩"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/wink.svg" alt="哔哩哔哩"><span class="back-menu-item-text">哔哩哔哩</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://gitee.com/huang-cancan-xbc" title="Gitee"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/laugh.svg" alt="Gitee"><span class="back-menu-item-text">Gitee</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.csdn.net/Huangcancan666?type=blog" title="CSDN"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/celebrate.svg" alt="CSDN"><span class="back-menu-item-text">CSDN</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://juejin.cn/user/3230789931118109" title="稀土掘金"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/kiss.svg" alt="稀土掘金"><span class="back-menu-item-text">稀土掘金</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">算法</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://leetcode.cn/u/nifty-faradayzqn" title="力扣"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/thinking-glass.svg" alt="力扣"><span class="back-menu-item-text">力扣</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://ac.nowcoder.com/acm/contest/profile/517073385" title="牛客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/think.svg" alt="牛客"><span class="back-menu-item-text">牛客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/1367427" title="洛谷"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/icons/funny.svg" alt="洛谷"><span class="back-menu-item-text">洛谷</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i><span> 统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i><span> 外链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i><span> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size:.88rem">AI<sup>2</sup></a><a href="/tags/C/" style="font-size:.88rem">C++<sup>11</sup></a><a href="/tags/Git/" style="font-size:.88rem">Git<sup>3</sup></a><a href="/tags/IO/" style="font-size:.88rem">IO<sup>5</sup></a><a href="/tags/Linux/" style="font-size:.88rem">Linux<sup>59</sup></a><a href="/tags/MySQL/" style="font-size:.88rem">MySQL<sup>9</sup></a><a href="/tags/Redis/" style="font-size:.88rem">Redis<sup>2</sup></a><a href="/tags/STL/" style="font-size:.88rem">STL<sup>2</sup></a><a href="/tags/VS-Code/" style="font-size:.88rem">VS Code<sup>1</sup></a><a href="/tags/%E4%BF%A1%E5%8F%B7/" style="font-size:.88rem">信号<sup>3</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size:.88rem">内存管理<sup>1</sup></a><a href="/tags/%E5%8E%86%E7%A8%8B/" style="font-size:.88rem">历程<sup>2</sup></a><a href="/tags/%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" style="font-size:.88rem">地址空间<sup>6</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size:.88rem">工具<sup>4</sup></a><a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size:.88rem">数学<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size:.88rem">模板<sup>1</sup></a><a href="/tags/%E7%81%B5%E5%85%89%E8%8D%9F%E8%90%83/" style="font-size:.88rem">灵光荟萃<sup>3</sup></a><a href="/tags/%E7%AE%A1%E9%81%93/" style="font-size:.88rem">管道<sup>2</sup></a><a href="/tags/%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" style="font-size:.88rem">类与对象<sup>3</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:.88rem">线程<sup>5</sup></a><a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size:.88rem">网站<sup>3</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size:.88rem">网络<sup>11</sup></a><a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size:.88rem">进程<sup>15</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="anzhiyu.scrollToDest(document.body.scrollHeight,500)"><i class="anzhiyufont anzhiyu-icon-arrow-down"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@6.1.6/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@19.1.3/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>var HoldLog=console.log;console.log=function(){};let now1=new Date;queueMicrotask(()=>{const o=function(){HoldLog.apply(console,arguments)},n=new Date("01/01/2025 00:00:00");now1.setTime(now1.getTime()+250);const c=(now1-n)/1e3/60/60/24,e=["这里是 小米里的大麦","芝兰生于深谷，不以无人而不芳。","\n        \n       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗\n      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║\n      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║\n      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║\n      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝\n      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝\n        \n        ","已上线",Math.floor(c),"天","©2025 By 安知鱼 V1.7.1"],t=["NCC2-036","调用前置摄像头拍照成功，识别为【小笨蛋】.","Photo captured: ","🤪"];setTimeout(o.bind(console,`\n%c${e[0]} %c ${e[1]} %c ${e[2]} %c${e[3]}%c ${e[4]}%c ${e[5]}\n\n%c ${e[6]}\n`,"color:#425AEF","","color:#425AEF","color:#425AEF","","color:#425AEF","")),setTimeout(o.bind(console,`%c ${t[0]} %c ${t[1]} %c \n${t[2]} %c\n${t[3]}\n`,"color:white; background-color:#4fd953","","",'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%')),setTimeout(o.bind(console,"%c WELCOME %c 你好，小笨蛋.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c ⚡ Powered by 安知鱼 %c 你正在访问 小米里的大麦 的博客.","color:white; background-color:#f0ad4e","")),setTimeout(o.bind(console,"%c W23-12 %c 你已打开控制台.","color:white; background-color:#4f90d9","")),setTimeout(console.warn.bind(console,"%c S013-782 %c 你现在正处于监控中.","color:white; background-color:#d9534f",""))})</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.minbit.top/",path:window.location.pathname,region:"ap-shanghai",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then(o=>{t.textContent=o[0].count}).catch(t=>{console.error(t)})})()};anzhiyu.loadComment(document.getElementById("twikoo-wrap"),t)})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.minbit.top/",region:"ap-shanghai",pageSize:6,includeReply:!0}).then((function(t){const n=t.map(e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t});saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.44/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)})</script><script async data-pjax src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="xiaomilidedamai@minbit.top"</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://cdn.cbd.int/qrcodejs@1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js"></script><script src="/js/footer-animal.js" defer></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="offer,暴富,健康,offer,喜乐,成功,offer,好运,自由,offer,坚持,上岸" data-fontsize="20px" data-random="true" async></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="https://events.vercount.one/js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script><script>window.addEventListener("load",()=>{const t=()=>{if(!window.location.pathname.startsWith("/comments/"))return;const t=async()=>{const t=new EasyDanmaku({page:"/comments/",el:"#danmu-wrap",line:5,speed:20,hover:!0,loop:!1,colourful:!0,coefficient:1.38,runtime:10});try{let a=saveToLocal.get("twikoo-danmu");if(a)t.batchSend(a,!0);else{const n={method:"POST",body:JSON.stringify({event:"GET_RECENT_COMMENTS",includeReply:!1,pageSize:100}),headers:{"Content-Type":"application/json"}};a=[];const o=await fetch("https://twikoo.minbit.top/",n);if(o.ok){const{data:n}=await o.json();n.forEach(t=>{null==t.avatar&&(t.avatar="https://cravatar.cn/avatar/d615d5793929e8c7d70eab5f00f7f5f1?d=mp"),a.push({avatar:t.avatar,content:t.nick+"："+e(t.comment),url:t.url+"#"+t.id})}),t.batchSend(a,!0),saveToLocal.set("twikoo-danmu",a,.5)}function e(t){return t=(t=(t=(t=(t=t.replace(/<\/*br>|[\s\uFEFF\xA0]+/g,"")).replace(/<img.*?>/g,"[图片]")).replace(/<a.*?>.*?<\/a>/g,"[链接]")).replace(/<pre.*?>.*?<\/pre>/g,"[代码块]")).replace(/<.*?>/g,"")}}}catch(t){console.error("Error fetching data:",t)}document.getElementById("danmu-Btn")&&(document.getElementById("danmu-Btn").innerHTML="<button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.remove('hide-danmu')\">显示弹幕</button> <button class=\"hide-Btn\" onclick=\"document.getElementById('danmu-wrap').classList.add('hide-danmu')\">隐藏弹幕</button>")};(async()=>{if("function"==typeof EasyDanmaku)await t();else{await getScript("https://npm.onmicrosoft.cn/naokuo-blog@1.2.12/js/easy-Danmaku.js");"function"==typeof EasyDanmaku?await t():console.error("EasyDanmaku function not found even after loading the script.")}})()};t(),document.addEventListener("pjax:complete",t)})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>